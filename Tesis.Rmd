---
title: "Tesis"
subtitle: "Una tesis"
author: "Elio Campitelli"
date: ""
lang: es-AR
bibliography: [Papers/Biblio.bib, Papers/packages.bib]
geometry: "inner = 3cm, outer = 2cm, top = 2.5cm, bottom = 2.5cm"
documentclass: book
classoption: a4paper
knit: (function(file, encoding, ...) {
    rmarkdown::render(file, encoding = encoding, 
                output_dir = "docs/")})
output:
    pdf_document:
      fig_height: 3
      fig_width: 6
      keep_tex: yes
      latex_engine: xelatex
      number_sections: yes
      toc: yes
      toc_depth: 4
header-includes: 
    - \linespread{1.25}
    - \usepackage{subfig}
    - \usepackage{hyperref}
    - \usepackage{marginnote}
    - \usepackage[nomarkers,figuresonly]{endfloat}
link-citations: yes
params: 
    draft: TRUE
biblio-style: apalike
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy = FALSE,
                      echo = FALSE, 
                      cache = TRUE, 
                      force.cap = TRUE,
                      fig.calss = "pagewidth",
                      fig.ncol = 1,
                      fig.publish = TRUE,
                      # cache.lazy = TRUE,
                      cache.path = "cache/tesis/",
                      fig.path = "fig/tesis/",
                      out.extra = " ",
                      warning = FALSE,
                      message = FALSE)

library(tufte)
library(data.table)
library(ggplot2)
library(dplyr)
library(metR) 
library(WaveletComp)
library(patchwork)

knitr::write_bib(c("base", "data.table", "ggplot2", "WaveletComp", "metR"), 
                 file = "Papers/packages.bib")

source("scripts/helperfun.R")

map.world <- BuildMap(res = 1, smooth = 1)
map.SH <- map.world[lat %b% c(-90, 0)]
map.world <- geom_map2(map.world)
map.SH <- geom_map2(map.SH)

pres <- ReadNetCDF("DATA/NCEP/srfp.mon.mean.nc")
pres.mean <- pres[, .(pres = median(pres)), by = lat]
pres.mean <- rbind(data.table(lat = 0.0, pres = Inf), 
                   pres.mean, 
                   data.table(lat = -90.0, pres = Inf))
surface <- geom_polygon(data = pres.mean, aes(y = pres), fill = "white", 
                        alpha = 0.5, color = "gray30", size = 0.5)
pres <- pres[, .(pres = mean(pres)), by = .(lon, lat)]

theme_elio <- theme_minimal(base_size = 11) +
    theme(legend.position = "bottom", legend.box = "vertical",
          panel.spacing.y = unit(5, "mm"),
          legend.spacing = unit(2, "mm"),
          plot.margin = grid::unit(rep(3, 4), "mm"),
          legend.title = element_blank(),
          panel.grid = element_line(color = "black", size = 0.2, linetype = 3),
          panel.ontop = TRUE)
theme_set(theme_elio)

## Hooks.

## Force captions
plot_hook <- knitr::knit_hooks$get("plot")
knitr::knit_hooks$set(
    plot = function(x, options) {
        if (options$force.cap == TRUE & is.null(options$fig.cap)) {
            stop("All figures must have captions.")
        }
        if (params$draft == TRUE) {
            options$fig.cap <- paste0(options$fig.cap, " - fig:", 
                                      knitr::opts_current$get("label"))
        }
        if (options$fig.publish == FALSE) {
            options$fig.cap <- paste0(options$fig.cap, " - SÓLO BORRADOR")
        }
        if (options$fig.publish == TRUE | params$draft == TRUE) {
            plot_hook(x, options)
        }
    })
## Figure classes
DefineClass <- function(class.opts) {
    class.name <- deparse(substitute(class.opts))
    class.fun <- function(options) {
        class <- options[[class.name]]
        class <- class.opts[[class]]
        options[names(class)] <- class
        options
    }
    invisible(knitr::opts_hooks$set(
        setNames(list(class.fun), class.name)
    ))
}

page.width <- 210 - 30 - 30
text.width <- page.width - 20
text.height <- page.height <- 297 - 25 - 25

fig.class <- list(
    pagewidth = list(
        fig.width = page.width/25.4,
        out.width = paste0(page.width, "mm"),
        # fig.align = "center",
        fig.env = "figure*",
        out.extra = " "
    ),
    textwidth = list(
        fig.width = text.width/25.4,
        out.width = paste0(text.width, "mm"),
        fig.env = "figure",
        fig.align = "center",
        out.extra = " "
    ),
    fullpage = list(
        fig.width = (page.height - 20)/25.4,
        fig.height = page.width/25.4,
        out.width = paste0(page.height - 20, "mm"),
        fig.align = "center",
        out.extra = "angle=90"
    ),
    vfullpage = list(
        fig.width = page.width/25.4,
        fig.height = (page.height - 20)/25.4,
        out.width = paste0(page.width, "mm"),
        fig.align = "center"
    ),
    halfpage = list(
        # out.width = "7.3cm",
        fig.width = (page.width/2)/25.4,
        out.width = paste0(page.width/2, "mm")
    ),
    
    medium = list(
        fig.width = 8,
        fig.height = 4,
        # out.width = "\\textwidth",
        # out.height = "0.25\\textheight",
        fig.align = "center")
)

DefineClass(fig.class)

setDTthreads(3)
```

Resumen.


```{r read-ncep, cache = FALSE}
file.ncep <- "DATA/NCEP/ncep.vars.Rds"
ncep <- cache.file(file.ncep, {
    ncep <- ReadNetCDF("DATA/NCEP/hgt.mon.mean_sub.nc", vars = c(gh = "hgt"))
    setnames(ncep, "level", "lev")
    ncep <- 
        ncep[, t := ReadNetCDF("DATA/NCEP/air.mon.mean_sub.nc", 
                               out = "vector")[[1]]] %>% 
        .[, u := ReadNetCDF("DATA/NCEP/uwnd.mon.mean_sub.nc", 
                            out = "vector")[[1]]] %>% 
        .[, v := ReadNetCDF("DATA/NCEP/vwnd.mon.mean_sub.nc", 
                            out = "vector")[[1]]]
    
    vars <- c("gh", "t", "u", "v")
    vars.z <- paste0(vars, ".z")
    ncep[, c(vars.z) := lapply(.SD, Anomaly), by = .(lat, lev, date), .SDcols = -"lon"]
    ncep
})


ncep[, date := as.Date(date), by = date]
ncep.mean <- ncep[, lapply(.SD, mean), 
                  by = .(lat, lon, lev, month(date))]

ncep.mean.season <- ncep.mean[, lapply(.SD, mean), 
                              by = .(lon, lat, lev, season(month))]
```

# Introducción


* Antecedentes    
Además de lo que hay en lo de las becas + lo que fui encontrando, agregar sobre las climatologías disponibles y sus limitaciones. 
* Objetivo General
* Objetivo particular 

Esto es para probar una referencia bibliográfica: @Vera2004 y [@Vera2004]

# Métodos y Materiales

## Conceptos básicos

* Ondas cuasiestacionarias
* Fourier


```{r fitqs-ncep}
ncep.qs <- ncep[, FitQsWave(gh, k = 1:4), by = .(lat, lev, date)]
```


Ejemplo:

```{r calc-fourier-ejemplo}
# set.seed(2)
select.date <- as.Date("1999-03-01")
wave <- ncep[date == select.date & lev == 300, 
             .(lon, lat, date, gh)]
wave[, gh.z := Anomaly(gh), by = .(lat)][
    , k := "campo"]

lons <- unique(ncep$lon)
qs.wave <- ncep.qs[date == select.date & lev == 300 & k < 4, 
                   .(lon = lons, 
                     gh.z = amplitude*cos(k*(lons*pi/180 - phase))),
                   by = .(lat, date, k)]
wave <- rbind(wave[, -c("gh")], qs.wave)
wave[, k := factor(k, levels = c("campo", 1:3))]
```


```{r fourier-ejemplo, fig.class = "pagewidth", fig.cap = "Ejemplo fourier"}
binwidth <- 20
ggplot(RepeatLon(wave), aes(lon, lat)) +
    stat_contour_fill(aes(z = gh.z), 
                      binwidth = binwidth, size = 0.5) +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(name = "", 
                         binwidth = binwidth, 
                         guide = guide_colorstrip_bottom()) +
    theme(axis.title = element_blank()) +
    facet_wrap(~ k, ncol = 4) +
    coord_polar()

```

Cosas para ver de \autoref{fig:fourier-ejemplo}:   
Descripción del "rol" de cada número de onda en generar el campo final. 
La onda 1 es la principal, marcando altas presiones al sur del pacífico y bajas al sur de África. La onda 3 modifica ese patrón simple haciendo que los máximos y mínimos no sean contínuos.


* Wavelets 


```{r calc-wavelet-ejemplo}
test <- ncep[lev == 300 & date == as.Date("2008-09-01") & lat %~% -60]
test.1 <- copy(test)
test.2 <- copy(test)
test.1[, lon := lon - 360]
test.2[, lon := lon + 360]
test.a <- rbind(test.1, test, test.2)

dlon <- diff(ncep$lon[1:2])
w <- WaveletComp::WaveletTransform(test.a$gh.z, dt = 1, upperPeriod = 360/dlon)

ampl <- w$Ampl*sd(test.a$gh.z)
dimnames(ampl) <- list(period = w$Period, lon = test.a$lon)
ampl <- as.data.table(melt(ampl))
ampl[, period := period*dlon]
ampl1 <- ampl[Between(lon, c(0, 360), include = c(T, F))]
ampl1[, lat := -60]

test <- ncep[lev == 300 & date == as.Date("2008-09-01") & lat %~% -45]
test.1 <- copy(test)
test.2 <- copy(test)
test.1[, lon := lon - 360]
test.2[, lon := lon + 360]
test.a <- rbind(test.1, test, test.2)

dlon <- diff(ncep$lon[1:2])
w <- WaveletComp::WaveletTransform(test.a$gh.z, dt = 1, upperPeriod = 360/dlon)

ampl <- w$Ampl*sd(test.a$gh.z)
dimnames(ampl) <- list(period = w$Period, lon = test.a$lon)
ampl <- as.data.table(melt(ampl))
ampl[, period := period*dlon]
ampl2 <- ampl[Between(lon, c(0, 360), include = c(T, F))]
ampl2[, lat := -45]
ampl <- rbind(ampl1, ampl2)

ncep.wv <- ncep[date == as.Date("2008-09-01") & lev == 300,
                .(lon = lon, gh.z = gh.z,
                  amplitude = unlist(PeriodicWavelet(gh, 3))),
                by = .(lat, lev, date)]
```


```{r wavelet-ejemplo, fig.show = "hold", fig.env = "figure*", fig.height = 70/25.4, fig.cap = "Wavelets", fig.class = "halfpage", fig.subcap = c("Campo", "Análisis de Wavelets en círculos de latitud señalados."), fig.ncol = 2}

ggplot(RepeatLon(ncep.wv[date == as.Date("2008-09-01") & lev == 300]), 
       aes(lon, lat)) +
    stat_contour_fill(aes(z = gh.z), exclude = 0,
                      binwidth = 75, size = 0.3) +
    stat_contour(aes(z = amplitude, color = ..level..), 
                 binwidth = 15, size = 0.4) +
    geom_hline(yintercept = -60, linetype = 2) +
    geom_hline(yintercept = -45, linetype = 2) +
    map.SH +
    scale_y_latitude(limits = c(-90, 0)) +
    scale_x_longitude() +
    scale_color_viridis_c(name = "Amplitud de onda 3", 
                          breaks = MakeBreaks(25, 0),
                          guide = "none") +
    scale_fill_divergent(guide = guide_colorstrip_bottom(15),
                         breaks = MakeBreaks(binwidth = 75)) +
    theme(axis.title = element_blank()) +
    scale_linetype_discrete(name = "Anomalía zonal de geopotencial", drop = T) +
    coord_polar()

ggplot(ampl, aes(lon, 360/period)) +
    # geom_tile(aes(fill = value)) +
    stat_contour(aes(z = value, color = ..level..), binwidth = 15) +
    # geom_contour(aes(z = pval), breaks = c(0.001), color = "black") +
    scale_y_continuous(name = "Número de onda zonal", 
                       breaks = 1:10, limits = c(NA, 5), 
                       expand = c(0, 0)) +
    scale_x_longitude(name = "longitud") +
    geom_hline(yintercept = 3, linetype = 3, alpha = 0.4) +
    scale_color_viridis_c(breaks = MakeBreaks(15),
                          guide = guide_colorstrip_bottom(15, inside = T)) +
    facet_wrap(~lat, ncol = 2, labeller = labeller(lat = AddPreffix("Latitud: ")))
```

Cosas para ver:    
Cambio en el máximo. Localización en vez de un número para cada latitud. 


## Fuentes de datos

## Descripción de SPEEDY

# Climatología observada

## Altura geopotencial

Campo medio:

```{r gh-ncep, fig.class = "fullpage", fig.cap = "Campo de Z (NCEP)"}
plot.levs <- c(500, 300, 200, 100, 50)
binwidth <- 250
ggplot(ncep.mean.season[lev %in% plot.levs], aes(lon, lat)) +
    geom_contour_fine(aes(z = gh), binwidth = binwidth, color = "black") +
    map.SH +
    geom_label_contour2(aes(z = gh, label = ..level..), binwidth = binwidth,
                        size = 1.6) +
    scale_s_map() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap() 
```

El campo de altura geopotencial media (Z, \autoref{fig:gh-ncep}) muestra una estructura más zonal en el HS que en el HN. Es evidente la generación del vórtice polar en la estratósfera de invierno y primavera y el aumento del gradiente meridional de Z con la altura. 

```{r ghdy-ncep-corte, fig.cap = "Gradiente meridional de Z", fig.publish = FALSE}
ncep.mean.season[, mean(gh), by = .(lat, lev, season)] %>% 
    .[, gh.dy := Derivate(V1 ~ lat), by = .(lev, season)] %>% 
    # .[, .(gh.dy = mean(gh.dy, na.rm = T)), by = .(lev, season)] %>% 
    # ggplot(aes(lev, gh.dy, color = season)) +
    # geom_line() + 
    # scale_x_level() +
    # coord_flip()
    ggplot(aes(lat, lev)) +
    geom_contour_fill(aes(z = gh.dy), binwidth = 10, na.rm = T) +
    surface +
    scale_fill_viridis_c(breaks = MakeBreaks(10),
                         guide = guide_colorstrip_bottom()) +
    scale_fill_divergent() +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(trans = "reverse") +
    facet_wrap(~season)
```


```{r ghz-ncep, fig.class = "fullpage", fig.cap = "Anomalía zonal de altura geopotencial."}
binwidth <- 20
cutlat <- -60
ggplot(ncep.mean.season[lev %in% plot.levs], aes(lon, lat)) +
    geom_contour_fill(aes(z = gh.z), binwidth = binwidth, exclude = 0) +
    # geom_hline(yintercept = cutlat, linetype = 2, size = 0.5) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(binwidth = binwidth, name = "Z*", exclude = 0, 
                         guide = guide_colorstrip_bottom(25)) +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap()
```

Las anomalías zonales (\autoref{fig:ghz-ncep}) muestran una preponderancia de una onda 1 (QS1) con una amplitud máxima en la estratósfera de primavera y una estructura coherente en la vertical en 60°S (\autoref{fig:ghz-ncep-corte60}). Pueden diferenciarse dos QS1 distintas; una centrada en ~60°S y con el centro anticiclónico al rededor de la línea de fecha, y la otra sobre la costa del continente y el centro anticilónico entre 120 y 60°O. @Quintanar1995 concluyó que el primero está asociado principalmente con forzantes de latitudes bajas mientras que el segundo responde a la orografía del continente antártico.

Salvo en verano, la inclinación hacia el oeste en la horizontal y en la vertical indica que las perturbaciones estacionarias están asociadas con transporte hacia el polo tanto de cantidad de movimiento zonal como de temperatura. \footnote{¿Debería agregar una justificaicón de esto? ¿Un resumen del desarrollo matemático que está en el James?} 

En verano, las anomalías zonales tienen una estructura barotrópica equivalente y carecen de inclinación en la horizontal. Consecuentemente, los transportes meridionales asociados se reducen considerablemente. \footnote{¿Por qué?}

```{r ghz-ncep-corte60, fig.class = "textwidth", fig.cap = "Corte zonal de anomalía de geopotencial en -60°."}
binwidth <- 60
ggplot(ncep.mean.season[lat %~% cutlat], aes(lon, lev)) +
    geom_contour_fill(aes(z = gh.z), binwidth = binwidth, exclude = 0) +
    scale_fill_divergent(binwidth = binwidth, exclude = 0, name = "Z*",
                         guide = guide_colorstrip_bottom(width = 25)) +
    scale_y_level(breaks = plot.levs, minor_breaks = NULL) +
    scale_x_longitude(name = "longitud") +
    facet_wrap(~season)
```


```{r uzvz-ncep-corte, fig.cap = "Transportes", fig.subcap = c("uz*vz*", "T*v*"), fig.publish = FALSE}
ncep[, mean(u.z*v.z), by = .(lat, lev, season(date))] %>% 
    ggplot(aes(lat, lev)) +
    geom_contour(aes(z = V1, color = ..level..), binwidth = 5) +
    scale_color_divergent(breaks = MakeBreaks(5)) +
    scale_y_level() +
    scale_x_latitude(trans = "reverse") +
    facet_wrap(~season)

ncep[, mean(v.z*t.z), by = .(lat, lev, season(date))] %>% 
    ggplot(aes(lat, lev)) +
    geom_contour(aes(z = V1, color = ..level..)) +
    scale_color_divergent(breaks = MakeBreaks()) +
    scale_y_level() +
    scale_x_latitude(trans = "reverse") +
    facet_wrap(~season)

```

El ciclo anual de la amplitud de las ondas estacionarias se observa en \autoref{fig:sd-gh-ncep}, donde se muestra el desvío estándar de Z por círculo de latitud para cada mes \footnote{¿Explicar la relación de esto con la amplitud de la onda?}. La mayor amplitud se enuentra centrado al rededor de los 60°S, como ya se vio en la \autoref{fig:ghz-ncep} y alcanza su máximo entre agosto y octubre, y el mínimo entre febrero y abril, según el nivel. 

```{r sd-gh-ncep, fig.class = "textwidth", fig.cap = "Desvío estándar por círculo de latitud."}
binwidth <- 15
ncep.mean[lev %in% plot.levs & !(lev %in% c(50)), .(sd = sd(gh.z)), by = .(lat, lev, month)] %>% 
    ggplot(aes(month, lat)) +
    stat_contour(aes(z = sd, color = ..level..), binwidth = binwidth,
                 size = 0.3) +
    # geom_contour(aes(z = sd), binwidth = binwidth) +
    scale_color_viridis_c(name = "Desvío estándar de Z* por círculo de latitud",
                          breaks = MakeBreaks(binwidth),
                          guide = guide_colorstrip_bottom(inside = T)) +
    scale_y_latitude(name = "latitud") +
    scale_x_continuous(name = "mes", breaks = 1:12, labels = month.abb_sp, 
                       expand = c(0, 0)) +
    facet_wrap(~lev, scales = "free", labeller = labeller(lev = AddSuffix(" hPa")))
```

## Temperatura

```{r t-ncep, fig.class = "fullpage", fig.cap = "Temperatura media."}
binwidth <- 5
ggplot(ncep.mean.season[lev %in% c(plot.levs, 850)], aes(lon, lat)) +
    geom_contour(aes(z = t), binwidth = binwidth, color = "black") +
    geom_label_contour2(aes(z = t, label = ..level..), binwidth = binwidth) +
    geom_tile(data = pres[, lev := 850][pres < 850], fill = "white", color = "white") +
    map.SH +
    scale_s_map() +
    coord_quickmap() +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
```

En la tropósfera, la temperatura (\autoref{fig:t-ncep}) presenta una estructura zonal con mayor baroclinicidad en invierno. En 200 hPa los gradientes meridionales son mínimos y por encima de ese nivel éstos se revierten, dando lugar a tempearturas ecuatoriales menores que las polares (\autoref{fig:t-ncep-corte}). Por encima de 100 hPa de invierno y primavera, hay un máximo relativo en ~45° \footnote{¿Por qué?} y una región de anomalías zonales positivas que se ve claramente incluso en el campo total, particularmente en primavera. 

```{r tz-ncep-corte, fig.class = "textwidth", fig.cap = "Corte meridional de temperatura media."}
binwidth <- 5
ggplot(ncep.mean.season[, .(t = mean(t)), by = .(lat, lev, season)],
       aes(lat, lev)) +
    geom_contour_fine(aes(z = t, color = ..level..)) +
    surface +
    scale_y_level(breaks = plot.levs, minor_breaks = NULL) + 
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_color_viridis_c(name = "Temperatura media zonal", 
                          breaks = MakeBreaks(binwidth), 
                          guide = guide_colorstrip_bottom()) +
    facet_wrap(~season)
```


```{r tz-ncep, fig.class = "fullpage", fig.cap = "Anomalía zonal de temperatura."}
binwidth <- 1
ggplot(ncep.mean.season[lev %in% c(plot.levs, 850)], 
       aes(lon, lat)) +
    stat_contour_fill(aes(z = t.z), binwidth = binwidth, exclude = 0) +
    geom_tile(data = pres[, lev := 850][pres < 850], 
              fill = "white", color = "white") +
    # geom_hline(yintercept = cutlat, linetype = 2, size = 0.5) +
    map.SH +
    scale_fill_divergent(breaks = MakeBreaks(binwidth), 
                         limits = c(-9, NA),
                         name = "T*", 
                         guide = guide_colorstrip_bottom(25)) +
    scale_y_latitude() +
    scale_x_longitude() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap() 
```


Como se puede apreciar en el campo de T* (\autoref{fig:tz-ncep}), en invierno y primavera, los niveles altos están dominados por una onda 1 con máximo en el sur de Autralia y mínimo en el Atlántico sur. En niveles más bajos, la onda se defasa hacia el este y queda casi en cuadratura (\autoref{fig:tz-ncep-corte60}) con el máximo en 850hPa en Antártida occidental. 



En los trópicos, las anomlaías de temperatura presentan un patrón de onda 3 con máximos en los continentes y mínimos en los océanos que se revierten de signo en 100hPa. Estas características tienen su correlato en la altura geopotencial y corresponden a circulaciones tipo Walker \footnote{¿Es así?}. 

```{r tz-ncep-corte60, fig.class = "textwidth", fig.cap = "Corte zonal de anomalía de temperatura en -60°."}
binwidth <- 1
ggplot(ncep.mean.season[lat %~% cutlat], aes(lon, lev)) +
    stat_contour_fill(aes(z = t.z), binwidth = binwidth, exclude = 0) +
    scale_fill_divergent(binwidth = binwidth, exclude = 0, name = "T*",
                         guide = guide_colorstrip_bottom(width = 25)) +
    scale_y_level(breaks = plot.levs, minor_breaks = NULL) +
    scale_x_longitude(name = "longitud") +
    facet_wrap(~season)
```

Cosas para ver:   
Coincidencia entre la onda estacionaria 1 en gh y de t (en primavera). 

## Viento zonal

```{r u-ncep-corte, fig.class = "textwidth", fig.cap = "Viento zonal medio."}
ncep.mean.season[, .(u = mean(u)), by = .(lat, lev, season)] %>% 
    ggplot(aes(lat, lev)) +
    geom_contour_fill(aes(z = u), binwidth = 5) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = 15) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = 5, size = 0.1) +
    # geom_label_contour2(aes(z = u, color = ..level.., label = ..level..),
    # binwidth = 15, skip = 0) +
    surface +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_divergent(name = "U media zonal", 
                         breaks = MakeBreaks(5),
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season)
```

La estructura meridional del viento zonal (\autoref{fig:u-ncep-corte}) muestra la localización e intensidad de los jets subtropical y subpolar. El primero está presente durante todo el año aunque con mayor intensidad y corrido hacia latitudes más ecuatoriales en invierno y primavera. El segundo está presente principalmente en invierno y primavera, e incipiente en otoño. En la estratósfera se observan vientos del este en latitudes bajas que son más intensos en verano y otoño. 

```{r u-ncep, fig.class = "fullpage", fig.cap = "Viento zonal."}
ggplot(ncep.mean.season[lev %in% plot.levs], aes(lon, lat)) +
    geom_contour_fill(aes(z = u), binwidth = 5, exclude = 0) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = 5, size = 0.7) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = 5, size = 0.1) +
    # geom_contourlabel(aes(z = u, color = ..level..), binwidth = 15, step = 1,
    # size = 3, vjust = "inward", hjust = "inward") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(name = "U", breaks = MakeBreaks(5),
                         guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
```

En la \autoref{fig:u-ncep} se observa que el jet subpolar es más intenso al sur de África, donde además se encuentra en una latitud más ecuatorial que en la región del Pacífico. El jet subtropical también tiene un máximo al sur de África y otro al norte de Nueva Zelanda --especialmente en invierno--, donde además se produce una bifurcación del jet. Se trata de una región de persistentes y frecuentes bloqueos [@Trenberth1985] que se evidencia como anomalías zonales negativas durante todo el año (\autoref{fig:uz-ncep}).

Las anomalías zonales en la \autoref{fig:uz-ncep} también evidencian la circulación tropical forzada por la temperatura superficial del pacífico. Consistene con los campos de temperatura, en verano del pacífico central existen divergencias en niveles altos y convergencias en niveles bajos (no se muestra) que se traducen anomalías zonales positivas y negativas al este y al oeste de 180° respectivamente. 

```{r uz-ncep, fig.class = "fullpage", fig.cap = "Anomalía zonal de viento zonal."}
binwidth <- 2.5
ggplot(ncep.mean.season[lev %in% plot.levs], aes(lon, lat)) +
    stat_contour_fill(aes(z = u.z), binwidth = binwidth, exclude = 0) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth), name = "U*", 
                         guide = guide_colorstrip_bottom()) +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap()
```


## Viento meridional


```{r v-ncep-corte, fig.class = "textwidth", fig.cap = "Media zonal del viento meridional."}
binwidth <- 0.5
ggplot(ncep.mean.season[lev >= 30, .(v = mean(v)), by = .(lat, lev, season)],
       aes(lat, lev)) +
    stat_contour_fill(aes(z = v), binwidth = binwidth, exclude = 0) +
    surface + 
    scale_y_level(breaks = unique(ncep.mean.season$lev), minor_breaks = NULL) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_divergent(name = "V media zonal", 
                         breaks = MakeBreaks(binwidth, 0), 
                         guide = guide_colorstrip_bottom()) + 
    facet_wrap(~season)
```

En los campos medios zonales de viento meridional (\autoref{fig:v-ncep-corte}) se muestra claramente la circulación de Hadley. En verano, la rama ascendente de encuentra en el hemisferio sur y se tiene convergencias en niveles bajos y divergencias en niveles altos. En invierno, en cambio, sólo se ve la rama descendente, mucho más intensa que en verano, que genera convergencias en niveles altos y divergencias en niveles bajos al rededor de los 30°S. 

Presentes durante todo el año, los vientos de drenaje antárticos también son evidentes en la \autoref{fig:v-ncep-corte}. Estos vientos catabáticos son máximos en la costa del continente y alcanzan su máxima intensidad en invierno. 
```{r v-ncep, fig.class = "fullpage", fig.cap = "Viento meridional medio."}
binwidth <- 2
ggplot(ncep.mean.season[lev %in% c(850, plot.levs)], aes(lon, lat)) +
    geom_contour_fill(aes(z = v), binwidth = binwidth, exclude = 0) +
    # geom_contour(aes(z = v, color = ..level..), binwidth = 1, size = 0.1) +
    # geom_contourlabel(aes(z = v, color = ..level..), binwidth = binwidth, step = 1,
    # size = 3, vjust = "inward", hjust = "inward") +
    # geom_tile(aes(fill = v)) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(name = "V", breaks = MakeBreaks(1),
                         guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
```

Los campos horizontales de V se muestran en la \autoref{fig:v-ncep}. En invierno, existe evidencia de un tren de ondas de Rossby que se propaga desde el Índico occidental sudeste llegando a su máxima latutud en 150°O donde comienza a propagarse hacia el norte hasta llegar al sur de Sudamérica. Este tren de ondas puede identificarse con mayor dificultad en el campo de geopotencial (\autoref{fig:ghz-ncep}) debido a la interferencia de la onda 1. 

También en invierno, en los trópicos se puede observar el viento meridional hacia el norte en 850hPa en la costa oeste de África asociado al monzón de la India. El monzón sudamericano, por su parte, se evidenia por un aumento de la intensidad de los vientos del norte en verano sobre el continente americano. En altura, el monzón de la India se muestra como viento hacia el sur producto de la divergencia de niveles altos generada por la convección anómala. El sudamérica, la alta de Bolivia genera viento hacia el nort y hacia el sur al este y al oeste de Bolivia respectivamente. 

La anomalía zonal de V es prácticamente idéntica al campo total ya que la media zonal es casi nula en gran parte del dominio (\autoref{fig:v-ncep-corte}); por lo tanto, no se muestra. 

```{r ghminus1-ncep, fig.publish = FALSE, fig.cap = "Z* menos onda 1."}
ncep.mean.season %>% 
    .[, c("ampl", "phase") := FitQsWave(gh, k = 1)[1:2], 
      by = .(lat, lev, season)] %>%
    .[, qs1 := BuildQsField(lon*pi/180, ampl, phase, k = 1), 
      by = .(lat, lev, season)] %>% 
    .[, gh.minus := gh.z - qs1] %>% 
    .[lev %in% plot.levs] %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = gh.minus)) +
    map.SH +
    scale_fill_divergent() +
    facet_grid(lev~season)
```


hasta acá

## Gradiente meridional de vorticidad absoluta

```{r calc-eta-ncep}
ncep.mean.season[, zeta := Vorticity(u + v ~ lon + lat, cyclical = TRUE,
                                     sphere = TRUE), 
                 by = .(lev, season)]
ncep.mean.season[, zeta.dy := Derivate(zeta ~ lon + lat, 
                                       cyclical = c(FALSE, FALSE),
                                       sphere = TRUE)[[2]],
                 by = .(lev, season)]

ncep.mean.season[, eta.dy := zeta.dy + f.dy(lat)]
ncep.mean.season <- ncep.mean.season
```

```{r etady-ncep, fig.class = "fullpage", fig.cap = "Gradiente meridional de vorticidad absoluta."}
binwidth <- 1e-11
ggplot(ncep.mean.season[lev %in% plot.levs & lat > -85], aes(lon, lat)) +
    stat_contour_fill(aes(z = eta.dy), binwidth = binwidth) +
    stat_contour_fill(aes(z = eta.dy), breaks = 0, 
                      fill = "grey50", alpha = 0.5, complete = FALSE) +
    geom_contour_fine(aes(z = eta.dy), breaks = 0, color = "black") +
    # stat_contour(aes(z = eta.dy), breaks = 0, geom = "polygon",
    # fill = "grey50", alpha = 0.5) +
    map.SH +
    # polar.SH + 
    scale_fill_divergent(name = "Gradiente meridional de vorticiad absoluta", 
                         guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    scale_s_map() +
    coord_quickmap() +
    # coord_polar() + 
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab))
```

## Número de onda estacionaria

```{r ks-ncep, fig.cap = "Número de onda estacionario en 200hPa.", fig.height = 6}
a <- 6371000

ks <- ncep.mean.season[lev == 200, 
                       .(k = sqrt(eta.dy/u)*(a*cos(lat*pi/180))), 
                       by = .(lon, lat, lev, season)] 
ks[ , k.full := ifelse(is.na(k) | k > 10, -1, k)]

ggplot(ks, aes(lon, lat)) +
    geom_contour_fine(aes(z = k), breaks = 0:9, color = "black") +
    geom_label_contour2(aes(z = k, label = ..level..),
                        breaks = 0:9, skip = 0) +
    stat_filter(aes(filter = !is.finite(k)), geom = "tile", color = "gray50",
                fill = "gray50") +
    map.SH +
    scale_s_map() +
    scale_fill_viridis_c(breaks = 1:9, guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_wrap(~season)
```

```{r ks-ncep-corte, fig.class = "textwidth", fig.cap = "Número de onda estacionario medio por círculo de latitud."}
ggplot(ks[lon %~% 180], aes(lat, k)) +
    geom_line() +
    scale_y_continuous(name = "Número de onda estacionaria", breaks = 1:9,
                       limits = c(1, 9)) +
    scale_x_latitude(name = "Latitud", ticks = 15) +
    scale_color_brewer(palette = "Set1") +
    facet_wrap(~season) +
    coord_flip()
```

Cosas para ver:    
Máximos asociado con los flancos del jet. Zona "prohibida" en 200 y 300 hPa.    
La onda 3 es estacionaria en -60°.

## Función corriente


```{r read-psi}
stream <- ReadNetCDF("DATA/NCEP/stream.mon.mean.nc") %>% 
    setnames("level", "lev") %>% 
    .[lat <= 40]
stream[, psi.z := Anomaly(psi), by = .(lat, date)]
stream[, date := as.Date(date), by = date]
stream.mean.season <- stream[, .(psi = mean(psi),
                                 psi.z = mean(psi.z)), 
                             by = .(lon, lat, lev, season(date))]

stream.mean.season[, c("f.lon", "f.lat") := WaveFlux(.SD), by = season]
```


```{r psi-ncep,  fig.class = "fullpage", fig.cap = "Función corriente x 1099"}
ggplot(stream.mean.season, aes(lon, lat)) +
    stat_contour_fill(aes(z = psi.z*10^-9), binwidth = 0.005, 
                      complete = FALSE, exclude = 0) +
    geom_contour_fine(aes(z = psi*10^(-9)), color = "black", binwidth = 0.02) +
    geom_vector(aes(dx = f.lon, dy = f.lat), skip = 3, min.mag = 0.05, 
                scale = 50) +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(breaks = MakeBreaks(0.005, 0), 
                         guide = guide_colorstrip_bottom(15)) +
    facet_wrap(~season, ncol = 2) +
    theme(axis.title = element_blank()) + 
    coord_quickmap()
```

## Ondas Quasiestacionarias

* Fourier

```{r r2-ncep, fig.class = "fullpage", fig.cap = "$R^2$ de Fourier."}
binwidth <- 0.1

rect.annotation <- data.frame(latmin = -65, latmax = -40,
                              levmin = 100, levmax = 700, 
                              k = 3)

r2.mean <- ncep.qs[, .(r2 = mean(r2)), 
                   by = .(lat, lev, k, season(month(date)))]

r2.diff <- r2.mean[, .(r2.ratio = r2[k == 3]/r2[k == 1]), 
                   by = .(lat, lev, season)]
r2.diff <- rbind(r2.diff[, k := 1], copy(r2.diff)[, k := 3])


ggplot(r2.mean, aes(lat, lev)) +
    stat_contour_fill(aes(z = r2), binwidth = binwidth) +
    stat_contour_fill(aes(z = r2.ratio), data = r2.diff, breaks = 1, 
                      color = "black", size = 0.5, complete = F,
                      fill = "gray20", alpha = 0.2) +
    surface +
    # geom_rect(aes(xmin = latmin, xmax = latmax, ymin = levmin, ymax = levmax),
    #           data = rect.annotation, inherit.aes = F,
    #           fill = NA, color = "black", size = 0.4) +
    geom_index.region(rect.annotation) +
    scale_fill_viridis_c(name = expression(R^2), limits = c(0, 1),
                         breaks = MakeBreaks(binwidth), 
                         guide = guide_colorstrip_bottom(),
                         option = "D") +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse", 
                     ticks = 15) +
    facet_grid(k ~ season, labeller = labeller(k = qs.lab))
```

Cosas para ver:    
Estructura. Zona donde onda 3 explica más que la onda 1 (zona marcada en negro) 

```{r ampl-ncep, fig.class = "fullpage", fig.cap = "Ampllitud de Fourier."}

ampl.mean <- ncep.qs[, .(amplitude = mean(amplitude)), 
                     by = .(lat, lev, k, season(month(date)))]
breaks <- 2^seq(0, log2(650), by = 0.5)
ggplot(ampl.mean, aes(lat, lev)) +
    stat_contour_fill(aes(z = amplitude), 
                      breaks = breaks) +
    surface +
    geom_index.region(rect.annotation) +
    scale_fill_viridis_c(name = "Amplitud (escala logarítmica)", trans = "log2",
                         breaks = breaks,
                         labels = round(breaks, 1),
                         guide = guide_colorstrip_bottom(),
                         option = "D") +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse", 
                     ticks = 15) +
    facet_grid(k ~ season, labeller = labeller(k = qs.lab))
```

Cosas para ver:    
Onda 1 y 2 principalmente en estratósfera pero baja, salvo en verano. Onda 3 y 4 más de atmósfera media/alta. Región recuadrada: máximo de amplitud de QS 3 y donde su R2 es mayor que la de QS 1.

# Onda 3

## Características típicas

```{r calc-qs3-ncep}
lons <- unique(ncep$lon)
qs.wave <- ncep.qs[k == 3, .(lon = lons, 
                             QS3 = amplitude*cos(3*(lons*pi/180 - phase))),
                   by = .(lat, lev, date)]
qs.wave.season <- qs.wave[, .(mean = mean(QS3),
                              sd = sd(QS3)), 
                          by = .(lon, lat, lev, season(date))]
```

```{r qs3-ncep, fig.class = "pagewidth", fig.cap = "Media de reconstrucción de onda 3.", fig.height = 6}
binwidth <- 10
cutlat <- data.frame(lat = c(-52.5, rep(NA, 3)), 
                     season = c("Verano", "Invierno", "Otoño", "Primavera"))
ggplot(qs.wave.season[lev == 300], aes(lon, lat)) +
    stat_contour(aes(z = mean, color = ..level..), binwidth = binwidth) +
    geom_hline(data = cutlat, aes(yintercept = lat),
               linetype = 2, size = 0.3, color = "gray50") +
    map.SH +
    scale_s_map() +
    scale_color_divergent(binwidth = binwidth, name = "QS3", exclude = 0,
                          guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) +
    coord_quickmap()
```

Cosas para ver:   
Solo en 300 porque la estructura es barotrópica (no se gana mucho mirando varios niveles). Localización de los centros de altas y bajas. Corrimiento de fase verano/invierno. Aparente ciclo anual con mínimo en primavera, que luego se ve que no es tan así, parece mínimo porque la fase varía mucho y el promedio se desdibuja mucho. 

Esto es el promedio de las ondas 3, pero es idéntico a la onda 3 del promedio. 


```{r qs3-ncep-corte, fig.class = "pagewidth", fig.cap = "Corte", fig.height = 4}
ggplot(qs.wave.season[lat %~% cutlat$lat[1]], aes(lon, lev)) +
    # stat_contour_fill(aes(z = sd), binwidth = 10) +
    stat_contour(aes(z = mean, color = ..level..), binwidth = binwidth) +
    scale_y_level(breaks = plot.levs) +
    scale_x_longitude(name = "longitud") +
    scale_color_divergent(binwidth = binwidth, name = "QS3", exclude = 0,
                          guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) 
```

Cosas para ver:    
Estrucutra vertical barotrópica equivalente. Ciclo anual en la extensión vertical (se ve también en los cortes de amplitud). Aunque notar que en este corte la extensión en primavera parece la menor, pero de nuevo es por la variabilidad en la fase, ya que en el corte de amplitud se ve que la amplitud es mayor en altura incluso que en otoño. 

```{r qs3sd-ncep, fig.class = "pagewidth", fig.cap = "Desvío estándar de la reconstrucción de QS3.",  fig.height = 6}
binwidth <- 5
# cutlat <- -52.5
ggplot(qs.wave.season[lev == 300], aes(lon, lat)) +
    stat_contour(aes(z = mean), breaks = c(1, -1)*20, color = "black", 
                 size = 0.5) +
    stat_contour(aes(z = sd, color = ..level..), binwidth = binwidth) +
    map.SH +
    scale_s_map() +
    scale_color_viridis_c(name = "Desvío estándar de QS3", 
                          guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) +
    coord_quickmap()
```


No tengo idea de cómo interpretar esto...



* Wavelets

```{r calc-wavelet}
file.wavelet <- "DATA/ncep.wv.Rds"
ncep.wv <- cache.file(file.wavelet, {
    ncep[,  .(lon = lon, gh.z = gh.z,
              amplitude = unlist(PeriodicWavelet(gh, 3))),
         by = .(lat, lev, date)]
})
```

La amplitud media obtenida mediante wavelets es virtualmente idéntica 

```{r wavelet-fourier-ncep, fig.class = "textwidth", fig.cap = "Amplitud de wavelets (sombreados) y de fourier (contornos)"}
binwidth <- 15
ncep.wv.mean <- ncep.wv[, .(amplitude = mean(amplitude)), 
                        by = .(lat, lev, season(month(date)))]

ggplot(ncep.wv.mean, aes(lat, lev)) +
    stat_contour_fill(aes(z = amplitude), binwidth = 15) +
    geom_contour_fine(data = ampl.mean[k == 3], 
                      aes(z = amplitude),
                      binwidth = binwidth, color = "black") +
    geom_text_contour(data = ampl.mean[k == 3], 
                      aes(z = amplitude, label = ..level..),
                      binwidth = binwidth) +
    scale_fill_viridis_c(name = expression(R^2), breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_color_viridis() +
    scale_y_level() +
    scale_x_latitude(trans = "reverse") +
    surface +
    facet_wrap(~season)
```

```{r waveletz-ncep, fig.class = "fullpage", fig.cap = "Campo medio de la amplitud de la onda 3 según wavelets (contornos) y su anomalía zonal (sombreado) en 300hPa."}
ncep.wv.mean <- ncep.wv[, .(amplitude = mean(amplitude)), 
                        by = .(lat, lon, lev, season(month(date)))]
ncep.wv.mean[, amplitude.z := Anomaly(amplitude), 
             by = .(lat, lev, season)]

ggplot(ncep.wv.mean[lev == 300], aes(lon, lat)) +
    geom_contour_fill(aes(z = amplitude.z), binwidth = 1, 
                      exclude = 0) +
    geom_contour_fine(aes(z = amplitude), binwidth = 10,
                      color = "black") +
    stat_contour(aes(z = mean), breaks = c(1, -1)*20, color = "black", 
                 size = 0.5, data = qs.wave.season[lev == 300]) +
    # geom_text_contour(aes(z = amplitude, label = ..level..), binwidth = 10, 
    # color = "black") +
    geom_label_contour2(aes(z = amplitude, label = ..level..), binwidth = 10, 
                        color = "black") +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(name = "Anomalía de ampltiud wavelets",
                         breaks = MakeBreaks(1),
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) +
    coord_quickmap()
```

Cosas para ver:    
* La amplitud de la onda 3 es bastante zonal, pero tiene asimetrías consistentes. En ~60°S, la máxima amplitude se da en el hemisferio oeste, mientras que en ~50°S se da en el hemisferio este. 

```{r wavelet-ncep-corte, fig.class = "fullpage", fig.cap = "Corte zonal en -60° de la amplitud media de la onda 3 según wavelets (contornos) y su anomalía zonal (sombreado)."}
ggplot(ncep.wv.mean[lat %~% -60], aes(lon, lev)) +
    geom_contour_fill(aes(z = amplitude.z), binwidth = 2, exclude = 0) +
    geom_contour_fine(aes(z = amplitude), color = "black", 
                      binwidth = 5) +
    geom_label_contour2(aes(z = amplitude, label = ..level..), 
                        binwidth = 5) +
    scale_y_level(breaks = plot.levs) +
    scale_x_longitude() +
    scale_fill_divergent(name = "Anomalía de amplitud wavelets",
                         breaks = MakeBreaks(2),
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) 
```

Cosas para ver:    
* Si bien el máximo medio de la amplitud se da en ~300hPa (Fig \autoref{fig:wavelet_fourier_comp}) igual que en fourier, el análisis por longitud muestra algo un poco más complejo. En verano y otoño, la máxima amplitud sigue en 300hPa, pero ésta asciente a entre 100 y 50hPa en invierno y primavera al rederor de 120°O. Además, durante estas estaciones hay indicación de que el máximo cambia de latitud con la altura. 

```{r cleanup1}
remove(ncep.wv, ncep.wv.mean)
```

Venajas y desventajas. Justificaicón de decisión. 


## Antecedentes 

Breve comentario sobre los índices usados en otros lados. Discutir ventajas y debilidades.

* Amplitud
* Fase (impacto en SA) 

De todo eso, motiva decisión del índice.

* Niveles elegidos
* Promedio vs. máximo
* Composiciones de campos y flujos.
* Decisión del índice. 

Quiero hacer el íncide a partir de la actividad de la onda 3 tomando la región del máximo (latitud entre -65 y -40, y entre 700 y 100 hPa). Variables posibles: amplitud media, amplitud máxima, r2, correlación entre campo teórico y observado.

## Amplitud

### Máximo o media. 

```{r calc-indice-ncep}
lats.index <- c(-65, -40)
levs.index <- c(100, 700)
ncep.qs <- ncep.qs[, index.region := (lev %b% levs.index) & (lat %b% lats.index)]

index <- ncep.qs[index.region == TRUE & k == 3, 
                 .(amplitude   = mean(amplitude),
                   m.amplitude = max(amplitude),
                   r2          = mean(r2),
                   phase       = mean(phase),
                   phase.mode  = mode(phase),
                   lat         = lat[which.max(amplitude)],
                   lon         = phase[which.max(amplitude)]*180/pi,
                   lev         = lev[which.max(amplitude)]),
                 by = date]
index <- ncep.qs[index.region == TRUE & k == 3] %>% 
    group_by(date) %>% 
    filter(abs(phase - mode(phase)) < 5*pi/180) %>% 
    setDT(.) %>% 
    .[, .(lat.mode = lat[which.max(amplitude)]), by = date] %>% 
    index[., on = "date"]

fields <- ncep[lev %b% levs.index, .(lon, lat, date, lev, gh, gh.z)][
    qs.wave[lev %b% levs.index], on = c("lat", "lon", "date", "lev")]
cor.index <- fields[, .(cor = cor(gh.z, QS3)^2), by = .(date)]
index <- index[cor.index, on = "date"]
```



```{r ampl-max-mean, fig.cap = "Distribució de amplitud para 12 fechas. En rojo la amplitud máxima, en azul la amplitud media.", fig.height = 4, fig.class = "pagewidth"}
set.seed(44)
select.dates <- sample(ncep.qs$date, 12)
gdata <- ncep.qs[k == 3 & date %in% select.dates]
ggplot(gdata[index.region == TRUE], aes(amplitude)) + 
    # geom_density() +
    geom_vline(aes(xintercept = m.amplitude), color = "red", size = 0.4,
               data = index[date %in% select.dates]) +
    geom_vline(aes(xintercept = amplitude), color = "blue",
               data = index[date %in% select.dates]) +
    geom_step(stat = "bin", binwidth = 5, boundary = 0) +
    geom_rug() +
    scale_x_continuous() +
    facet_wrap(~date)
```

```{r ampl-max-mean-corte, fig.cap = "Corte vertical de amplitud", fig.class = "pagewidth", fig.height = 4}
M <- max(index[date %in% select.dates, m.amplitude])
binwidth <- 15
ggplot(gdata, aes(lat, lev)) + 
    stat_contour_fill(aes(z = amplitude), binwidth = binwidth) +
    geom_index.region(rect.annotation) +
    geom_segment(data = index[date %in% select.dates], inherit.aes = F,
                 size = 1, color = "red", 
                 aes(x = -90, xend = -90, y = 1000, 
                     yend = 10^(-2/M*m.amplitude + 3))) +
    geom_segment(data = index[date %in% select.dates], inherit.aes = F,
                 size = 1, color = "blue", 
                 aes(x = -90, xend = -90, y = 1000, 
                     yend = 10^(-2/M*amplitude + 3))) +
    surface +
    scale_y_level(name = "nivel", 
                  sec.axis = sec_axis(~-M/2*(log10(.) - 3), name = "amplitud")) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_viridis_c(guide = guide_colorstrip_bottom(15)) +
    facet_wrap(~date)
```

Cosas para ver:   
Casos donde el máximo es mayor pero la media, menor. (1985-01-01 vs 1988-07-01 o ). 1987-11-01 vs 2008-01-01 muestra el caso: igual amplitud máxima pero en 2008 está más "concentrada". 
Casos donde la actividad está ligeramente fuera de la caja (2000-09-01). 

```{r ghz-ncep-select, fig.cap = "Anomalía zonal geopotencial en 300hPa para fechas seleccionadas.", fig.class = "pagewidth", fig.height = 6}
ggplot(ncep[date %in% select.dates & lev == 300], aes(lon, lat)) +
    stat_contour_fill(aes(z = gh.z), binwidth = 50) +
    map.SH + 
    scale_s_map() +
    scale_fill_divergent(guide = guide_colorstrip_bottom(15)) +
    coord_quickmap() +
    facet_wrap(~date) +
    theme(axis.title = element_blank()) 
```

Cosas para ver:    
Analizar nivel de similitud entre los campos y similitud entre la estructura de la ampltiud.


```{r cor-mean-max, fig.cap = "Correlación entre amplitud máxima y media."}
r2.ampl <- index[, cor(m.amplitude, amplitude)]^2
ggplot(index, aes(m.amplitude, amplitude)) +
    geom_point(size = 0.5, alpha = 0.5) +
    geom_smooth(color = "black", size = 0.7) +
    geom_abline(linetype = 3) +
    annotate(geom = "text", x = 50, y = 100, 
             label = paste0("r2 = ", round(r2.ampl, 2))) +
    scale_y_continuous(name = "Amplitud media", breaks = MakeBreaks(25)) +
    scale_x_continuous(name = "Amplitud máxima", breaks = MakeBreaks(25)) +
    coord_equal()
```

Cosas para ver:    
Relación lineal entre ambas. Ergo, da más o menso igual usar cualquiera. 

Luego... concluir que vamos a usar la media. 

```{r cleanup2}
index[, m.amplitude := NULL]
```

```{r ampl-ts, fig.class = "pagewidth", fig.cap = "Amplitud media", fig.subcap = c("Serie temporal", "Ciclo anual"), cache = FALSE, fig.height = 4, fig.show = "hold", fig.ncol = 1}
g <- ggplot(index, aes(date, amplitude)) +
    geom_line() +
    geom_hline(yintercept = mean(index$amplitude), linetype = 3) +
    scale_x_date(date_breaks = "1 years", expand = c(0, 0), date_labels = "%C")
DivideTimeseries(g, index$date, n = 3, xlab = "Fecha", ylab = "Amplitud")

ggplot(index, aes(factor(month(date)), amplitude)) +
    geom_boxplot() +
    scale_x_discrete(name = "Mes", labels = month.abb_sp) +
    scale_y_continuous(name = "Amplitud")
```

## Fase

Además de eso, tengo la fase. Puedo tomar la fase media en la región o la fase correspondiente a donde está el máximo de la amplitud (lo que equivale al centro del anticiclón) o la moda de la fase. 

(más explicación...)

¿Cuál usar? 

```{r lon-phase, fig.cap = "Fase promedio vs Fase del máximo", fig.class = "textwidth"}

dates <- c(as.Date("2013-06-01"),
           index[, date[which.max(abs(lon - phase*180/pi))]],
           index[, date[which.min(abs(lon - phase*180/pi))]])
ggplot(index, aes(lon, phase*180/pi)) +
    geom_point(size = 0.5) +
    geom_point(data = index[date %in% dates], size = 3, 
               shape = 21, fill = NA, color = "red") +
    geom_abline(linetype = 3) +
    scale_x_continuous(name = "Fase de amplitud máxima") +
    scale_y_continuous(name = "Fase promedio") +
    coord_fixed() 
```

Cosas para ver:   
Se ve que hay muchos casos donde coinciden bastante bien, pero otros que se alejan mucho. La razón es que al tomar el promedio, puede quedar cualquier cosa si la estructura cambia mucho con la latitud. Por ejemplo, los casos marcados en rojo.


```{r fase-mal, fig.cap = "Campo de onda 3 reconstruido para junio de 2013. El punto rojo es la fase en la latitud de amplitud máxima; el punto negro, la fase promedio; el punto azul, la moda de la fase. El rectángulo la región donde puede encontrarse la fase. Los límites meridionales definidos por la región donde se calcula el índice y los zonales por 360/3.", fig.height = 6}
ggplot(fields[lev == 300 & date %in% dates], 
       aes(lon, lat)) +
    stat_contour_fill(aes(z = QS3), exclude = 0, complete = F, binwidth = 10) +
    geom_point(data = index[date %in% dates], aes(x = lon),
               color = "red") +
    geom_point(data = index[date %in% dates], 
               aes(x = phase*180/pi)) +
    geom_point(data = index[date %in% dates],
               aes(x = phase.mode*180/pi, y = lat.mode), 
               color = "blue") +
    annotate(geom = "rect", xmin = 0, xmax = 120, 
             ymin = rect.annotation$latmin, ymax = rect.annotation$latmax,
             fill = NA, linetype = 3, color = "black") +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(breaks = MakeBreaks(10),
                         guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_wrap(~date, ncol = 1)
```

En el primer caso el máximo de geopotencial se encuentra cercano a 0° lo que hace que la fase oscile entre valores cercanos a 0° y a 120° en distintas latitudes a pesar de que representan el mismo centro de máxima. El promedio, por lo tanto, queda en el centro y termina estando en una región donde el campo de geopotencial de onda 3 es nulo. Si bien la fase de la amplitud máxima y la moda de la fase parecen ser muy distintas, la naturaleza cíclica de la fase implica que representan aproximadamente el mismo punto. 

En tercer caso la estructura de onda 3 es de dos centros a distintas latitudes. La fase promedio de ambas (punto negro) representa el punto medio y, por lo tanto, está más cerca del mínimo de geopotencial que del máximo. En este caso la moda de la fase es una mejor representación del campo de onda 3 que la fase del máximo. 

En el caso del medio, todo anda bien y los tres puntos coinciden. 

Conclusión: vamos a usar la moda de la fase. 


```{r cleanup3}
index <- index[, c("lon", "phase", "lat") := NULL]
setnames(index, c("phase.mode", "lat.mode"), c("phase", "lat"))
```

Ciclo anual de la fase. 

```{r fase-boxplot, fig.cap = "Ciclo anual de la fase (20 mayores amplitudes para cada mes)"}
lat.lims <- c(-70, -22)
lon.lims <- c(230, 360)
map.arg <- geom_map2(BuildMap(countries = T)[lat %b% lat.lims & 
                                                 long %b% lon.lims])
index %>% 
    group_by(month = month(date)) %>% 
    filter(greater(amplitude, 20)) %>% 
    ggplot() +
    map.arg + 
    ggstance::geom_boxploth(aes(phase*180/pi + 240, 
                                (-month(date) + 6)*2.4 - 45, 
                                group = as.factor(month(date)))) +
    annotate(geom = "text", x = rep(237, 12), y = (-(1:12) + 6)*2.4 - 45, 
             label = month.abb_sp, size = 3, hjust = 1) +
    geom_vline(xintercept = c(240, 360), linetype = 3) +
    # map.SH.3 +
    scale_x_longitude(ticks = 20) +
    scale_y_latitude(ticks = 10) +
    ylab("lat") +
    # coord_quickmap(xlim = lon.lims, ylim = lat.lims) +
    coord_map(projection = "mollweide", xlim = lon.lims, ylim = lat.lims)
```

Cosas para ver:    
Se ve el ciclo anual que ya se veía en una figura anterior. Pero hay mucha variabilidad.    
Recordar que este es aproximadamente el centro del máximo de geopotencial y que, por construcción, hay un centro de mínima a 60°. Eso implica que en los casos donde hay puntos cerca de -120° o 0°, hay el centro de mínima está en ~-60°.    
También notar que, como se trata en realidad de una variable cíclica, los puntos extremos representan una situación similar.     
¿Hay mucha diferencia entre el boxplot con todos los datos y el de sólo los 20 más intensos? Yo no veo mucha y me parece que excluir a los 10 más débiles invita más preguntas que las que responde. 

```{r centros-10max, fig.cap = "Centros de máxima (puntos rojos) y mínima (puntos azules) para los 10 años con mayor amplitud de la onda 3, para cada mes.", fig.class = "fullpage"}
library(scales)
index[index[, .I[greater(amplitude, 10)], by = month(date)]$V1] %>%
    mutate(month = month(date)) %>% 
    ggplot(aes(phase*180/pi + 240, lat)) +
    # geom_segment(aes(xend = ifelse(phase*180/pi > 60, 
    #                                phase*180/pi + 240 - 60, 
    #                                phase*180/pi + 60 + 240), 
    #                  yend = lat)) +
    geom_point(color = muted("red")) +
    geom_point(aes(x = phase*180/pi + 240 - 60), color = muted("blue")) +
    geom_point(aes(x = phase*180/pi + 240 + 60), color = muted("blue")) +
    map.arg +
    annotate(geom = "rect", xmin = 240, xmax = 360, 
             ymin = rect.annotation$latmin, ymax = rect.annotation$latmax,
             fill = NA, linetype = 3, color = "black") +
    # map.SH.3 +
    scale_x_longitude(ticks = 20, limits = c(240, 360)) +
    scale_y_latitude(ticks = 10) +
    ylab("lat") +
    # coord_quickmap(xlim = lon.lims, ylim = lat.lims) +
    coord_map(projection = "mollweide", xlim = lon.lims, ylim = lat.lims) +
    facet_wrap(~month, ncol = 4, labeller = labeller(month = month.abb_sp))
```

Cosas para ver:    
La mayoría del tiempo estamos afectados por centro de máxima, pero hay casos intensos donde hay mínima. Especialmente en junio y julio. 

## Estaciones


¿Cómo establecer una "estacionalidad"? Algún criterio para agrupar meses. Claramente las estaciones climatológicas de siempre no sirven. 

Una forma es, a partir del índice, agrupar los meses según su amplitud y fase media:

```{r ampl-vs-fase, fig.cap = "Amplitud y fase media para cada mes."}
index[, .(amplitude = mean(amplitude), 
          phase = mean(phase)),
      by = month(date)] %>% 
    ggplot(aes(phase, amplitude)) +
    ggforce::geom_link2(aes(color = qs.season(month), group = 1),
                        alpha = 0.5) +
    # geom_path(alpha = 0.5, aes(color = qs.season(month), group = 1)) +
    geom_point(aes(color = qs.season(month))) +
    ggrepel::geom_text_repel(aes(label = month.abb_sp[month]))  +
    scale_y_continuous(name = "Amplitud") +
    scale_x_continuous(name = "Fase")
# coord_polar(theta = "y", start = -180*pi/180)
```

Otro ejemplo podría usar SVD:

```{r eof, fig.cap = "Análisis SVD de QS3.probablemente basura", fig.ncol = 1, fig.show = "hold", fig.subcap = c("Varianza explicada de cada componente", "Campo asociado a las primeras 2 componentes", "Factor de peso para cada mes")}
qs.eof.full <- EOF(fields[lev == 300], lon + lat ~ date, value.var = "QS3", 
                   n = 1:10)

qs.eof <- EOF(fields[lev == 300], lon + lat ~ date, value.var = "QS3", n = 1:2)

ggplot(qs.eof.full$sdev, aes(PC, r.squared)) +
    geom_point() +
    scale_x_continuous(breaks = 1:10) 

ggplot(qs.eof$left, aes(lon, lat)) + 
    stat_contour(aes(z = -value, color = ..level..)) +
    map.SH +
    scale_color_divergent() +
    facet_wrap(~PC)

ggplot(qs.eof$right, aes(month(date), -value)) +
    geom_boxplot(aes(color =  paste0("PC", PC), 
                     group = interaction(PC, month(date)))) +
    annotate("errorbarh", y = 0.15, height = 0.01, alpha = 0.5,
             xmin = c(-1, 4, 6, 8, 12) - 0.4, 
             xmax = c(3, 5, 7, 11, 14) + 0.3, 
             color = 1) +
    scale_x_continuous(name = "Mes", breaks = 1:12, labels = month.abb_sp) +
    scale_y_continuous(name = "PC") +
    coord_cartesian(xlim = c(1, 12))
```

```{r eof1-eof2, fig.cap = "'Magnitud' y 'Fase' de cada mes a partir de las componentes principales"}
dcast(qs.eof$right, ... ~ paste0("PC", PC)) %>% 
    .[, .(dif = mean(PC2 - PC1), mag = mean(sqrt(PC2^2 + PC2^2))),
      by = .(month(date))] %>% 
    ggplot(aes(dif, mag)) +
    ggforce::geom_link2(aes(color = qs.season(month), group = 1),
                        alpha = 0.5) +
    geom_point(aes(color = qs.season(month))) +
    ggrepel::geom_text_repel(aes(label = month.abb_sp[month]))  +
    scale_x_continuous(name = "PC2 - PC1") +
    scale_y_continuous(name = "sqrt(PC1^2 + PC2^2)")
```

Cosas para ver:    
Los campos son descriptos bien por sólo 2 componentes principales de igual magnitud que esencialmente describen el corrimiento de fase de la onda. La "magnitud" del vector de componentes mapea bien a la amplitud de fourier y la diferencia mapea bien a la fasae. 
No hay nada nuevo por acá. 


Grupos:
* Enero + Febrero + Marzo es un grupo bastante seguro. Se ven juntos en el diagrama amplitud-fase, tienne alta correlación entre ellos y en componentes principales tienen PC1 significativamente mayor que PC2. 
* Junio + Julio parecen ir por su cuenta. Tienen mucha correlación entre ellos y ambos tienen PC2 mayor que PC1 aunque su fase difiere bastante. 

Los otros meses quedan medio mezclados, pero pueden agruparse como meses de "transición". 

## Persistencia (ver dónde va)

```{r lag-cor, fig.cap = "Correlación lageada para cada mes con los 12 sigientes."}
lags <- 0:12
qs.croscor <- copy(qs.wave[lev == 300]) %>%
    .[, (paste0("l", lags)) := shift(QS3, lags, type = "lead"), 
      by = .(lat, lon)] %>% 
    .[, lapply(lags, function(l) cor(.SD$l0, .SD[[paste0("l", l)]], 
                                     use = "complete.obs")), 
      by = month(date)] %>% 
    set_colnames(c("month", 0:12)) %>% 
    melt(id.vars = "month", variable.name = "lag", value.name = "cor") %>% 
    .[, lag := as.numeric(as.character(lag))] %>% 
    .[, month2 := ifelse2(month + lag, x > 12, x - 12)]

ggplot(qs.croscor[lag != 0], aes(month2, month)) +
    # annotate("ribbon", x = c(0.5, rep(1:12 + 0.5, each = 2)),
    #          ymin = c(0, 0, rep(1:11, each = 2) + 0.5, 12),
    #          ymax = 13, 
    #          fill = "gray80", alpha = 0.2) +
    # geom_point(aes(size = abs(cor), color = cor)) +
    geom_tile(aes(fill = cor)) +
    geom_text(aes(label = round(cor*10, 1))) +
    annotate("step", x = 2:13 - 0.5, y = 1:12 - 0.5, direction = "vh",
             color = "gray20", linetype = 1) +
    # points(seq(0.1, 0.5, by = 0.1)) +
    scale_size() +
    scale_y_continuous(name = "Mes", expand = c(0, 0), trans = "reverse", 
                       breaks = 1:12, labels = month.abb_sp) +
    scale_x_continuous(name = "Mes siguiente", expand = c(0, 0),
                       breaks = 1:12, labels = month.abb_sp) +
    scale_fill_divergent(breaks = MakeBreaks(0.1), 
                         guide = "none")
```

## R2

Se puede estimar de dos maneras distintas: a partir del ajuste de fourier para cada nivel y latitud (figura blabla) y haciendo un promedio, o reconstruyendo el campo tridimensional de la onda 3 y haciendo la correlación (global) con el campo tridimensional observado. Esta segunda forma da casi siempre un valor menor. 

```{r r2-cor2, fig.cap = "Relación entre R2 medio y R2 reconstruido."}
r2.cor <- index[, cor(cor, r2)]^2
ggplot(index, aes(r2, cor)) +
    geom_point(size = 0.5, alpha = 0.5) +
    geom_smooth(color = "black", size = 0.7) + 
    # geom_smooth(method = "lm", data = index[r2 < 0.4]) +
    # geom_smooth(method = "lm", data = index[r2 >= 0.4]) +
    geom_abline(linetype = 3) +
    annotate(geom = "text", x = 0.5, y = 0.2, 
             label = paste0("r2 = ", round(r2.cor, 2))) +
    scale_y_continuous(name = "R2 reconstrucción", breaks = MakeBreaks(0.1)) +
    scale_x_continuous(name = "R2 medio", breaks = MakeBreaks(0.1)) +
    coord_equal()
```

Para ver:    
La relación ya no es lineal y hay bastante más scatter. Ergo, hay diferencia en la información.     
Dos regímenes: Cuando el R^2 es bajo, la relación es "menor" que 1:1 y hay algunos casos donde el R2 reconstruido es mayor que el r2 medio. Para R2 más grandes, la pendiente es 1. Modelar la relación... ¿Cómo se interpreta?


```{r r2-corte, fig.cap = "R2 medio", fig.height = 4, fig.class = "pagewidth"}
M <- max(index[date %in% select.dates, r2])
binwidth <- 0.1
ggplot(gdata, aes(lat, lev)) + 
    stat_contour_fill(aes(z = r2), binwidth = binwidth) +
    geom_index.region(rect.annotation) +
    surface +
    geom_segment(data = index[date %in% select.dates], inherit.aes = F,
                 size = 1, color = "red", 
                 aes(x = -90, xend = -90, y = 1000, 
                     yend = 10^(-2/M*r2 + 3))) +
    geom_segment(data = index[date %in% select.dates], inherit.aes = F,
                 size = 1, color = "blue", 
                 aes(x = -90, xend = -90, y = 1000, 
                     yend = 10^(-2/M*(cor) + 3))) +
    scale_y_level(name = "nivel", 
                  sec.axis = sec_axis(~-M/2*(log10(.) - 3), name = "R^2")) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_viridis_c(guide = guide_colorstrip_bottom(15)) +
    facet_wrap(~date)
```

Cosas para ver:    
Comparando con las figuras anteriores, casos donde la amplitud es grande pero el R2 no tanto. 

```{r r2-ts, fig.class = "pagewidth", fig.cap = "R2 medio", fig.subcap = c("Serie temporal", "Ciclo anual"), cache = FALSE, fig.height = 4, fig.show = "hold", fig.ncol = 1}
gdata <- melt(index, id.vars = "date", measure.vars = c("r2", "cor"), 
              variable.name = "tipo", value.name = "r2" )
g <- ggplot(gdata, aes(date, r2)) +
    geom_line(aes(color = tipo)) +
    geom_hline(data = gdata[, .(m = mean(r2)), by = tipo],
               aes(yintercept = m, color = tipo), linetype = 3) +
    scale_x_date(date_breaks = "1 years", expand = c(0, 0), date_labels = "%C") +
    scale_color_brewer(palette = "Set1")
DivideTimeseries(g, index$date, n = 3, xlab = "Fecha", ylab = "R2")

ggplot(gdata, aes(factor(month(date)), r2, color = tipo)) +
    geom_boxplot() +
    scale_x_discrete(name = "Mes", labels = month.abb_sp) +
    scale_y_continuous(name = "R2") +
    scale_color_brewer(palette = "Set1")
```

Cosas para ver:    
El ciclo anual no es para nada tan claro. Varios outliers. La correlación reconstruida (azul) no tiene casi ciclo anual. 


Una ventaja de la correlación entre el campo real y el reconstruido es que puede hacerse para cada punto y analizar la variación espacial de la misma. 


```{r cor-campo, fig.cap = "Correlación cuadrada media para estaciones según onda3."}
cor.months <- fields[lat > -90 & lev == 300, 
                     .(corelation = cor(gh, QS3)), 
                     by = .(lon, lat, month(date))][
                         , cor.w := corelation*sqrt(cos(lat*pi/180))]

binwidth <- 0.15
ggplot(cor.months[, .(cor = mean(corelation^2)), 
                  by = .(lon, lat, season = qs.season(month))], 
       aes(lon, lat)) +
    stat_contour(aes(z = cor, color = ..level..), binwidth = binwidth) +
    map.SH +
    scale_color_viridis_c(breaks = MakeBreaks(binwidth),
                          limits = c(0, 1),
                          guide = guide_colorstrip_bottom()) +
    scale_s_map() +
    coord_quickmap() +
    facet_wrap(~season)
```


Cosas para ver:    
Esto es, para cada punto de grilla, la correlación entre el campo observado y el reconstruido en todos los meses y años. 
Además de la dependencia latitudinal de la importancia de la onda 3 (que se puede ver en los cortes anteriores), se ve la dependencia zonal. La onda 3 es más importante en el Pacífico sur que en el Atlántico o el Índico. Además, se ve un patrón de altas correlaciones que asemejan a un tren de ondas.    
¿Confirma? lo que se ve en en análisis de wavelets. 


Conclusión: no voy a usar el r2 a partir del campo reconstruido. 


## Regresiones

### Geopotencial

```{r calc-regr-gh-ncep}
file <- "DATA/regr-gh-ncep.Rds"
regression <- cache.file(file, {
    ncep[lev == 300, .(lon, lat, date, gh)] %>% 
        .[index[, .(date, amplitude, phase)], on = "date"] %>% 
        .[, setNames(ExtractLm(
            RcppArmadillo::fastLm(cbind(mean = 1,
                                        amplitude = amplitude/sd(amplitude), 
                                        phase = phase),
                                  gh)),
            c("regressor", "estimate", "se")), 
          by = .(lat, lon, month(date))] %>% 
        .[, t := abs(estimate)/se]
})
```

```{r regr-gh-ncep, fig.cap = "Regresión sobre amplitud.", fig.class = "vfullpage"}
binwidth <- 10
ggplot(regression[regressor == "amplitude"], aes(lon, lat)) +
    stat_contour(aes(z = estimate, color = ..level..), binwidth = binwidth) +
    map.SH +
    # scale_s_map() +
    scale_y_latitude(limits = c(-90, 0)) +
    scale_x_longitude() +
    scale_color_divergent(binwidth = binwidth,
                          guide = guide_colorstrip_bottom()) +
    # coord_polar() +
    coord_quickmap() +
    facet_wrap(~month, ncol = 3, nrow = 4, dir = "v",
               labeller = labeller(month = month.abb_sp))
```

Cosas para ver:   
* Además los patrones de onda 3, en julio y diciembre aparece un patrón de SAM positivo y negativo respectivamente. 

```{r regr-gh-polar, fig.cap = "Igual que figura  XX, pero en proyección polar para julio y septiembre."}
binwidth <- 10
ggplot(RepeatLon(regression[regressor == "amplitude" & month %in% c(7, 12)]), 
       aes(lon, lat)) +
    stat_contour(aes(z = estimate, color = ..level..), binwidth = binwidth) +
    map.SH +
    # scale_s_map() +
    scale_y_latitude(limits = c(-90, 0)) +
    scale_x_longitude() +
    scale_color_divergent(binwidth = binwidth,
                          guide = guide_colorstrip_bottom()) +
    coord_polar() +
    # coord_quickmap() +
    facet_wrap(~month, labeller = labeller(month = month.abb_sp))
```

```{r sam-ampl, fig.cap = "Relación entre amplitud media de la onda 3 y el SAM", fig.height = 6}
sam <- fread("DATA/sam.monthly.txt") %>% 
    setnames(c("year", "month", "sam")) %>% 
    .[year > 1984 & year < 2016] %>% 
    .[, date := ymd(paste0(year, " ", month, " ", 01))] %>% 
    .[, `:=`(year = NULL, month = NULL)]


index[sam, on = "date"] %>% 
    .[, month := month(date)] %>% 
    ggplot(aes(amplitude, sam)) +
    geom_point(size = 0.5) + 
    geom_smooth(method = "lm", size = 0.5, color = "black") +
    scale_x_continuous(name = "Amplitud media") +
    scale_y_continuous(name = "SAM") +
    facet_wrap(~month, scales = "free", 
               ncol = 3, nrow = 4, dir = "v",
               labeller = labeller(month = month.abb_sp))
```

### Función Corriente
```{r calc-regr-psi-ncep}
file <- "DATA/stream.reg.Rds"
stream.reg <- cache.file(file, {
    stream[, .(lon, lat, date, psi)] %>% 
        .[index[, .(date, amplitude, phase)], on = "date"] %>% 
        .[, setNames(ExtractLm(
            RcppArmadillo::fastLm(cbind(mean = 1,
                                        amplitude = amplitude/sd(amplitude), 
                                        phase = phase),
                                  psi)),
            c("regressor", "estimate", "se")),
          by = .(lat, lon, month(date))] %>% 
        .[, t := abs(estimate)/se] %>% 
        .[, estimate.z := Anomaly(estimate),
          by = .(lat, month, regressor)] %>% 
        .[, psi.z := estimate.z] %>% 
        .[, c("f.x", "f.y") := WaveFlux(.SD), by = .(regressor, month)]
})
```


```{r regr-psi-ncep, fig.cap = "Regresión de Psi con la amplitud.", fig.class = "vfullpage"}
binwidth <- 1e6
scale <- 600

ggplot(stream.reg[regressor == "amplitude"], 
       aes(lon, lat)) +
    stat_contour_fill(aes(z = estimate.z), exclude = 0, 
                      complete = FALSE, binwidth = binwidth) +
    # geom_segment(aes(xend = lon + f.x*scale, yend = lat + f.y*scale)) +
    geom_vector(aes(dx = f.x, dy = f.y), skip = 4, min.mag = 0.005,
                arrow.size = 0.2, scale = 600, size = 0.2) +
    map.world +
    # scale_s_map() +
    scale_y_latitude(limits = c(-90, 40)) +
    scale_x_longitude() +
    scale_fill_divergent(binwidth = binwidth, 
                         guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_wrap(~month, labeller = labeller(month = month.abb_sp))
```


## Composición de campos. 

```{r calc-qs-fields}
setnames(fields, c("gh.z", "gh", "QS3"), c("ncep.z", "ncep", "qs3"))
fields <- melt(fields[lev == 300], id.vars = c("lon", "lat", "date"), 
               variable.name = "campo", value.name = "gh", 
               measure.vars = c("ncep", "qs3", "ncep.z"))
```

Descripción de la seleccion.  


```{r seleccion-tabla, fig.class = "fullpage", fig.cap = "Tabla de selección"}
index[, `:=`(select.amplitude = greater(amplitude, 10),
             select.r2 = greater(r2, 10)), 
      by = month(date)]
index <- index

selected <- melt(index[select.amplitude | select.r2],
                 id.vars = c("date", "phase", "amplitude"), 
                 measure.vars = c("select.amplitude", "select.r2"), 
                 variable.name = "select")
selected <- selected[value == T]

scale_color_selection <- 
    scale_color_brewer(palette = "Set1", name = "Selección según:", 
                       labels = c(select.amplitude = "Amplitud",
                                  select.r2  = "R2"))
library(ggstance)
ggplot(selected, aes(year(date), as.factor(month(date)))) +
    geom_point(aes(color = select),
               position = position_dodgev(height = 0.6)) +
    geom_spoke(aes(angle = phase/120*360, radius = amplitude/150), alpha = 0.6,
               data = unique(selected[, .(date, amplitude, phase)])) +
    scale_y_discrete(label = month.abb_sp, name = "Mes") +
    scale_x_continuous(breaks = 1985:2015, 
                       name = "Año", labels = decade(1985:2015)) +
    scale_color_selection
```

Cosas para ver:   
Años con coincidencia, años sin coindicentica. Meses donde la fase coincide (julio) vs meses donde no coindice (septiembre).
También, años donde hay seguidilla de meses seleccionados (1999). Aunque posiblemente sea casualidad (no hay mucha persistencia mes a mes.)

Pequeña digresión: Efecto de la fase.     
La climatología de la fase se va a discutir más adelante, pero... discutir el efecto de promediar campos con similar amplitud pero fase distinta. Del gráfico, septiembre tiene 1997 y 2003 con fase a 180°, lo que significa que va a a haber cancelación parcial. Enero, por el contrario, no tiene ningún año en contrafase, aunque sí algunos a 90°, que desdibujan el patrón. 

```{r interaccion-tabla, fig.height = 4, fig.class = "textwidth", fig.cap = "Tabla de interacción"}
gdata <- index[, .N, by = .(month(date), 
                            interaction(select.amplitude, 
                                        select.r2))] %>%
    .[, c("amplitude", "r2") := tstrsplit(interaction, split = "\\.")] %>%
    .[, interaction := NULL]

labels.truefalse <- c("TRUE" = "Sí", "FALSE" = "No")

ggplot(gdata, aes(amplitude, r2)) +
    geom_text(aes(label = N)) +
    facet_wrap(~month, labeller = labeller(month = month.abb_sp))  +
    theme(legend.title = element_text()) +
    scale_y_discrete(name = "R^2", labels = labels.truefalse) +
    scale_x_discrete(name = "Amplitud", labels = labels.truefalse)
```

Cosas para ver:    
Ambos criterios coinciden en casi todos los años seleccionados, así que no hay mucha diferencia. En efecto, las composiciones son casi iguales (no se muestra).  Voy a usar la amplitud.

```{r cleanup124}
index <- index[, c("select.r2", "cor") := NULL]
setnames(index, "select.amplitude", "select")
```

```{r gh-comp, fig.class = "fullpage", fig.cap = "Composición de campos"}
select.dates <- index[select == TRUE, date]
composition <- copy(fields) %>% 
    .[, gh.a := gh - mean(gh), by = .(lon, lat, campo, month(date))] %>% 
    .[date %in% select.dates, 
      .(gh = mean(gh.a)), 
      by = .(lon, lat, campo, month(date))]

binwidth <- 15
ggplot(composition[campo == "ncep"], aes(lon, lat)) +
    geom_contour_fine(aes(z = gh, color = ..level..), binwidth = binwidth) +
    map.SH +
    scale_s_map() +
    scale_color_divergent(breaks = MakeBreaks(binwidth),
                          guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    # coord_polar() +
    facet_wrap(~month, ncol = 3, nrow = 4, dir = "v",
               labeller = labeller(month = month.abb_sp))
```


```{r fun-plot-comp, cache = FALSE}
enso <- fread("DATA/ONI_v5.csv") %>% 
    set_names(c("year", 1:12)) %>% 
    melt(id.vars = "year", variable.name = "month", value.name = "oni") %>% 
    .[, date := ymd(paste(year, month, "01", sep = "-"))] %>% 
    .[, `:=`(month = NULL, year = NULL)] %>% 
    setkey(date) %>% 
    .[, sign := cut(oni, breaks = c(-Inf, -0.5, 0.5, Inf),
                    labels = c("niña", "neutral", "niño"))]

scale_color_enso <- function(...) {
    scale_color_manual(values = c(niña = "blue", niño = "red", neutral = "gray50"),
                       ...)
}

select.dates <- select.dates[month(select.dates) %in% c(1, 9)]
gdata <- fields[date %in% select.dates] %>% 
    .[, year := year(date), by = date] %>% 
    enso[., on = "date"] 

binwidth <- 30
tempplot <- function(m) {
    ggplot(mapping = aes(lon, lat, z = gh)) +
        stat_contour_fill(data = gdata[campo == "qs3" & month(date) == m], 
                          exclude = 0, complete = F,
                          binwidth = binwidth) +
        geom_contour_fine(data = gdata[campo == "ncep.z" & month(date) == m],
                          aes(linetype = factor(sign(-..level..))),
                          binwidth = binwidth,
                          color = "black") +
        map.SH +
        geom_point(data = gdata[lon %~% 15 & lat %~% -5 & month(date) == m], 
                   aes(color = sign)) +
        scale_s_map() +
        scale_color_enso(guide = "none") +
        scale_linetype(guide = "none") +
        scale_fill_divergent(breaks = MakeBreaks(binwidth),
                             guide = guide_colorstrip_bottom()) +
        coord_quickmap() +
        facet_wrap(~year, ncol = 2,
                   labeller = labeller(month = month.abb_sp))
}
```


```{r gh-qs3-select-ene, fig.cap = "Campos para los 10 eneros seleccionados.", fig.class = "vfullpage"}
tempplot(1)

```

```{r gh-qs3-select-sep, fig.cap = "Campos para los 10 septiembres seleccionados.", fig.class = "vfullpage"}
tempplot(9)

```

Estos gráficos me parecen importantes para ver lo que hay "adentro" de la composición, pero no sé bien qué decir sobre ellos. Supongo que lo principal es que hay años donde la onda 


## Fuentes de variabilidad interna

(Discusión escrita más de papers), Pero nos concentramos en la fuente externa.

## Fuentes externas

### SST

```{r calc-regr-sst-ncep}
file <- "DATA/sst.regr.Rds"

sst.regr <- cache.file(file, {
    sst <- ReadNetCDF("DATA/NCEP/sst.nc", vars = "sst") %>% 
        .[, date := as.Date(date), by = date]
    sst.regr <- sst[index[, .(date, amplitude, phase)], on = "date"] %>% 
        .[, ExtractLm(RcppArmadillo::fastLm(cbind(mean = 1, 
                                                  amplitude = amplitude/sd(amplitude), 
                                                  phase = phase),
                                            sst)),
          by = .(lon, lat, month(date))] %>% 
        .[, t := abs(estimate)/se]
})
```

```{r regr-sst-ncep, fig.cap = "Regresión de SST con la amplitud de la onda 3", fig.class = "fullpage"}
sst.regr[, estimate.full := ifelse(is.na(estimate), 
                                   mean(estimate, na.rm = T), 
                                   estimate), 
         by = regressor]

binwidth <- 0.15
ggplot(sst.regr[regressor == "amplitude"], aes(lon, lat)) +
    stat_contour_fill(aes(z = estimate.full), binwidth = binwidth, 
                      complete = FALSE, exclude = 0) +
    # stat_contour(aes(z = estimate), binwidth = binwidth) +
    # geom_raster(aes(ifelse(is.na(estimate), lon, NA)), fill = "white") +
    stat_contour(aes(z = t), breaks = c(2, 3), color = "black", size = 0.2) +
    map.world +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_s_map() +
    coord_quickmap() +
    facet_wrap(~month, labeller = labeller(month = month.abb_sp))
```


Campos de correlación con SST y OLR, principalmente
¿Discusión de otros forzantes?

# Experimentos

## Validación SPEEDY

Validación de la corrida control

```{r read-speedy, cache = FALSE}
vars <- c(gh = "gh", u = "u", t = "temp", psi = "psi", v = "v")
vars.z <- paste0(names(vars), ".z")

runs <- c("Control", "SSTCLIM", "NOLAND", "SSTZONAL") 

file.speedy <- "DATA/SPEEDY/speedy.runs.Rds"
speedy <- cache.file(file.speedy, {
    rbindlist(lapply(seq_along(runs), function (x) {
        ReadNetCDF(paste0("DATA/SPEEDY/attm-", runs[x], "_HS.nc"), 
                   vars = vars)[, run := runs[x]]
    }))
})
speedy[, run := factor(run, levels = runs)]
speedy[, t := t - 273.15]

speedy[, c(vars.z) := lapply(.SD, Anomaly), 
       by = .(lat, lev, date, run), .SDcols = -"lon"]
speedy[, c("amplitude", "phase", "r2") := FitQsWave(gh, 3),
       by = .(lat, lev, date, run)]
speedy <- speedy[, QS3 := amplitude*cos(3*(lon*pi/180 - phase))]

speedy.mean.season <- speedy[, lapply(.SD, mean), 
                             by = .(lon, lat, lev, season(date), run)]

speedy.mean.season[, zeta := Vorticity(u + v ~ lon + lat, cyclical = TRUE,
                                       sphere = TRUE), 
                   by = .(lev, season, run)]
speedy.mean.season[, zeta.dy := Derivate(zeta ~ lon + lat, 
                                         cyclical = c(FALSE, FALSE),
                                         sphere = TRUE)[[2]],
                   by = .(lev, season, run)]

speedy.mean.season[, eta.dy := zeta.dy + f.dy(lat)]
speedy.mean.season[, `:=`(zeta = NULL, zeta.dy = NULL)]
speedy.mean.season[lev == 200, 
                   c("f.lon", "f.lat") := WaveFlux(.SD, p = 200), 
                   by = .(season, run)]
```

* Comparación campos medios. 

Acá un problemita es que en speedy no tengo el nivel de 50hPa, sólo tengo `r unique(speedy$lev)`. Podría usar 30, pero eso es la tapa del modelo...

```{r calc-interp-ncep}
lons <- unique(speedy.mean.season$lon)
lats <- unique(speedy.mean.season$lat)
ncep.interp <- 
    ncep.mean.season %>% 
    melt(id.vars = c("season", "lon", "lat", "lev")) %>% 
    .[variable %in% c(names(vars), vars.z, "eta.dy")] %>% 
    .[, Interpolate.DT(value, lon, lat, lats, lons), 
      by = .(lev, season, variable)]
```


```{r calc-cor-sp-nc}
sp.nc <-  melt(speedy.mean.season[run == "Control"][, run := NULL], 
               id.vars = c("season", "lon", "lat", "lev")) %>% 
    .[ncep.interp, on = c("variable", "season", "lon", "lat", "lev")] %>% 
    .[!is.na(value) & !is.na(i.value)]

cor.sp_nc <- sp.nc[, .(cor = cor(value, i.value)),
                   by = .(season, lev, variable)]

cor.sp_nc[, zonal := substr(variable, 
                            stri_length(variable) - 1, 
                            stri_length(variable)) == ".z"] 
cor.sp_nc[zonal == TRUE, 
          variable := substr(variable, 
                             1, 
                             stri_length(variable) - 2)]
```

```{r cor-sp-nc, fig.cap = "Correlación lineal entre campos de SPEEDY y NCEP.", fig.height = 5, fig.publish = FALSE}
ggplot(cor.sp_nc, aes(lev, cor, color = zonal)) +
    geom_line() +
    coord_flip() +
    scale_x_level(breaks = plot.levs, name = "Nivel") +
    scale_y_continuous(name = "Correlación") +
    scale_color_brewer(palette = "Set1", name = "", 
                       labels = c("TRUE" = "Anomalía", "FALSE" = "Completa")) +
    facet_grid(season~variable, 
               labeller = labeller(variable = c(gh = "Altura Geopotencial",
                                                u = "Viento zonal",
                                                v = "Viento meridional",
                                                eta.dy = "Gradiente meridinoal\nde vorticidad absoluta",
                                                t = "Temperatura"))) 

```


* Altura geopotencial (gh)
Para el caso del campo total, la correlación del campo es buena (>0.8)en casi todos los niveles y meses, excepto en 30hPa durante verano donde los campos ¡está anticorrelacionados! La parte asimétrica zonal muestra valores menores, indicando que gran parte de la correlación del campo total se debe a la capacidad del modelo de reproducir el gradiente meridional. Sin embargo, se siguen obteniendo correlaciones >0.6 en casi todos los niveles y estaciones. Se observa un mínimo relativo en 500hPa donde en se tienen correlaciones menores durante casi todo el año y uno en niveles altos centrado en invierno y primavera.

* Viento zonal (U)
Las correlaciones con el campo total son >=0.8 en todo el año y todos los niveles, sin embargo, la parte asimétrica muestra correlaciones mucho más baja con un máximo de \~0.6 en 925hPa. Esto indica que el modelo resuelve correctamente la estructura media del Jet, pero no sus variaciones zonales. 

* Viento meridional (V)
Los campos de correlación son prácticamente idénticos entre parte total y parte asimétrica. Ésta muestra un patrón de bajas correlaciones en general.

* Temperatura (T)
La correlación con el campo total muestra una estructura similar que la altura geopotencial, con una excelente correlación en todos los meses para niveles mayores a 200hPa, pero anticorrelacionado en niveles altos en todos los meses salvo en invierno. La parte asimétrica muestra correlaciones bajas en todos los niveles salvo en 925hPa. 

* Gradiente meridional de vorticidad absoluta. 
Tiene correlación moderada con un mínimo relativo en 200hPa en verano que en las otras estacione se convierte en un máximo. 


### Altura Geopotencial

Anomalía


```{r ghz-sp-nc, fig.class = "fullpage", fig.cap = "Anomalía zonal de altura geopotencial (speedy sombreado, ncep contornos)"}
plot.levs.sp <- c(500, 200)
binwidth <- 20
cutlat <- -60
ggplot(speedy.mean.season[run == "Control" & lev %in% plot.levs.sp], aes(lon, lat)) +
    geom_contour_fill(aes(z = gh.z), 
                      binwidth = binwidth, exclude = 0) +
    # geom_contour_fine(aes(z = gh.z), binwidth = binwidth, exclude = 0,
    # color = "black", size = 0.2) +
    geom_contour_back(aes(z = gh.z, linetype = factor(sign(-..level..))),
                      binwidth = binwidth,
                      data = ncep.mean.season[lev %in% plot.levs.sp]) +
    geom_label_contour_back(aes(z = gh.z, label = ..level..),
                            binwidth = binwidth,
                            data = ncep.mean.season[lev %in% plot.levs.sp]) +
    # geom_hline(yintercept = cutlat, 
    # linetype = 2, size = 0.5) +
    scale_fill_divergent(binwidth = binwidth, name = "Z*", 
                         guide = guide_colorstrip_bottom(25)) +
    scale_linetype(guide = "none") +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap()
```

```{r ghz-dif-sp-nc, fig.class = "fullpage", fig.cap = "Diferencia entre speedy y ncep"}
sp.nc <- sp.nc[, dif := i.value - value]

binwidth <- 20
ggplot(sp.nc[lev %in% plot.levs.sp & variable == "gh.z"], aes(lon, lat)) +
    geom_contour_fill(aes(z = dif), exclude = 0, binwidth = binwidth) +
    scale_fill_divergent(name = "Z*", breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap()
```

Veredicto:    
* Agarra bien la anomalía zonal aunque con magnitud menor. 

```{r ghz-sp-nc-corte60, fig.class = "textwidth", fig.cap = "Corte zonal de anomalía de geopotencial en -60° (speedy sombreado, ncep contornos)."}
binwidth <- 20
ggplot(speedy.mean.season[run == "Control" & lat %~% cutlat], aes(lon, lev)) +
    geom_contour_fill(aes(z = gh.z), binwidth = binwidth, exclude = 0) +
    geom_contour_back(aes(z = gh.z, linetype = factor(sign(-..level..))), 
                      binwidth = binwidth, 
                      data = ncep.mean.season[lat %~% cutlat]) + 
    geom_label_contour_back(aes(z = gh.z, label = ..level..), 
                            binwidth = binwidth, skip = 2,
                            data = ncep.mean.season[lat %~% cutlat]) +
    scale_fill_divergent(breaks = MakeBreaks(binwidth), name = "Z*",
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    scale_y_level(breaks = plot.levs, minor_breaks = NULL) +
    scale_x_longitude(name = "longitud") +
    facet_wrap(~season)
```

El corte zonal evidencia que además de tener menor amplitud, la estructura vertical de las anomalías es barotrópica equivalente en Speedy, a diferencia de la estructura baroclínica de NCEP. 

### Temperatura 

```{r t-nc-sp, fig.cap = "Temperatura"}
binwidth <- 5
ggplot(speedy.mean.season[run == "Control" & lev %in% 850], aes(lon, lat, z = t)) +
    geom_contour_fill(binwidth = binwidth) +
    # geom_contour_fine(aes(z = gh.z), binwidth = binwidth, exclude = 0,
    # color = "black", size = 0.2) +
    geom_contour_back(aes(linetype = factor(sign(-..level..))),
                      binwidth = binwidth,
                      data = ncep.mean.season[lev %in% 850]) +
    geom_label_contour_back(aes(label = ..level..),
                            binwidth = binwidth,
                            data = ncep.mean.season[lev %in% 850]) +
    # geom_hline(yintercept = cutlat, 
    # linetype = 2, size = 0.5) +
    scale_fill_viridis_c(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) 
```


```{r tz-sp-nc, fig.cap = "T*"}
binwidth <- 2
ggplot(speedy.mean.season[run == "Control" & lev %in% c(200, 850)], aes(lon, lat, z = t.z)) +
    geom_contour_fill(binwidth = binwidth, exclude = 0) +
    # geom_contour_fine(aes(z = gh.z), binwidth = binwidth, exclude = 0,
    # color = "black", size = 0.2) +
    geom_contour_back(aes(linetype = factor(sign(-..level..))),
                      binwidth = binwidth,
                      data = ncep.mean.season[lev %in% c(200, 850)]) +
    geom_label_contour_back(aes(label = ..level..),
                            binwidth = binwidth,
                            data = ncep.mean.season[lev %in% c(200, 850)]) +
    # geom_hline(yintercept = cutlat, 
    # linetype = 2, size = 0.5) +
    scale_fill_divergent(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) 
```

En 850 tiene una fuerte onda 1 en latitudes polares producida por la topografía de la Antártida y representa bien las anomalías causadas por los continentes, aunque en menor amplitud.    
En 200, falla miserablemente. La onda 1 polar que se ve bien claro en NCEP ni aparece en SPEEDY, mientras que en latitudes medias aparecen ligeras anomalías que no se observan en las observaciones. 


### Viento zonal

```{r u-sp-nc-corte, fig.class = "textwidth", fig.cap = "Viento zonal medio (speedy contornos, ncep sombreado)."}
speedy.mean.season[run == "Control", 
                   .(u = mean(u)), 
                   by = .(lat, lev, season)] %>% 
    ggplot(aes(lat, lev)) +
    geom_contour_fill(aes(z = u), binwidth = 5, exclude = 0, complete = FALSE) +
    geom_contour_back(aes(z = u, linetype = factor(-sign(..level..))), 
                      binwidth = 5,
                      data = ncep.mean.season[, .(u = mean(u)), 
                                              by = .(lat, lev, season)]) +
    geom_label_contour_back(aes(z = u, label = ..level..), 
                            binwidth = 5,
                            data = ncep.mean.season[, .(u = mean(u)), 
                                                    by = .(lat, lev, season)]) +
    surface +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_divergent(name = "U media zonal", breaks = MakeBreaks(5),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    facet_wrap(~season)
```


Cosas para ver:    
* Speedy no logra desarrollar un jet polar por la falta de niveles verticales en la estratósfera. Tampoco reproduce los estes estratosféricos en latitudes bajas. Su jet subtropical es más intenso y su máximo se da ligéramente en niveles más altos en NCEP. 

Campo medio (me parece que no lo voy a poner, no agrega información que no esté en el anterior y en el de geopotencial.)

```{r u-sp-nc, fig.class = "fullpage", fig.cap = "Viento zonal (contornos ncep, sombreado speedy)."}
ggplot(RepeatLon(speedy.mean.season[run == "Control" & lev == 200]), aes(lon, lat)) +
    geom_contour_fill(aes(z = u), binwidth = 5) +
    geom_contour_back(aes(z = u, linetype = factor(-sign(..level..))), 
                      binwidth = 5, 
                      data = RepeatLon(ncep.mean.season[lev == 200])) +
    geom_label_contour_back(aes(z = u, label = ..level..), 
                            binwidth = 5, 
                            data = RepeatLon(ncep.mean.season[lev == 200])) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = 5, size = 0.1) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(name = "U", breaks = MakeBreaks(5),
                         guide = guide_colorstrip_bottom(),
                         limits = c(-20, 70)) +
    scale_linetype(guide = "none") +
    # coord_quickmap() +
    coord_polar() +
    # coord_map(projection = "stereographic", orientation = c(-90, 0, 0)) +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
```


```{r u-dif-sp-nc, fig.cap = "Diferencia entre ncep y speedy en viento zonal"}
binwidth <- 5

ggplot(RepeatLon(sp.nc[lev == 200 & variable == "u"]), aes(lon, lat)) +
    geom_contour_fill(aes(z = dif), exclude = 0, binwidth = binwidth) +
    scale_fill_divergent(name = "Z*", breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_polar() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) 
```

Cosas para ver:    
Jet polar en invierno y primavera en niveles altos (< 100 hPa). Jest subtropical en niveles "medios".

### Gradiente meridional de vorticidad absoluta

```{r etady-sp-nc, fig.class = "fullpage", fig.cap = "Gradiente meridional de vorticidad absoluta (speedy)."}
binwidth <- 1
ggplot(speedy.mean.season[run == "Control" & lev == 200 & lat > -85], 
       aes(lon, lat, z = eta.dy*1e11)) +
    # stat_contour_fill(binwidth = binwidth) +
    geom_contour_fine(binwidth = binwidth, color = "black") +
    geom_label_contour2(aes(label = ..level..), 
                        binwidth = binwidth) +
    stat_filter(aes(filter = eta.dy <= 0), geom = "tile",
                color = "gray50", fill = "gray50") +
    # stat_contour_fill(breaks = 0,
    # fill = "black", complete = FALSE) +
    geom_contour_fine(breaks = 0, color = "black") +
    map.SH +
    # polar.SH + 
    scale_fill_divergent(name = "Gradiente meridional de vorticiad absoluta", 
                         guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    scale_s_map() +
    coord_quickmap() +
    # coord_polar() + 
    facet_wrap( ~ season, labeller = labeller(lev = lev.lab))
```

Comparando con la figura \autoref{fig:eta-dy-ncep}, los gradientes son menores y más zonales. Es significativo que la región "prohibida" en invierno de niveles altos es menor en 200hPa y casi desaparece en 300hPa. 


### Número de onda estacionaria

```{r ks-sp, fig.cap = "Número de onda estacionario en 300hPa (speedy).", fig.height = 6}
a <- 6371000

speedy.mean.season[, k := sqrt(eta.dy/u)*(a*cos(lat*pi/180))] 
sp.ks <- speedy.mean.season[run == "Control" & lev == 300,
                            .(lon, lat, lev, season, k)]
sp.ks[ , k.full := ifelse(is.na(k) | k > 10, -1, k)]

ggplot(sp.ks, aes(lon, lat)) +
    geom_contour_fine(aes(z = k.full), breaks = 0:9, color = "black") +
    # stat_contour(aes(z = k.full),
    #              breaks = c(2.5, 3.5), color = "black") +
    geom_label_contour2(aes(z = k.full, label = ..level..),
                        breaks = 0:9, skip = 0) +
    stat_filter(aes(filter = k.full == -1), geom = "tile", color = "gray50",
                fill = "gray50") +
    map.SH +
    scale_s_map() +
    scale_fill_viridis_c(breaks = 1:9, guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_wrap(~season)
```

Comparando con \autoref{fig:k-steady-ncep} la mayor diferencia es la desaparición de una región de propagación impedida en ~-40° en el Índico y el Pacífico en Otoño. 


```{r ks-sp-nc-corte, fig.class = "textwidth", fig.cap = "Número de onda estacionario medio por círculo de latitud."}
rbind(ks[lon %~% 180][, mod := "NCEP"], 
      sp.ks[lon %~% 180][, mod := "SPEEDY"]) %>%
    .[, k := ifelse(k > 9 | !is.finite(k), NA, k)] %>% 
    ggplot(aes(lat, k, color = mod)) +
    geom_line() +
    scale_y_continuous(name = "Número de onda estacionaria", breaks = 1:9,
                       limits = c(1, 9)) +
    scale_x_latitude(name = "Latitud", ticks = 15) +
    scale_color_brewer(palette = "Set1") +
    facet_wrap(~season) +
    coord_flip()
```

En promedio zonal, sin embargo, SPEEDY funciona bien. 

### Función corriente


```{r psi-sp, fig.class = "fullpage", fig.cap = "Función corriente x 1099"}

binwidth <- 5
ggplot(speedy.mean.season[run == "Control" & lev == 200], aes(lon, lat)) +
    stat_contour_fill(aes(z = psi.z),
                      binwidth = binwidth,
                      complete = FALSE, exclude = 0) +
    geom_contour_fine(aes(z = psi), 
                      binwidth = 20,
                      color = "black") +
    geom_vector(aes(dx = f.lon, dy = f.lat), skip = 3,
                min.mag = 1e-14,
                scale = 5e14) +
    map.SH +
    # scale_s_map() +
    scale_x_longitude(limits = c(0, 360)) +
    scale_y_latitude() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season) +
    theme(axis.title = element_blank()) + 
    coord_quickmap()
```

### Onda 3


```{r ampl-sp-nc, fig.class = "pagewidth", fig.cap = "Amplitud de Fourier (speedy en sombreado, ncep en contornos)."}

qs.sp.season <-speedy[, lapply(.SD, mean),
                      by = .(lat, lev, season(date), run), 
                      .SDcols = c("amplitude", "phase", "r2")]
# breaks <- 2^seq(0, log2(650), by = 0.5)
binwidth <- 10
ggplot(qs.sp.season[run == "Control"], aes(lat, lev)) +
    geom_contour_fill(aes(z = amplitude), binwidth = binwidth) +
    geom_contour_back(aes(z = amplitude), 
                      data = ampl.mean[k == 3], binwidth = binwidth) +
    geom_label_contour_back(aes(z = amplitude, label = ..level..), 
                            data = ampl.mean[k == 3], binwidth = binwidth) +
    surface +
    geom_index.region(rect.annotation) +
    scale_fill_viridis_c(name = "Amplitud (escala logarítmica)", 
                         guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth),
                         option = "D") +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse", 
                     ticks = 15) +
    facet_grid(~ season)
```


```{r calc-qs3-sp}
lons <- unique(speedy$lon)
qs.wave.sp.season <- speedy[lev == 300, .(mean = mean(QS3)), 
                            by = .(lon, lat, season(date), run)]
```


```{r qs2-sp-nc, fig.class = "pagewidth", fig.cap = "Media de reconstrucción de onda 3 (sombreado speedy, contornos ncep)", fig.height = 6}
binwidth <- 10
cutlat <- data.frame(lat = c(-52.5), 
                     season = c("Verano"))
ggplot(qs.wave.sp.season[run == "Control"], aes(lon, lat)) +
    geom_contour_fill(aes(z = mean), binwidth = binwidth, exclude = 0, 
                      complete = FALSE) +
    geom_contour_back(aes(z = mean, linetype = factor(-sign(..level..))),
                      color = "black",
                      binwidth = binwidth,
                      data = qs.wave.season[lev == 300]) +
    geom_label_contour_back(aes(z = mean, label = ..level..), 
                            binwidth = binwidth,
                            data = qs.wave.season[lev == 300]) +
    map.SH +
    scale_s_map() +
    scale_linetype(guide = "none") +
    scale_fill_divergent(breaks = MakeBreaks(binwidth), name = "QS3",
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) +
    coord_quickmap()
```

La onda 3 no está muy bien representada en el modelo. Aunque la estructura vertical y la posición meridional está bien (salvo en otoño), la amplitud es mucho menor. La fase, además, está corrida ligeramente en verano, pero quedando en cuadratura en invierno y defasado 180 en primavera. 



## Comparación 


Comparación entre corridas
### Altura geopotencial

```{r ghz-sp-runs, fig.class = "fullpage", fig.cap = "Anomalía zonal de altura geopotencial."}

plot.levs.sp <- 200
binwidth <- 20

ggplot(speedy.mean.season[lev == 200], aes(lon, lat)) +
    geom_contour_fill(aes(z = gh.z), 
                      binwidth = binwidth, exclude = 0) +
    scale_fill_divergent(binwidth = binwidth, name = "Z*", 
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(lev = lev.lab)) 
```

```{r ghz-dif-sp-runs, fig.calss = "fullpage", fig.cap = "Diferencia Control - corrida para Z*"}
speedy.mean.season.l <- melt(speedy.mean.season, 
                             id.vars = c("lon", "lat", "lev", "season", "run"))

s <- speedy.mean.season.l[, value[run == "Control"]]
speedy.mean.season.l[, dif := s - value, by = run]
run.dif <- setNames(paste0("Control -\n", runs[-1]),
                    runs[-1])
sp.dif <- dcast(speedy.mean.season.l[run != "Control"][, -c("value")], 
                ... ~ variable, 
                value.var = "dif")
remove(speedy.mean.season.l)

binwidth <- 10
ggplot(sp.dif[lev == 200], aes(lon, lat, z = gh.z)) +
    geom_contour_fill(binwidth = binwidth) +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = "colorstrip_bottom") +
    coord_quickmap() +
    # coord_polar() +
    facet_grid(run ~ season, labeller = labeller(run = run.dif))
```

### Temperatura

ONo hay casi diferencia entre las corridas. 

```{r t-sp-runs, fig.cap = "Temperatura media en 850hPa.", fig.publish = FALSE}
binwidth <- 5
ggplot(speedy.mean.season[lev == 850], aes(lon, lat)) +
    geom_contour_fill(aes(z = t), 
                      binwidth = binwidth) +
    scale_fill_viridis_c(breaks = MakeBreaks(binwidth),
                         name = "Z*", 
                         guide = guide_colorstrip_bottom()) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(lev = lev.lab)) 
```

```{r tz-sp-runs, fig.cap = "Temperatura media en 850hPa."}
binwidth <- 5
ggplot(speedy.mean.season[lev == 850], aes(lon, lat)) +
    geom_contour_fill(aes(z = t.z), 
                      binwidth = binwidth, exclude = 0) +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         name = "Z*", 
                         guide = guide_colorstrip_bottom()) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(lev = lev.lab)) 
```

```{r tz-dif-sp-runs, fig.class = "fullpage", fig.cap = "Diferencia Control - corrida para T*"}
binwidth <- 1
ggplot(sp.dif[lev == 850], aes(lon, lat, z = t.z)) +
    geom_contour_fill(binwidth = binwidth, exclude = 0) +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = "colorstrip_bottom") +
    coord_quickmap() +
    # coord_polar() +
    facet_grid(run ~ season, labeller = labeller(run = run.dif))
```

### Viento zonal

```{r uz-sp-runs, fig.class = "fullpage", fig.cap = "Viento zonal"}
binwidth <- 5
ggplot(speedy.mean.season[lev == 200], aes(lon, lat)) +
    geom_contour_fill(aes(z = u), 
                      binwidth = binwidth,
                      # breaks = MakeBreaks(binwidth),
                      exclude = 0) +
    scale_fill_divergent(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(lev = lev.lab)) 
```

```{r u-dif-sp-runs, fig.cap = "Diferencia control - corrida para U."}
binwidth <- 2
speedy.mean.season[lev == 200] %>% 
    .[, u.dif := speedy.mean.season[lev == 200 & run == "Control", u] - u] %>%
    .[run != "Control"] %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = u.dif), 
                      binwidth = binwidth,
                      # breaks = MakeBreaks(binwidth),
                      exclude = 0) +
    scale_fill_divergent(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(run = run.dif)) 
```

### Función corriente

```{r psi-sp-runs, fig.class = "fullpage", fig.cap = "Anomalía zonal de función corriente y flujos de acción de onda."}
binwidth <- 2
ggplot(speedy.mean.season[lev == 200], aes(lon, lat)) +
    geom_contour_fill(aes(z = psi.z), 
                      binwidth = binwidth,
                      exclude = 0) +
    scale_fill_divergent(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    geom_vector(aes(dx = f.lon, dy = f.lat), skip = 3,
                min.mag = 1e-14,
                scale = 5e14) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(lev = lev.lab)) 
```


```{r psiz-dif-sp-runs, fig.cap = "Diferencia en psi.z y flujos de acción de onda."}
binwidth <- 2
ggplot(sp.dif[lev == 200], aes(lon, lat, z = psi.z)) +
    geom_contour_fill(binwidth = binwidth,
                      # breaks = MakeBreaks(binwidth),
                      exclude = 0) +
    scale_fill_divergent(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    geom_vector(aes(dx = f.lon, dy = f.lat), skip = 3,
                min.mag = 1e-14,
                scale = 5e14) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(run = run.dif)) 
```


### Onda 3

```{r ampl-sp-runs, fig.cap = c("Amplitud media de la onda 3 para cada corrida."), fig.height = 5}
sp.levs <- unique(speedy$lev)
binwidth <- 5
ggplot(qs.sp.season, aes(lat, lev)) +
    geom_contour_fill(aes(z = amplitude), binwidth = binwidth) +
    scale_x_latitude(trans = "reverse") +
    scale_y_level(breaks = sp.levs)+
    scale_fill_viridis_c(guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    ylab("Nivel") + xlab("Latitud") +
    facet_grid(run ~ season)
```

```{r ampl-dif-sp-runs, fig.cap = "Diferencia de amplitud entre la corrida control y cada corrida.", fig.height = 5}
qs.sp.season[, dif := qs.sp.season[run == "Control", amplitude] - 
                 amplitude,
             by = run]
binwidth <- 2
dif <- setNames(paste0("Control - ", runs[-1]),
                runs[-1])
ggplot(qs.sp.season[run != "Control"], aes(lat, lev, z = dif)) +
    geom_contour_fill(binwidth = binwidth, exclude = 0, complete = F) +
    scale_y_level(breaks = sp.levs) +
    scale_x_latitude(trans = "reverse") +
    scale_fill_divergent(guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    facet_grid(run ~ season, 
               labeller = labeller(run = dif))
```

```{r calc-sp-index}
levs.index <- c(700, 300, 100)
lats.index <- c(-65, -40)
levs.index <- c(100, 700)

sp.index <- speedy[(lev %b% levs.index) & 
                       (lat %b% lats.index) & 
                       lon == 0,
                   .(amplitude   = mean(amplitude),
                     r2          = mean(r2),
                     phase  = mode(phase)),
                   by = .(date, run)]
```




```{r index-sp-boxplot, fig.cap = "Ciclo anual de amplitud de onda 3."}
ggplot(sp.index, aes(factor(month(date)), amplitude, color = run)) +
    geom_boxplot() +
    scale_color_brewer(palette = "Set1") +
    scale_x_discrete(breaks = 1:12, labels = month.abb_sp, name = "Mes") +
    scale_y_continuous(name = "Amplitud")
```




## Regresión


```{r calc-regr-psi-sp}
regr.file <- "DATA/regression-exps.Rds"
regr.exps <- cache.file(regr.file, {
    speedy[lev == 300, ] %>% 
        .[sp.index[, .(date, run, amplitude, phase)], 
          on = c("date", "run")] %>% 
        .[, 
          ExtractLm(RcppArmadillo::fastLm(cbind(mean = 1, 
                                                amplitude = amplitude/sd(amplitude),
                                                phase = phase),
                                          psi)), 
          by = .(lon, lat, month(date), run)]
})
```

```{r regr-psi-sp-runs, fig.cap = "Regresión en función corriente."}
binwidth <- 1
regr.exps[regressor == "amplitude"] %>%
    .[, lapply(.SD, mean, na.rm = T), 
      by = .(lon, lat, run, season(month), regressor)] %>% 
    .[, psi.z := Anomaly(estimate), by = .(run, season, lat)] %>% 
    .[, c("fx", "fy") := WaveFlux(.SD, p = 300), by = .(run, season)] %>%
    ggplot(aes(lon, lat, z = psi.z)) +
    geom_contour_fill(binwidth = binwidth, exclude = 0) +
    geom_vector(aes(dx = fx, dy = fy), skip = 3,
                min.mag = 1e-15,
                scale = 1e15) +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_grid(run ~ season)
```





## Cosas inesperadas...

* ?? 
* protif!

# Conclusiones

# Agradecimientos

# Referencias


```{r ending-cheer, eval = !params$draft, include = !params$draft}
beepr::beep(3)
```

