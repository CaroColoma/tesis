---
title: "Estudio de los mecanismos físicos asociados con el patrón de onda 3 de la circulación atmosférica del Hemisferio Sur" 
author: "Elio Campitelli"
date: ""
lang: es-AR
bibliography: [Papers/Biblio.bib, Papers/packages.bib]
geometry: "inner = 3cm, outer = 2.5cm, top = 2.5cm, bottom = 2.5cm"
documentclass: book
classoption: a4paper,12p
knit: (function(file, encoding, ...) {
    rmarkdown::render(file, encoding = encoding,
                output_dir = "docs/")})
output:
    pdf_document:
      includes: 
        in_header: header.tex
      fig_height: 3
      fig_width: 6
      keep_tex: yes
      latex_engine: xelatex
      number_sections: yes
      toc: yes
      toc_depth: 4
link-citations: yes
params: 
    draft: FALSE
biblio-style: apalike
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy = FALSE,
                      echo = FALSE, 
                      cache = TRUE, 
                      force.cap = TRUE,
                      fig.class = "pagewidth",
                      fig.ncol = 1,
                      fig.publish = TRUE,
                      cache.lazy = TRUE,
                      cache.path = "cache/tesis/",
                      fig.path = "fig/tesis/",
                      out.extra = " ",
                      warning = FALSE,
                      message = FALSE)

library(tufte)
library(data.table)
library(ggplot2)
library(dplyr)
library(metR) 
library(WaveletComp)
library(patchwork)
library(circular)

knitr::write_bib(c("base", "data.table", "ggplot2", "WaveletComp", "metR", "circular"), 
                 file = "Papers/packages.bib")

source("scripts/helperfun.R")

# Plot thingys

data.world <- BuildMap(res = 1, smooth = 1)
map.world <- geom_map2(data.world)
map.SH <- geom_map2(data.world[lat %b% c(-90, 0)])


pres <- ReadNetCDF("DATA/NCEP/srfp.mon.mean.nc")
pres.mean <- pres[, .(pres = median(pres)), by = lat]
pres.mean <- rbind(data.table(lat = 0.0, pres = Inf), 
                   pres.mean, 
                   data.table(lat = -90.0, pres = Inf))
surface <- geom_polygon(data = pres.mean, aes(y = pres), fill = "white", 
                        alpha = 0.5, color = "gray30", size = 0.5)
pres <- pres[, .(pres = mean(pres)), by = .(lon, lat)]

theme_elio <- theme_minimal(base_size = 11) +
    theme(legend.position = "bottom", legend.box = "vertical",
          panel.spacing.y = unit(5, "mm"),
          panel.spacing.x = unit(5, "mm"),
          legend.spacing = unit(2, "mm"),
          plot.margin = grid::unit(rep(3, 4), "mm"),
          legend.title = element_blank(),
          legend.box.spacing = unit(3, "mm"),
          legend.margin = margin(t = -5),
          panel.grid = element_line(color = "black", size = 0.2, linetype = 3),
          panel.ontop = TRUE)
theme_set(theme_elio)

# For vertical cross-sections
coord_latlev <- function(ratio = 20, ...) coord_fixed(ratio = ratio, ...)
coord_lonlev <- function(ratio = 20*4, ...) coord_fixed(ratio = ratio, ...)

## Hooks.

## Force captions
plot_hook <- knitr::knit_hooks$get("plot")
knitr::knit_hooks$set(
    plot = function(x, options) {
        if (options$force.cap == TRUE & is.null(options$fig.cap)) {
            stop("All figures must have captions.")
        }
        if (params$draft == TRUE) {
            options$fig.cap <- paste0(options$fig.cap, " - fig:", 
                                      knitr::opts_current$get("label"))
        }
        if (options$fig.publish == FALSE) {
            options$fig.cap <- paste0(options$fig.cap, " - SÓLO BORRADOR")
        }
        if (options$fig.publish == TRUE) {
            plot_hook(x, options)
        }
    }
)

knitr::knit_hooks$set(
    rotate = function(before, options, envir) {
        if (before) {
            return("\\begin{landscape}")
        } else{
            return("\\end{landscape}")
        }
    }
)

## Figure classes
DefineClass <- function(class.opts) {
    class.name <- deparse(substitute(class.opts))
    class.fun <- function(options) {
        class <- options[[class.name]]
        class <- class.opts[[class]]
        options[names(class)] <- class
        options
    }
    invisible(knitr::opts_hooks$set(
        setNames(list(class.fun), class.name)))
}

page.width <- 210 - 30 - 25
text.width <- page.width - 20
text.height <- page.height <- 297 - 25 - 25

fig.class <- list(
    pagewidth = list(
        fig.width = page.width/25.4,
        out.width = paste0(page.width, "mm"),
        # fig.align = "center",
        fig.env = "figure*",
        out.extra = " "
    ),
    textwidth = list(
        fig.width = text.width/25.4,
        out.width = paste0(text.width, "mm"),
        fig.env = "figure",
        fig.align = "center",
        out.extra = " "
    ),
    fullpage = list(
        fig.width = (page.height)/25.4,
        fig.height = (page.width - 10)/25.4,
        out.width = paste0(page.height, "mm"),
        fig.align = "center",
        rotate = TRUE,
        out.extra = ""
        # out.extra = "angle=90"
    ),
    vfullpage = list(
        fig.width = page.width/25.4,
        fig.height = (page.height - 20)/25.4,
        out.width = paste0(page.width, "mm"),
        fig.align = "center"
    ),
    halfpage = list(
        # out.width = "7.3cm",
        fig.width = (page.width/2)/25.4,
        out.width = paste0(page.width/2, "mm")
    ),
    medium = list(
        fig.width = 8,
        fig.height = 4,
        # out.width = "\\textwidth",
        # out.height = "0.25\\textheight",
        fig.align = "center")
)

DefineClass(fig.class)

setDTthreads(3)
```

Resumen.


```{r read-ncep, cache = FALSE}
file.ncep <- "DATA/NCEP/ncep.vars.Rds"
ncep <- cache.file(file.ncep, {
    ncep <- ReadNetCDF("DATA/NCEP/hgt.mon.mean_sub.nc", vars = c(gh = "hgt"))
    setnames(ncep, c("level", "time"), c("lev", "date")) 
    ncep <- 
        ncep[, t := ReadNetCDF("DATA/NCEP/air.mon.mean_sub.nc", 
                               out = "vector")[[1]]] %>% 
        .[, u := ReadNetCDF("DATA/NCEP/uwnd.mon.mean_sub.nc", 
                            out = "vector")[[1]]] %>% 
        .[, v := ReadNetCDF("DATA/NCEP/vwnd.mon.mean_sub.nc", 
                            out = "vector")[[1]]]
    
    vars <- c("gh", "t", "u", "v")
    vars.z <- paste0(vars, ".z")
    ncep[, c(vars.z) := lapply(.SD, Anomaly), by = .(lat, lev, date), .SDcols = -"lon"]
    ncep
})


ncep[, date := as.Date(date), by = date]
ncep.mean <- ncep[, lapply(.SD, mean), 
                  by = .(lat, lon, lev, month(date))]

ncep.mean.season <- ncep.mean[, lapply(.SD, mean), 
                              by = .(lon, lat, lev, season(month))]
```

\todo[inline]{Listado de abreviaturas}
\todo[inline]{Revisar TODOS los epígrafes}

\listoffigures
\newpage

# Introducción

Estudios sobre el flujo medio del hemisferio sur (HS) muestran que, a pesar de tener una estructura significativamente más zonalmente simétrica que el del hemisferio norte, presenta importantes asimetrías asociadas principalmente por las ondas planetarias de número de onda 1 y 3 (QS1 y QS3) [@Loon1972, @Trenberth1980a]. 




La variabilidad del clima en el sur de Sudamérica (SSA) es en gran parte influenciado remotamente por las condiciones del clima en las regiones tropicales y en las regiones extratropicales, desde escalas sinópticas e intraestacionales hasta escalas interanuales y más largas. [ej. @Vera2006]. Si bien la influencia tropical ha sido y es extensamente estudiada, aquella asociada con las fuentes de variabilidad en latitudes medias y subpolares no lo ha sido tanto. Esto se explica por los altos niveles de predictivilidad del clima de zonas tropicales (en escalas estacionales por el fenómeno del Niño-Oscilación del Sur (ENSO) y por la oscilación de Madden-Julian (MJO) en escalas intraestacionales) que en promedio decaen en latitudes más altas. 

Sin embargo, estudios recientes de la variabilidad climática en las regiones subpolares y polares del Hemisferio Sur (HS) destacan la actividad del Modo Anular del Sur (SAM, por sus siglas en inglés) como una fuente de variabilidad climática de significativa influencia sobre los continentes del HS y en particular del SSA [ej. @Silvestri2009 en escalas interanuales y @Alvarez2014 en escalas intraestacionales]. La distribución espacial del SAM en su fase positiva se caracteriza por una anomalía negativa de presión o altura geopotencial sobre el continente antártico y anomalías de signo opuesto en latitudes medias. Esta estructura zonalmente simétrica generalmente está asociada con un patrón de onda planetario de números de onda zonal entre 3 y 4 (conocido generalmente como “la onda 3” o por su sigla en inglés QS3). La alternancia del signo entre las anomalías polares y extratropicales del SAM se asocia con intensificaciones y debilitamiento de los vientos Oestes que caracterizan las latitudes medias del HS. Si bien hay evidencia de que los feedbacks en los flujos de cantidad de movimiento por las ondas planetarias de baja frecuencia son importantes en el proceso de debilitamiento de los Oestes [@Lorenz2001, @Simpson2013] las causas por las cuales estas variaciones se asocian con el desarrollo de la QS3 aún no se conocen con certeza. Teniendo en cuenta el impacto que su desarrollo tiene en el establecimiento y persistencia de condiciones climáticas en el SSA amerita esta investigación.

@Trenberth1985 mostraron una recurrencia importante en la ocurrencia de anticiclones de bloqueo simultáneos en diferentes regiones del HS (sur de Sudamérica, sur de Nueva Zelandia y porción central del Océano Indico) favorecida por el establecimiento de un patrón de QS3, aunque dejaron abierta la posibilidad de que éste se trate de un tren de ondas localizado en vez de una verdadera onda zonal. Desde ese momento hasta la actualidad diferentes estudios se concentraron en entender la influencia de los bloqueos sobre el clima de Sudamérica y su relación con la QS3 [ej. @Rao2004] o de su efecto en el hielo marítimo [ej. @Raphael2007a] pero, como se mencionó anteriormente, muy poca atención ha recibido el estudio de las causas que dan lugar al establecimiento de este patrón en un primer lugar. @Quintanar1995 realizaron experimentos de sensibilidad similares a los propuestos en este trabajo pero centrados en la QS1. Encontraron que las condiciones térmico-orográficas sobre la Antártida no eran suficientes para explicar la QS1 de latitudes subpolares, por lo que concluyen que forzantes remotos deberían jugar un papel. @Wang2013 encontraron que la destrucción y recuperación de la capa de ozono está asociada a un aumento y disminución de la actividad de onda plantaria respectivamente, pero su análisis no separa entre distintos números de onda. @Hobbs2010 ponen en duda la utilidad de analizar la circulación del hemisferio sur en ondas planetarias zonalmente simétricas y proponen que ésta está mejor caracterizada por un par de anticilones al sur de Nueva Zelanda y al sur de Sudamérica. 

Estudios sobre el flujo medio del HS muestran que éste tiende a ser más zonalmente simétrico que el del HN, sin embargo presenta importantes asimetrías asociadas principalmente por las ondas planetarias de número de onda 1 y 3 o QS3. Estas ondas zonales tienden a ser cuasi-estacionarias y exhiben importantes variabilidades temporales [ej. @Loon1972]. En particular, se ha documentado que la QS3 presenta una estructura barotrópica con variabilidad en escalas diarias-semanales [ej. @Kidson1988], estacionales [ej. @Mo1985] y más largas [ej. @Karoly1989]. @Mo1985 en particular mostraron que existen ubicaciones preferenciales para los centros de acción de la QS3. 



Por la antigüedad de estos trabajos, sus climatologías tienen limitaciones inherentes a la poca calidad de datos disponible en el HS previa a la era satelital. 

@Cai1999 evaluaron la habilidad del modelo CSIRO en representar la QS3 y encontraron que proporcionaba una representación adecuada de la misma. @Raphael1998 examinó la QS3 en el modelo CCM del NCAR (versiones 1 y 3) y encontró diferencias en cómo cada versión simulaba la QS3, siendo los resultados sensibles al grado de representación del modelo tanto de la interacción mar-atmósfera como de las condiciones de hielo marino en las zonas polares. Este es un resultado importante ya que a pesar de que la QS3 puede desarrollarse solamente por la dinámica interna de la atmósfera [ej. @Simpson2013], estos trabajos muestran que los modelos pueden reproducirla y que existen evidencias de que las condiciones superficiales pueden influenciar su actividad. Asimismo, @Raphael2003 encontró importantes variaciones interanuales experimentadas por la QS3 entre 1958 y 1996, aparentemente relacionadas con variaciones en la frecuencia del ENSO, que también influenciaron las asimetrías del SAM [@Fogt2012].



índices (no sé muy bien dónde ponerlo)

Múlitples trabajos elaboraron series temporales de la actividad de la QS3 para luego realizar correlaciones con otras variables. La mayoría de éstos índices en la literatura son definidos a partir del promedio de las anomalía zonales de geopotencial en tres puntos fijos cercanos a donde climatológicamente se dan los máximos de geopotencial asociados a la QS3 [ej, @Mo1985, @Cai1999 y @Raphael2004a]. Cada trabajo utiliza puntos ligeramente distintos a causa de las distintas climatologías analizadas y @Raphael2004a además utiliza valores trimestrales en vez de medias mensuales. Otra metodología, utilizada por @Yuan2008, es crear la serie temporal de actividad de la QS3 a partir de la primer componente principal del campo de viento meridional superficial, el cual resulta en un patrón de onda 3 consistente con climatologías previas.

La principal limitación de estos índices es que al ser estacionarios no permiten cambios de fase en la onda planetaria. En particular, no capturan correctamente el corrimiento estacional en la posición de la QS3 (de aproximadamente 15° entre verano e invierno) [@Loon1972] ni permiten capturar casos de actividad de onda intensa pero alejada de las zonas climatológicas. @Irving2015 construye un índice de actividad de onda planetaria a partir de la transformada de Hilbert que no tiene estas limitaciones pero no distingue entre la actividad de distintos números de onda. 



En consecuencia el objetivo general de este plan es entender los mecanismos que explican el desarrollo de la QS3 en la circulación del Hemisferio Sur. Los objetivos particulares son 

* caracterizar la climatología de la QS3,
* explorar la influencia de las condiciones oceánicas superficiales tanto en los trópicos como en los extratrópicos sobre la actividad de la QS3,
* explorar la sensibilidad de la QS3 en general a las condiciones superficie.


Esto de abajo se va a borrar?:

Muchas variables atmosféricas varían con la longitud en menor medida que con la latitud o la altura de manera que resulta natural descomponer cualquier variable $\phi_{(x, y, z, t)}$ en un promedio zonal y las desviaciones con respecto al mismo según:

$$
\phi_{(x, y, z, t)} = [\phi]_{(y, z, t)} + \phi_{(x, y, z, t)}^*
$$
donde los corchetes indican el promedio zonal y el asterísco indica el desvío con respecto al mismo. $[\phi]$ representa la circulación simétrica zonal y es independiente de la longitud mientras que $\phi^*$ representa la circulación asimétrica estacionaria.  

Estas ondas cuasiestacionarias (QS) representan una parte improtante de los flujos meridionales de calor y cantidad de movimiento junto con las ondas transcientes [@James] y en gran medida son forzadas por forzantes superficales como orografía y contrastes de temperatura así como por interacciones con los transcientes [@Rao2004]. 


# Datos y Metodologías 

En este capítulo se describen los datos utilizados en la presente investigación y las metodologías que se aplicaron.

## Datos

En los capítulos\ \ref{climatologia-observada} y\ \ref{onda-3} se analizan datos mensuales de altura geopotencial, temperatura, viento zonal, viento meridional y función corriente provenientes del Reanálisis NCEP/NCAR [@Kalnay1996] (de aquí en adelante NCEP) entre enero de 1985 y diciembre de 2015. Los mismos poseen una resolución de 2.5° en longitud y latitud y 17 niveles verticales entre 1000hPa y 10hPa. A partir de los datos mensuales se calcularon las medias estacionales definidas a partir de las estaciones climatológicas del hemisferio sur.

Se utilizó el modelo SPEEDY [@Molteni2003] para realizar corridas de sensibilidad (descriptas en el capítulo\ \ref{experimentos}). El modelo SPEEDY es un modelo de complejidad intermedia basado en ecuaciones primitivas espectrales y parametrizaciones simplificadas. En su versión 41, posee una truncación espectral hasta el número de onda 30 (equivalente a una resolución de 3.75° en longitud y latitud) y 8 niveles verticales entre 925hPa y 30hPa. 

Una primera gran limitación de SPEEDY es su pobre representación de la estratósfera. Sólo el más alto de sus 8 niveles está en la estatósfera (30hPa) y al ser la tapa del modelo, que tiene una "esponja" para evitar la propagación de ondas de gravedad, no es un nivel con información confiable. Esto limita seriamente la posibilidad de describir numéricamente lo que ocurre en la estratosfera, como por ejemplo la dinámica del vórtice polar. 


## Metodología

La caracterización de las ondas cuasiestacionarias a partir de Fourier puede realizarse descomponiendo los campos medios o calculando las características medias de la descomposición de los campos instantáneos (mensuales, en este caso). Si bien pueden dar resultados similares, ambas estrategias brindan distinta información. 

Al calcular la amplitud y la fase de cada onda planteria a partir de los campos medios, se obtiene una descripción de las ondas presentes en los campos medios y que sobreviven a la interferencia destructiva del promedio temporal. La amplitud y la fase media de los campos instantáneos, en cambio, indica las propiedades medias de las ondas planetarias independientemente de su fase. 

La primer metodología, entonces, brinda información sobre las ondas estacionarias, mientras que la segunda mezcla información de las anomalías zonales instantáneas que no necesariamente son estacionarias. Para los datos de NCEP, no se encontraron diferencias importantes entre ambas metodologías, por lo que se muestran los resultados sólo de la primera. 

Para la descomposición de los campos de geopotencial en modos de Fourier se utilizó la función `FitQsWave()` del paquete `metR` [@R-metR].

En la descomposición de Fourier, el estudio de la fase requiere un tratamiento especial ya que se trata de una variable circular. Para el cálculo de estadísticas circulares se se utilizó el paquete `circular` [@R-circular].

El análisis de wavelets es similar a Fourier pero permite describir oscilaciones localizadas en el dominio [@Torrence1998]. En el contexto de las ondas cuasiestacionarias, esto implica que en vez de obtener una amplitud y fase por cada círculo de latitud, se tiene una amplitud local que depende de la longitud. En la ciencias atmosféricas el análisis de wavelets se usa extensivamente en el análisis de periodicidades en el dominio tiempo [ej. @Raphael2004, @Kinnard2011] y de procesamiento de imágenes [ej. @Desrochers1999], pero existen pocos estudios que lo apliquen a dominios espaciales [ej. @Pinault2016] aunque sí hay aplicaciones de este tipo en la literatura de ecología [ej, @Mi2005]. 

Para el cálculo de wavelets se utilizó la función `WaveletTransform()` del paquete `WaveletComp`[@R-WaveletComp] que utiliza un wavelet de Morlet.

El flujo de actividad de onda es un vector que, bajo ciertas suposiciones, es paralelo a la velocidad de grupo de las ondas de Rossby [@James]. En este estudio se la calculó a partir de las anomalías zonales de función corriente según

$$
\begin{aligned}
F_\lambda &= \frac{p}{2000a^2\cos\phi}\left[ \left( \frac{\partial \psi^*}{\partial \lambda} \right)^2 - \psi^*\frac{\partial^2 \psi^*}{\partial \lambda^2}  \right] \\
F_\phi &= \frac{p}{2000a^2} \left( \frac{\partial \psi^*}{\partial \lambda}\frac{\partial \psi^*}{\partial \phi}  - \psi^* \frac{\partial^2 \psi^*}{\partial \lambda \partial \phi} \right) 
\end{aligned}
$$

donde $p$ es la presión, $\phi$ la latidud, $\lambda$ la longitud, $a$ es el radio de la Tierra (tomado como 6371km) y $\psi^*$ es la anomalía zonal de la función corriente [@Vera2004]. 

El análisis de componentes principales se realizó mediante la `EOF()` del paquete `metR` [@R-metR], la cual realiza una descomposición en valores singulares de la matriz de datos. Este método es preferible al cálculo de autovalores y autovectores sobre la matriz de correlación o covarianza ya que es numéricamente más estable (¿cita?). Los datos de geopotencial fueron pesados por la raiz cuadrada del coseno de la latitud.

Se calcularon campos de anomalía zonal de geopotencial eliminando la influencia de las ondas planetarias 1 y 2. Para esto se reconstruyeron los campos de anomalía zonal de geopotencial de QS1 y QS2 mediante Fourier y luego se restaron al campo de anomalía zonal total. 


```{r fitqs-ncep}
ncep.qs.all <- ncep[, FitQsWave(gh, k = 1:4), by = .(lat, lev, date)]
```



# Climatología observada

En este capítulo se presentan campos medios y anomalías zonales de altura geopotencial, temperatura, viento zonal, viento meridinal, función corriente, gradiente meridional de vorticidad absoluta y el número de onda estacionario, como introducción general al estado medio de la atmósfera sobre el cual se desarrollan las ondas estacionarias. Luego se analizan los campos de amplitud y varianza explicada por las ondas cuasiestacionarias (QS) en sí mismas. 

## Altura geopotencial

Campo medio:

```{r gh-ncep, fig.class = "fullpage", fig.cap = "Campo de Z (NCEP)"}
plot.levs <- c(500, 300, 200, 100, 50)
binwidth <- 250
ggplot(ncep.mean.season[lev %in% plot.levs], aes(lon, lat)) +
    geom_contour_fine(aes(z = gh), binwidth = binwidth, color = "black") +
    map.SH +
    geom_label_contour2(aes(z = gh, label = ..level..), binwidth = binwidth,
                        size = 1.6) +
    scale_s_map() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap() 
```

El campo de altura geopotencial media (Z, \autoref{fig:gh-ncep}) muestra una estructura marcadamente zonal en todos los niveles y estaciones. En verano el gradiente meridional de Z es máximo en 200hPa, reduciéndose en 500hPa y por encima de 100hPa. En 50hPa el gradiente es prácticamente nulo y en niveles superiores, éste se invierte en comparación a los inferiores (no se muestra). En otoño el máximo de gradiente todavía se da en 200hPa, pero continua siendo intenso en niveles superiores. En invierno y primavera, el mayor gradiente se da en 50hPa y es mucho más intenso que los observados en los demás niveles o estaciones. En contraste con el resto de los niveles, 50hPa y 100hPa tienen mucha más variabilidad estacional. 

El aumento del gradiente meridional de geopotencial en invierno y primavera en niveles altos está relacionado con la generación del vórtice polar\todo{cita} que aisla las latitudes polares de las latitudes medias. En 200hPa, en cambio, es evidente el gradiente asociado con el jet subtropical, que es más intenso en invierno y más débil en verano.

```{r ghdy-ncep-corte, fig.cap = "Gradiente meridional de Z", fig.publish = FALSE}
ncep.mean.season[, mean(gh), by = .(lat, lev, season)] %>% 
    .[, gh.dy := Derivate(V1 ~ lat), by = .(lev, season)] %>% 
    # .[, .(gh.dy = mean(gh.dy, na.rm = T)), by = .(lev, season)] %>% 
    # ggplot(aes(lev, gh.dy, color = season)) +
    # geom_line() + 
    # scale_x_level() +
    # coord_flip()
    ggplot(aes(lat, lev)) +
    geom_contour_fill(aes(z = gh.dy), binwidth = 10, na.rm = T) +
    surface +
    scale_fill_divergent() +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(trans = "reverse") +
    coord_latlev() +
    facet_wrap(~season)
```

En la \autoref{fig:sd-gh.ncep} se muestra, para cada latitud y mes, el desvío estándar de la altura geopotencial con respecto a la media zonal ($\sigma_z$). En todos los niveles la variación meridional es muy similar con un máximo principal al rededor de 60°S durante todo el año y un máximo secundario en 30°S que aparece sólo entre junio y septiembre. El ciclo anual de $\sigma_z$ también es similar entre niveles aunque con marcadas diferencias. En 100hPa el máximo absoluto se da en octubre, mientras que en los niveles más bajos, éste se da en agosto. 

```{r sd-gh-ncep, fig.class = "textwidth", fig.cap = "Desvío estándar por círculo de latitud."}
binwidth <- 15
ncep.mean[lev %in% plot.levs & !(lev %in% c(50)), .(sd = sd(gh.z)), by = .(lat, lev, month)] %>% 
    ggplot(aes(month, lat)) +
    stat_contour(aes(z = sd, color = ..level..), binwidth = binwidth,
                 size = 0.3) +
    # geom_contour(aes(z = sd), binwidth = binwidth) +
    scale_color_viridis_c(name = "Desvío estándar de Z* por círculo de latitud",
                          breaks = MakeBreaks(binwidth),
                          guide = guide_colorstrip_bottom(inside = T)) +
    scale_y_latitude(name = "latitud", limits = c(-90, 0)) +
    scale_x_continuous(name = "mes", breaks = 1:12, labels = month.abb_sp, 
                       expand = c(0, 0)) +
    facet_wrap(~lev, scales = "free", labeller = labeller(lev = AddSuffix(" hPa")))
```

```{r ghz-ncep, fig.class = "fullpage", fig.cap = "Anomalía zonal de altura geopotencial."}
binwidth <- 20
cutlat <- -60
ggplot(ncep.mean.season[lev %in% plot.levs], aes(lon, lat)) +
    geom_contour_fill(aes(z = gh.z), binwidth = binwidth, exclude = 0) +
    # geom_hline(yintercept = cutlat, linetype = 2, size = 0.5) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(binwidth = binwidth, name = "Z*", exclude = 0, 
                         guide = guide_colorstrip_bottom(25)) +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap()
```

Las anomalías zonales de geopotencial (Z\*, \autoref{fig:ghz-ncep}) muestran una preponderancia de la onda 1 (QS1) con una amplitud máxima en la estratósfera de primavera. Pueden diferenciarse dos QS1 distintas; una centrada en ~60°S y con el centro anticiclónico al rededor de la línea de fecha, y la otra centrada en 75°S sobre la costa del continente antártico y el centro anticiclónico entre 120 y 60°O. @Quintanar1995 concluyeron que la primer QS1 está asociada principalmente con forzantes de latitudes bajas mientras que la segunda responde a la orografía del continente antártico. 

En latitudes tropicales, en verano hay una anomalía negativa sobre el Pacífico este con máxima amplitud en 200hPa que está presente en las otras estaciones con menor intensidad. Sobre Sudamérica, en verano y primavera en ese mismo nivel aparece un centro anticiclónico con un centro ciclónico al noroeste. Estas anomalías (la alta de Bolivia y la baja del noroeste) son características del Sistema Monzónico Sudamericano [@Vera2006].

En la \autoref{fig:ghz-ncep-corte60} se muestra un corte zonal en 60°S de Z\*. Se aprecia la coherencia vertical de la QS1 y es evidente la inclinación hacia el oeste con la altura en todas las estaciones salvo en verano, en coincidencia con lo encontrado por @Quintanar1995a. @Karoly1985 describió una estructura equivalente barotrópica tanto en verano como en invierno en 55°S, pero esto se debe a la falta de niveles verticales por encima de los 100hPa que es donde la inclinación es más importante.

La inclinación hacia el oeste con la latitud (\autoref{fig:ghz-ncep}) y con la altura (\autoref{fig:ghz-ncep-corte60}) indican que las perturbaciones estacionarias están asociadas con transporte hacia el polo tanto de cantidad de movimiento zonal como de temperatura, por las perturbaciones [@James]. En verano las anomalías zonales tienen una estructura barotrópica equivalente y carecen de inclinación en la horizontal, así como los transportes meridionales asociados se reducen considerablemente en la estratósfera. \todo{¿Por qué?}

```{r ghz-ncep-corte60, fig.class = "textwidth", fig.cap = "Corte zonal de anomalía de geopotencial en -60°."}
binwidth <- 60
ggplot(ncep.mean.season[lat %~% -55], aes(lon, lev)) +
    geom_contour_fill(aes(z = gh.z), binwidth = binwidth, exclude = 0) +
    scale_fill_divergent(binwidth = binwidth, exclude = 0, name = "Z*",
                         guide = guide_colorstrip_bottom(width = 25)) +
    scale_y_level(breaks = plot.levs, minor_breaks = NULL) +
    # scale_y_reverse() +
    scale_x_longitude(name = "longitud") +
    coord_lonlev() +
    facet_wrap(~season)
```


```{r uzvz-ncep-corte, fig.cap = "Transportes", fig.subcap = c("u*v*", "T*v*"), fig.publish = FALSE}
ncep[, mean(u.z*v.z), by = .(lat, lev, season(date))] %>% 
    ggplot(aes(lat, lev)) +
    geom_contour(aes(z = V1, color = ..level..), binwidth = 5) +
    scale_color_divergent(breaks = MakeBreaks(5)) +
    scale_y_level() +
    scale_x_latitude(trans = "reverse") +
    coord_latlev() +
    facet_wrap(~season)

ncep[, mean(v.z*t.z), by = .(lat, lev, season(date))] %>% 
    ggplot(aes(lat, lev)) +
    geom_contour(aes(z = V1, color = ..level..)) +
    scale_color_divergent(breaks = MakeBreaks()) +
    scale_y_level() +
    scale_x_latitude(trans = "reverse") +
    coord_latlev() +
    facet_wrap(~season)

```

## Temperatura

```{r t-ncep, fig.class = "fullpage", fig.cap = "Temperatura media."}
binwidth <- 5
ggplot(ncep.mean.season[lev %in% c(plot.levs, 850)], aes(lon, lat)) +
    geom_contour(aes(z = t), binwidth = binwidth, color = "black") +
    geom_label_contour2(aes(z = t, label = ..level..), binwidth = binwidth) +
    geom_tile(data = copy(pres)[, lev := 850][pres < 850], fill = "white", color = "white") +
    map.SH +
    scale_s_map() +
    coord_quickmap() +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
```

La distribución horizontal de la temperatura media (\autoref{fig:t-ncep}), al igual que la altura geopotencial media, tiene una estructura principalmente zonal en todos los niveles y estaciones. Por debajo de los 200hPa, donde el gradiente meridional de temperatura es mínimo, la temperatura disminuye con la latitud en todas las estaciones. Por encima de este nivel, en cambio, en verano la temperatura crece con la latitud, y en el resto de las estaciones muestra un máximo centrado en 60°S en otoño y en 45°S en invierno y primavera. El nivel de 850hPa se ven las asimetrías zonales más importantes  asociadas con los contrastes de temperatura entre continente y océanos, como el máximo sobre Australia en verano.

En 300hPa, el gradiente meridional de temperatura en latitudes medias tiene un importante ciclo anual con máximo en invierno y mínimo en verano. En niveles inferiores, el ciclo anual es menos marcado y más dependiente de la latitud. En 500hPa, en 150°E en 30°S se da un máximo del gradiente meridional de temperatura en invierno con mínimo en verano mientras que en 45°S el ciclo es el inverso.

```{r t-ncep-corte, fig.class = "textwidth", fig.cap = "Corte meridional de temperatura media."}
binwidth <- 10

ggplot(ncep.mean.season[, .(t = mean(t)), by = .(lat, lev, season)],
       aes(lat, lev)) +
    geom_contour_fill(aes(z = t), binwidth = binwidth) +
    surface +
    scale_y_level(breaks = plot.levs, minor_breaks = NULL) + 
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_viridis_c(name = "Temperatura media zonal", 
                         breaks = MakeBreaks(binwidth), 
                         guide = guide_colorstrip_bottom()) +
    coord_latlev() +
    facet_wrap(~season)
```

El promedio zonal de la temperatura se muestra en la \autoref{fig:t-ncep-corte}. Al norte de los 45° durante todo el año la tempertura decrece con la altura por debajo de los 100hPa aproximadamente, donde alcanza un mínimo que marca la tropopausa, y crece por encima. La altura del mínimo de temperatura varía mucho al sur de los 45°, siendo mínima en verano (300hPa) y máxima en invierno y otoño (30hPa). Hay que tener encuenta, sin embargo, que la tropopausa no está bien definida en el invierno Antártico [@Court1942 @Zangl2001] por lo que el uso de la tropopausa térmica no es conveniente. @Zangl2001, utilizando datos de ERA para el período 1979-93, encontraron que la tropopausa térmica varía entre los 320hPa en enero y los 170hPa en agosto aunque advierten que el uso del criterio término es "problemático" en el invierno antártico. 

```{r tz-ncep, fig.class = "fullpage", fig.cap = "Anomalía zonal de temperatura."}
binwidth <- 1

copy(pres)[ncep.mean.season[lev %in% c(plot.levs, 850)], 
           on = c("lon", "lat")] %>% 
    .[, t.z := NULL] %>% 
    .[lev < pres, t.z := Anomaly(t), by = .(lat, lev, season)] %>%  
    ggplot(aes(lon, lat)) +
    stat_contour_fill(aes(z = t.z), binwidth = binwidth, exclude = 0) +
    geom_tile(data = copy(pres)[, lev := 850][pres < 850],
              fill = "white", color = "white") +
    # geom_hline(yintercept = cutlat, linetype = 2, size = 0.5) +
    map.SH +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         limits = c(-9, NA),
                         name = "T*",
                         guide = guide_colorstrip_bottom(25)) +
    scale_y_latitude() +
    scale_x_longitude() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap() 
```

En la \autoref{fig:tz-ncep} se muestran las anomalías zonales de temperatura media. En 850hPa se aprecia el efecto del contraste de temperatura entre el suelo y el mar. Se observan anomalías positivas sobre los continentes y negativas sobre los océanos en todas las estaciones, aunque más intensas en verano y primavera. En niveles más altos éstas pierden su intensidad pero reaparecen en 100hPa con signo invertido. Estas características tienen su correlato en la altura geopotencial y corresponden a circulaciones tipo Walker \todo{¿Es así?}. 

En invierno y primavera, los niveles altos están dominados por una QS1 con máximo en el sur de Australia y mínimo en el Atlántico sur. En niveles más bajos, la onda disminuye su amplitud y se defasa hacia el este y queda casi en cuadratura con la onda de niveles altos (\autoref{fig:t-ncep-corte60}) presentando un máximo en 850hPa en Antártida occidental. En otoño esta onda está presente pero con amplitud muy reducida y máxima en niveles medios. Finalmente, en verano ésta desaparece por encima de 100hPa. 

```{r t-ncep-corte60, fig.class = "textwidth", fig.cap = "Corte zonal de anomalía de temperatura en -60°."}
binwidth <- 1
ggplot(ncep.mean.season[lat %~% cutlat], aes(lon, lev)) +
    stat_contour_fill(aes(z = t.z), binwidth = binwidth, exclude = 0) +
    scale_fill_divergent(binwidth = binwidth, exclude = 0, name = "T*",
                         guide = guide_colorstrip_bottom(width = 25)) +
    scale_y_level(breaks = plot.levs, minor_breaks = NULL) +
    # scale_y_reverse() +
    scale_x_longitude(name = "longitud") +
    facet_wrap(~season)
```

En la \autoref{fig:t-nceo-corte60} se muestra un corte vertical-zonal en 60°S de la anomalía zonal de temperatura. En invierno y primavera la estructura vertical tiene una inclinación hacia el oeste con la altura por encima de los 300hPa, pero es barotrópica equivalente por debajo de ese nivel. 

## Viento zonal

```{r u-ncep-corte, fig.class = "textwidth", fig.cap = "Viento zonal medio."}
ncep.mean.season[, .(u = mean(u)), by = .(lat, lev, season)] %>% 
    ggplot(aes(lat, lev)) +
    geom_contour_fill(aes(z = u), binwidth = 5) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = 15) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = 5, size = 0.1) +
    # geom_label_contour2(aes(z = u, color = ..level.., label = ..level..),
    # binwidth = 15, skip = 0) +
    surface +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_divergent(name = "U media zonal", 
                         breaks = MakeBreaks(5),
                         guide = guide_colorstrip_bottom()) +
    coord_latlev() +
    facet_wrap(~season)
```

La media zonal del viento zonal (\autoref{fig:u-ncep-corte}) muestra dos máximos, uno en latitudes medias en 200hPa y otro en latitudes plares en la estatósfera, correspondientes al jet subtropical y subpolar, respectivamente. El primero está presente durante todo el año aunque con mayor intensidad y corrido hacia latitudes más ecuatoriales en invierno y primavera. El segundo está presente principalmente en invierno y primavera, e incipiente en otoño. Además enn la estratósfera se observan vientos del este en latitudes bajas que son más intensos en verano y otoño. 

```{r u-ncep, fig.class = "fullpage", fig.cap = "Viento zonal."}
ggplot(ncep.mean.season[lev %in% plot.levs], aes(lon, lat)) +
    geom_contour_fill(aes(z = u), binwidth = 5, exclude = 0) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = 5, size = 0.7) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = 5, size = 0.1) +
    # geom_contourlabel(aes(z = u, color = ..level..), binwidth = 15, step = 1,
    # size = 3, vjust = "inward", hjust = "inward") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(name = "U", breaks = MakeBreaks(5),
                         guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
```

En la \autoref{fig:u-ncep} se observa que el jet subpolar es más intenso al sur de África, donde además se encuentra en una latitud más ecuatorial que en la región del Pacífico. El jet subtropical también tiene un máximo al sur de África y otro al norte de Nueva Zelanda --especialmente en invierno--, donde además se produce una bifurcación del jet. Se trata de una región de persistentes y frecuentes bloqueos [ej. @Trenberth1985].

Esta bifurcación del jet sobre Nueva Zelanda se evidencia en el campo de anomalías zonales de viento zonal (\autoref{fig:uz-ncep}) como anomalías negativas durante todo el año. Este campo también presenta varios pares de QS1 antisimétricos respecto a 60°S. Estas anomalías se corresponden con la variación meridional del jet observado en la \autoref{fig:u-ncep} y son consistentes con la QS1 de geopotencial observada en la \autoref{fig:ghz-ncep}, las cuales generan viento zonal anómalo del este y del oeste al norte y sur del anticiclón respectivamente.

En verano, entre 300hPa y 100hPa sobre el Pacífico ecuatorial existe una zona de anomalías del viento zonal positivas al este y negativas al oeste. Consistente con los campos de temperatura, esto implica divergencias en niveles altos y convergencias en niveles bajos (no se muestra). Evidencia de la circulación tropical forzada por la temperatura superficial del pacífico.\todo{buscar cita.}

```{r uz-ncep, fig.class = "fullpage", fig.cap = "Anomalía zonal de viento zonal."}
binwidth <- 2.5
ggplot(ncep.mean.season[lev %in% plot.levs], aes(lon, lat)) +
    stat_contour_fill(aes(z = u.z), binwidth = binwidth, exclude = 0) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth), name = "U*", 
                         guide = guide_colorstrip_bottom()) +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap()
```

Los campos de viento zonal, temperatura y altura geopotencial están ligados por el balance de viento geostrófico y de viento térmico. El máximo del jet se encuentra en regiones de máxima baroclinicidad y máximo gradiente meridional de Z y donde el gradiente meridional de temperatura se anula. 

## Viento meridional


```{r v-ncep-corte, fig.class = "textwidth", fig.cap = "Media zonal del viento meridional."}
binwidth <- 0.5
ggplot(ncep.mean.season[lev >= 30, .(v = mean(v)), by = .(lat, lev, season)],
       aes(lat, lev)) +
    stat_contour_fill(aes(z = v), binwidth = binwidth, exclude = 0) +
    surface + 
    scale_y_level(breaks = unique(ncep.mean.season$lev), minor_breaks = NULL) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_divergent(name = "V media zonal", 
                         breaks = MakeBreaks(binwidth, 0), 
                         guide = guide_colorstrip_bottom()) + 
    coord_latlev() +
    facet_wrap(~season)
```

El corte vertical-meridional del promedio zonal viento meridional medio (\autoref{fig:v-ncep-corte}) muestra los máximos tropicales presentes en superficie y altura en todas las estaciones, relacionados con la circulación de Hadley. En verano, la rama ascendente se encuentra en el hemisferio sur y se tiene convergencias en niveles bajos y divergencias en niveles altos. En invierno, en cambio, sólo se ve la rama descendente, mucho más intensa que en verano, que genera convergencias en niveles altos y divergencias en niveles bajos al rededor de los 30°S. 

Presente durante todo el año, también se observa un maximo de vientos del sur en la costa antártica. Esta es la señal de los vientos catabáticos antárticos producidos por una capa muy estable cerca de superficie y la consistente inclinación de la topografía del continente.\todo{cita para esto}. Aunque los datos allí pueden tener limitaciones por la falta de observaciones y la representación de la orografía.

```{r v-ncep, fig.class = "fullpage", fig.cap = "Viento meridional medio."}
binwidth <- 2
ggplot(ncep.mean.season[lev %in% c(850, plot.levs)], aes(lon, lat)) +
    geom_contour_fill(aes(z = v), binwidth = binwidth, exclude = 0) +
    # geom_contour(aes(z = v, color = ..level..), binwidth = 1, size = 0.1) +
    # geom_contourlabel(aes(z = v, color = ..level..), binwidth = binwidth, step = 1,
    # size = 3, vjust = "inward", hjust = "inward") +
    # geom_tile(aes(fill = v)) +
    geom_tile(data = copy(pres)[, lev := 850][pres < 850], fill = "white",
              color = "white") +
    map.SH +
    
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(name = "V", breaks = MakeBreaks(1),
                         guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
```

Los campos horizontales de V se muestran en la \autoref{fig:v-ncep}. Consistente con los campos de Z\* (\autoref{fig:ghz-ncep}), en niveles altos se observa una QS1 que alcanza su máximo en la estratósfera de primavera.

En invierno entre 500hPa y 100hPa, existe evidencia de un tren de ondas de Rossby que se propaga desde el Índico occidental sudeste llegando a su máxima latitud en 150°O donde comienza a propagarse hacia el norte hasta llegar al sur de Sudamérica. Este tren de ondas puede identificarse en el campo de Z\* (\autoref{fig:ghz-ncep}), pero con mayor dificultad debido a la interferencia de la QS1 y a la dependencia de Z\* con el parámetro de Coriolis, es decir, la latitud. El tren de ondas se distingue en la troposfera alta, también en primavera y con menor intensidad en verano y otoño.

Las anomalías zonales del viento meridional también permiten distinguir otras características cuasiestacionarias del clima, como aquellas asociadas con los monzones. En el invierno, en los trópicos se puede observar la anomalía positiva en 850hPa en la costa oeste de África asociada con el flujo hacia el monzón de la India. En altura, el monzón de la India se evidencia en esa estación como anomalía de viento hacia el sur producto de la divergencia de niveles altos generada por la convección anómala. Por otra parte, en verano se evidencia en la troposfera alta sobre Sudamérica tropical anomalías positivas sobre el centro-este del continente y negativas en los océanos subyacentes. Tal patrón de ondas estacionario se relaciona con la presencia del Alta de Bolivia y las vaguadas estacionarias a sus lados, siendo la del este típicamente llamada la Baja del Nordeste [@Vera2006].

No se muestran los campos de anomalías zonales de V ya que son virtualmente idénticos a los campos de V porque la media zonal de esta variable es virtualmente nula en todo el dominio. 

```{r ghminus1-ncep, fig.class = "fullpage", fig.publish = FALSE, fig.cap = "Z* menos QS1."}
ncep.mean.season[lev == 200] %>% 
    .[, c("ampl", "phase") := FitQsWave(gh, k = 1)[1:2], 
      by = .(lat, lev, season)] %>%
    .[, qs1 := BuildQsField(lon*pi/180, ampl, phase, k = 1), 
      by = .(lat, lev, season)] %>% 
    .[, gh.minus := gh.z - qs1] %>% 
    .[lev %in% plot.levs] %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = gh.minus)) +
    map.SH +
    scale_fill_divergent() +
    coord_quickmap() + 
    facet_grid(lev~season)
```


## Función corriente

```{r read-psi}
stream <- ReadNetCDF("DATA/NCEP/stream.mon.mean.nc") %>% 
    setnames(c("level", "time"), c("lev", "date")) %>% 
    .[lat <= 40]
stream[, psi.z := Anomaly(psi), by = .(lat, date)]
stream[, date := as.Date(date), by = date]
stream.mean.season <- stream[, .(psi = mean(psi),
                                 psi.z = mean(psi.z)), 
                             by = .(lon, lat, lev, season(date))]

stream.mean.season[, c("f.lon", "f.lat") := WaveFlux(.SD), by = season]
```


```{r psi-ncep,  fig.class = "fullpage", fig.cap = "Función corriente x 1099"}
ggplot(stream.mean.season,aes(lon, lat)) +
    stat_contour_fill(aes(z = psi.z*10^-9), binwidth = 0.005, 
                      complete = FALSE, exclude = 0) +
    geom_contour_fine(aes(z = psi*10^(-9)), color = "black", binwidth = 0.02) +
    geom_vector(aes(dx = f.lon, dy = f.lat), skip = 3, min.mag = 0.05, 
                scale = 50, size = 0.2) +
    geom_map2(data.world[lat < 30]) +
    scale_x_longitude() +
    scale_y_latitude() +
    scale_fill_divergent(breaks = MakeBreaks(0.005, 0), 
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) +
    theme(axis.title = element_blank()) + 
    coord_quickmap(ylim = c(-90, 30))
```

Para analizar la influencia tropical en la circulación no es posible usar la altura geopotencial, ya que el balance geostrófico pierde validez cerca del ecuador. Por lo tanto, es útil analizar el campo de función corriente ($\psi$). El reanálisis de NCEP provee esta variable en niveles sigma en vez de presión. En la \autoref{fig:psi-ncep} se muestra $\psi$ en el nivel 0.2101 sigma, que equivale aproximadamente a 250hPa. Además del campo medio, se muestran las anomalías zonales en sombreado y los flujos de actividad de onda en flechas. 

Las características del campo de $\psi$, tanto el total como las anomalías zonales, es similar al de Z (\autoref{fig:gh-ncep}, 200hPa) con una estructura eminentemente zonal y un aumento del gradiente meridional en invierno y primavera y los mismos centros de anomalías. La principal diferencia es, además del cambio de signo dada por la dependencia de $\psi$ con f, es que los patrones presentes en las latitudes tropicales se ven con mayor magnitud que los de latitudes medias y altas. 

Los flujos de actividad de onda en verano muestran transporte de energía desde el Pacífico este hacia el sur de África pasando por el Atlántico que se sostiene durante todo el año con menor intensidad. Desde ese lugar también se observa transferencia de energía hacia el hemisferio norte, que se junta con otra región de flujos intensos que viene desde el Pacífico oeste. Sobre el Índico, los flujos son de mayor magnitud en invierno transportando energía hacia el sur. 

## Propagacion Meridional de Ondas de Rossby

En la teoría de propagación meridional de ondas de Rossby, el gradiente meridional de vorticidad absoluta ($\psi_y$) \todo[inline]{es importante porque blavalbla ¿Resumen de la deducción en James?}

```{r calc-eta-ncep}
ncep.mean.season[, zeta := Vorticity(u + v ~ lon + lat, cyclical = TRUE,
                                     sphere = TRUE), 
                 by = .(lev, season)]
ncep.mean.season[, zeta.dy := Derivate(zeta ~ lon + lat, 
                                       cyclical = c(FALSE, FALSE),
                                       sphere = TRUE)[[2]],
                 by = .(lev, season)]

ncep.mean.season[, eta.dy := zeta.dy + f.dy(lat)]
ncep.mean.season <- ncep.mean.season
```

```{r etady-ncep, fig.class = "fullpage", fig.cap = "Gradiente meridional de vorticidad absoluta * 1e11"}
mult <- 1e11
binwidth <- 1e-11*mult
ggplot(ncep.mean.season[lev %in% plot.levs & lat > -85], 
       aes(lon, lat, z = eta.dy*mult)) +
    stat_contour_fill(binwidth = binwidth) +
    stat_contour_fill(breaks = 0, 
                      fill = "grey80", alpha = 0.5, complete = FALSE) +
    geom_contour_fine(breaks = 0, color = "black") +
    # stat_contour(aes(z = eta.dy), breaks = 0, geom = "polygon",
    # fill = "grey50", alpha = 0.5) +
    map.SH +
    # polar.SH + 
    scale_fill_divergent(name = "Gradiente meridional de vorticiad absoluta", 
                         guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    scale_s_map() +
    coord_quickmap() +
    # coord_polar() + 
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab))
```


La \autoref{fig:etady-ncep} muestra el campo de $\psi_y$ con una región con valores negativos centrada sobre Nueva Zelanda, en invierno entre 300hPa y 200hPa, coincidiendo con la región de bloqueos. Está flanqueada por el jet subtropical intenso y el jet subpolar más al sur, dando lugar a gradientes meridionales de U negativos más intensos que $\beta$. Otras regiones con valores negativos se distinguen en la costa antártica.

Valores de $\psi_y$ negativos son un factor que impiden la propagación meridional de ondas de Rossby barotrópicas. Esta figura reproduce y extiende el resultado de @Berbery1992 (su Figura\ 3) utilizando 5 años de análisis objetivo del Centro Europeo de Predicción a Plazo Medio (ECMWF). Asimismo, aún con $\psi_y$ positivo, las ondas de Rossby barotrópicas sólo se pueden propagar si su número de onda zonal es menor que el número de onda estacionario [@James]. En la \autoref{fig:ks-ncep} se muestra el número de onda estacionario para el nivel de 200hPa. Entre otoño y primavera, se destaca claramente la región del Pacífico Oeste en la cual la propagación meridional está inhibida. Además, en todas las estaciones, las ondas cortas no pueden propagarse meridionalmente en latitudes altas. La \autoref{fig:ks-ncep} muestra que las ondas de Rossby barotrópicas con k menores o iguales a 3 pueden propagarse meridionalmente en las cuatro estaciones hasta aproximadamente los 60°S, excepto en la franja de longitudes entre 60°E y 120°O, donde quedan atrapadas al sur de 45°S (excepto en verano).

La \autoref{fig:ks-ncep-corte} se muestra un corte vertical en 180° del número de onda estacionario. Se observa que en la troposfera alta se dan las condiciones para la propagación desde latitudes más bajas hasta las subpolares. Además se destaca que la zona de inhibición de la propagación meridional es una característica de la troposfera alta solamente, lo que confirma de alguna manera el papel del jet subtropical en producirla.  

```{r ks-ncep, fig.cap = "Número de onda estacionario en 200hPa.", fig.class = "fullpage"}
a <- 6371000

ncep.mean.season[, k := sqrt(eta.dy/u)*(a*cos(lat*pi/180))]
ncep.mean.season <- ncep.mean.season[, k.full := ifelse(is.na(k) | k > 10, -1, k)]

ggplot(ncep.mean.season[lev == 200], aes(lon, lat)) +
    geom_contour_fine(aes(z = k), breaks = 0:9, color = "black") +
    geom_label_contour2(aes(z = k, label = ..level..),
                        breaks = 0:9, skip = 0) +
    stat_filter(aes(filter = !is.finite(k)), geom = "tile", color = "gray50",
                fill = "gray50") +
    map.SH +
    scale_s_map() +
    coord_quickmap() +
    facet_wrap(~season)
```


```{r ks-ncep-cortelev, fig.publish = FALSE, fig.cap = "Número de onda estacionario en 180°"}
ggplot(ncep.mean.season[lon %~% 180], aes(lat, lev))+
    geom_contour_fine(aes(z = k), breaks = 0:9, color = "black") +
    geom_label_contour2(aes(z = k, label = ..level..),
                        breaks = 0:9, skip = 0) +
    geom_contour_fill(aes(z = k.full), breaks = c(0, -0.5), 
                      complete = F, fill = "gray80") +
    surface +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(trans = "reverse") +
    coord_latlev() +
    facet_wrap(~season) 
```


## Ondas Quasiestacionarias

Como se describió en \autoref{métodos-y-materiales}, el análisis estacional de la amplitud y $r^2$ de Fourier puede hacerse a partir de la media delos campos mensuales o aplicando Fourier a los campos estacionales. En el caso de los datos de NCEP existe poca diferencia, por lo que sólo se muestran los resultados conseguidos mediante esta última metodología. 


La \autoref{fig:r2-ncep} muestra el corte vertical-meridional de $r^2$ de Fourier para las ondas estacionarias 1 a 4. Consistente con lo encontrado previamente en el campo de Z\*, la QS1 explica la mayor parte de la variabilidad en todo el dominio al sur de los 45°S. La QS2 es preponderante en la estratósfera ecuatorial, en la costa antártica y alrededor de 35°S, donde es el modo dominante en toda la columna de aire en verano. La QS3, a diferencia de las ondas anteriores es importante en una región reducida. Explica una parte substancial de la varianza en niveles bajos al rededor de los 45°S y mayormente en invierno. La QS4 explica muy poca varianza a excepción de cerca de superficie entre 15°S y 30°S. Ondas más cortas son aún menos importantes (no se muestra). 

```{r r2-ncep, fig.class = "fullpage", fig.cap = "$R^2$ de Fourier."}
rect.annotation <- data.frame(latmin = -65, latmax = -40,
                              levmin = 100, levmax = 700, 
                              k = 3)
ncep.qs <- ncep.mean.season[, FitQsWave(gh, k = 1:4), 
                            by = .(lat, lev, season)] 

binwidth <- 0.1
ggplot(ncep.qs, aes(lat, lev)) +
    stat_contour_fill(aes(z = r2), binwidth = binwidth, na.rm = T) +
    surface +
    geom_index.region(rect.annotation) +
    scale_fill_viridis_c(name = expression(R^2), limits = c(0, 1),
                         breaks = MakeBreaks(binwidth), 
                         guide = guide_colorstrip_bottom(),
                         option = "D") +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse", 
                     ticks = 15) +
    coord_latlev() +
    facet_grid(k ~ season, labeller = labeller(k = qs.lab))
```

El $r^2$ permite analizar la importancia relativa de cada modo con respecto a la variabilidad total, pero lo que importa desde el punto de vista físico es la amplitud de la onda. La \autoref{fig:ampl-ncep} muestra cortes verticales-meridionales de la amplitud. Las diferencias entre los campos de $r^2$ y los de amplitud son evidentes comparando con la \autoref{fig:ampl-ncep} (notar la escala logarítmica en los colores). La amplitud de la QS1 muestra un máximo bien definido centrado en 60°S que en verano se encuentra en niveles más bajos que en las otras estaciones. También existe un máximo relativo entre 15°S y 30°S en verano que migra a latitudes más altas en invierno y primavera. El mismo está presente también en las otras ondas estacionarias. 

En el caso de la QS2, se evidencia que a pesar de tener máximos de $r^2$ en la estratósfera al norte de 45°S, alcanza su máxima amplitud al sur de esa latitud y en 200hPa en verano y en 30hPa en invierno. Su actividad en la costa antártica se extiende en toda la tropósfera en invierno (a pesar de que en $r^2$ pierde importancia por encima de los 200hPa)

La región de amplitud máxima de la QS3, coincide aproximadamente con la región de máximo $r^2$ entre y otoño y primavera, aunque con menos actividad en superficie y extensión en toda la columna. En verano, en cambio aparece un máximo de amplitud importante que no se observa en el campo de $r^2$. 

Finalmente, fuera de la superficie, la QS4 presenta un máximo de amplitud bien definido sólo en verano. El máximo entre 15°S y 30°S sigue presente. 

```{r ampl-ncep, fig.class = "fullpage", fig.cap = "Ampllitud de Fourier."}
breaks <- 2^seq(0, log2(650), by = 1)
ggplot(ncep.qs, aes(lat, lev)) +
    stat_contour_fill(aes(z = amplitude), 
                      breaks = breaks) +
    surface +
    geom_index.region(rect.annotation) +
    scale_fill_viridis_c(name = "Amplitud (escala logarítmica)", 
                         trans = "log2",
                         breaks = breaks,
                         labels = round(breaks, 1),
                         guide = guide_colorstrip_bottom(),
                         option = "D") +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse", 
                     ticks = 15) +
    coord_latlev() +
    facet_grid(k ~ season, labeller = labeller(k = qs.lab))
```

\todo[inline]{Acá podría poner alguna reflexión general de lo que se ve. Por ejemplo, cómo en verano la variabilidad está más acotada a la tropóstera mientras que en invierno y primavera hay más contacto con la estratósfera.}


# Onda 3

En este capítulo se analiza la climatología observada de la QS3 a partir de su reconstrucción mediante descomposición de Fourier. Se estudia su amplitud y fase y se propone una división estacional alternativa a partir de estas variables y el análisis de componentes principales. Además, se muestran la estructura típica de la altura geopotencial, la función corriente y la SST asociada a la QS3 a partir de regresiones con respecto a la amplitud de la QS3. 

## Características típicas

```{r calc-qs3-ncep}
lons <- unique(ncep$lon)
qs.wave <- ncep.qs.all[k == 3, .(lon = lons, 
                                 QS3 = amplitude*cos(3*(lons*pi/180 - phase))),
                       by = .(lat, lev, date)]
qs.wave.season <- qs.wave[, .(mean = mean(QS3),
                              sd = sd(QS3)), 
                          by = .(lon, lat, lev, season(date))]
```

```{r qs3-ncep, fig.class = "pagewidth", fig.cap = "Media de reconstrucción de onda 3.", fig.height = 6}
binwidth <- 10
cutlat <- data.frame(lat = c(-52.5, rep(NA, 3)),
                     season = c("Verano", "Invierno", "Otoño", "Primavera"))
ggplot(qs.wave.season[lev == 300], aes(lon, lat)) +
    geom_contour_fill(aes(z = mean), binwidth = binwidth, 
                      exclude = 0) +
    # geom_hline(data = cutlat, aes(yintercept = lat),
    # linetype = 2, size = 0.3, color = "gray50") +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(binwidth = binwidth, name = "QS3",
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) +
    coord_quickmap()
```

En la \autoref{fig:qs3-ncep} se muestra el campo de Z\* reconstruido sólo a partir de la QS3 en 300 hPa, que ilustra lo que sucede en todos los niveles dado que su estructura es barotrópica equivalente (como se verá en la \autoref{fig:qs3-ncep-corte}). De acuerdo con lo encontrado en la amplitud de Fourier para la QS3 (\autoref{fig:ampl-ncep}), la amplitud es máxima entre 60°S y 45°S con menor intensidad en primavera. En el verano la fase es tal que una de las tres anomalías anticiclónicas se ubica hacia el este del sur de Sudamérica. Se observa que existe un corrimiento de la fase entre verano e invierno de poco más de 15° (algo ya observado por @Loon1972 y @Mo1985) anticipando que el efecto de la QS3 sobre cada lugar pueda tener una componente estacional. 

Además, las anomalías presentan una inclinación meridional que, como la teoría de ondas de Rossby indica, está asociada a transportes de cantidad de movimiento hacia el polo. La inclinación es más importante en las estaciones de transición, pero menor en verano y no detectable en el invierno.

```{r uv-qs2-ncep, include = params$draft}
qs.wave.season[, 
               c("ug", "vg") := GeostrophicWind(mean, lon, lat, 
                                                cyclical = TRUE), 
               by = .(lev, season)] %>% 
    .[lev == 300, 
      .(uv = mean(ug*vg, na.rm = T)), by = .(season)] %>% 
    knitr::kable(col.names = c("Estación", "[u\\*v\\*]"), digits = 3, caption = "Transporte meridinoal de cantidad de viento zonal NO SE PUBLICA")
```

```{r qs3-ncep-corte, fig.class = "pagewidth", fig.cap = "Corte", fig.height = 4}
ggplot(qs.wave.season[lat %~% cutlat$lat[1]], aes(lon, lev)) +
    # stat_contour_fill(aes(z = sd), binwidth = 10) +
    geom_contour_fill(aes(z = mean), binwidth = binwidth, exclude = 0) +
    # geom_path(data = qs.wave.season[lon < 90 & lat %~% cutlat$lat[1] & mean > 5, 
    #            .(lon = lon[which.max(mean)]), 
    #            by = .(season, lev)]) +
    scale_y_level(breaks = plot.levs) +
    scale_x_longitude(name = "longitud") +
    scale_fill_divergent(binwidth = binwidth, name = "QS3",
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) 
```

La estructura vertical de las perturbaciones zonales de geopotencial reconstruidas a partir de la QS3 se presenta en la \autoref{fig:qs3-ncep-corte}. En todas las estaciones la mayor amplitud se da en 300hPa, con el máximo desarrollo vertical en invierno, seguido por el otoño y verano. Se destaca además la variación estacional de la fase, descripta previamente. 

Asimismo, se observa que existe una variación estacional en la inclinación vertical de las perturbaciones. En invierno se observa una ligera inclinación hacia el oeste por debajo de los 300hPa. Algo que no se detecta en las otras estaciones. La teoría de ondas de Rossby indica que una inclinación hacia el oeste está asociada con transporte de calor hacia el polo por las perturbaciones [@James].

```{r qs3sd-ncep, fig.class = "pagewidth", fig.cap = "Desvío estándar de la reconstrucción de QS3. Se incluyen en negro, contornos que describen la posición de los centros de las perturbaciones.",  fig.height = 6}
binwidth <- 5
cutlat <- -52.5
ggplot(qs.wave.season[lev == 300], aes(lon, lat)) +
    stat_contour_fill(aes(z = sd, fill = ..level..), binwidth = binwidth) +
    stat_contour(aes(z = mean), breaks = c(1, -1)*20, color = "black", 
                 size = 0.5) +
    map.SH +
    scale_s_map() +
    scale_fill_viridis_c(name = "Desvío estándar de QS3", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) +
    coord_quickmap()
```

En la \autoref{fig:qs3sd-ncep} se muestra el desvío estándar de las perturbaciones reconstruidas a partir de la QS3. La variabilidad máxima se da entre los centros ciclónicos y anticiclónicos (marcados en la \autoref{fig:qs3sd-ncep} con contornos negros), indicando que la variabilidad del geopotencial asociada a la QS3 se debería principalmente corrimientos de la fase que ocurren dentro de cada estación.

### Wavelets

```{r calc-wavelet}
wv.mean.season <- ncep.mean.season[,  
                                   .(lon = lon,
                                     amplitude = unlist(PeriodicWavelet(gh, 3))),
                                   by = .(lat, lev, season)]

file.wavelet <- "DATA/ncep.wv.Rds"
wv.all <- cache.file(file.wavelet, {
    ncep[,  .(lon = lon, gh.z = gh.z,
              amplitude = unlist(PeriodicWavelet(gh, 3))),
         by = .(lat, lev, date)]
})

wv.mean.season2 <- wv.all[, .(amplitude = mean(amplitude)), 
                          by = .(lon, lat, lev, season(date))]
wv.mean.season <- wv.mean.season[wv.mean.season2, on = c("lat", "lon", "season", "lev")]
```

```{r wavelet-fourier-ncep, fig.class = "textwidth", fig.cap = "Amplitud de wavelets (sombreados) y de Fourier (contornos)"}
binwidth <- 10
wv.mean.season[, .(amplitude = mean(amplitude)), 
               by = .(lat, lev, season)] %>% 
    ggplot(aes(lat, lev)) +
    stat_contour_fill(aes(z = amplitude), binwidth = binwidth) +
    geom_contour_fine(data = ncep.qs[k == 3], 
                      aes(z = amplitude),
                      binwidth = binwidth, color = "black") +
    geom_text_contour(data = ncep.qs[k == 3], 
                      aes(z = amplitude, label = ..level..),
                      binwidth = binwidth) +
    scale_fill_viridis_c(name = expression(R^2), 
                         breaks = MakeBreaks(binwidth),
                         limits = c(0, 40),
                         guide = guide_colorstrip_bottom()) +
    scale_color_viridis() +
    scale_y_level() +
    scale_x_latitude(trans = "reverse") +
    surface +
    coord_latlev() +
    facet_wrap(~season)
```

Como se describió en el capítulo 2, se utilizó la metodología de wavelets como alternativa a la de Fourier para aislar la QS3. La amplitud media obtenida mediante wavelets \todo{agregar referencia a sección} es virtualmente idéntica a la amplitud obtenida con Fourier (\autoref{fig:wavelet-fourier-ncep}). 

La metodología de wavelets también permite obtener información de la variación meridional de la amplitud de la QS3. Al igual que con Fourier, esto puede hacerse promediando estacionalmente la amplitud de los campos mensuales o calculando la amplitud de los campos estacionales. Los valores de amplitud media zonal como los mostrados en la \autoref{fig:wavelet-fourier-ncep} son similares en ambas metodologías (no se muestra) pero sí hay diferencias en las anomalías con respecto a la media zonal.

\todo[inline]{OK, esto está todo mal. En realidad no hay tantas diferencias importantes. Ambas metodologías muestran una franja de anomalías positivas que va desde el índico sur hasta el pacífico sur. La diferencia principal es que en la amplitud de la media las anomalías son más intensas en ~45°S y en la media de la amplitud es en ~65°S}

```{r waveletz-ncep, fig.cap = "Campo medio de la amplitud de la onda 3 según wavelets (contornos) y su anomalía zonal (sombreado) en 300hPa.", fig.class = "vfullpage"}
wv.comp <- copy(wv.mean.season) %>% 
    setnames(c("amplitude", "i.amplitude"), c("Amplitud de \nla Media", "Media de \nla Amplitud")) %>% 
    melt(id.vars = c("lon", "lat", "lev", "season"), variable.name = "method") %>% 
    .[, value.z := Anomaly(value), 
      by = .(lat, lev, season, method)]
wv.comp[lev == 300] %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = value.z), binwidth = 1, exclude = 0) +
    # geom_contour_fine(aes(z = value), binwidth = 10,
    #                   color = "black") +
    # stat_contour(aes(z = mean), breaks = c(1, -1)*20, color = "black",
    # size = 0.5, data = qs.wave.season[lev == 300]) +
    # geom_text_contour(aes(z = amplitude, label = ..level..), binwidth = 10,
    # color = "black") +
    # geom_label_contour2(aes(z = value, label = ..level..), binwidth = 10, 
    #                     color = "black") +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(name = "Anomalía de ampltiud wavelets",
                         breaks = MakeBreaks(1),
                         guide = guide_colorstrip_bottom()) +
    facet_grid(season ~ method) +
    coord_quickmap()
```


Las anomalías zonales de la amplitud de la QS3 según wavelets se muestran en la \autoref{fig:waveletz-ncep} para los dos métodos utilizados. Los valores positivos representan regiones donde la amplitud de la QS3 es mayor que la media zonal y viceversa. Al norte de los 30°S, ambas metodologías dan resultados similares: en primavera, verano y otoño hay anomalías zonales positivas sobre el Pacífico y negativas en el Índico, indicando que en estas latitudes la QS3 tiene mayor amplitud en el hemisferio occidental que en el oriental. 

Al sur de 30°S las dos metodologías divergen. La anomalía zonal de la amplitud media de la QS3 del campo medio (Figura\ \ref{fig:waveletz-ncep1}) tiene, en todas las estaciones, un máximo al sur del Índico centrado en 45°S que se desplaza hacia el este en latitudes más altas. Existe un segundo máximo en altas latitudes que en otoño y primavera se encuentran en 120°E y en invierno se encuentra en 180°. La media de la amplitud de la QS3 (Figura\ \ref{fig:waveletz-ncep2}), en cambio tiene anomalías negativas al sur del Índico y positivas al sur del Pacífico durante todo el año. 
 

```{r estacionaridad, fig.cap = "Ratio de amplitud de la media y media de la amplitud (¿medida de estacionaridad?)", fig.subcap = c("campo", "media zonal"), fig.publish = FALSE, fig.sep = "\\newpage"}
copy(wv.mean.season) %>% 
    .[, a.z := Anomaly(amplitude/i.amplitude),
      by = .(lat, season)] %>% 
    .[lev == 300] %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = amplitude/i.amplitude)) +
    map.SH +
    scale_fill_viridis_c() +
    facet_wrap(~season) 

wv.mean.season[lev == 300, .(mean(amplitude/i.amplitude)),
               by = .(lat, season)] %>% 
    ggplot(aes(lat, V1)) +
    geom_line(aes(color = season)) +
    scale_x_latitude() +
    scale_y_continuous(name = "estacionaridad") + 
    coord_flip()
```

Las diferencias vistas en la \autoref{fig:waveletz-ncep} están relacionadas con la estacionariedad\todo{¿Es una palabra?} de las ondas \todo{de nuevo, esto es general para la metodología, la explicación va en métodos}, se puede utilizar la relación entre ambas para generar un *índice de estacionariedad* \todo{¿Estoy seguro de que esto es así?}. Cuanto más similar sea el resultado, más estacionarias son las ondas. Así, la estacionariedad sería máxima en latitudes bajas y al rederor de 50°S --principalmente en verano-- y mínima en dos franjas angostas cerca de 30°S y 75°S. \todo{¿Mostrar el gŕafico \ref{fig:estacionaridad}?}
\todo[inline]{Esta discusión también aplica a Fourier (\autoref{fig:estacionaridad-fourier}), en realidad, pero ahí no estoy mostrando ambos resultados porque da parecido. Quizás este párrafo se puede mover.. o borrar todo si resulta puro sinsentido.}

```{r estacionaridad-fourier, fig.cap = "Estacionaridad según Fourier", fig.publish = FALSE}
ncep.qs.all %>% 
    .[k == 3, .(amplitude = mean(amplitude)), 
      by = .(lat, lev, season(date))] %>% 
    .[ncep.qs[k == 3], on = c("lat", "lev", "season")] %>%
    ggplot(aes(lat, lev)) +
    geom_contour_fill(aes(z = i.amplitude/amplitude), na.rm = T) +
    surface +
    scale_y_level() +
    scale_x_latitude(trans = "reverse") +
    scale_fill_viridis_c() +
    coord_latlev() +
    facet_wrap(~season)
```

```{r dif-wavelets}
lats.index <- c(-65, -40)
levs.index <- c(100, 700)
wvdif <- wv.mean.season[lat %b% lats.index & lev %b% levs.index,
                        sd(amplitude)/mean(amplitude), 
                        by = .(lat, lev, season)] %>% 
    .[, mean(V1)]*100
```


```{r cleanup1}
remove(wv.mean.season, wv.all, wv.comp, wv.mean.season2)
```

Estas observaciones destacan la utilidad de wavelets en el análisis de ondas cuasiestacionarias. Mientras que el tratamiento con Fourier asume a las ondas como una propiedad media de cada círculo de latitud, wavelets permite reconocer su heterogeneidad meridional. Evaluando esta heterogeneidad, sería posible distinguir entre campos donde una onda con un determinado número de onda está presente en todo un círculo de latitud de campos donde ésta está localizada en una región acotada. 

Por otro lado, la no ortogonalidad de los wavelets complejizan la interpretación de los resultados ya que no es posible la separación de un campo en modos oscilatorios con distinto número de onda. El análisis de una QS específica, por lo tanto, está contaminado por la actividad de otras QS con longitud de onda cercana. 

```{r wavelet-reconstr, fig.cap = "Reconstrucción de QS3 usando wavelets", fig.publish = FALSE}
ncep.mean.season[lev == 300, wavelet3 := ReconstructWavelet(gh.z, 3), 
                 by = .(lat, lev, season)]

ggplot(ncep.mean.season[lev == 300], aes(lon, lat)) +
    geom_contour_fill(aes(z = wavelet3), binwidth = 25, exclude = 0) +
    scale_fill_divergent() +
    map.SH +
    facet_wrap(~season)

```

Wavelets, en resumen, puede entenderse como una *corrección* a Fourier que agrega información de asimetrías zonales. Dado que la variabilidad zonal es del orden de un 10% de la amplitud media, en lo que sigue de la tesis se utilizará sólo Fourier, dejando el análisis e interpretación de wavelets para futuros trabajos. 


## Amplitud

Existen varios estadísticos que podrían utilizarse para representar la amplitud de la QS3 en una región extendida, como la media, la máxima, la moda, la mediana, etc. En este caso, se estudió la posibilidad de representarla con la media o la máxima.

```{r calc-indice-ncep}
lats.index <- c(-65, -40)
levs.index <- c(100, 700)
ncep.qs.all <- ncep.qs.all[, index.region := (lev %b% levs.index) & (lat %b% lats.index)]

ncep.qs.all[, phase.c := circular(phase*k, modulo = "2pi")]
index <- ncep.qs.all[index.region == TRUE & k == 3, 
                     .(amplitude   = mean(amplitude),
                       m.amplitude = max(amplitude),
                       r2          = mean(r2),
                       phase       = mean.circular(phase.c)/3,
                       lat         = lat[which.max(amplitude)]),
                     by = date]
index[, phase.c := circular(phase*3, modulo = "2pi")]
fields <- ncep[lev %b% levs.index, .(lon, lat, date, lev, gh, gh.z)][
    qs.wave[lev %b% levs.index], on = c("lat", "lon", "date", "lev")]
cor.index <- fields[, .(cor = cor(gh.z, QS3)^2), by = .(date)]
index <- index[cor.index, on = "date"]

```


```{r ampl-max-mean, fig.cap = "Amplitud máxima y media para 9 casos.", fig.height = 4, fig.class = "pagewidth"}

select.dates <- as.Date(
    c("1997-05-01",  
      "2012-04-01",  
      
      "1985-01-01", 
      "1988-07-01",
      
      "1987-11-01",
      "2008-01-01", 
      
      "2000-09-01",  
      "1990-12-01",  
      
      "2003-10-01"))

# select.dates <- select.dates.manual
gdata <- ncep.qs.all[k == 3 & date %in% select.dates] %>% 
    .[, date.f := factor(as.character(date), 
                         levels = as.character(select.dates),
                         ordered = T)]
gdata.index <- index[date %in% select.dates] %>% 
    .[, date.f := factor(as.character(date), 
                         levels = as.character(select.dates),
                         ordered = T)]


melt(gdata.index[, .(date.f, amplitude, m.amplitude)], 
     id.vars = c("date.f")) %>% 
    ggplot(aes(date.f, value)) +
    geom_col(aes(fill = variable), width = 0.5, 
             position = "dodge") +
    scale_fill_brewer(palette = "Set1", 
                      labels = c(m.amplitude = "Máxima",
                                 amplitude = "Media"),
                      direction = -1) +
    scale_y_continuous(name = "Amplitud",
                       breaks = MakeBreaks(15),
                       expand = c(0, 0)) +
    scale_x_discrete(name = "Fecha", 
                     labels = labeller.date("\n"), 
                     expand = c(0, 0)) +
    coord_flip() +
    theme(panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank())
```

```{r ampl-max-mean-corte, fig.cap = "Corte vertical de amplitud", fig.class = "pagewidth", fig.height = 4}
M <- max(gdata.index[date %in% select.dates, m.amplitude])
binwidth <- 15
ggplot(gdata, aes(lat, lev)) +
    stat_contour_fill(aes(z = amplitude), binwidth = binwidth) +
    geom_index.region(rect.annotation) +
    geom_segment(data = gdata.index[date %in% select.dates], inherit.aes = F,
                 size = 1, color = "#E41A1C",
                 aes(x = -90, xend = -90, y = 1000,
                     yend = 10^(-2/M*m.amplitude + 3))) +
    geom_segment(data = gdata.index[date %in% select.dates], inherit.aes = F,
                 size = 1, color = "#377EB8",
                 aes(x = -90, xend = -90, y = 1000,
                     yend = 10^(-2/M*amplitude + 3))) +
    surface +
    scale_y_level(name = "nivel",
                  sec.axis = sec_axis(~-M/2*(log10(.) - 3), name = "Amplitud")) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_viridis_c(guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    coord_latlev() +
    facet_wrap(~date.f, labeller = labeller(date.f = labeller.date()))
```

```{r ghz-ncep-select, fig.cap = "Anomalías zonales de geopotencial en 300hPa para fechas seleccionadas.", fig.class = "pagewidth", fig.height = 6}
lons <- unique(ncep$lon)
ncep[lev == 300 & date %in% select.dates, 
     FitQsWave(gh, 1:2), by = .(lat, date)] %>% 
    .[, .(lon = lons, 
          qs = amplitude*cos(k*((lons*pi/180) - phase))),
      by = .(lat, date, k)] %>% 
    .[, .(rec = sum(qs)), by = .(lon, lat, date)] %>% 
    .[ncep[lev == 300 & date %in% select.dates], on = c("lat", "lon", "date")] %>% 
    .[, gh.minus := gh.z - rec] %>% 
    .[, date.f := factor(as.character(date), 
                         levels = as.character(select.dates))] %>% 
    ggplot(aes(lon, lat)) +
    stat_contour_fill(aes(z = gh.minus), binwidth = 25, exclude = 0) +
    map.SH + 
    scale_s_map() +
    scale_fill_divergent(guide = guide_colorstrip_bottom(15)) +
    coord_quickmap() +
    facet_wrap(~date.f, labeller = labeller(date.f = labeller.date())) +
    theme(axis.title = element_blank()) 
```

A modo exploratorio se seleccionaron 9 casos que representan distintas características de la amplitud media y la máxima. Sus magnitudes correspondientes se muestran en la \autoref{fig:ampl-max-mean}, y los campos de Z* (con las contribuciones de las QS1 y QS2 removidas como se explicó en el capítulo\ \ref{metodologia}) en la \autoref{fig:ghz-ncep-select}. 

Comparando el caso de mayo de 1997 con el de abril de 2012, ambos tienen una media muy similar (\autoref{fig:ampl-max-mean}), pero la máxima del primero es menor que la del segundo. El corte vertical de la amplitud (\autoref{fig:ampl-max-mean-corte}) muestra que la amplitud de la QS3 en abril de 2012 era más grande pero más localizada en la troposfera alta que en el caso de mayo de 1997 en el que la amplitud es mayor en la estratosfera. Esto se refleja en la comparación de las perturbaciones de geopotencial (\autoref{fig:ghz-ncep-select}), donde la QS3 se aprecia mucho más claramente en 2012 que en 1997. 

Enero de 1985 y julio de 1988 son similares en cuanto a la relación de las métricas de amplitud (\autoref{fig:ampl-max-mean}), pero en este caso ambos campos de Z* (\autoref{fig:ghz-ncep-select}) son muy similares en cuanto a intensidad y claridad de la QS3. Los dos meses presentan un tren de ondas que ocupan aproximadamente 1/3 de círculo de latitud. A pesar de que la amplitud máxima de 1985 es menor que la de 1988, el tren de ondas de 1988 se ve algo más claro que el de 1985. 

El par septiembre de 2000 y diciembre de 1990 es más claro. Ambas medidas de amplitud son mayores en 1990 (\autoref{fig:ampl-max-mean}) y, en efecto, el campo de Z* (\autoref{fig:ghz-ncep-select}) tiene una estructura de QS3 zonal más clara que el de 2000. Sin embargo, las anomalías sí están presentes en 1990 --un tren de ondas similar al de enero de 1985, aunque con distinta fase-- son más intensas, por lo que su efecto local puede ser mayor que las de 2000. 

Más extrema aún es la diferencia entre septiembre de 2000 y octubre de 2003. Ambos meses tienen una métrica de amplitud similares (\autoref{fig:ampl-max-mean}), pero la QS3 es apenas distinguible en el segundo mes (\autoref{fig:ghz-ncep-select}). 

Estos casos ilustran la diversidad de situaciones en que se puede desarrollar la QS3 y las limitaciones que un estudio dinámico-estadístico como el que sigue, puede tener. Algunos problemas son inherentes al intentar representar una estructura con variabilidad espacial a partir de un sólo número o indicador y otros están relacionados con la limitación de la descomposición de Fourier que trata toda onda como una onda planetaria con igual estructura a lo largo de todo el dominio.\todo{Aclarar qué comparación ilustra qué problema} 

```{r cor-mean-max, fig.cap = "Correlación entre amplitud máxima y media."}
r2.ampl <- index[, cor(m.amplitude, amplitude)]^2
ggplot(index, aes(m.amplitude, amplitude)) +
    geom_point(size = 0.5, alpha = 0.5) +
    geom_smooth(color = "black", size = 0.7) +
    geom_abline(linetype = 3) +
    annotate(geom = "text", x = 50, y = 100, 
             label = paste0("r2 = ", round(r2.ampl, 2))) +
    scale_y_continuous(name = "Amplitud media", breaks = MakeBreaks(25)) +
    scale_x_continuous(name = "Amplitud máxima", breaks = MakeBreaks(25)) +
    coord_equal()
```

Es importante tener en cuenta que estos 9 casos fueron seleccionados específicamente para ilustrar estas limitaciones y que no son necesariamente representativos de la totalidad de casos posibles. Como se muestra en la \autoref{fig:cor-mean-max}, la amplitud media máxima tienen una excelente correlación ($r^2>0.9$) y una relación lineal. Debido a esto, a fines estadísticos la elección de una métrica o la otra no tiene una influencia importante. Desde este momento se usará la amplitud media\todo{expresar mejor esto}.

```{r cleanup2}
index <- index[, m.amplitude := NULL]
```

El ciclo anual de la amplitud media se muestra en la Figura\ \ref{fig:ampl-ts1} donde los puntos son datos puntuales. La amplitud máxima se da en agosto así como la mayor variabilidad. Esto es de esperarse en una variable definida positiva que toma valores cercanos a cero. Notar que la amplitud media no es mínima en los meses de primavera, en contraste con lo observado en el análisis climatológico (\autoref{fig:ampl-ncep}) y los campos reconstruidos (\autoref{fig:qs3-ncep}). La resolución a este problema radica en el análisis de la fase (\autoref{fase}).

```{r ampl-ts, fig.class = "pagewidth", fig.cap = "Amplitud media", fig.subcap = c("Ciclo anual", "Serie temporal"), fig.height = 4, fig.show = "hold", fig.ncol = 1}
ggplot(index, aes(factor(month(date)), amplitude)) +
    # geom_violin() +
    geom_boxplot(outlier.alpha = 0, fill = "gray95") +
    geom_point(position = position_jitter(width = 0.2),
               alpha = 0.5, size = 0.7) +
    scale_x_discrete(name = "Mes", labels = month.abb_sp) +
    scale_y_continuous(name = "Amplitud") +
    theme(panel.grid.major.x = element_blank())

DivideTimeseries({
    copy(index) %>% 
        .[, amplitude.mean := mean(amplitude), by = .(year(date))] %>%
        .[, anomaly := sign(amplitude.mean - mean(amplitude))] %>% 
        ggplot(aes(date, amplitude)) +
        geom_line(aes(group = year(date), y = amplitude.mean,
                      color = factor(-anomaly))) +
        geom_line(color = "gray50") +
        geom_hline(yintercept = mean(index$amplitude), linetype = 3) +
        scale_color_brewer(palette = "Set1", guide = "none") +
        scale_x_date(date_breaks = "1 years", expand = c(0, 0), 
                     date_labels = "%y", minor_breaks = NULL) 
    # coord_cartesian(ylim = c(20, 60))
}, index$date, n = 3, xlab = "Fecha", ylab = "Amplitud")
```


La serie temporal de la amplitud media se muestra en la Figura\ \ref{fig:ampl-ts2} donde en líneas horizontales se marca la amplitud media anual para cada año indicando en color rojo o azul si dicho valor está por encima o debajo de la media de la serie respectivamente. Se observan series de años con anomalías positivas consistentemente seguidos por anoamlías negativas (1985-1990, 1992-1996 y 1999-2005) y otras con persistencia de anomalías positivas o negativas (2005-2009 y 2012-2015). No hay evidencia visual de periodicidades ni de una tendencia secular.  

```{r calc-wavelet-dt}
index <- index[, amplitude.t := Anomaly(amplitude), 
               by = .(month(date))]
invisible(capture.output(w <- analyze.wavelet(index, "amplitude.t", 
                                              verbose = FALSE, n.sim = 500)))
```

```{r wavelet-period, fig.cap = "Análisis de wavelet para la amplitud de la onda 3.", fig.publish = FALSE}
ampl <- w$Ampl
dimnames(ampl) <- list(period = w$Period, date = as.character(index$date)) 
cowplot::plot_grid(
    {
        melt(ampl, value.name = "amplitude") %>%
            as.data.table(.) %>% 
            .[, date := as.Date(date)] %>% 
            .[, p.val := c(w$Power.pval)] %>% 
            # .[, amplitude := ecdf(amplitude)(amplitude)] %>% 
            ggplot(aes(date, period)) +
            geom_contour_fill(aes(z = amplitude), breaks = c()) +
            geom_contour(aes(z = p.val), breaks = 0.01) +
            scale_y_continuous(trans = "log2", expand = c(0, 0),
                               breaks = 2^(seq(0, 7, by = 1))) +
            geom_hline(yintercept = c(12, 24)) +
            scale_x_date(date_breaks = "5 years", date_labels = "%y", 
                         expand = c(0, 0)) +
            # scale_fill_distiller(palette = "Spectral")
            scale_fill_viridis_c()
    }, 
    {
        with(w, 
             data.table(period = Period, power = Power.avg, pval = Power.avg.pval)) %>% 
            ggplot(aes(period, power)) +
            geom_line() +
            stat_filter(aes(filter = pval < 0.01), geom = "point") +
            scale_x_continuous(trans = "log2", expand = c(0, 0),
                               breaks = 2^(seq(0, 7, by = 1))) +
            coord_flip() +
            theme(axis.title.y = element_blank(),
                  axis.text.y = element_blank())
    }, align = "h", axis = "tblr", rel_widths = c(4, 1))
```

```{r acf-ampl, fig.cap = "Función de autocorrelación para la amplitud media anual de la onda 3", fig.publish = FALSE}
acf.sig(index$amplitude.t, alpha = 0.01, lag.max = 12*2, sided = "two") %>%
    ggplot(aes(lag, acf)) +
    geom_col(fill = "black", width = 0.3) +
    geom_line(aes(y = upp.sig.cut)) +
    geom_line(aes(y = low.sig.cut)) +
    scale_x_continuous(name = "lag (meses)")
```

COrrelación con SOI? Siguiendo a Mo& White. Ellos encontraron una correlación entre un índice (medio fumado, la verdad) y SOI. Pero Cai et al hicieron su índice y no encontraron correlació (en un modelo).

## Fase

Además de la amplitud, las sondas planetarias se caracterizan por su fase.
\todo[inline]{intro sobre la fase}

```{r fase-boxplot, fig.cap = "Ciclo anual de la fase (20 mayores amplitudes para cada mes)", fig.class = "fullpage"}
lat.lims <- c(-70, -22)
lon.lims <- c(240, 360)
map.arg <- geom_map2(BuildMap(countries = T)[lat %b% lat.lims & 
                                                 long %b% lon.lims],
                     color = "gray50")
nudge <- 0.54
size <- 2

index <- index[, phase.c := circular(phase*3, modulo = "2pi")]
index %>% 
    group_by(month = month(date)) %>% 
    filter(greater(amplitude, 20)) %>% 
    as.data.table() %>% 
    .[, .(phase = mean.circular(phase.c)/3,
          phase.sd = sd.circular(phase.c)/3),
      by = .(month(date))] %>% 
    ggplot(aes(y = (-month + 6)*2.6 - 45)) +
    map.arg +
    geom_point(data = index %>% 
                   group_by(month = month(date)) %>% 
                   filter(greater(amplitude, 20)), 
               aes(phase*180/pi +240),
               alpha = 0.5, size = size, color = "red",
               position = position_nudge(y = -nudge)) +
    geom_point(data = index %>%
                   group_by(month = month(date)) %>%
                   filter(greater(amplitude, 20)),
               aes(ifelse(phase*180/pi + 240 - 60 < 240, NA,
                          phase*180/pi + 240 - 60)),
               alpha = 0.5, size = size, color = "blue",
               position = position_nudge(y = nudge)) +
    geom_point(data = index %>% 
                   group_by(month = month(date)) %>% 
                   filter(greater(amplitude, 20)), 
               aes(ifelse(phase*180/pi + 240 + 60 > 360, NA,
                          phase*180/pi + 240 + 60)),
               alpha = 0.5, size = size, color = "blue",
               position = position_nudge(y = nudge)) +
    # geom_point(aes(phase*180/pi + 240 + 60), color = "blue") +
    geom_point(aes(phase*180/pi + 240)) +
    
    geom_errorbarh(aes(xmin = (phase*180/pi + 240 - phase.sd*180/pi), 
                       xmax = (phase*180/pi + 240 + phase.sd*180/pi))) +
    geom_errorbarh(aes(xmin = (phase*180/pi + 240 - phase.sd*180/pi) + 120, 
                       xmax = (phase*180/pi + 240 + phase.sd*180/pi) + 120)) +
    # annotate(geom = "label", x = rep(237, 12), y = (-(1:12) + 6)*2.6 - 45, 
    #          label = month.abb_sp, size = 3, hjust = 0.5) +
    geom_vline(xintercept = c(240, 360), linetype = 3) +
    # map.SH.3 +
    scale_x_longitude(ticks = 20, name = "Longitud") +
    scale_y_continuous(breaks = (-(1:12) + 6)*2.6 - 45, 
                       minor_breaks = NULL,
                       labels = month.abb_sp, 
                       name = "Mes", expand = c(0, 0)) +
    # coord_quickmap()
    coord_quickmap(xlim = lon.lims, ylim = lat.lims) 
# coord_map(projection = "mollweide", xlim = lon.lims, ylim = lat.lims)
```

La \autoref{fig:fase-boxplot} muestra la fase media (localización media del máximo de geopotencial) y el rango delimitado por $\pm$ 1 desvío estándar para cada mes para los 20 años con más amplitud de cada mes. En rojo y azul se indican la localización de los centros de máxima y mínima anomalía de geopotencial respectivamente de los 10 casos más extremos. El mapa se muestra para referencia, pero notar que la posición de los puntos en el eje vertical no tiene significado geográfico. 

Se observa el ciclo anual en la fase ya se podía apreciar en la \autoref{fig:qs3-ncep}. La fase media se centra en 55°O en enero y se desplaza a 90°O en junio con valores intermedios en los meses de transición. El continente queda al este del máximo de geopotencial en invierno que, por balance geostrófico, implica vientos del sur. En verano se da la situación contraria. Esto reslata que el efecto de la QS3 sobre Sudamérica depende de forma cruicial en la fase. 

Superpuesto a el ciclo anual, en la \autoref{fig:fase-boxplot} también se puede apreciar la variabilidad interanual para cada mes. Ésta es considerable y de una magnitud comparable a la del ciclo anual. En particular, es notorio el aumento en la variabilidad en los meses de primavera, al punto de que en noviembre la fase prácticamente no tiene una posición predilecta. 

La gran variabilidad presente durante los meses de primavera, en comparación con el resto del año, explica por qué en los campos medios la QS3 aparece débil a pesar de que su amplitud mensual no es menor. Al hacer el promedio, los campos que están defasados en entre 1/4 y 3/4 de longitud de onda (entre 30° y 90° en el caso de la QS3) interfieren destructivamente entre ellos, eliminando la señal en los campos medios. En primavera, más del 30% de los meses tienen algún nivel de interferencia destructiva con el campo medio, comparado con el 13% en verano.  

```{r phase-sd, include = params$draft}
index[, .(sd = sd(phase.c)/3*180/pi),
      by = month(date)] %>% 
    knitr::kable(digis = 2, col.names = c("Estación", "SD"),
                 caption = "Desvío estándar de la fase para cada estación - NO SE PUBLICA")
```

```{r destructiva, include = params$draft}
index[, mean(abs(phase.c - mean(phase.c)) %between% (c(1/4, 3/4)*2*pi))*100, 
      by = season(date)] %>% 
    knitr::kable(caption = "Porcentaje de meses con interferencia destructiva - NO SE PUBLICA",
                 digits = 3)
```

Observando ahora la distribución de los centros ciclónicos y anticiclónicos (puntos rojos y azules, respectivamente\todo{esto ya está dicho antes, pero lo aclaro de nuevo?}) se nota que, a pesar de que climatolǵoicamente la Sudamérica está afectada por un máximo de Z\* de la QS3, la variabilidad interanual implica que hay un número no despreciable de años donde el continente tiene un mínimo de Z\* asociado a esa onda. Aún sólo mirando a los 20 años más intensos de cada mes, en noviembre hay 5 casos y en diciembre, 4. 

## Estaciones

En las secciones anteriores se mostraron campos medios estacionales utilizando la definición tradicional de las estaciones climatológicas (verano = DEF, otoño = MAM, invierno = JJA, primavera = SON). Sin embargo, como éstas son definidas a partir del ciclo anual de temperatura en latitudes medias no constituyen necesariamente el mejor agrupamiento de los datos para otras variables u otras latitudes (por ejemplo, la Antártida \todo{cita de King}). 

Una metodología muy utilizada para la clasificación de campos es el análisis de componentes principales (PCA)\todo{citas de PCA}\todo{asumo que no hace falta explicar PCA}. 

La tabla xx \ref{eoftabla}\todo{cómo referenciar tablas?} muestra la varianza explicada de cada componente principal obtenida a partir de los campos reconstruidos de QS3. Las primeras dos componentes explican más del 80% de la varianza y cada una explica una parte similar de la varianza, indicando que se trata de autovalores degenerados\todo{buscar cita de esto}. Sabiendo, además, que los campos de QS3 prácticamente sólo tienen dos grados de libertad (amplitud y fase), la elección de seleccionar las dos primera componentes es natural además de justificada por la tabla \ref{eoftabla}.


```{r eoftabla}
qs.eof <- EOF(fields[lev == 300][, QS3w := QS3*sqrt(cos(lat*pi/180))], lon + lat ~ date, value.var = "QS3", 
              n = 1:5)
qs.eof$sdev[, .(PC, r.squared)] %>% 
    # t() %>% 
    knitr::kable(digits = 3, 
                 caption = "Varianza explicada por las 5 primeras componentes principales de los campos de QS3 reconstruidos.", col.names = c("PC", "$R^2$"))
```


```{r eof, fig.cap = "Primeras dos componentes principales del campo de QS3"}
qs.eof <- EOF(fields[lev == 300][, QS3w := QS3*sqrt(cos(lat*pi/180))], lon + lat ~ date, value.var = "QS3", n = 1:2)

ggplot(qs.eof$left, aes(lon, lat)) + 
    stat_contour_fill(aes(z = -value), binwidth = 0.01,
                      exclude = 0) +
    map.SH +
    scale_fill_divergent(breaks = MakeBreaks(0.01),
                         guide = "none") +
    scale_s_map() +
    coord_quickmap() + 
    facet_wrap(~PC, ncol = 2, labeller = labeller(PC = AddPreffix("PC")))

# ggplot(qs.eof$right, aes(month(date), -value)) +
#     geom_boxplot(aes(color =  paste0("PC", PC),
#                      group = interaction(PC, month(date)))) +
#     annotate("errorbarh", y = 0.15, height = 0.01, alpha = 0.5,
#              xmin = c(-1, 4, 6, 8, 12) - 0.4,
#              xmax = c(3, 5, 7, 11, 14) + 0.3,
#              color = 1) +
#     scale_x_continuous(name = "Mes", breaks = 1:12, labels = month.abb_sp) +
#     scale_y_continuous(name = "PC") +
#     scale_color_brewer(palette = "Set1") +
#     coord_cartesian(xlim = c(1, 12))
```

La forma de las dos primeras componentes principales del campo de QS3 (\autoref{fig:eof-field}) son dos QS3 en cuadratura cuya combinación lineal resulta en otra QS3 cuya fase depende de la amplitud relativa de cada componente. En verano predomina la PC1, mientras que en invierno predomina la PC2 como se muestra en la \autoref{fig:pc1-pc2}. En este diagrama se puede mapear aproximadamente la amplitud y la fase media de cada mes a la distancia y el ángulo con respecto al origen.

En la \autoref{fig:pc1-pc2} también se hace una posible modificación de las estaciones clásicas adaptada para el análisis de la QS3 basada en la posición media de cada mes en el espacio de componentes principales. Enero, febrero y marzo tienen preponderancia del PC1 y casi nulo PC2, abril, mayo, agosto, septiembre y octubre tienen una mezcla similar de componentes, pero es conveniente separar los dos primeros para respetar la progresión temporal. Junio y julio no están tan juntos como los demás meses, pero se los puede agrupar por tener gran magnitud de PC2. Finalmente, noviembre y diciembre aparecen como *outliers* en este diagrama debido a que su mayor variabilidad (como se notó en la \autoref{fase}) hace que no predomine ninguna componente principal. Es posible clasificarlos juntos como meses de "no estacionaridad" indicando que se trata de una época del año donde la QS3 no está presente. 


```{r pc1-pc2, fig.cap = "Valor medio de las dos primeras componentes principales del campo de QS3", fig.height = 5}
qs.eof$right[, .(value = -mean(value)), by = .(PC, month(date))] %>% 
    dcast(... ~ paste0("PC", PC)) %>% 
    # .[, .(dif = mean(PC2 - PC1), mag = mean(sqrt(PC2^2 + PC2^2))),
    # by = .(month(date))] %>% 
    ggplot(aes(PC1, PC2)) +
    geom_hline(yintercept = 0, linetype = 1, color = "gray50") +
    geom_vline(xintercept = 0, linetype = 1, color = "gray50") +
    ggforce::geom_link2(aes(color = qs.season(month), group = 1),
                        alpha = 0.5) +
    geom_point(aes(color = qs.season(month))) +
    ggrepel::geom_text_repel(aes(label = month.abb_sp[month])) +
    scale_color_brewer(palette = "Set1", na.translate = F) +
    coord_equal()
```

El efecto de esta nueva clasificación en los campos medios se presenta en las figuras \ref{fig:qs3-qsseason-ncep} y \ref{qs3-qsseason-ncep}. Comparando con las figuras \ref{fig:qs3-season-ncep} y \ref{qs3-season-ncep} de la sección \ref{onda-3} se ve que los campos de las estaciones de transición (AM y ASO) son más similares entre ellas tanto en el campo horizontal como en el corte meridional. Los meses no estacionarios (ND), por su parte, prácticamente carecen de QS3. 

```{r qs3-qsseason-ncep, fig.class = "pagewidth", fig.cap = "Media de reconstrucción de onda 3 en 300hPa", fig.height = 6}
qs.qs.season <- qs.wave[, 
                        .(QS3 = mean(QS3)),
                        by = .(lon, lat, lev, qs.season(date))] 

binwidth <- 10
ggplot(qs.qs.season[lev == 300], aes(lon, lat)) +
    geom_contour_fill(aes(z = QS3), binwidth = binwidth, 
                      exclude = 0) +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(binwidth = binwidth, name = "QS3",
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~qs.season, ncol = 2) +
    coord_quickmap()
```

```{r qs3-qsseason-ncep-corte, fig.class = "pagewidth", fig.cap = "Corte", fig.height = 4}
ggplot(qs.qs.season[lat %~% -52.5], aes(lon, lev)) +
    # stat_contour_fill(aes(z = sd), binwidth = 10) +
    geom_contour_fill(aes(z = QS3), binwidth = binwidth, exclude = 0) +
    scale_y_level(breaks = plot.levs) +
    scale_x_longitude(name = "longitud") +
    scale_fill_divergent(binwidth = binwidth, name = "QS3",
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~qs.season, ncol = 2) 
```

El uso de componentes principales para el análisis de una onda que cambia de fase es similar a la metodología utilizada para el monitoreo de la MJO\todo{cita de MJO} por lo que sería posible su utilización como indicador de la actividad de la QS3 distinto de la amplitud media de Fourier. La exploración de dicho indicador está por fuera del objetivo de este trabajo. 

Una desventaja de esta clasificación es que no todas las estaciones tienen la misma cantidad de meses, lo cual dificulta la comparación estadística entre distintas estaciones. 
## Persistencia (ver dónde va)

```{r lag-cor, fig.cap = "Correlación lageada para cada mes con los 12 sigientes."}
lags <- 0:12
qs.croscor <- copy(qs.wave[lev == 300]) %>%
    .[, QS3.t := Anomaly(QS3), by = .(month(date), lon, lat)] %>% 
    .[, (paste0("l", lags)) := shift(QS3, lags, type = "lead"), 
      by = .(lat, lon)] %>% 
    .[, lapply(lags, function(l) cor.test(.SD$l0, .SD[[paste0("l", l)]], 
                                          use = "complete.obs")$estimate), 
      by = month(date)] %>% 
    set_colnames(c("month", 0:12)) %>% 
    melt(id.vars = "month", variable.name = "lag", value.name = "cor") %>% 
    .[, lag := as.numeric(as.character(lag))] %>% 
    .[, month2 := ifelse2(month + lag, x > 12, x - 12)]

# qs.test <- copy(qs.wave[lev == 300]) %>%
#     .[, QS3.t := Anomaly(QS3), by = .(month(date), lon, lat)] %>% 
#     .[, (paste0("l", lags)) := shift(QS3.t, lags, type = "lead"), 
#       by = .(lat, lon)] %>% 
#     .[, lapply(lags, function(l) cor.test(.SD$l0, .SD[[paste0("l", l)]], 
#                                      use = "complete.obs")$p.value), 
#       by = month(date)] %>% 
#     set_colnames(c("month", 0:12)) %>% 
#     melt(id.vars = "month", variable.name = "lag", value.name = "p.value") %>% 
#     .[, lag := as.numeric(as.character(lag))] %>% 
#     .[, month2 := ifelse2(month + lag, x > 12, x - 12)]
# 
# qs.croscor[, p.value := qs.test$p.value]

ggplot(qs.croscor[lag != 0], aes(month2, month)) +
    # annotate("ribbon", x = c(0.5, rep(1:12 + 0.5, each = 2)),
    #          ymin = c(0, 0, rep(1:11, each = 2) + 0.5, 12),
    #          ymax = 13, 
    #          fill = "gray80", alpha = 0.2) +
    # geom_point(aes(size = abs(cor), color = cor)) +
    # geom_contour(aes(z = cor, color = ..level..), binwidth = 0.05)  +
    # scale_color_divergent() +
    geom_tile(aes(fill = cor)) +
    # geom_contour(aes(z = cor, color = ..level..), binwidth = 0.05)  +
    geom_text(aes(label = no.zero(round(cor, 2)))) +
    annotate("step", x = 2:13 - 0.5, y = 1:12 - 0.5, direction = "vh",
             color = "gray20", linetype = 1) +
    scale_y_continuous(name = "Mes", expand = c(0, 0), trans = "reverse", 
                       breaks = 1:12, labels = month.abb_sp) +
    scale_x_continuous(name = "Mes siguiente", expand = c(0, 0),
                       breaks = 1:12, labels = month.abb_sp) +
    scale_fill_divergent(breaks = MakeBreaks(0.1), 
                         guide = "none") +
    theme(panel.ontop = F)
```

En la \autoref{fig:lag-cor} se muestra la correlación del campo de QS3 de cada mes con los demás. La línea escalonada marca la separación del año de manera que un número a la izquierda de la misma implica correlación de ese mes con meses del año siguiente. Las correlaciones justo a la izquierda de la línea escalonada son positivas y relativamente altas para casi todos los meses salvo noviembre, diciembre y agosto. Esto implica que estos meses tienen poca similaridad de un año a otro. Noviembre y diciembre también presentan bajas correlaciones en general con los demás meses y ambas observaciones se puede comprender a la luz de los resultados de las secciones anteriores: al ser meses con actividad de la onda 3 poco estacionaria, sus campos de QS3 no son consistentemente similares con ningún otro mes. Esta interpretació no parece posible para agosto, ya que su variabilidad no es paricularmente alta (\autoref{fig:fase-boxplot})\todo{¿qué pasa con agosto?}.

Los valores un mes a la derecha de la linea escalonada son también generalmente altos indicando buena concordancia entre los campos de un mes y el siguiente. Para esto nuevamente las excepciónes son noviembre, diciembre y julio. La explicación para estas bajas correlaciones posiblemente sea la misma que para las anteriores. 

Las correlaciones entre meses corridos 6 meses son bajas para los meses de verano e invierno y medias para los meses de transición. Es decir, los meses de verano son muy distintos de los de invierno, mientras que los de transición son medianamente parecidos a todos. Esta es una consecuencia del ciclo anual de la fase (\autoref{fig:fase-boxplot}). 


## R2

En la \autoref{fig:ondas-quasiestacionarias}, se mostró la estructura vertical de la varianza explicada por la QS3 para cada estación (\autoref{fig:r2-ncep}). En esta sección se explora la estructura horizontal de dicha propiedad. Para esto, se toma como $r^2$ la correlación cuadrada entre el valor de Z\* y el de QS3 para cada punto de grilla y cada mes. 

```{r cor-campo, fig.cap = "Correlación cuadrada media para estaciones según onda3.", fig.height = 6}
cor.season <- fields[lat > -90 & lev == 300, 
                     .(corelation = cor(gh, QS3)^2), 
                     by = .(lon, lat, season(date))]

binwidth <- 0.1
ggplot(cor.season, aes(lon, lat)) +
    geom_contour_fill(aes(z = corelation), breaks = MakeBreaks(binwidth)(c(0.1, 0.6)),
                      complete = FALSE) +
    geom_contour_fine(aes(z = mean, color = factor(sign(..level..))),
                      data = qs.wave.season[lev == 300],
                      breaks = c(1, -1)*20) +
    map.SH +
    scale_fill_viridis_c(breaks = MakeBreaks(binwidth)(c(0.1, 0.6)),
                         limits = c(0, 0.6),
                         guide = guide_colorstrip_bottom()) +
    scale_color_brewer(palette = "Set1", guide = "none", direction = -1) +
    scale_s_map() +
    coord_quickmap() +
    facet_wrap(~season, ncol = 2)
```

Los campos horizontales de $r^2$ para 300hPa se muestran en la \autoref{fig:cor-camp}, con los centros de máximas anomalías marcados con líneas. En las cuatro estaciones la QS3 explica la mayor parte de la varianza en el hemiferio oeste entre 60°S y 45°S. Lejos de ser homogéneos, los campos muestran tres máximos localizados con cierta persistencia durante el año. El primero, al sur del Índico, está presente en verano y otoño en 60°E que se mueve hacia el este en invierno y primavera. Algo similar sucede on el segundo máximo al sur del Pacífico, que pasa de 180° a 120° entre otoño y primavera. Hay un tercer máximo en el Atlántico sur cuyo desplazamiento hacia el este es bastante menor. Finalmente, en verano y otoño hay un máximo en latitudes bajas en el pacífico central. 

Si se compara la posición de los máximos de $r^2$ con los centros de QS3, el máximo del Índico, por ejemplo, coincide con un anticiclón en verano pero se encuentra entre dos centros en otoño y lo mismo pasa con el máximo del Atlántico. Éste último coincide con un centro anticiclónico en verano pero está más cerca de uno ciclónico en invierno. No parece haber una asociación entre los máximos de $r^2$ y los centros de QS3. 

Comparando con la \autoref{fig:waveletz-ncep} de campos de amplitud de wavelets, se puede observar cierta correspondencia entre las anomalías zonales de wavelets y los campos de $r^2$. Ambos son más intensos en el hemisferio occidental, muestran una translación general hacia el este entre verano e invierno e incluso ambos presentan máximos en el pacífico central. Que estas características se recuperen utilizando dos metodologías independientes brindan robustez al resultado.

Si se realiza un análisis análogo pero en base a las estaciones definidas en la \autoref{estaciones} las principales diferencias son un debilitamiento del los máximos durante EFM y una fuerte intensificación del máximo del Atlántico durante DN (no se muestra). Las características generales no cambian. 

```{r cor-campo2, fig.cap = "Correlación cuadrada media para estaciones según onda3.", fig.publish = FALSE, fig.height = 6}
cor.season <- fields[lat > -90 & lev == 300, 
                     .(corelation = cor(gh, QS3)^2), 
                     by = .(lon, lat, season = qs.season(date))]

binwidth <- 0.1
ggplot(cor.season, aes(lon, lat)) +
    geom_contour_fill(aes(z = corelation), breaks = MakeBreaks(binwidth)(c(0.1, 0.6)),
                      complete = FALSE) +
    geom_contour_fine(aes(z = mean, color = factor(sign(..level..))),
                      data = qs.wave[lev == 300, 
                                     .(mean = mean(QS3)), 
                                     by = .(lon, lat, season = qs.season(date))],
                      breaks = c(1, -1)*20) +
    map.SH +
    scale_fill_viridis_c(breaks = MakeBreaks(binwidth)(c(0.1, 0.6)),
                         limits = c(0, 0.6),
                         guide = guide_colorstrip_bottom()) +
    scale_color_brewer(palette = "Set1", guide = "none", direction = -1) +
    scale_s_map() +
    coord_quickmap() +
    facet_wrap(~season, ncol = 2)
```

<!-- Se puede estimar de dos maneras distintas: a partir del ajuste de Fourier para cada nivel y latitud (figura blabla) y haciendo un promedio, o reconstruyendo el campo tridimensional de la onda 3 y haciendo la correlación (global) con el campo tridimensional observado. Esta segunda forma da casi siempre un valor menor.  -->

```{r r2-cor2, fig.cap = "Relación entre R2 medio y R2 reconstruido.", fig.publish = FALSE}
r2.cor <- index[, cor(cor, r2)]^2
ggplot(index, aes(r2, cor)) +
    geom_point(size = 0.5, alpha = 0.5) +
    geom_smooth(color = "black", size = 0.7) + 
    # geom_smooth(method = "lm", data = index[r2 < 0.4]) +
    # geom_smooth(method = "lm", data = index[r2 >= 0.4]) +
    geom_abline(linetype = 3) +
    annotate(geom = "text", x = 0.5, y = 0.2, 
             label = paste0("r2 = ", round(r2.cor, 2))) +
    scale_y_continuous(name = "R2 reconstrucción", breaks = MakeBreaks(0.1)) +
    scale_x_continuous(name = "R2 medio", breaks = MakeBreaks(0.1)) +
    coord_equal()
```


<!-- Para ver:     -->
<!-- La relación ya no es lineal y hay bastante más scatter. Ergo, hay diferencia en la información.      -->


<!-- Dos regímenes: Cuando el R^2 es bajo, la relación es "menor" que 1:1 y hay algunos casos donde el R2 reconstruido es mayor que el r2 medio. Para R2 más grandes, la pendiente es 1. Modelar la relación... ¿Cómo se interpreta? -->

<!-- ```{r r2-ts, fig.class = "pagewidth", fig.cap = "R2 medio", fig.subcap = c("Serie temporal", "Ciclo anual"), cache = FALSE, fig.height = 4, fig.show = "hold", fig.ncol = 1} -->
<!-- gdata <- melt(index, id.vars = "date", measure.vars = c("r2", "cor"),  -->
<!--               variable.name = "tipo", value.name = "r2" ) -->
<!-- g <- ggplot(gdata, aes(date, r2)) + -->
<!--     geom_line(aes(color = tipo)) + -->
<!--     geom_hline(data = gdata[, .(m = mean(r2)), by = tipo], -->
<!--                aes(yintercept = m, color = tipo), linetype = 3) + -->
<!--     scale_x_date(date_breaks = "1 years", expand = c(0, 0), date_labels = "%y") + -->
<!--     scale_color_brewer(palette = "Set1") -->
<!-- DivideTimeseries(g, index$date, n = 3, xlab = "Fecha", ylab = "R2") -->

<!-- ggplot(gdata, aes(factor(month(date)), r2, color = tipo)) + -->
<!--     geom_boxplot() + -->
<!--     scale_x_discrete(name = "Mes", labels = month.abb_sp) + -->
<!--     scale_y_continuous(name = "R2") + -->
<!--     scale_color_brewer(palette = "Set1") -->
<!-- ``` -->

<!-- Cosas para ver:     -->
<!-- El ciclo anual no es para nada tan claro. Varios outliers. La correlación reconstruida (azul) no tiene casi ciclo anual.  -->

Conclusión: no voy a usar el r2 a partir del campo reconstruido. 


## Regresiones

Los campos de QS3 reconstruida a partir de Fourier permiten conocer la forma idealizada del campo de geopotencial asociado a esa onda, pero por su naturaleza no permiten conocer el estado típico de la atmósfera cuando la QS3 está activa. Haciendo la regresión entre el índice de QS3 obtenido en la sección anterior, se pueden obtener...\todo{me estoy haciendo lio con esto...}

### Geopotencial

```{r calc-regr-gh-ncep}
file <- "DATA/regr-gh-ncep.Rds"
regression <- cache.file(file, {
    ncep[lev == 300, .(lon, lat, date, gh)] %>% 
        .[index[, .(date, amplitude, phase)], on = "date"] %>% 
        .[, setNames(ExtractLm(
            RcppArmadillo::fastLm(cbind(mean = 1,
                                        amplitude = amplitude/sd(amplitude), 
                                        phase = phase),
                                  gh)),
            c("regressor", "estimate", "se")), 
          by = .(lat, lon, month(date))] %>% 
        .[, t := abs(estimate)/se]
})
```

```{r regr-gh-ncep, fig.cap = "Regresión sobre amplitud.", fig.class = "fullpage"}
binwidth <- 10
regression[regressor == "amplitude"] %>% 
    # .[lat > -85] %>% 
    # .[, estimate.z := Anomaly(estimate), by = .(lat, month, regressor)] %>%
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate), binwidth = binwidth, exclude = 0) +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_wrap(~month, ncol = 3, nrow = 4, dir = "h",
               labeller = labeller(month = month.abb_sp))
```

En la \autoref{fig:regr-gh-ncep} se muestra la regresión del campo de Z con la amplitud media de la QS3. Las variables están estandarizados de manera que los valores en la figura representan el cambio típico en el campo de Z relacionado con el aumento de la amplitud media de la QS3 en 1 desvío estándar. Existe mucha heterogeneidad en las caracterśiticas presentes en los distintos meses. 

Enero tiene una señal importante al sur del Pacífico, donde se observa un tren de ondas originado al este de Nueva Zelanda, y al sur del Índico, donde hay un máximo de geopotencial. En ferbero, la estructura se mantiene similar, pero con menor propagación meridional, una intensificación del anticiclón en Sudamérica y un debilitamiento del ubicado al sur del Índico. En marzo, está presente una QS3 con mínima variación meridional que ocupa todo el círculo de latitud entre 60°S y 45°S. Abril es similar a marzo, pero sin centros ciclónicos. En mayo, aparece nuevamente un tren de ondas con propagación meridional pero en vez de terminar al sur de Sudamérica, lo hace en el Mar de Weddell. Junio, al igual que marzo, presenta una estructura de QS3 zonal, pero menos definida y, consistente con el corrimiento de la fase observado en la \autoref{fase} (\autoref{fig:fase-boxplot}), con los centros ciclónicos y anticiclónicos desplazados hacia el oeste.

```{r sam-cor, include = params$draft}
sam <- fread("DATA/sam.monthly.txt") %>% 
    setnames(c("year", "month", "sam")) %>% 
    .[year > 1984 & year < 2016] %>% 
    .[, date := ymd(paste0(year, " ", month, " ", 01))] %>% 
    .[, `:=`(year = NULL, month = NULL)]

sam.cor <- index[sam, on = "date"] %>% 
    .[, cor.test(sam, amplitude)[c("p.value", "estimate")], by = month(date)]
knitr::kable(sam.cor, caption = "Correlación entre QS3 y SAM - NO SE PUBLICA", digits = 4)
```

En julio, el patroń de QS3 se ve opacao por anomalías positiva de geopotencial en latitues antárticas y negativas en latitudes medias. En la \autoref{fig:regr-gh-polar} se muestran los mismos campos que en la \autoref{fig:regr-gh-ncep} pero en coordenadas polares para julio y diciembre. En esta proyección es fácil identificar el patrón similar al SAM negativo\todo{buscar cita a SAM} presente en julio y el SAM positivo presente en diciembre. En efecto, la correlación entre el índice SAM y la amplitud media de la QS3 es `r round(sam.cor[7]$estimate, 2)` (p-valor $\sim `r round(sam.cor[7, p.value], 4)`$) para julio y `r round(sam.cor[12, estimate], 2)` (p-valor $\sim `r round(sam.cor[12, p.value], 4)`$) para diciembre\footnote{Correlación de Pearson, tests a dos colas}. Estos dos meses son los únicos con una relación significativa con al menos 95% de confianza.

```{r regr-gh-polar, fig.cap = "Igual que figura  XX, pero en proyección polar para julio y septiembre."}
binwidth <- 10
ggplot(RepeatLon(regression[regressor == "amplitude" & month %in% c(7,12)]), 
       aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate), exclude = 0, 
                      binwidth = binwidth) +
    map.SH +
    # scale_s_map() +
    scale_y_latitude(limits = c(-90, 0)) +
    scale_x_longitude() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    coord_polar() +
    # coord_quickmap() +
    facet_wrap(~month, labeller = labeller(month = month.abb_sp))
```

```{r sam-ampl, fig.cap = "Relación entre amplitud media de la onda 3 y el SAM", fig.height = 6, fig.publish = FALSE}
index[sam, on = "date"] %>% 
    .[, month := month(date)] %>% 
    ggplot(aes(amplitude, sam)) +
    geom_point(size = 0.5) + 
    geom_smooth(method = "lm", size = 0.5, color = "black") +
    scale_x_continuous(name = "Amplitud media") +
    scale_y_continuous(name = "SAM") +
    facet_wrap(~month, scales = "free", 
               ncol = 3, nrow = 4, dir = "v",
               labeller = labeller(month = month.abb_sp))
```

Volviendo a la \autoref{fig:regr-gh-ncep}, agosto muestra una estructura de QS3 zonal salvo en la región de Sudamérica, donde el centro anticiclónico esperado a partir de una QS3 se encuentra a mayor latitud, sobre la Península Antártica. Septiembre muestra un tren de ondas similar al de enero pero con una conexión clara entre las anomalías sobre Sudamérica y las del sur del Índico\todo{expresar esto mejor}. En octubre, el patrón de QS3 se ve claramente en los máximos de Z, pero no tanto en los mínimos y el tren de ondas Pacífico-Atlántico con signo invertido (ciclón sobre Sudamérica). El campo de noviembre es muy similar al de abril; hay indicios de un tren de ondas proveniente del sur de Autralia hacia Sudamérica. Finalmente, en diciembre se tiene un patrón similar a enero pero modificado por la señal de la SAM positiva detectada en el párrafo anterior. 

### Función Corriente

```{r calc-regr-psi-ncep}
file <- "DATA/stream.reg.Rds"
stream.reg <- cache.file(file, {
    stream[, .(lon, lat, date, psi)] %>% 
        .[index[, .(date, amplitude, phase)], on = "date"] %>% 
        .[, setNames(ExtractLm(
            RcppArmadillo::fastLm(cbind(mean = 1,
                                        amplitude = amplitude/sd(amplitude), 
                                        phase = phase),
                                  psi)),
            c("regressor", "estimate", "se")),
          by = .(lat, lon, month(date))] %>% 
        .[, t := abs(estimate)/se] %>% 
        .[, estimate.z := Anomaly(estimate),
          by = .(lat, month, regressor)] %>% 
        .[, psi.z := estimate.z] %>% 
        .[, c("f.x", "f.y") := WaveFlux(.SD), by = .(regressor, month)]
})
```

```{r regr-psi-ncep, fig.cap = "Regresión de Psi con la amplitud (anomalía zonal).", fig.class = "fullpage"}
binwidth <- 1e6
scale <- 600

ggplot(stream.reg[regressor == "amplitude" & lat <= 0], 
       aes(lon, lat)) +
    geom_contour_fill(aes(z = estimate.z), exclude = 0, 
                      complete = FALSE, binwidth = binwidth) +
    # geom_segment(aes(xend = lon + f.x*scale, yend = lat + f.y*scale)) +
    geom_vector(aes(dx = f.x, dy = f.y), skip = 4, min.mag = 0.005,
                arrow.size = 0.2, scale = 600, size = 0.2) +
    map.world +
    scale_s_map() +
    scale_fill_divergent(binwidth = binwidth, 
                         guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_wrap(~month, ncol = 3, nrow = 4, dir = "h",
               labeller = labeller(month = month.abb_sp))
```

En la \autoref{fig:regr-psi-ncep} se muestra la anomalía zonal de la regresión de $\psi$ con la amplitud media de la QS3 junto con los flujos de actividad de onda calculados a partir del mismo. A partir de la misma se puede confirmar la existencia de los trenes de onda identificados en la \autoref{fig:regr-gh-ncep} y ampliar el análisis a los trópicos. En mayo, por ejemplo, aparece claramente una fuente de actividad de onda sobre Indonesia que genera un flujo hacia el sur de de Sudamérica y otro hacia el Pacífico central. 

# Experimentos

Se realizaron tres corridas entre enero de 1985 y diciembre de 2014. En la corrida **Control**, la temperatura de la superficie del mar es la observada a partir de la based de datos HadISST [@Rayner2003] y se activó el modelo de suelo y de hielo provistos por SPEEDY. En la corrida **NOLAND** se desactivaron los modelos de hielo y suelo y la temperatura de la superficie del mar fue reemplazada por la media climatológica mensual. De esta manera, la temperatura de la superficie permanece constante durante todos los meses de simulación. Finalmente, en la corrida **SSTZONAL** además de estar desactivados los modelos de hielo y suelo, se reemplaza la temperatura de la superficie del mar por su media zonal climatológica mensual. 

En este capítulo primero se realiza una validación de la corrida Control con respecto a los datos de NCEP. Luego se comparan los resultados de las otras dos corridas.

## Validación SPEEDY

```{r read-speedy, cache = FALSE}
vars <- c(gh = "gh", u = "u", t = "temp", v = "v")
vars.z <- paste0(names(vars), ".z")

runs <- c("Control", "NOLAND", "SSTZONAL") 

file.speedy <- "DATA/SPEEDY/speedy.runs.Rds"
speedy <- cache.file(file.speedy, {
    rbindlist(lapply(seq_along(runs), function (x) {
        ReadNetCDF(paste0("DATA/SPEEDY/attm-", runs[x], "_HS.nc"), 
                   vars = vars)[, 
                                run := runs[x]]})) %>% 
        setnames("time", "date") %>% 
        .[, run := factor(run, levels = runs)] %>% 
        .[, t := t - 273.15] %>% 
        .[, c("amplitude", "phase", "r2") := FitQsWave(gh, 3),
          by = .(lat, lev, date, run)] %>% 
        .[, QS3 := amplitude*cos(3*(lon*pi/180 - phase))]
})


psi.sp <- rbindlist(lapply(seq_along(runs), function(x){
    ReadNetCDF(paste0("DATA/SPEEDY/attm-", runs[x], ".nc"), 
               vars = "psi", 
               subset = list(lat = -90:31, lev = 200)) %>%
        .[, run := runs[x]] %>% 
        setnames("time", "date") %>% 
        .[, psi := psi*1e6] %>%
        .[, psi.z := Anomaly(psi), by = .(lat, date)]
    # .[, c("f.lon", "f.lat") := WaveFlux(.SD, p = 200), by = .(date)]
}))
```

```{r calc-sp}

pres.sp <- ReadNetCDF(paste0("DATA/SPEEDY/attm-", runs[1], "_HS.nc"), 
                      vars = "sp") %>% 
    .[, .(sp = mean(sp)), by = .(lon, lat)]

speedy.mean.season <- speedy[, lapply(.SD, mean), 
                             by = .(lon, lat, lev, season(date), run)]
speedy.mean.season <- speedy.mean.season[pres.sp, on = c("lat", "lon")] 

speedy.mean.season[lev < sp, c(vars.z) := lapply(.SD, Anomaly), 
                   by = .(lat, lev, season, run), 
                   .SDcols = names(vars)]

speedy.mean.season[, zeta := Vorticity(u + v ~ lon + lat, cyclical = TRUE,
                                       sphere = TRUE), 
                   by = .(lev, season, run)]
speedy.mean.season[, zeta.dy := Derivate(zeta ~ lon + lat, 
                                         cyclical = c(FALSE, FALSE),
                                         sphere = TRUE)[[2]],
                   by = .(lev, season, run)]

speedy.mean.season[, eta.dy := zeta.dy + f.dy(lat)]
speedy.mean.season[, `:=`(zeta = NULL, zeta.dy = NULL)]
```

```{r calc-sp-nc}
lons <- unique(speedy.mean.season$lon)
lats <- unique(speedy.mean.season$lat)
ncep.interp <- 
    ncep.mean.season %>% 
    melt(id.vars = c("season", "lon", "lat", "lev")) %>% 
    .[variable %in% c(names(vars), vars.z, "eta.dy")] %>% 
    .[, Interpolate.DT(value, lon, lat, lats, lons), 
      by = .(lev, season, variable)]

sp.nc <-  melt(speedy.mean.season[run == "Control"][, run := NULL], 
               id.vars = c("season", "lon", "lat", "lev")) %>% 
    .[ncep.interp, on = c("variable", "season", "lon", "lat", "lev")] %>% 
    .[!is.na(value) & !is.na(i.value)]

sp.nc <- sp.nc[, dif := i.value - value]
```

Para la validación de SPEEDY con respecto a NCEP se muestran los niveles de 200hPa y 500hPa como representación de niveles altos y medios respectivamente. Las conclusiones no cambian sustancialmente en el resto de los niveles. 

Como se mencionó previamente (capítulo\ \ref{datos}), SPEEDY carece de niveles verticales en la estratósfera y su nivel más alto funciona de "esponja" que evita la reflexión de ondas de gravedad, haciendo que no sea un nivel con información confiable.

### Altura Geopotencial

Anomalía

```{r ghz-sp-nc, fig.class = "fullpage", fig.cap = "Anomalía zonal de altura geopotencial (speedy sombreado, ncep contornos)"}
plot.levs.sp <- c(500, 200)
binwidth <- 20
cutlat <- -60
ggplot(speedy.mean.season[run == "Control" & lev %in% plot.levs.sp], aes(lon, lat)) +
    geom_contour_fill(aes(z = gh.z), 
                      binwidth = binwidth, exclude = 0) +
    # geom_contour_fine(aes(z = gh.z), binwidth = binwidth, exclude = 0,
    # color = "black", size = 0.2) +
    geom_contour_back(aes(z = gh.z, linetype = factor(sign(-..level..))),
                      binwidth = binwidth,
                      data = ncep.mean.season[lev %in% plot.levs.sp]) +
    geom_label_contour_back(aes(z = gh.z, label = ..level..),
                            binwidth = binwidth,
                            data = ncep.mean.season[lev %in% plot.levs.sp]) +
    # geom_hline(yintercept = cutlat, 
    # linetype = 2, size = 0.5) +
    scale_fill_divergent(binwidth = binwidth, name = "Z*", 
                         guide = guide_colorstrip_bottom(25)) +
    scale_linetype(guide = "none") +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap()
```

El campo medio de geopotencial está bien representado en el modelo (no se muestra) mientras que las mayores diferencias se encuentran en el campo de anomalías zonales. El mismo se muestra en la \autoref{fig:ghz-sp-nc} donde en sombreado se muestra el campo de SPEEDY y en contornos el correspondiente a NCEP (convención que se mantendrá en el resto de las figuras de validación). SPEEDY representa correctamente la estructura aproximadamente barotrópica equivalente de las anomalías zonales. Reproduce el patrón de QS1 y su intensificación en invierno, aunque en verano es demasiado débil y en invierno demasiado intenso. Por ejemplo, en primavera el máximo de Z en 500hPa en 60°S supera los 120mgp en SPEEDY mientras que en NCEP no llega a 80mgp. 

Si bien la ubicación de los máximos y mínimos de Z en SPEEDY es aproximadamente la correcta no logra capturar parte de la estructura fina. En 500hPa durante otoño, invierno y primavera, SPEEDY presenta un sólo máximo en 120°O a pesar de que NCEP tiene dos máximos identificables con ciclos anuales independientes. 

```{r ghz-dif-sp-nc, fig.class = "fullpage", fig.cap = "Diferencia entre SPEEDY y ncep"}
binwidth <- 20
ggplot(sp.nc[lev %in% plot.levs.sp & variable == "gh.z"], aes(lon, lat)) +
    geom_contour_fill(aes(z = dif), exclude = 0, binwidth = binwidth) +
    scale_fill_divergent(name = "Z*", breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap()
```

En la \autoref{fig:ghz-dif-sp-nc} se muestra la diferencia entre el campo de Z\* de NCEP y SPEEDY. En verano y otoño la principal diferencia radica en que NCEP muestra una alta más intensa de la QS1 al norte de 60°S. En invierno y primavera se observa un tren de ondas con propagación medirional que une el Índico con el Atlántico con número de onda planetaria 3. Un tren de ondas similar fue identificado en las observaciones en la \autoref{sec:viento-meridional}. Su aparición al hacer la resta NCEP - SPEEDY indica que el mismo no está presente en la corrida Control. 

```{r ghz-sp-nc-corte60, fig.class = "textwidth", fig.cap = "Corte zonal de anomalía de geopotencial en -60° (speedy sombreado, ncep contornos)."}
binwidth <- 20
ggplot(speedy.mean.season[run == "Control" & lat %~% cutlat], aes(lon, lev)) +
    geom_contour_fill(aes(z = gh.z), binwidth = binwidth, exclude = 0) +
    geom_contour_back(aes(z = gh.z, linetype = factor(sign(-..level..))), 
                      binwidth = binwidth, 
                      data = ncep.mean.season[lat %~% cutlat]) + 
    geom_label_contour_back(aes(z = gh.z, label = ..level..), 
                            binwidth = binwidth, skip = 2,
                            data = ncep.mean.season[lat %~% cutlat]) +
    scale_fill_divergent(breaks = MakeBreaks(binwidth), name = "Z*",
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    scale_y_level(breaks = plot.levs, minor_breaks = NULL) +
    scale_x_longitude(name = "longitud") +
    coord_lonlev() +
    facet_wrap(~season)
```

En la \autoref{fig:ghz-sp-nc-corte60} se muestra el corte de Z\* en 60°S. Se evidencia la falta de inclinación de las anomalías zonales de SPEEDY, las cuales son mcho más barotrópicas que en las observaciones. Esto indica que la QS1 en SPEEDY no está asociada a transporte de calor hacia el polo, por lo que es de esperarse que los términos en la ecuación de balande de energía tengan distinta magnitud relativa\todo{no sé si se entiende bien lo que quiero decir}. 

### Temperatura 

```{r t-nc-sp, fig.cap = "Temperatura", fig.class = "fullpage"}
binwidth <- 5
cowplot::plot_grid({
    ggplot(speedy.mean.season[run == "Control" & lev %in% 200], aes(lon, lat, z = t)) +
        geom_contour_fill(binwidth = binwidth) +
        # geom_contour_fine(aes(z = gh.z), binwidth = binwidth, exclude = 0,
        # color = "black", size = 0.2) +
        geom_contour_back(aes(linetype = factor(sign(-..level..))),
                          binwidth = binwidth,
                          data = ncep.mean.season[lev %in% 200]) +
        geom_label_contour_back(aes(label = ..level..),
                                binwidth = binwidth,
                                data = ncep.mean.season[lev %in% 200]) +
        # geom_hline(yintercept = cutlat,
        # linetype = 2, size = 0.5) +
        scale_fill_viridis_c(name = "Z*",
                             breaks = MakeBreaks(binwidth),
                             guide = guide_colorstrip_bottom()) +
        scale_linetype(guide = "none") +
        theme(legend.margin = margin(t = -10)) +
        map.SH +
        scale_s_map() +
        coord_quickmap() +
        facet_grid(lev ~ season, labeller = labeller(lev = lev.lab))
},
{
    ggplot(speedy.mean.season[run == "Control" & lev %in% 500], aes(lon, lat, z = t)) +
        geom_contour_fill(binwidth = binwidth) +
        # geom_contour_fine(aes(z = gh.z), binwidth = binwidth, exclude = 0,
        # color = "black", size = 0.2) +
        geom_contour_back(aes(linetype = factor(sign(-..level..))),
                          binwidth = binwidth,
                          data = ncep.mean.season[lev %in% 500]) +
        geom_label_contour_back(aes(label = ..level..),
                                binwidth = binwidth,
                                data = ncep.mean.season[lev %in% 500]) +
        # geom_hline(yintercept = cutlat,
        # linetype = 2, size = 0.5) +
        scale_fill_viridis_c(name = "Z*",
                             breaks = MakeBreaks(binwidth),
                             guide = guide_colorstrip_bottom()) +
        scale_linetype(guide = "none") +
        map.SH +
        scale_s_map() +
        coord_quickmap() +
        facet_grid(lev ~ season, labeller = labeller(lev = lev.lab))
},
{
    ggplot(speedy.mean.season[run == "Control" & lev %in% 850], aes(lon, lat, z = t)) +
        geom_contour_fill(binwidth = binwidth) +
        # geom_contour_fine(aes(z = gh.z), binwidth = binwidth, exclude = 0,
        # color = "black", size = 0.2) +
        geom_contour_back(aes(linetype = factor(sign(-..level..))),
                          binwidth = binwidth,
                          data = ncep.mean.season[lev %in% 850]) +
        geom_label_contour_back(aes(label = ..level..),
                                binwidth = binwidth,
                                data = ncep.mean.season[lev %in% 850]) +
        stat_filter(aes(filter = lev > sp), geom = "tile", color = "white", fill = "white") +
        # geom_hline(yintercept = cutlat,
        # linetype = 2, size = 0.5) +
        scale_fill_viridis_c(name = "Z*",
                             breaks = MakeBreaks(binwidth),
                             guide = guide_colorstrip_bottom()) +
        scale_linetype(guide = "none") +
        map.SH +
        scale_s_map() +
        coord_quickmap() +
        facet_grid(lev ~ season, labeller = labeller(lev = lev.lab))
}, ncol = 1, align = "hv")
```

En la \autoref{fig:t-nc-sp} se muestra el campo total de temperatura de SPEEDY en sombreado y NCEP en líneas. En 850hPa y 500hPa, ambos campos son muy similares, tanto en el gradiente meridional como en las anomalas zonales (que se muestran mejor en la \autoref{fig:tz-nc-sp}). En niveles altos (200hPa) las simulación control diverge considerablemente de las observaciones. En verano y en otoño, SPEEDY muestra un gradiente meridional mucho más importante que NCEP y en invierno y primavera el gradiente máximo se da entre 30°S y 45°S para SPEEDY, y en 60°S en NCEP.

En cuanto a las anomalías zonales (\autoref{fig:tz-sp-nc}), éstas coinciden en niveles bajos, donde la influencia superficial es importante, pero divergen en altura. En 500hPa, las anomalías Antárticas de SPEEDY coinciden aproximadamente en ubicación con las de NCEP aunque son ligeramente más débiles en invierno y primavera. En 60°S, en verano hay buena coincidencia, pero entre otoño e invierno la QS1 observada en esas latitudes virtualmente desaparece en SPEEDY mientras que en primavera vuelve a crecer incluso con mayor intensidad que en NCEP. En 200hPa, SPEEDY carece casi totalmente de anomalías zonales significativas al sur de los 45°S durante todo el año a diferencia de NCEP, que muestra una estructura de QS1 bien definida con máxima amplitud en primavera. Al norte de esa latitud las anomalías de SPEEDY coinciden mejor con NCEP.

```{r tz-sp-nc, fig.cap = "T*"}
plot.levs2 <- c(200, 500, 850)
tz.ncep <- copy(pres)[ncep.mean.season[lev %in% plot.levs2], 
                      on = c("lon", "lat")] %>% 
    .[, t.z := NULL] %>% 
    .[lev < pres, t.z := Anomaly(t), by = .(lat, lev, season)]

binwidth <- 1
ggplot(speedy.mean.season[run == "Control" & lev %in% plot.levs2], 
       aes(lon, lat, z = t.z)) +
    geom_contour_fill(binwidth = binwidth, exclude = 0) +
    # geom_contour_fine(aes(z = gh.z), binwidth = binwidth, exclude = 0,
    # color = "black", size = 0.2) +
    geom_contour_back(aes(linetype = factor(sign(-..level..))),
                      binwidth = binwidth,
                      data = tz.ncep) +
    geom_label_contour_back(aes(label = ..level..),
                            skip = 2,
                            binwidth = binwidth,
                            data = tz.ncep) +
    # geom_hline(yintercept = cutlat, 
    # linetype = 2, size = 0.5) +
    scale_fill_divergent(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_s_map() +
    coord_quickmap() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) 
```

### Viento zonal

```{r u-sp-nc-corte, fig.class = "textwidth", fig.cap = "Viento zonal medio (speedy contornos, ncep sombreado)."}
speedy.mean.season[run == "Control", 
                   .(u = mean(u)), 
                   by = .(lat, lev, season)] %>% 
    ggplot(aes(lat, lev)) +
    geom_contour_fill(aes(z = u), binwidth = 5) +
    geom_contour_back(aes(z = u, linetype = factor(-sign(..level..))), 
                      binwidth = 5,
                      data = ncep.mean.season[, .(u = mean(u)), 
                                              by = .(lat, lev, season)]) +
    geom_label_contour_back(aes(z = u, label = ..level..), 
                            binwidth = 5,
                            data = ncep.mean.season[, .(u = mean(u)), 
                                                    by = .(lat, lev, season)]) +
    surface +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_divergent(name = "U media zonal", breaks = MakeBreaks(5),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    coord_latlev() +
    facet_wrap(~season)
```

En la \autoref{fig:u-sp-nc-corte} se muestra el viento zonal para SPEEDY y NCEP. El jet subtropical se encuentra más al norte y ligéramente más elevado en verano, así como considerablemente más intenso en todas las estaciones. La principal discrepancia se da en altura. Por encima de los 30hPa, SPEEDY carece de niveles verticales y aún por debajo no logra desarrollar un jet polar. En invierno y primavera hay un aumento del viento zonal con la altura en latitudes donde debería estar el jet, pero no llega a formar un máximo ni alcanza las magnitudes observadas en NCEP. Esta falta de niveles verticales también se observa en los estes ecuatoriales de menor magnitud en verano y otoño. 

Dada la importancia del jet polar en la dinámica atmosférica durante los meses de invierno y primavera\todo{cita}, su mala representación es una limitación muy importante del modelo SPEEDY. 


```{r u-sp-nc, fig.class = "fullpage", fig.cap = "Viento zonal (contornos ncep, sombreado speedy)."}
binwidth <- 5
ggplot(RepeatLon(speedy.mean.season[run == "Control" & lev == 200]), aes(lon, lat)) +
    geom_contour_fill(aes(z = u), binwidth = binwidth) +
    geom_contour_back(aes(z = u, linetype = factor(-sign(..level..))), 
                      binwidth = binwidth, 
                      data = RepeatLon(ncep.mean.season[lev == 200])) +
    geom_label_contour_back(aes(z = u, label = ..level..), 
                            binwidth = binwidth, 
                            data = RepeatLon(ncep.mean.season[lev == 200])) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = binwidth, size = 0.1) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(name = "U", breaks = MakeBreaks(5),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    # coord_quickmap() +
    coord_polar() +
    # coord_map(projection = "stereographic", orientation = c(-90, 0, 0)) +
    facet_wrap(~season, labeller = labeller())
```


```{r u-dif-sp-nc, fig.cap = "Diferencia entre ncep y speedy en viento zonal"}
binwidth <- 5

ggplot(RepeatLon(sp.nc[lev == 200 & variable == "u"]), aes(lon, lat)) +
    geom_contour_fill(aes(z = dif), exclude = 0, binwidth = binwidth) +
    scale_fill_divergent(name = "Z*", breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_polar() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) 
```

Cosas para ver:    
Jet polar en invierno y primavera en niveles altos (< 100 hPa). Jest subtropical en niveles "medios".

### Gradiente meridional de vorticidad absoluta

```{r etady-sp-nc, fig.class = "fullpage", fig.cap = "Gradiente meridional de vorticidad absoluta (speedy)."}
mult <- 1e11
binwidth <- 1e-11*mult
ggplot(speedy.mean.season[run == "Control" & lev == 200 & lat > -85], 
       aes(lon, lat, z = eta.dy*mult)) +
    stat_contour_fill(binwidth = binwidth) +
    # geom_contour_fine(binwidth = binwidth, color = "black") +
    geom_label_contour2(aes(label = ..level..), 
                        binwidth = binwidth) +
    stat_contour_fill(breaks = 0, 
                      fill = "grey80", alpha = 0.5, complete = FALSE) +
    # stat_filter(aes(filter = eta.dy <= 0), geom = "tile",
    # color = "gray50", fill = "gray50") +
    # stat_contour_fill(breaks = 0,
    # fill = "black", complete = FALSE) +
    geom_contour_fine(breaks = 0, color = "black") +
    map.SH +
    # polar.SH + 
    scale_fill_divergent(name = "Gradiente meridional de vorticiad absoluta", 
                         guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    scale_s_map() +
    coord_quickmap() +
    # coord_polar() + 
    facet_wrap( ~ season, labeller = labeller(lev = lev.lab))
```

Comparando con la figura \autoref{fig:etady-ncep} (nivel de 200hPa), se ve que la franja de máximo gradiente presente en todas las estaciones es más zonal en el caso de SPEEDY y corrida hacia el sur en verano. La región de gradientes negativos que se desarrolla en invierno sobre Nueva Zelanda tiene menor extensión y no aparece en otoño ni primavera. 


```{r ks-sp,  include = FALSE, fig.cap = "Número de onda estacionario en 300hPa (speedy).", fig.height = 6}
a <- 6371000

speedy.mean.season[, k := sqrt(eta.dy/u)*(a*cos(lat*pi/180))]
sp.ks <- speedy.mean.season[run == "Control" & lev == 200,
                            .(lon, lat, lev, season, k)]
sp.ks[ , k.full := ifelse(is.na(k) | k > 10, -1, k)]
# 
# ggplot(sp.ks, aes(lon, lat)) +
#     geom_contour_fine(aes(z = k.full), breaks = 0:9, color = "black") +
#     # stat_contour(aes(z = k.full),
#     #              breaks = c(2.5, 3.5), color = "black") +
#     geom_label_contour2(aes(z = k.full, label = ..level..),
#                         breaks = 0:9, skip = 0) +
#     stat_filter(aes(filter = k.full == -1), geom = "tile", color = "gray50",
#                 fill = "gray50") +
#     map.SH +
#     scale_s_map() +
#     scale_fill_viridis_c(breaks = 1:9, guide = guide_colorstrip_bottom()) +
#     coord_quickmap() +
#     facet_wrap(~season)
```

En la \autoref{fig:ks-sp-nc-corte} se muestra un corte meridional del número de onda estacionario en 180°. En verano no hay regiones prohibidas en ningún modelo, pero la región entre 45°S y 60°S aparece como un mínimo en SPEEDY y un máximo en NCEP. Esto implica que la propagación meridional inhibida para un amplio rango de números de onda en SPEEDY pero no en NCEP. En particular, la QS3 puede propagarse meridionalmente en las observaciones, pero no en el modelo. En otoño la situación es inversa: al rededor de 40°S, NCEP muestra una región con número de onda estacionario imaginario, impidiendo la propagación meridional, mientras que en SPEEDY no existe tan impedimento. La QS3 nuevamente se ve afectada, teniendo propagación meridional irrestricta al norte de 60°S en SPEEDY pero quedando atrapada al sur de 50°S en las observaciones. En invierno y primavera la cooncordancia entre SPEEDY y NCEP es mayor. 

```{r ks-sp-nc-corte, fig.class = "textwidth", fig.cap = "Número de onda estacionario medio por círculo de latitud."}
rbind(ncep.mean.season[lev == 200, .(lon, lat, lev, season, k, k.full)][lon %~% 180][, mod := "NCEP"], 
      sp.ks[lon %~% 180][, mod := "SPEEDY"]) %>%
    .[, k := ifelse(k > 9 | !is.finite(k), NA, k)] %>% 
    ggplot(aes(lat, k, color = mod)) +
    geom_line() +
    scale_y_continuous(name = "Número de onda estacionaria", breaks = 1:9,
                       limits = c(1, 9)) +
    scale_x_latitude(name = "Latitud", ticks = 15) +
    scale_color_brewer(palette = "Set1") +
    facet_wrap(~season) +
    coord_flip() + theme(aspect.ratio = 1)
```

### Función corriente

```{r psi-sp, fig.class = "fullpage", fig.cap = "Función corriente x 1099"}
psi.sp.season <- psi.sp[, lapply(.SD, mean), 
                        by = .(lon, lat, lev, season(date), run)] %>% 
    .[, c("f.lon", "f.lat") := WaveFlux(.SD, p = 200), by = .(season, run, lev)]

sp.l <- melt(psi.sp.season, 
             id.vars = c("lon", "lat", "lev", "season", "run"))
s <- sp.l[, value[run == "Control"]]
sp.l[, dif := value - s, by = run]
run.dif <- setNames(paste0(runs[-1], "-\n Control"),
                    runs[-1])
psi.dif <- dcast(sp.l[run != "Control"][, -c("value")], 
                 ... ~ variable, 
                 value.var = "dif")
remove(sp.l)

mult <- 1e-9
binwidth <- 0.005
ggplot(psi.sp.season[run == "Control"], aes(lon, lat)) +
    stat_contour_fill(aes(z = psi.z*mult),
                      binwidth = binwidth,
                      complete = FALSE, exclude = 0) +
    geom_contour_fine(aes(z = psi*mult), 
                      binwidth = 0.02,
                      color = "black") +
    geom_vector(aes(dx = f.lon, dy = f.lat), skip = 1, min.mag = 0.05, 
                scale = 50, size = 0.2) +
    map.world +
    # scale_s_map() +
    scale_x_longitude(limits = c(0, 360)) +
    scale_y_latitude(limits = c(-90, 30)) +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season) +
    theme(axis.title = element_blank()) + 
    coord_quickmap()
```

La función corriente en 200hPa de SPEEDY se muestra en la \autoref{fig:psi-sp} (donde el sombreado corresponde a la anomalía zonal y las felchas a los flujos de actividad de onda) en comparación con los mismos campos de NCEP (\autoref{fig:psi-ncep}; notar que en NCEP está en coordenadas $\sigma$) existe una correspondencia general buena en los trópicos. La localización de los máximos y mínimos coincide en aproximadamente en todas las estaciones. En verano y primavera no aparece la alta de Bolivia relacionada con el SAMS, pero sí la baja del noroeste. La intensidad de las anomalías es menor en todas las estaciones, especialmente en el HN. Consecuentemente, también tienen menor magnitud los flujos de actividad de onda

### Onda 3

```{r ampl-sp-nc, fig.class = "pagewidth", fig.cap = "Amplitud de Fourier (speedy en sombreado, ncep en contornos)."}

# qs.sp.season <- speedy[, lapply(.SD, mean),
#                       by = .(lat, lev, season(date), run), 
#                       .SDcols = c("amplitude", "phase", "r2")]

qs.sp.season <- speedy.mean.season[, FitQsWave(gh, k = 3), by = .(lat, lev, run, season)]

# breaks <- 2^seq(0, log2(650), by = 0.5)
binwidth <- 5
ggplot(qs.sp.season[run == "Control"], aes(lat, lev)) +
    geom_contour_fill(aes(z = amplitude), binwidth = binwidth) +
    geom_contour_back(aes(z = amplitude), 
                      data = ncep.qs[k == 3], binwidth = binwidth) +
    geom_label_contour_back(aes(z = amplitude, label = ..level..), 
                            data = ncep.qs[k == 3], binwidth = binwidth) +
    surface +
    geom_index.region(rect.annotation) +
    scale_fill_viridis_c(name = "Amplitud (escala logarítmica)", 
                         guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth),
                         option = "D") +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse", 
                     ticks = 15) +
    coord_latlev() +
    facet_wrap(~ season)
```

En la \autoref{fig:ampl-sp-nc} se muestra la amplitud de la QS3 media para SPEEDY en contornos y NCEP en líneas. En verano, entre 45°S y 60°S SPEEDY coincide con NCEP en la localización y extension del máximo, pero subestima la intensidad. El máximo secundario en latitudes bajas aparece más al sur y en un nivel más alto en SPEEDY. En otoño, speedy carece casi por completo de señal de QS3 en  comparación con NCEP. Si se calcula la amplitud media de la QS3 SPEEDY sí tiene una señal importante (no se muestra), indicando que la diferencia con NCEP se debe no a la falta de una onad 3, sino a su característica no estacionaria. En invierno, la amplitud de la QS3 media está subestimada en SPEEDY y corrida hacia el polo. Además, está mucho más restringida a niveles troposféricos en comparación con NCEP; posiblemente como consecuencia de la falta de niveles verticales y la mala representación del jet polar. En primavera, por el contrario, la señal en SPEEDY es considerablemente mayor que en NCEP. 


```{r calc-qs3-sp}
lons <- unique(speedy$lon)
qs.wave.sp.season <- speedy[lev == 300, .(mean = mean(QS3)), 
                            by = .(lon, lat, season(date), run)]
```

La QS3 reconstruida para SPEEDY se muestra en la \autoref{fig:qs3-sp-nc} donde además de confirmarse la variación de la amplitud prevista a partir de la \autoref{ampl-sp-nc}, se puede apreciar la estructura horizontal. En verano, invierno y privamera, la inclinación de los centros es hacia el este, contraria a las observaciones e indicando transporte de cantidad de movimiento zonal hacia el norte en vez de hacia el sur. En otoño, por supuesto, el campo de QS3 de SPEEDY es virtualmente nulo. 

```{r qs3-sp-nc, fig.class = "pagewidth", fig.cap = "Media de reconstrucción de onda 3 (sombreado speedy, contornos ncep)", fig.height = 6}
binwidth <- 10
cutlat <- data.frame(lat = c(-52.5), 
                     season = c("Verano"))
ggplot(qs.wave.sp.season[run == "Control"], aes(lon, lat)) +
    geom_contour_fill(aes(z = mean), binwidth = binwidth, exclude = 0, na.rm= T) +
    # geom_contour(aes(z = mean), binwidth = binwidth) +
    geom_contour_back(aes(z = mean, linetype = factor(-sign(..level..))),
                      binwidth = binwidth,
                      data = qs.wave.season[lev == 300]) +
    geom_label_contour_back(aes(z = mean, label = ..level..), 
                            binwidth = binwidth,
                            data = qs.wave.season[lev == 300]) +
    map.SH +
    scale_s_map() +
    scale_linetype(guide = "none") +
    scale_fill_divergent(breaks = MakeBreaks(binwidth), name = "QS3",
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) +
    coord_quickmap()
```


## Comparación entre corridas

Como se vio en la sección XX, además de la corrida Control, se realizaron 3 corridas para evaluar la sensibilidad de la QS3 a distintos parámetros del modelo. **NOLAND** es idéndica a **Control** a excepción de que se desactivaron los modelos de mar, hielo y tierra y se reemplazó la SST por su media climatológica mensual. **SSTZONAL** es similar, pero la SST fue reemplazada por su media zonal mensual. 

### Altura geopotencial

Los campos de Z\* en 200hPa para cada corrida se muestra en la \autoref{fig:ghz-sp-runs}. La corrida NOLAND no presenta diferencias obvias con respecto a Control. SSTZONAL en cambio, muestra una clara disminución de las anomalías zonales. Todas las corridas presentan una QS1 en altas latitudes con máximo en invierno pero su intensidad es notablemente menor en SSTZONAL en comparación a las otras dos. La QS1 en latitudes polares, en cambio, mantiene su amplitud en todas las corridas. 

```{r ghz-sp-runs, fig.class = "fullpage", fig.cap = "Anomalía zonal de altura geopotencial."}
plot.levs.sp <- 200
binwidth <- 20

ggplot(speedy.mean.season[lev == 200], aes(lon, lat)) +
    geom_contour_fill(aes(z = gh.z), 
                      binwidth = binwidth, exclude = 0) +
    scale_fill_divergent(binwidth = binwidth, name = "Z*", 
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_s_map() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(lev = lev.lab)) 
```

La figura \autoref{fig:ghz-dif-sp-runs} muestra la diferencia entre Z\* de la corrida Control y las corridas de sensibilidad. NOLAND sólo muestra cambios significativos en invierno y primavera, donde la diferencia es un tren de ondas de propagación meridional muy similar al observado en la \autoref{fig:ghz-dif-sp-nc} y presente en las observaciones (\autoref{sec:viento-meridional}). Es decir que a pesar de que la corrida Control carece del mismo, éste se desarrolla correctamente si se elimina la variabilidad de la temperatura superficial y su interacción con la atmósfera. 

La diferencia entre SSTZONAL y Control se da principalmente entre 45°S y 60°S y responde a la casi desaparición de la QS1 en esas latitudes. Estos resultados son consistentes con los de @Quintanar1995 dado que la eliminación de las anomalías zonales reduciría la convección anómala que genera los trenes de onda que ellos concluyeron son el principal sostén de este patrón. En invierno y primavera, está presente el tren de ondas observado en NOLAND - Control, pero con menor amplitud. Esto quizás se deba a que éste se encuentra enmascarado por los otros cambios. 

```{r ghz-dif-sp-runs, fig.calss = "fullpage", fig.cap = "Diferencia Corrida - control para Z*"}
speedy.mean.season.l <- melt(speedy.mean.season, 
                             id.vars = c("lon", "lat", "lev", "season", "run"))

s <- speedy.mean.season.l[, value[run == "Control"]]
speedy.mean.season.l[, dif := value - s, by = run]
run.dif <- setNames(paste0(runs[-1], "-\n Control"),
                    runs[-1])
sp.dif <- dcast(speedy.mean.season.l[run != "Control"][, -c("value")], 
                ... ~ variable, 
                value.var = "dif")
remove(speedy.mean.season.l)

binwidth <- 10
ggplot(sp.dif[lev == 200], aes(lon, lat, z = gh.z)) +
    geom_contour_fill(binwidth = binwidth) +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = "colorstrip_bottom") +
    coord_quickmap() +
    # coord_polar() +
    facet_grid(run ~ season, labeller = labeller(run = run.dif))
```

### Temperatura


<!-- ```{r t-sp-runs, fig.cap = "Temperatura media en 850hPa.", fig.publish = FALSE} -->
<!-- binwidth <- 5 -->
<!-- ggplot(speedy.mean.season[lev == 850], aes(lon, lat)) + -->
<!--     geom_contour_fill(aes(z = t),  -->
<!--                       binwidth = binwidth) + -->
<!--     scale_fill_viridis_c(breaks = MakeBreaks(binwidth), -->
<!--                          name = "Z*",  -->
<!--                          guide = guide_colorstrip_bottom()) + -->
<!--     map.SH + -->
<!--     scale_y_latitude() + -->
<!--     scale_x_longitude() + -->
<!--     coord_quickmap() + -->
<!--     facet_grid(run ~ season, labeller = labeller(lev = lev.lab))  -->
<!-- ``` -->


<!-- ```{r tz-sp-runs, fig.cap = "Temperatura media en 850hPa."} -->
<!-- binwidth <- 2 -->
<!-- ggplot(speedy.mean.season[lev == 850], aes(lon, lat)) + -->
<!--     geom_contour_fill(aes(z = t.z),  -->
<!--                       binwidth = binwidth, exclude = 0) + -->
<!--     scale_fill_divergent(breaks = MakeBreaks(binwidth), -->
<!--                          name = "Z*",  -->
<!--                          guide = guide_colorstrip_bottom()) + -->
<!--     map.SH + -->
<!--     scale_y_latitude() + -->
<!--     scale_x_longitude() + -->
<!--     coord_quickmap() + -->
<!--     facet_grid(run ~ season, labeller = labeller(lev = lev.lab))  -->
<!-- ``` -->

La \autoref{fig:tzdif-sp-runs} presenta la diferencia de temperatura en 850hPa entre las corridas. Para NOLAND, las únicas diferencias se dan en la Antártida en verano e invierno, donde ésta simula temperaturas menores y mayores respectivamente. Al no tener un suelo que interactúa con el aire, es posible???

SSTZONAl tiene las mismas diferencias que NOLAND en la Antártida, a la que se le suman diferencias en latitude más bajas a causa de la eliminación de los contrastes zonales de SST. Durante todo el año hay temperaturas mayores en la costa este del Pacífico y menores en la oeste, indicando una situación tipo Niño que, en realidad representan la desaparición de la lengua fría al este y la pileta de agua cálida al oeste. 

```{r tz-dif-sp-runs, fig.class = "fullpage", fig.cap = "Diferencia Control - corrida para T"}
binwidth <- 1
ggplot(sp.dif[lev == 850], aes(lon, lat, z = t)) +
    geom_contour_fill(binwidth = binwidth, exclude = 0) +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = "colorstrip_bottom") +
    coord_quickmap() +
    # coord_polar() +
    facet_grid(run ~ season, labeller = labeller(run = run.dif))
```

### Viento zonal

<!-- ```{r uz-sp-runs, fig.class = "fullpage", fig.cap = "Viento zonal"} -->
<!-- binwidth <- 5 -->
<!-- ggplot(speedy.mean.season[lev == 200], aes(lon, lat)) + -->
<!--     geom_contour_fill(aes(z = u), -->
<!--                       binwidth = binwidth, -->
<!--                       # breaks = MakeBreaks(binwidth), -->
<!--                       exclude = 0) + -->
<!--     scale_fill_divergent(name = "Z*", -->
<!--                          breaks = MakeBreaks(binwidth), -->
<!--                          guide = guide_colorstrip_bottom()) + -->
<!--     scale_linetype(guide = "none") + -->
<!--     map.SH + -->
<!--     scale_y_latitude() + -->
<!--     scale_x_longitude() + -->
<!--     coord_quickmap() + -->
<!--     facet_grid(run ~ season, labeller = labeller(lev = lev.lab)) -->
<!-- ``` -->


```{r u-dif-sp-runs, fig.cap = "Diferencia control - corrida para U.", fig.class = "fullpage"}
binwidth <- 2.5
ggplot(sp.dif[lev == 200], aes(lon, lat)) +
    geom_contour_fill(aes(z = u), 
                      binwidth = binwidth,
                      # breaks = MakeBreaks(binwidth),
                      exclude = 0) +
    scale_fill_divergent(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(run = run.dif)) 
```

La diferencia del viento meridional entre corridas se muestra en la \autoref{fig:u-dif-sp-runs}. NOLAND - Control casi nulas diferencias en otoño. En verano NOLAND tiene vientos más inensos al norte y sur de Nueva Zelanda y menos intensos sobre ésta región, indicando una intensificación de los bloqueos con respeto a la corrida Control; el mismo patrón se observa en primavera. En invierno y primavera hay valores positivos en latitudes bajas indicando un debilitamiento de los alisios. 

En SSTZONAL el patrón de aumento de los bloqueos se ve intensificado. En otoño, invierno y primavera se observan franjas de valores negativos al sur de 30° y positivos al norte, indicando que el jet se encuentra desplazado hacia el norte. En las regiones ecuatoriales, los alisios son más intensos durante todo el año, lo cual resulta paradójico dada la estructura tipo Niño observada en la \autoref{fig:tzdif-sp-runs}. 

### Función corriente

```{r psi-sp-runs, fig.class = "fullpage", fig.cap = "Anomalía zonal de función corriente y flujos de acción de onda."}
mult <- 1e-9
binwidth <- 0.005
ggplot(psi.sp.season, aes(lon, lat)) +
    geom_contour_fill(aes(z = psi.z*mult), 
                      binwidth = binwidth,
                      exclude = 0, complete = FALSE) +
    scale_fill_divergent(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    geom_vector(aes(dx = f.lon, dy = f.lat), skip = 1,
                min.mag = 0.05,
                scale = 50, size = 0.2) +
    scale_linetype(guide = "none") +
    map.world +
    scale_s_map(limits.lat = c(-90, 30)) +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(lev = lev.lab)) 
```

En la \autoref{fig:psi-sp-runs} se muestra la anomalía zonal de la función corriente para cada corrida y los flujos de acción de onda. La misma es consistente con las observaciones generales de la \autoref{fig:ghz-sp-runs}. Para todos los meses las anomalías en SSTZONAL son muy menores que las otras dos corridas y los flujos de actividad de onda son casi nulos en el HS y menores que las otras dos corridas en los trópicos del HN. La persistencia de las anomalías en el HN en comparación con el HS sugiere que el forzante principal de estos patrones de onda es el orográfico, ya que éste es el único forzante zonalmente asimétrico en SSTZONAL. 

Para la corrida NOLAND, las diferencias son mínimas en verano y otoño. En invierno y primavera se observan anomalías más intensas al rededor de 30° y los flujos de acción de onda que son más hacia el sur al rededor de 60°E en comparación a la corrida Control. Nuevamente, esto es consistente con lo visto en la \autoref{fig:ghz-dif-sp-runs} donde en NOLAND aparecía el tren de ondas desde el Índico hacia el pacífico que estaba ausente en la corrida Control.

```{r psiz-dif-sp-runs, fig.cap = "Diferencia en psi.z y flujos de acción de onda."}
mult <- 1e-9
binwidth <- 0.005
ggplot(psi.dif, aes(lon, lat, z = psi.z*mult)) +
    geom_contour_fill(binwidth = binwidth,
                      # breaks = MakeBreaks(binwidth),
                      exclude = 0) +
    scale_fill_divergent(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    geom_vector(aes(dx = f.lon, dy = f.lat), skip = 1,
                min.mag = 0.05,
                scale = 50, size = 0.2) +
    scale_linetype(guide = "none") +
    map.world +
    scale_s_map(limits.lat = c(-90, 30)) +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(run = run.dif)) 
```

La diferencia de la anomalía zonal función corriente y de los flujos de acción de onda entre las corridas se muestra en la \autoref{fig:psiz-dif-sp}. Las diferencias indicadas en los párrafos anteriores se muestran con más claridad. 

\todo[inline]{Esto es medio poco y podría borrarse. No sé.}

### Onda 3

```{r ampl-sp-runs, fig.cap = c("Amplitud de la onda 3 media para cada corrida."), fig.height = 5}
sp.levs <- unique(speedy$lev)
binwidth <- 5
ggplot(qs.sp.season, aes(lat, lev)) +
    geom_contour_fill(aes(z = amplitude), binwidth = binwidth) +
    scale_x_latitude(trans = "reverse") +
    scale_y_level(breaks = sp.levs)+
    scale_fill_viridis_c(guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    ylab("Nivel") + xlab("Latitud") +
    surface +
    coord_latlev() +
    facet_grid(run ~ season)
```

En la \autoref{fig:ampl-sp-runs} se muestra la amplitud de la QS3 para cada estación y cada corrida. En verano se observa una reducción de la señal de la QS3 en 60°S entre Control, NOLAND y SSTZONAL además de un ligero corrimiento hacia el sur. La señal de más al norte, en cambio, no presenta cambios importantes más allá del mismo corrimiento que la señal anterior. En otoño la poca señal existente en Control prácticamente desaparece en en SSTZONAl, pero no hay cambios en NOLAND. En SSTZONAL hay un aumento de la amplitud de la QS3 en la costa antártica.  

En invierno, NOLAND tiene la mayor señal de QS3 entre las simulaciones y Control, la mínima. Esto posiblemente se deba a la aparición del tren de ondas desde el Índico identificado en la \autoref{fig:ghz-dif-sp-runs}. Primavera es la estación con el cambio más dramático. Pasa de tener la señal más alta en la Corrrida control a tener una de las menores en NOLAND y SSTZONAL. La amplitud de la QS3 en 60°S y 300hPa desaparece prácticamente en su totalidad

\todo[inline]{de nuevo las diferencias no muestran nada distinto que no se vea en los campos. Quizás lo saco.}

```{r ampl-dif-sp-runs, fig.cap = "Diferencia de amplitud entre la corrida control y cada corrida.", fig.height = 5}
qs.sp.season[, dif := amplitude - qs.sp.season[run == "Control", amplitude],
             by = run]
binwidth <- 2
dif <- setNames(paste0(runs[-1], " -\nControl"),
                runs[-1])
ggplot(qs.sp.season[run != "Control"], aes(lat, lev)) +
    geom_contour_fill(aes(z = dif), binwidth = binwidth, exclude = 0, complete = F) +
    scale_y_level(breaks = sp.levs) +
    scale_x_latitude(trans = "reverse") +
    scale_fill_divergent(guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    coord_latlev() +
    # surface + 
    facet_grid(run ~ season, 
               labeller = labeller(run = dif))
```

Es importante notar que estas observaciones son sensibles a la metodología utilizada. La \autoref{fig:ampl-mean-sp-runs} muestra la amplitud media de la QS3 para cada corrida y es útil compararla con la \autoref{fig:ampl-sp-runs} (que muestra la amplitud de la QS3 media). Verano se comporta de manera similar, con una ligera disminución de la señal en NOLAND y SSTZONAL. 

Otoño tiene un gran cambio. Tanto la corrida Control como NOLAND y SSTZONAL tienen una señal fuerte que no cambia significativamente entre corridas. Esto indica que la baja señal en otoño en SPEEDY tiene es causada por que la onda 3 está presente mes a mes, pero no estacionariamente. Lo mismo parece suceder invierno de la corrida Control y primavera de NOLAND y SSTZONAL.

```{r ampl-mean-sp-runs, fig.cap = c("Amplitud media de la onda 3 mensual para cada corrida."), fig.height = 5}
mean.qs.sp <- speedy[lon == 0, .(amplitude = mean(amplitude)), 
                     by = .(lat, lev, run, season(date))] 

sp.levs <- unique(speedy$lev)
binwidth <- 5
ggplot(mean.qs.sp, aes(lat, lev)) +
    geom_contour_fill(aes(z = amplitude), binwidth = binwidth) +
    scale_x_latitude(trans = "reverse") +
    scale_y_level(breaks = sp.levs)+
    scale_fill_viridis_c(guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    ylab("Nivel") + xlab("Latitud") +
    surface +
    coord_latlev() +
    facet_grid(run ~ season)
```


<!-- ```{r} -->
<!-- sp.index[, density.circular(phase.c, bw = 10)[c("x", "y")], by = .(season(date), run)] %>% -->
<!--     ggplot(aes(x*180/pi/3, color = run)) +  -->
<!--     geom_line(aes(color = run, y = y)) +  -->
<!--     geom_rug(data = copy(sp.index)[, season := season(date)], -->
<!--              aes(x = phase*180/pi), alpha = 0.5) + -->
<!--     facet_wrap(~season) +  -->
<!--     scale_x_continuous(limits = c(0, 120)) -->
<!-- ``` -->


```{r calc-sp-index}
levs.index <- c(700, 300, 100)
lats.index <- c(-65, -40)
levs.index <- c(100, 700)

speedy[, phase.c := circular(phase*3, modulo = "2pi")]
sp.index <- speedy[(lev %b% levs.index) & 
                       (lat %b% lats.index) & 
                       lon == 0,
                   .(amplitude   = mean(amplitude),
                     r2          = mean(r2),
                     phase  = mean.circular(phase.c)/3),
                   by = .(date, run)]
sp.index[, phase.c := circular(phase*3, modulo = "2pi")]
```

```{r sd-fase-sp-runs, fig.cap = "Desvío estándar (en grados) de la fase media mensual para cada estación y cada corrida."}
sp.index[, .(sd = sd.circular(phase.c)*180/pi/3), by = .(run, season(date))] %>% 
    ggplot(aes(factor(season), sd)) +
    geom_col(aes(fill = run), position = "dodge", width = 0.5) +
    geom_hline(yintercept = 30, size = 0.3) +
    scale_y_continuous(name = "SD de la fase") +
    scale_x_discrete(name = "") +
    scale_fill_brewer(palette = "Set1") +
    theme(panel.grid.major.x = element_blank())
```

Para profundizar en esta observación, la \autoref{fig:sd-fase-sp-runs} muestra el desvío estándar de la fase media mensual para cada estación y corrida. Si se asume distribución normal, aproximadamente el 95% de los datos están en un rango de $\pm 2\sigma$ al rededor de la media. Como la fase está acotada entre 0° y 120°, valores de $\sigma$ por encima de 30° implica que los datos están distribuidos casi uniformemente en todo el dominio.

En verano, el desvío es mínimo y aumenta ligeramente en NOLAND y SSTZONAL pero siempre por debajo de los 30°. En otoño, todas las corridas muestran valores altos muy por encima de los 30°, indicando que hay muy poca estacionaridad en todas las corridas. En invierno, la corrida Control está en el límite de los 30° y NOLAND y SSTZONAL tienen valores menores. En primavera, la corrida Control tiene valores mínimos de $\sigma$ mientras que NOLAND y SSTZONAL presentan valores muy altos, por encima de los 30°. Estos valores son consistentes con lo observado en la comparación de las figuras\ \ref{fig:ampl-dif-sp-runs} y\ \ref{fig: ampl-mean-sp-runs} y sugieren que las diferencias observadas entre las corridas en la señal de la QS3 se deben principalmente a mayor o menor estacionaridad y no a una mayor o menor amplitud de las onda planetaria 3. 

En la \autoref{fig:index-sp-boxplot}, se muestra el ciclo anual de la amplitud de la onda 3 para cada corrida. La amplitud media en ningún mes presenta cambios significativos entre los modelos, dando más peso a la hipótesis de que los cambios observados en la señal de la QS3 se deben a cambios en la variabiliad de la fase. 

```{r index-sp-boxplot, fig.cap = "Ciclo anual de amplitud de onda 3."}

ggplot(sp.index, aes(factor(month(date)), amplitude)) +
    # geom_violin() +
    geom_boxplot(aes(fill = run)) +
    scale_fill_brewer(palette = "Set1") +
    scale_x_discrete(name = "Mes", labels = month.abb_sp) +
    scale_y_continuous(name = "Amplitud") +
    theme(panel.grid.major.x = element_blank())
```


### Regresiones

```{r calc-regr-psi-sp}
regr.file <- "DATA/regression-exps.Rds"
regr.psi.sp <- cache.file(regr.file, {
    psi.sp[, .(lon, lat, date, run, psi)] %>% 
        .[sp.index[, .(date, run, amplitude, phase)], on = c("date", "run")] %>% 
        .[, ExtractLm(
            RcppArmadillo::fastLm(cbind(mean = 1,
                                        amplitude = amplitude/sd(amplitude), 
                                        phase = phase),
                                  psi)),
          keyby = .(lat, lon, month(date), run)] %>% 
        .[, t := abs(estimate)/se] %>% 
        .[, estimate.z := Anomaly(estimate),
          by = .(lat, month, run, regressor)] %>% 
        setnames("estimate.z", "psi.z") %>% 
        .[, c("f.lon", "f.lat") := WaveFlux(.SD), by = .(regressor, month, run)]
})
```

<!-- ```{r psi-regr-runs, cache = FALSE, fig.cap = "Regresión de psi con la amplitud de la QS3.", fig.subcap = c("DEF", "MAM", "JJA", "SON"), fig.class = "fullpage", fig.show = "hold"} -->
<!-- mult <- 1e-9 -->
<!-- binwidth <- 0.0005 -->

<!-- regr.psi.sp[, monthf := factor(month, levels = c(12, 1:11), ordered = T)] -->

<!-- lapply(1:4, function(n){ -->
<!--     print( -->
<!--         ggplot(regr.psi.sp[regressor == "amplitude", ], aes(lon, lat)) + -->
<!--             geom_contour_fill(aes(z = psi.z*mult),  -->
<!--                               binwidth = binwidth, -->
<!--                               exclude = 0, complete = FALSE) + -->
<!--             scale_fill_divergent(name = "Z*",  -->
<!--                                  breaks = MakeBreaks(binwidth), -->
<!--                                  guide = guide_colorstrip_bottom()) + -->
<!--             geom_vector(aes(dx = f.lon, dy = f.lat), skip = 1, -->
<!--                         min.mag = 0.005, -->
<!--                         scale = 500, size = 0.2) + -->
<!--             scale_linetype(guide = "none") + -->
<!--             map.world + -->
<!--             scale_s_map(limits.lat = c(-90, 30)) + -->
<!--             coord_quickmap() + -->
<!--             facet_grid_paginate(run ~ monthf, nrow = 3, ncol = 3, page = n, -->
<!--                                 labeller = labeller(monthf = month.abb_sp)) -->
<!--     ) -->
<!-- }) -->
<!-- ``` -->


\todo[inline]{hasta acá}




## Cosas inesperadas...

me dio neumonía. :(

Y pericarditis.

* ?? 
* protif!

# Conclusiones

# Agradecimientos

A las médicas y enfermeras del Sanatorio Güemes que me cuidaron durante mi internación.

# Referencias


```{r ending-cheer, eval = !params$draft, include = !params$draft}
beepr::beep(3)
```

