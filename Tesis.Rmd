---
title: "Tesis"
subtitle: "Una tesis"
author: "Elio Campitelli"
date: "`r Sys.Date()`"
lang: es-AR
bibliography: Papers/Biblio.bib
link-citations: yes
output:
    pdf_document:
        fig_height: 10
        fig_width: 8
        toc: yes
        toc_depth: 4
        number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy = FALSE,
                      echo = FALSE, 
                      cache = TRUE, 
                      warning = FALSE)
library(data.table)
library(ggplot2)
library(metR)
source("scripts/helperfun.R")
source("scripts/geom_contourlabel.R")

map.world <- BuildMap(res = 3, smooth = 1)
map.SH <- map.world[lat %b% c(-90, 0)]
map.world <- geom_map2(map.world)
map.SH <- geom_map2(map.SH)

theme_elio <- theme_minimal() +
    theme(legend.position = "bottom")
theme_set(theme_elio)

polar.SH <- list(coord_polar(),
                 scale_y_latitude(limits = c(-90, 0)),
                 scale_x_longitude())

guide_colorbar_bottom <- function(width = 25, height = 0.5, ...) {
    guide_colorbar(title.position = "top", title.hjust = 0.5,
                   barheight = height,
                   barwidth = width, ...)
}

scale_s_map <- function() list(scale_y_latitude(), scale_x_longitude())

AddSuffix <- function(suffix = "") {
    function(string) {
        paste0(string, suffix)
    }
}

lev.lab <- AddSuffix(" hPa")

MakeBreaks <- function(binwidth = NULL, exclude = NULL) {
    # If no parameters set, use pretty bins
    if (is.null(binwidth)) {
        breaks <- function(range) {
            b <- pretty(range, 10)
            b[!(b %in% exclude)]
        }
    } else {
        breaks <- function(range) {
            b <- scales::fullseq(range, binwidth)
            b[!(b %in% exclude)]
        }
    }
}

## Hooks.

DefineHook <- function(class.name, class.opts) {
    class.name <- deparse(substitute(class.opts))
    class.fun <- function(options) {
        # print(class.name)
        class <- options[[class.name]]
        class <- class.opts[[class]]
        # print(class)
        options[names(class)] <- as.list(class)
        options
    }
    invisible(knitr::opts_hooks$set(
        setNames(list(class.fun), class.name)
    ))
}


fig.class <- list(
    fullpage = c(
        fig.width = 9,
        fig.height = 12,
        out.width = "\\textwidth", 
        out.height = "\\textheight",
        fig.align = "center"),
    halfpage = c(
        fig.width = 9,
        fig.height = 3,
        # out.width = "\\textwidth",
        out.height = "0.5\\textheight",
        fig.align = "center")
)

DefineHook(fig.class)

```

Por ahora esto es un outline y no mucho más. 

Numerar las cosas. Figuras relevantes para cada sección. 

# Introducción

## Motivación

Algo más substancioso que "me interesa la gran escala y el clima de altas latitudes" :P 

* Efectos en nuestra región. 
* Analogía con estudios en el hemisferio norte. 

## Conceptos básicos

* Ondas cuasiestacionarias
* Fluos de activdiad de onda

## Antecedentes

* Quintanar y Mechoso, Raphael, et. al. 

## Hipótesis

¿Tengo una?

## Métodos

Descripción de los experimentos. 

## Fuentes de datos

## Modelo SPEEDY

# Climatología observada

## Campos medios y anomalías. 

```{r read_ncep}
ncep <- ReadNetCDF("DATA/NCEP/hgt.mon.mean_sub.nc", vars = c(gh = "hgt"))
setnames(ncep, "level", "lev")
ncep[, t := ReadNetCDF("DATA/NCEP/air.mon.mean_sub.nc", out = "vector")]
ncep[, u := ReadNetCDF("DATA/NCEP/uwnd.mon.mean_sub.nc", out = "vector")]
ncep[, v := ReadNetCDF("DATA/NCEP/vwnd.mon.mean_sub.nc", out = "vector")]

vars <- c("gh", "t", "u", "v")
vars.z <- paste0(vars, ".z")

ncep.mean <- ncep[, lapply(.SD, mean), 
                  by = .(lat, lon, lev, month(date))]

ncep.mean <- ncep.mean[, c(vars.z) := lapply(.SD, Anomaly), 
                       by = .(lat, lev, month), 
                       .SDcols = -"lon"]

ncep.mean.season <- ncep.mean[, lapply(.SD, mean), 
                              by = .(lon, lat, lev, season = AssignSeason(month))]
```


### Altura geopotencial

Campo medio:

```{r gh_campo_medio_ncep, fig.class = "fullpage"}
plot.levs <- c(500, 300, 200, 100, 30)
binwidth <- 250
ggplot(RepeatLon(ncep.mean.season[lev %in% plot.levs]), aes(lon, lat)) +
    stat_contour(aes(z = gh), binwidth = binwidth, color = "black", size = 0.5) +
    map.SH +
    geom_contourlabel(aes(z = gh, label = ..level..), binwidth = binwidth,
                      size = 1.6) +
    scale_s_map() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap() 
```

Cosas para ver:    
Estructura dominantemente zonal. Zona de jet, variación de intensidad estacional. Vórtice polar en invierno/primavera. 

Anomalías

```{r gh_anomalia_ncep, fig.class = "fullpage"}
binwidth <- 60
cutlat <- -60
ggplot(RepeatLon(ncep.mean.season[lev %in% plot.levs]), aes(lon, lat)) +
    stat_contour_fill(aes(z = gh.z), binwidth = binwidth, exclude = 0) +
    geom_hline(yintercept = cutlat, linetype = 2, size = 0.5) +
    # geom_contour(aes(z = gh.z), binwidth = 60, color = "gray27", size = 0.2) +
    # geom_contourlabel(aes(z = gh.z, label = ..level..), binwidth = 60) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(binwidth = binwidth, name = "Z*", exclude = 0, 
                         guide = guide_colorbar_bottom(25)) +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap()
```

Cosas para ver:    
Estructura de onda 1. Ciclo estacional de la amplitud. Baroclinicidad. 

Propuesta: unir ambos mapas

```{r}
binwidth.mean <- 250
binwidth.anom <- 60
ggplot(RepeatLon(ncep.mean.season[lev %in% plot.levs]), aes(lon, lat)) +
    stat_contour_fill(aes(z = gh.z), binwidth = binwidth.anom, exclude = 0) +
    stat_contour(aes(z = gh), binwidth = binwidth.mean, color = "black", size = 0.5) +
    map.SH +
    geom_contourlabel(aes(z = gh, label = ..level..), binwidth = binwidth.mean,
                      size = 1.6) +
    scale_fill_divergent(binwidth = binwidth.anom, name = "Z*", exclude = 0, 
                         guide = guide_colorbar_bottom(25)) +
    scale_s_map() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap() 
```




Corte zonal en -65°

```{r gh_zonal65_ncep, fig.class = "halfpage", fig.height = 4, fig.width = 9}
binwidth. <- 60
ggplot(RepeatLon(ncep.mean.season[lat %~% cutlat]), aes(lon, lev)) +
    stat_contour_fill(aes(z = gh.z), binwidth = binwidth, exclude = 0) +
    scale_fill_divergent(binwidth = binwidth, exclude = 0, name = "Z*",
                         guide = guide_colorbar_bottom(width = 25)) +
    scale_y_level(breaks = plot.levs, minor_breaks = NULL) +
    scale_x_longitude(name = "longitud") +
    facet_wrap(~season)
```

Complementa la figura anterior. 

Desvío estándar por círculo de latitud:

```{r gh_sd_ncep, fig.class = "halfpage"}
binwidth <- 20
ncep.mean[lev %in% plot.levs, .(sd = sd(gh.z)), by = .(lat, lev, month)] %>% 
    ggplot(aes(month, lat)) +
    stat_contour_fill(aes(z = sd), binwidth = binwidth) +
    # geom_contour(aes(z = sd), binwidth = binwidth) +
    scale_fill_viridis_c(name = "Desvío estándar de Z* por círculo de latitud",
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorbar_bottom(25)) +
    scale_y_latitude(name = "latitud") +
    scale_x_continuous(name = "mes", breaks = 1:12, labels = month.abb_sp, 
                       expand = c(0, 0)) +
    facet_wrap(~lev, labeller = labeller(lev = AddSuffix(" hPa")))
```

Cosas para ver:    
Latitud de mayor actividad de onda. Máximo en octubre en 300 hPa. Más adelante, se hace la misma figura pero con el desvío estándar asociado a cada número de onda. 

### Viento zonal:
Campo medio:

```{r u_medio_ncep, fig.class = "fullpage"}
ggplot(RepeatLon(ncep.mean.season[lev %in% plot.levs]), aes(lon, lat)) +
    geom_contour(aes(z = u, color = ..level..), binwidth = 15, size = 0.5) +
    geom_contour(aes(z = u, color = ..level..), binwidth = 5, size = 0.1) +
    geom_contourlabel(aes(z = u, color = ..level..), binwidth = 15, step = 1,
                      size = 3, vjust = "inward", hjust = "inward") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_color_divergent(name = "U", breaks = MakeBreaks(5),
                          guide = guide_colorbar_bottom()) +
    coord_quickmap() +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
```

Cosas para ver:    
Jet polar en invierno y primavera en niveles altos (< 100 hPa). Jest subtropical en niveles "medios".

```{r u_medio_corte_ncep, fig.class = "halfpage"}
ncep.mean.season[, .(u = mean(u)), by = .(lat, lev, season)] %>% 
    ggplot(aes(lat, lev)) +
    geom_contour(aes(z = u, color = ..level..), binwidth = 15) +
    geom_contour(aes(z = u, color = ..level..), binwidth = 5, size = 0.1) +
    geom_contourlabel(aes(z = u, color = ..level..), binwidth = 15, step = 1,
                      size = 3) +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_color_divergent(name = "U media zonal", breaks = MakeBreaks(5),
                          guide = guide_colorbar_bottom()) +
    facet_wrap(~season)
```

Cosas para ver:    
Extensión y localización vertical de los jets. 


### Temperatura

```{r temp_media_ncep, fig.class = "fullpage"}
binwidth <- 5
ggplot(ncep.mean.season[lev %in% c(plot.levs, 1000)], aes(lon, lat)) +
    geom_contour(aes(z = t), binwidth = binwidth, color = "black") +
    geom_contourlabel(aes(z = t), binwidth = binwidth,
                      size = 1.6) +
    map.SH +
    # scale_color_viridis_c(name = "T", guide = guide_colorbar_bottom(25), 
                          # breaks = MakeBreaks(binwidth)) +
    coord_quickmap() +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
```

Cosas para ver:    
Gradiente muy pequeño en 200 hPa. Gradiente inverso en estratósfera. Núcleo cálido en ~50° (que se va a ver mejor en la anomalía zonal). Temperaturas frías en altas y bajas latitudes pero relativamente cálidas en ~50° en 100 hPa.


```{r temp_corte_ncep, fig.class = "halfpage"}
binwidth <- 5
ggplot(ncep.mean.season[, .(t = mean(t)), by = .(lat, lev, season)],
       aes(lat, lev)) +
    stat_contour_fill(aes(z = t)) +
    scale_y_level(breaks = plot.levs, minor_breaks = NULL) + 
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_viridis_c(name = "Temperatura media zonal", 
                         breaks = MakeBreaks(binwidth), 
                         guide = guide_colorbar_bottom()) +
    facet_wrap(~season)
```



```{r temp_zonal_ncep, fig.class = "fullpage"}
binwidth <- 1
ggplot(RepeatLon(ncep.mean.season[lev %in% plot.levs]), aes(lon, lat)) +
    stat_contour_fill(aes(z = t.z), binwidth = binwidth, exclude = 0) +
    map.SH +
    scale_fill_divergent(binwidth = binwidth, name = "T*", exclude = 0, 
                         guide = guide_colorbar_bottom(25)) +
    scale_y_latitude() +
    scale_x_longitude() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap() 
```

Cosas para ver:   
Coincidencia entre la onda estacionaria 1 en gh y de t (en primavera). 

Propuesta: combinar mapa de T y T*


### Viento meridional?

Campos medios.

```{r v_medio_ncep, fig.class = "halfpage"}
binwidth <- 5
ggplot(RepeatLon(ncep.mean.season[lev %in% plot.levs]), aes(lon, lat)) +
    geom_contour(aes(z = v, color = ..level..), binwidth = binwidth, size = 0.5) +
    geom_contour(aes(z = v, color = ..level..), binwidth = 1, size = 0.1) +
    geom_contourlabel(aes(z = v, color = ..level..), binwidth = binwidth, step = 1,
                      size = 3, vjust = "inward", hjust = "inward") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_color_divergent(name = "V", breaks = MakeBreaks(1),
                          guide = guide_colorbar_bottom()) +
    coord_quickmap() +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
```

Cosas para ver:    
    No mucha actividad salvo por la onda 1 en niveles altos (consistente con la onda 1 de geopotenical).

Corte meridional (v medio zonal):

```{r v_corte_ncep, fig.class = "halfpage"}
binwidth <- 0.5
ggplot(ncep.mean.season[lev >= 30, .(v = mean(v)), by = .(lat, lev, season)],
       aes(lat, lev)) +
    stat_contour_fill(aes(z = v), binwidth = binwidth, exclude = 0) +
    scale_y_level(breaks = unique(ncep.mean.season$lev), minor_breaks = NULL) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_divergent(name = "V media zonal", 
                         breaks = MakeBreaks(binwidth, 0), 
                         guide = guide_colorbar_bottom()) + 
    facet_wrap(~season)
```

Cosas para ver:    
    Dipolo entre niveles bajos y altos que alterna entre invierno y verano (parte convergente en superficie y divergente en altura de la ITCZ que se mueve hacia el hemisferio de verano). En altas latitudes, en superficie hay máximos de viento del sur debido a los vientos catabáticos de la antártida.

## Ondas Quasiestacionarias

* Fourier

* Onda 1 a 4. 
* Amplitud, r2, etc...
* Fase. 

* Wavelets
+ Comparación.

Venajas y desventajas. Justificaicón de decisión. 

## Creación del índice

## Antecedentes

Breve comentario sobre los índices usados en otros lados. Discutir ventajas y debilidades.

* Amplitud
* Fase (impacto en SA) 

De todo eso, motiva decisión del índice.

## Índice propio

* Niveles elegidos
* Promedio vs. máximo
* Composiciones de campos y flujos.
* Decisión del índice. 

## Análisis dinámica de septiembre



## Fuentes de actividad de onda

## Fuentes de variabilidad interna

(Discusión escrita más de papers), Pero nos concentramos en la fuente externa.

## Fuentes externas

Campos de correlación con SST y OLR, principalmente
¿Discusión de otros forzantes?

# Experimentos

## Validación SPEEDY

* Comparación campos medios. 
* Validación de las corridas experimentales (mostrar que es constante lo que tiene que ser consante)

## Comparación 

Comparación entre corridas y ncep.

## Cosas inesperadas...

* ?? 
* protif!

# Conclusiones

# Agradecimientos

# Referencias


