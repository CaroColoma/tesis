---
title: "Tesis"
subtitle: "Una tesis"
author: "Elio Campitelli"
date: ""
lang: es-AR
bibliography: [Papers/Biblio.bib, Papers/packages.bib]
geometry: "inner = 5cm, outer = 5cm, top = 2.5cm, bottom = 2.5cm"
documentclass: book
classoption: a4paper
knit: (function(file, encoding, ...) {
    rmarkdown::render(file, encoding = encoding, 
                output_dir = "docs/")})
output:
    pdf_document:
      fig_height: 3
      fig_width: 6
      keep_tex: yes
      latex_engine: xelatex
      number_sections: yes
      toc: yes
      toc_depth: 4
header-includes: 
    - \linespread{1.25}
    - \usepackage{subfig}
    - \usepackage{hyperref}
    - \usepackage{marginnote}
    - \usepackage[nomarkers,figuresonly]{endfloat}
    - \usepackage[spanish]{todonotes}
    - \usepackage{wrapfig}
link-citations: yes
params: 
    draft: TRUE
biblio-style: apalike
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy = FALSE,
                      echo = FALSE, 
                      cache = TRUE, 
                      force.cap = TRUE,
                      fig.calss = "pagewidth",
                      fig.ncol = 1,
                      fig.publish = TRUE,
                      cache.lazy = TRUE,
                      cache.path = "cache/tesis/",
                      fig.path = "fig/tesis/",
                      out.extra = " ",
                      warning = FALSE,
                      message = FALSE)

library(tufte)
library(data.table)
library(ggplot2)
library(dplyr)
library(metR) 
library(WaveletComp)
library(patchwork)
library(circular)

knitr::write_bib(c("base", "data.table", "ggplot2", "WaveletComp", "metR"), 
                 file = "Papers/packages.bib")

source("scripts/helperfun.R")

data.world <- BuildMap(res = 1, smooth = 1)
map.world <- geom_map2(data.world)
map.SH <- geom_map2(data.world[lat %b% c(-90, 0)])


pres <- ReadNetCDF("DATA/NCEP/srfp.mon.mean.nc")
pres.mean <- pres[, .(pres = median(pres)), by = lat]
pres.mean <- rbind(data.table(lat = 0.0, pres = Inf), 
                   pres.mean, 
                   data.table(lat = -90.0, pres = Inf))
surface <- geom_polygon(data = pres.mean, aes(y = pres), fill = "white", 
                        alpha = 0.5, color = "gray30", size = 0.5)
pres <- pres[, .(pres = mean(pres)), by = .(lon, lat)]

theme_elio <- theme_minimal(base_size = 11) +
    theme(legend.position = "bottom", legend.box = "vertical",
          panel.spacing.y = unit(5, "mm"),
          panel.spacing.x = unit(5, "mm"),
          legend.spacing = unit(2, "mm"),
          plot.margin = grid::unit(rep(3, 4), "mm"),
          legend.title = element_blank(),
          panel.grid = element_line(color = "black", size = 0.2, linetype = 3),
          panel.ontop = TRUE)
theme_set(theme_elio)

## Hooks.

## Force captions
plot_hook <- knitr::knit_hooks$get("plot")
knitr::knit_hooks$set(
    plot = function(x, options) {
        if (options$force.cap == TRUE & is.null(options$fig.cap)) {
            stop("All figures must have captions.")
        }
        if (params$draft == TRUE) {
            options$fig.cap <- paste0(options$fig.cap, " - fig:", 
                                      knitr::opts_current$get("label"))
        }
        if (options$fig.publish == FALSE) {
            options$fig.cap <- paste0(options$fig.cap, " - SÓLO BORRADOR")
        }
        if (options$fig.publish == TRUE | params$draft == TRUE) {
            plot_hook(x, options)
        }
    })
## Figure classes
DefineClass <- function(class.opts) {
    class.name <- deparse(substitute(class.opts))
    class.fun <- function(options) {
        class <- options[[class.name]]
        class <- class.opts[[class]]
        options[names(class)] <- class
        options
    }
    invisible(knitr::opts_hooks$set(
        setNames(list(class.fun), class.name)
    ))
}

page.width <- 210 - 30 - 30
text.width <- page.width - 20
text.height <- page.height <- 297 - 25 - 25

fig.class <- list(
    pagewidth = list(
        fig.width = page.width/25.4,
        out.width = paste0(page.width, "mm"),
        # fig.align = "center",
        fig.env = "figure*",
        out.extra = " "
    ),
    textwidth = list(
        fig.width = text.width/25.4,
        out.width = paste0(text.width, "mm"),
        fig.env = "figure",
        fig.align = "center",
        out.extra = " "
    ),
    fullpage = list(
        fig.width = (page.height - 20)/25.4,
        fig.height = page.width/25.4,
        out.width = paste0(page.height - 20, "mm"),
        fig.align = "center",
        out.extra = "angle=90"
    ),
    vfullpage = list(
        fig.width = page.width/25.4,
        fig.height = (page.height - 20)/25.4,
        out.width = paste0(page.width, "mm"),
        fig.align = "center"
    ),
    halfpage = list(
        # out.width = "7.3cm",
        fig.width = (page.width/2)/25.4,
        out.width = paste0(page.width/2, "mm")
    ),
    
    medium = list(
        fig.width = 8,
        fig.height = 4,
        # out.width = "\\textwidth",
        # out.height = "0.25\\textheight",
        fig.align = "center")
)

DefineClass(fig.class)

setDTthreads(3)
```


Resumen.


```{r read-ncep, cache = FALSE}
file.ncep <- "DATA/NCEP/ncep.vars.Rds"
ncep <- cache.file(file.ncep, {
    ncep <- ReadNetCDF("DATA/NCEP/hgt.mon.mean_sub.nc", vars = c(gh = "hgt"))
    setnames(ncep, "level", "lev")
    ncep <- 
        ncep[, t := ReadNetCDF("DATA/NCEP/air.mon.mean_sub.nc", 
                               out = "vector")[[1]]] %>% 
        .[, u := ReadNetCDF("DATA/NCEP/uwnd.mon.mean_sub.nc", 
                            out = "vector")[[1]]] %>% 
        .[, v := ReadNetCDF("DATA/NCEP/vwnd.mon.mean_sub.nc", 
                            out = "vector")[[1]]]
    
    vars <- c("gh", "t", "u", "v")
    vars.z <- paste0(vars, ".z")
    ncep[, c(vars.z) := lapply(.SD, Anomaly), by = .(lat, lev, date), .SDcols = -"lon"]
    ncep
})


ncep[, date := as.Date(date), by = date]
ncep.mean <- ncep[, lapply(.SD, mean), 
                  by = .(lat, lon, lev, month(date))]

ncep.mean.season <- ncep.mean[, lapply(.SD, mean), 
                              by = .(lon, lat, lev, season(month))]
```

\todo[inline]{Listado de abreviaturas}
\todo[inline]{Revisar TODOS los epígrafes}



# Introducción


* Antecedentes    
Además de lo que hay en lo de las becas + lo que fui encontrando, agregar sobre las climatologías disponibles y sus limitaciones. 
* Objetivo General
* Objetivo particular 

Esto es para probar una referencia bibliográfica: @Vera2004 y [@Vera2004]

# Métodos y Materiales

\todo[inline]{Agregar en algún lugar algo sobre las estadísticas circulares}

## Conceptos básicos

* Ondas cuasiestacionarias
* Fourier
* wavelets

\todo[inline]{chequear este paper: https://link.springer.com/article/10.1007/s00024-012-0635-9}

```{r fitqs-ncep}
ncep.qs.all <- ncep[, FitQsWave(gh, k = 1:4), by = .(lat, lev, date)]
```


Ejemplo:

```{r calc-fourier-ejemplo}
# set.seed(2)
select.date <- as.Date("1999-03-01")
wave <- ncep[date == select.date & lev == 300, 
             .(lon, lat, date, gh)]
wave[, gh.z := Anomaly(gh), by = .(lat)][
    , k := "campo"]

lons <- unique(ncep$lon)
qs.wave <- ncep.qs.all[date == select.date & lev == 300 & k < 4, 
                       .(lon = lons, 
                         gh.z = amplitude*cos(k*(lons*pi/180 - phase))),
                       by = .(lat, date, k)]
wave <- rbind(wave[, -c("gh")], qs.wave)
wave[, k := factor(k, levels = c("campo", 1:3))]
```


```{r fourier-ejemplo, fig.class = "pagewidth", fig.cap = "Ejemplo fourier"}
binwidth <- 20
ggplot(RepeatLon(wave), aes(lon, lat)) +
    stat_contour_fill(aes(z = gh.z), 
                      binwidth = binwidth, size = 0.5) +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(name = "", 
                         binwidth = binwidth, 
                         guide = guide_colorstrip_bottom()) +
    theme(axis.title = element_blank()) +
    facet_wrap(~ k, ncol = 4) +
    coord_polar()

```

Cosas para ver de \autoref{fig:fourier-ejemplo}:   
Descripción del "rol" de cada número de onda en generar el campo final. 
La QS1 es la principal, marcando altas presiones al sur del pacífico y bajas al sur de África. La onda 3 modifica ese patrón simple haciendo que los máximos y mínimos no sean continuos.


* Wavelets 


```{r calc-wavelet-ejemplo}
test <- ncep[lev == 300 & date == as.Date("2008-09-01") & lat %~% -60]
test.1 <- copy(test)
test.2 <- copy(test)
test.1[, lon := lon - 360]
test.2[, lon := lon + 360]
test.a <- rbind(test.1, test, test.2)

dlon <- diff(ncep$lon[1:2])
w <- WaveletComp::WaveletTransform(test.a$gh.z, dt = 1, upperPeriod = 360/dlon)

ampl <- w$Ampl*sd(test.a$gh.z)
dimnames(ampl) <- list(period = w$Period, lon = test.a$lon)
ampl <- as.data.table(melt(ampl))
ampl[, period := period*dlon]
ampl1 <- ampl[Between(lon, c(0, 360), include = c(T, F))]
ampl1[, lat := -60]

test <- ncep[lev == 300 & date == as.Date("2008-09-01") & lat %~% -45]
test.1 <- copy(test)
test.2 <- copy(test)
test.1[, lon := lon - 360]
test.2[, lon := lon + 360]
test.a <- rbind(test.1, test, test.2)

dlon <- diff(ncep$lon[1:2])
w <- WaveletComp::WaveletTransform(test.a$gh.z, dt = 1, upperPeriod = 360/dlon)

ampl <- w$Ampl*sd(test.a$gh.z)
dimnames(ampl) <- list(period = w$Period, lon = test.a$lon)
ampl <- as.data.table(melt(ampl))
ampl[, period := period*dlon]
ampl2 <- ampl[Between(lon, c(0, 360), include = c(T, F))]
ampl2[, lat := -45]
ampl <- rbind(ampl1, ampl2)

ncep.wv <- ncep[date == as.Date("2008-09-01") & lev == 300,
                .(lon = lon, gh.z = gh.z,
                  amplitude = unlist(PeriodicWavelet(gh, 3))),
                by = .(lat, lev, date)]
```


```{r wavelet-ejemplo, fig.show = "hold", fig.env = "figure*", fig.height = 70/25.4, fig.cap = "Wavelets", fig.class = "halfpage", fig.subcap = c("Campo", "Análisis de Wavelets en círculos de latitud señalados."), fig.ncol = 2}

ggplot(RepeatLon(ncep.wv[date == as.Date("2008-09-01") & lev == 300]), 
       aes(lon, lat)) +
    stat_contour_fill(aes(z = gh.z), exclude = 0,
                      binwidth = 75, size = 0.3) +
    stat_contour(aes(z = amplitude, color = ..level..), 
                 binwidth = 15, size = 0.4) +
    geom_hline(yintercept = -60, linetype = 2) +
    geom_hline(yintercept = -45, linetype = 2) +
    map.SH +
    scale_y_latitude(limits = c(-90, 0)) +
    scale_x_longitude() +
    scale_color_viridis_c(name = "Amplitud de onda 3", 
                          breaks = MakeBreaks(25, 0),
                          guide = "none") +
    scale_fill_divergent(guide = guide_colorstrip_bottom(15),
                         breaks = MakeBreaks(binwidth = 75)) +
    theme(axis.title = element_blank()) +
    scale_linetype_discrete(name = "Anomalía zonal de geopotencial", drop = T) +
    coord_polar()

ggplot(ampl, aes(lon, 360/period)) +
    # geom_tile(aes(fill = value)) +
    stat_contour(aes(z = value, color = ..level..), binwidth = 15) +
    # geom_contour(aes(z = pval), breaks = c(0.001), color = "black") +
    scale_y_continuous(name = "Número de onda zonal", 
                       breaks = 1:10, limits = c(NA, 5), 
                       expand = c(0, 0)) +
    scale_x_longitude(name = "longitud") +
    geom_hline(yintercept = 3, linetype = 3, alpha = 0.4) +
    scale_color_viridis_c(breaks = MakeBreaks(15),
                          guide = guide_colorstrip_bottom(15, inside = T)) +
    facet_wrap(~lat, ncol = 2, labeller = labeller(lat = AddPreffix("Latitud: ")))
```

Cosas para ver:    
Cambio en el máximo. Localización en vez de un número para cada latitud. 


## Fuentes de datos

## Descripción de SPEEDY

# Climatología observada

## Altura geopotencial

Campo medio:

```{r gh-ncep, fig.class = "fullpage", fig.cap = "Campo de Z (NCEP)"}
plot.levs <- c(500, 300, 200, 100, 50)
binwidth <- 250
ggplot(ncep.mean.season[lev %in% plot.levs], aes(lon, lat)) +
    geom_contour_fine(aes(z = gh), binwidth = binwidth, color = "black") +
    map.SH +
    geom_label_contour2(aes(z = gh, label = ..level..), binwidth = binwidth,
                        size = 1.6) +
    scale_s_map() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap() 
```

El campo de altura geopotencial media (Z, \autoref{fig:gh-ncep}) muestra una estructura más zonal en el HS que en el HN. Es evidente la generación del vórtice polar en la estratósfera de invierno y primavera y el aumento del gradiente meridional de Z con la altura. 

```{r ghdy-ncep-corte, fig.cap = "Gradiente meridional de Z", fig.publish = FALSE}
ncep.mean.season[, mean(gh), by = .(lat, lev, season)] %>% 
    .[, gh.dy := Derivate(V1 ~ lat), by = .(lev, season)] %>% 
    # .[, .(gh.dy = mean(gh.dy, na.rm = T)), by = .(lev, season)] %>% 
    # ggplot(aes(lev, gh.dy, color = season)) +
    # geom_line() + 
    # scale_x_level() +
    # coord_flip()
    ggplot(aes(lat, lev)) +
    geom_contour_fill(aes(z = gh.dy), binwidth = 10, na.rm = T) +
    surface +
    scale_fill_viridis_c(breaks = MakeBreaks(10),
                         guide = guide_colorstrip_bottom()) +
    scale_fill_divergent() +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(trans = "reverse") +
    facet_wrap(~season)
```


```{r ghz-ncep, fig.class = "fullpage", fig.cap = "Anomalía zonal de altura geopotencial."}
binwidth <- 20
cutlat <- -60
ggplot(ncep.mean.season[lev %in% plot.levs], aes(lon, lat)) +
    geom_contour_fill(aes(z = gh.z), binwidth = binwidth, exclude = 0) +
    # geom_hline(yintercept = cutlat, linetype = 2, size = 0.5) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(binwidth = binwidth, name = "Z*", exclude = 0, 
                         guide = guide_colorstrip_bottom(25)) +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap()
```

Las anomalías zonales (\autoref{fig:ghz-ncep}) muestran una preponderancia de una onda 1 (QS1) con una amplitud máxima en la estratósfera de primavera y una estructura coherente en la vertical en 60°S (\autoref{fig:ghz-ncep-corte60}). Pueden diferenciarse dos QS1 distintas; una centrada en ~60°S y con el centro anticiclónico al rededor de la línea de fecha, y la otra sobre la costa del continente y el centro anticiclónico entre 120 y 60°O. @Quintanar1995 concluyó que el primero está asociado principalmente con forzantes de latitudes bajas mientras que el segundo responde a la orografía del continente antártico.

Salvo en verano, la inclinación hacia el oeste en la horizontal y en la vertical indica que las perturbaciones estacionarias están asociadas con transporte hacia el polo tanto de cantidad de movimiento zonal como de temperatura. \todo[inline]{¿Debería agregar una justificación de esto? ¿Un resumen del desarrollo matemático que está en el James?} 

En verano, las anomalías zonales tienen una estructura barotrópica equivalente y carecen de inclinación en la horizontal. Consecuentemente, los transportes meridionales asociados se reducen considerablemente. \todo{¿Por qué?}

```{r ghz-ncep-corte60, fig.class = "textwidth", fig.cap = "Corte zonal de anomalía de geopotencial en -60°."}
binwidth <- 60
ggplot(ncep.mean.season[lat %~% cutlat], aes(lon, lev)) +
    geom_contour_fill(aes(z = gh.z), binwidth = binwidth, exclude = 0) +
    scale_fill_divergent(binwidth = binwidth, exclude = 0, name = "Z*",
                         guide = guide_colorstrip_bottom(width = 25)) +
    scale_y_level(breaks = plot.levs, minor_breaks = NULL) +
    scale_x_longitude(name = "longitud") +
    facet_wrap(~season)
```


```{r uzvz-ncep-corte, fig.cap = "Transportes", fig.subcap = c("uz*vz*", "T*v*"), fig.publish = FALSE}
ncep[, mean(u.z*v.z), by = .(lat, lev, season(date))] %>% 
    ggplot(aes(lat, lev)) +
    geom_contour(aes(z = V1, color = ..level..), binwidth = 5) +
    scale_color_divergent(breaks = MakeBreaks(5)) +
    scale_y_level() +
    scale_x_latitude(trans = "reverse") +
    facet_wrap(~season)

ncep[, mean(v.z*t.z), by = .(lat, lev, season(date))] %>% 
    ggplot(aes(lat, lev)) +
    geom_contour(aes(z = V1, color = ..level..)) +
    scale_color_divergent(breaks = MakeBreaks()) +
    scale_y_level() +
    scale_x_latitude(trans = "reverse") +
    facet_wrap(~season)

```

El ciclo anual de la amplitud de las ondas estacionarias se observa en \autoref{fig:sd-gh-ncep}, donde se muestra el desvío estándar de Z por círculo de latitud para cada mes \todo{¿Explicar la relación de esto con la amplitud de la onda?}. La mayor amplitud se encuentra centrado al rededor de los 60°S, como ya se vio en la \autoref{fig:ghz-ncep} y alcanza su máximo entre agosto y octubre, y el mínimo entre febrero y abril, según el nivel. 

```{r sd-gh-ncep, fig.class = "textwidth", fig.cap = "Desvío estándar por círculo de latitud."}
binwidth <- 15
ncep.mean[lev %in% plot.levs & !(lev %in% c(50)), .(sd = sd(gh.z)), by = .(lat, lev, month)] %>% 
    ggplot(aes(month, lat)) +
    stat_contour(aes(z = sd, color = ..level..), binwidth = binwidth,
                 size = 0.3) +
    # geom_contour(aes(z = sd), binwidth = binwidth) +
    scale_color_viridis_c(name = "Desvío estándar de Z* por círculo de latitud",
                          breaks = MakeBreaks(binwidth),
                          guide = guide_colorstrip_bottom(inside = T)) +
    scale_y_latitude(name = "latitud") +
    scale_x_continuous(name = "mes", breaks = 1:12, labels = month.abb_sp, 
                       expand = c(0, 0)) +
    facet_wrap(~lev, scales = "free", labeller = labeller(lev = AddSuffix(" hPa")))
```

## Temperatura

```{r t-ncep, fig.class = "fullpage", fig.cap = "Temperatura media."}
binwidth <- 5
ggplot(ncep.mean.season[lev %in% c(plot.levs, 850)], aes(lon, lat)) +
    geom_contour(aes(z = t), binwidth = binwidth, color = "black") +
    geom_label_contour2(aes(z = t, label = ..level..), binwidth = binwidth) +
    geom_tile(data = pres[, lev := 850][pres < 850], fill = "white", color = "white") +
    map.SH +
    scale_s_map() +
    coord_quickmap() +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
```

En la tropósfera, la temperatura (\autoref{fig:t-ncep}) presenta una estructura zonal con mayor baroclinicidad en invierno. En 200 hPa los gradientes meridionales son mínimos y por encima de ese nivel éstos se revierten, dando lugar a temperaturas ecuatoriales menores que las polares (\autoref{fig:tz-ncep-corte}). Por encima de 100 hPa de invierno y primavera, hay un máximo relativo en ~45° \todo{¿Por qué?} y una región de anomalías zonales positivas que se ve claramente incluso en el campo total, particularmente en primavera. 

```{r tz-ncep-corte, fig.class = "textwidth", fig.cap = "Corte meridional de temperatura media."}
binwidth <- 5
ggplot(ncep.mean.season[, .(t = mean(t)), by = .(lat, lev, season)],
       aes(lat, lev)) +
    geom_contour_fine(aes(z = t, color = ..level..)) +
    surface +
    scale_y_level(breaks = plot.levs, minor_breaks = NULL) + 
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_color_viridis_c(name = "Temperatura media zonal", 
                          breaks = MakeBreaks(binwidth), 
                          guide = guide_colorstrip_bottom()) +
    facet_wrap(~season)
```


```{r tz-ncep, fig.class = "fullpage", fig.cap = "Anomalía zonal de temperatura."}
binwidth <- 1
ggplot(ncep.mean.season[lev %in% c(plot.levs, 850)], 
       aes(lon, lat)) +
    stat_contour_fill(aes(z = t.z), binwidth = binwidth, exclude = 0) +
    geom_tile(data = pres[, lev := 850][pres < 850], 
              fill = "white", color = "white") +
    # geom_hline(yintercept = cutlat, linetype = 2, size = 0.5) +
    map.SH +
    scale_fill_divergent(breaks = MakeBreaks(binwidth), 
                         limits = c(-9, NA),
                         name = "T*", 
                         guide = guide_colorstrip_bottom(25)) +
    scale_y_latitude() +
    scale_x_longitude() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap() 
```


Como se puede apreciar en el campo de T* (\autoref{fig:tz-ncep}), en invierno y primavera, los niveles altos están dominados por una QS1 con máximo en el sur de Australia y mínimo en el Atlántico sur. En niveles más bajos, la onda se defasa hacia el este y queda casi en cuadratura (\autoref{fig:tz-ncep-corte60}) con el máximo en 850hPa en Antártida occidental. 

\todo[inline]{¿Más detalle?}

En los trópicos, las anomalías de temperatura presentan un patrón de onda 3 con máximos en los continentes y mínimos en los océanos que se revierten de signo en 100hPa. Estas características tienen su correlato en la altura geopotencial y corresponden a circulaciones tipo Walker \todo{¿Es así?}. 

```{r tz-ncep-corte60, fig.class = "textwidth", fig.cap = "Corte zonal de anomalía de temperatura en -60°."}
binwidth <- 1
ggplot(ncep.mean.season[lat %~% cutlat], aes(lon, lev)) +
    stat_contour_fill(aes(z = t.z), binwidth = binwidth, exclude = 0) +
    scale_fill_divergent(binwidth = binwidth, exclude = 0, name = "T*",
                         guide = guide_colorstrip_bottom(width = 25)) +
    scale_y_level(breaks = plot.levs, minor_breaks = NULL) +
    scale_x_longitude(name = "longitud") +
    facet_wrap(~season)
```

## Viento zonal

```{r u-ncep-corte, fig.class = "textwidth", fig.cap = "Viento zonal medio."}
ncep.mean.season[, .(u = mean(u)), by = .(lat, lev, season)] %>% 
    ggplot(aes(lat, lev)) +
    geom_contour_fill(aes(z = u), binwidth = 5) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = 15) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = 5, size = 0.1) +
    # geom_label_contour2(aes(z = u, color = ..level.., label = ..level..),
    # binwidth = 15, skip = 0) +
    surface +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_divergent(name = "U media zonal", 
                         breaks = MakeBreaks(5),
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season)
```

La estructura meridional del viento zonal (\autoref{fig:u-ncep-corte}) muestra la localización e intensidad de los jets subtropical y subpolar. El primero está presente durante todo el año aunque con mayor intensidad y corrido hacia latitudes más ecuatoriales en invierno y primavera. El segundo está presente principalmente en invierno y primavera, e incipiente en otoño. En la estratósfera se observan vientos del este en latitudes bajas que son más intensos en verano y otoño. 

```{r u-ncep, fig.class = "fullpage", fig.cap = "Viento zonal."}
ggplot(ncep.mean.season[lev %in% plot.levs], aes(lon, lat)) +
    geom_contour_fill(aes(z = u), binwidth = 5, exclude = 0) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = 5, size = 0.7) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = 5, size = 0.1) +
    # geom_contourlabel(aes(z = u, color = ..level..), binwidth = 15, step = 1,
    # size = 3, vjust = "inward", hjust = "inward") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(name = "U", breaks = MakeBreaks(5),
                         guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
```

En la \autoref{fig:u-ncep} se observa que el jet subpolar es más intenso al sur de África, donde además se encuentra en una latitud más ecuatorial que en la región del Pacífico. El jet subtropical también tiene un máximo al sur de África y otro al norte de Nueva Zelanda --especialmente en invierno--, donde además se produce una bifurcación del jet. Se trata de una región de persistentes y frecuentes bloqueos [@Trenberth1985] que se evidencia como anomalías zonales negativas durante todo el año (\autoref{fig:uz-ncep}).

Las anomalías zonales en la \autoref{fig:uz-ncep} también evidencian la circulación tropical forzada por la temperatura superficial del pacífico. Consistente con los campos de temperatura, en verano del pacífico central existen divergencias en niveles altos y convergencias en niveles bajos (no se muestra) que se traducen anomalías zonales positivas y negativas al este y al oeste de 180° respectivamente. 

```{r uz-ncep, fig.class = "fullpage", fig.cap = "Anomalía zonal de viento zonal."}
binwidth <- 2.5
ggplot(ncep.mean.season[lev %in% plot.levs], aes(lon, lat)) +
    stat_contour_fill(aes(z = u.z), binwidth = binwidth, exclude = 0) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth), name = "U*", 
                         guide = guide_colorstrip_bottom()) +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    coord_quickmap()
```


## Viento meridional


```{r v-ncep-corte, fig.class = "textwidth", fig.cap = "Media zonal del viento meridional."}
binwidth <- 0.5
ggplot(ncep.mean.season[lev >= 30, .(v = mean(v)), by = .(lat, lev, season)],
       aes(lat, lev)) +
    stat_contour_fill(aes(z = v), binwidth = binwidth, exclude = 0) +
    surface + 
    scale_y_level(breaks = unique(ncep.mean.season$lev), minor_breaks = NULL) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_divergent(name = "V media zonal", 
                         breaks = MakeBreaks(binwidth, 0), 
                         guide = guide_colorstrip_bottom()) + 
    facet_wrap(~season)
```

En los campos medios zonales de viento meridional (\autoref{fig:v-ncep-corte}) se muestra claramente la circulación de Hadley. En verano, la rama ascendente de encuentra en el hemisferio sur y se tiene convergencias en niveles bajos y divergencias en niveles altos. En invierno, en cambio, sólo se ve la rama descendente, mucho más intensa que en verano, que genera convergencias en niveles altos y divergencias en niveles bajos al rededor de los 30°S. 

Presentes durante todo el año, los vientos de drenaje antárticos también son evidentes en la \autoref{fig:v-ncep-corte}. Estos vientos catabáticos son máximos en la costa del continente y alcanzan su máxima intensidad en invierno. 
```{r v-ncep, fig.class = "fullpage", fig.cap = "Viento meridional medio."}
binwidth <- 2
ggplot(ncep.mean.season[lev %in% c(850, plot.levs)], aes(lon, lat)) +
    geom_contour_fill(aes(z = v), binwidth = binwidth, exclude = 0) +
    # geom_contour(aes(z = v, color = ..level..), binwidth = 1, size = 0.1) +
    # geom_contourlabel(aes(z = v, color = ..level..), binwidth = binwidth, step = 1,
    # size = 3, vjust = "inward", hjust = "inward") +
    # geom_tile(aes(fill = v)) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(name = "V", breaks = MakeBreaks(1),
                         guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
```

Los campos horizontales de V se muestran en la \autoref{fig:v-ncep}. En invierno, existe evidencia de un tren de ondas de Rossby que se propaga desde el Índico occidental sudeste llegando a su máxima latitud en 150°O donde comienza a propagarse hacia el norte hasta llegar al sur de Sudamérica. Este tren de ondas puede identificarse con mayor dificultad en el campo de geopotencial (\autoref{fig:ghz-ncep}) debido a la interferencia de la QS1. 

También en invierno, en los trópicos se puede observar el viento meridional hacia el norte en 850hPa en la costa oeste de África asociado al monzón de la India. El monzón sudamericano, por su parte, se evidencia por un aumento de la intensidad de los vientos del norte en verano sobre el continente americano. En altura, el monzón de la India se muestra como viento hacia el sur producto de la divergencia de niveles altos generada por la convección anómala. El Sudamérica, la alta de Bolivia genera viento hacia el norte y hacia el sur al este y al oeste de Bolivia respectivamente. 

La anomalía zonal de V es prácticamente idéntica al campo total ya que la media zonal es casi nula en gran parte del dominio (\autoref{fig:v-ncep-corte}); por lo tanto, no se muestra. 

```{r ghminus1-ncep, fig.class = "fullpage", fig.publish = FALSE, fig.cap = "Z* menos QS1."}
ncep.mean.season %>% 
    .[, c("ampl", "phase") := FitQsWave(gh, k = 1)[1:2], 
      by = .(lat, lev, season)] %>%
    .[, qs1 := BuildQsField(lon*pi/180, ampl, phase, k = 1), 
      by = .(lat, lev, season)] %>% 
    .[, gh.minus := gh.z - qs1] %>% 
    .[lev %in% plot.levs] %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = gh.minus)) +
    map.SH +
    scale_fill_divergent() +
    facet_grid(lev~season)
```

## Gradiente meridional de vorticidad absoluta

En la teoría de propagación meridional de ondas de Rossby, el gradiente meridional de vorticidad absoluta ($\psi_y$) \todo[inline]{es importante porque blavalbla ¿Resumen de la deducción en James?}

```{r calc-eta-ncep}
ncep.mean.season[, zeta := Vorticity(u + v ~ lon + lat, cyclical = TRUE,
                                     sphere = TRUE), 
                 by = .(lev, season)]
ncep.mean.season[, zeta.dy := Derivate(zeta ~ lon + lat, 
                                       cyclical = c(FALSE, FALSE),
                                       sphere = TRUE)[[2]],
                 by = .(lev, season)]

ncep.mean.season[, eta.dy := zeta.dy + f.dy(lat)]
ncep.mean.season <- ncep.mean.season
```

```{r etady-ncep, fig.class = "fullpage", fig.cap = "Gradiente meridional de vorticidad absoluta * 1e11"}
mult <- 1e11
binwidth <- 1e-11*mult
ggplot(ncep.mean.season[lev %in% plot.levs & lat > -85], 
       aes(lon, lat, z = eta.dy*mult)) +
    stat_contour_fill(binwidth = binwidth) +
    stat_contour_fill(breaks = 0, 
                      fill = "grey80", alpha = 0.5, complete = FALSE) +
    geom_contour_fine(breaks = 0, color = "black") +
    # stat_contour(aes(z = eta.dy), breaks = 0, geom = "polygon",
    # fill = "grey50", alpha = 0.5) +
    map.SH +
    # polar.SH + 
    scale_fill_divergent(name = "Gradiente meridional de vorticiad absoluta", 
                         guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    scale_s_map() +
    coord_quickmap() +
    # coord_polar() + 
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab))
```

La \autoref{fig:etady-ncep} muestra que el campo de $\psi_y$ impide la propagación meridional de ondas de Rossby en una *región prohibida* acotada centrada sobre Nueva Zelanda principalmente en invierno entre 300 y 200 hPa. Ésta coincide con la región de bloqueos que, en invierno está franqueada por el jet intenso, dando lugar a gradientes meridionales de U negativos más intensos que $\beta$. Estas figuras extienden el resultado de @Berbery1992 (su Figura 3) utilizando 5 años de análisis objetivo del Centro Europeo de Predicción a Plazo Medio (ECMWF). 

## Número de onda estacionaria

Aún con $\psi_y$ positivo, las ondas de Rossby sólo se pueden propagar si su número de onda zonal es menor que el número de onda estacionario [@James]. En la \autoref{fig:ks-ncep} se muestra el número de onda estacionario para el nivel de 200hPa y en la \autoref{fig:ks-ncep-corte} se muestra un corte en 180°. Además de la *región prohibida*, las ondas cortas no pueden propagarse meridionalmente en latitudes altas. Las ondas largas con k < 3 pueden propagarse meridionalmente libremente en verano al norte de los 60°S aproximadamente, pero quedan atrapadas al sur de 45°S en toda una franja de longitudes entre 60°E y 120°O durante el resto del año. 

El corte de $\psi_y$ en 180° evidencia que la onda 3 sólo puede propagarse meridionalmente dentro de una franja angosta de latitudes, entre 60°S y 50°S. Una región donde este modo muestra un máximo de amplitud (\autoref{fig:ampl-ncep}).

```{r ks-ncep, fig.cap = "Número de onda estacionario en 200hPa.", fig.height = 6}
a <- 6371000

ncep.mean.season[, k := sqrt(eta.dy/u)*(a*cos(lat*pi/180))]
ncep.mean.season[, k.full := ifelse(is.na(k) | k > 10, -1, k)]

ggplot(ncep.mean.season[lev == 200], aes(lon, lat)) +
    geom_contour_fine(aes(z = k), breaks = 0:9, color = "black") +
    geom_label_contour2(aes(z = k, label = ..level..),
                        breaks = 0:9, skip = 0) +
    stat_filter(aes(filter = !is.finite(k)), geom = "tile", color = "gray50",
                fill = "gray50") +
    map.SH +
    scale_s_map() +
    coord_quickmap() +
    facet_wrap(~season)
```

```{r ks-ncep-corte, fig.class = "textwidth", fig.cap = "Número de onda estacionario medio por círculo de latitud."}
ggplot(ncep.mean.season[lon %~% 180 & lev == 200], aes(lat, k)) +
    geom_line() +
    scale_y_continuous(name = "Número de onda estacionaria", breaks = 1:9,
                       limits = c(1, 9)) +
    scale_x_latitude(name = "Latitud", ticks = 20) +
    scale_color_brewer(palette = "Set1") +
    facet_wrap(~season) +
    coord_flip()
```

```{r ks-ncep-cortelev, fig.publish = FALSE, fig.cap = "Número de onda estacionario en 180°"}
ggplot(ncep.mean.season[lon %~% 180], aes(lat, lev))+
    geom_contour_fine(aes(z = k), breaks = 0:9, color = "black") +
    geom_label_contour2(aes(z = k, label = ..level..),
                        breaks = 0:9, skip = 0) +
    geom_contour_fill(aes(z = k.full), breaks = c(0, -0.5), 
                      complete = F, fill = "gray80") +
    surface +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(trans = "reverse") +
    facet_wrap(~season) 
```


## Función corriente

```{r read-psi}
stream <- ReadNetCDF("DATA/NCEP/stream.mon.mean.nc") %>% 
    setnames("level", "lev") %>% 
    .[lat <= 40]
stream[, psi.z := Anomaly(psi), by = .(lat, date)]
stream[, date := as.Date(date), by = date]
stream.mean.season <- stream[, .(psi = mean(psi),
                                 psi.z = mean(psi.z)), 
                             by = .(lon, lat, lev, season(date))]

stream.mean.season[, c("f.lon", "f.lat") := WaveFlux(.SD), by = season]
```


```{r psi-ncep,  fig.class = "fullpage", fig.cap = "Función corriente x 1099"}
ggplot(stream.mean.season, aes(lon, lat)) +
    stat_contour_fill(aes(z = psi.z*10^-9), binwidth = 0.005, 
                      complete = FALSE, exclude = 0) +
    geom_contour_fine(aes(z = psi*10^(-9)), color = "black", binwidth = 0.02) +
    geom_vector(aes(dx = f.lon, dy = f.lat), skip = 3, min.mag = 0.05, 
                scale = 50) +
    geom_map2(data.world[lat < 30]) +
    scale_s_map() +
    scale_fill_divergent(breaks = MakeBreaks(0.005, 0), 
                         guide = guide_colorstrip_bottom(15)) +
    facet_wrap(~season, ncol = 2) +
    theme(axis.title = element_blank()) + 
    coord_quickmap(ylim = c(-90, 30))
```

No sé bien qué decir de la \autoref{fig:psi-ncep} :(.

## Ondas Quasiestacionarias

Como se describió en \autoref{métodos-y-materiales}, el análisis estacional de la amplitud y $r^2$ de Fourier puede hacerse a partir de la media delos campos mensuales o aplicando Fourier a los campos estacionales. En el caso de los datos de NCEP existe poca diferencia, por lo que sólo se muestran los resultados conseguidos mediante esta última metodología. 

El campo de Z* está caracterizado principalmente por un patrón de QS1 en altas latitudes latitudes (\autoref{fig:ghz-ncep}). No es sorprendente, entonces, que la QS1 explica la mayor parte de la variabilidad del geopotencial en virtualmente todo el dominio al sur de los 45°S(\autoref{fig:r2-ncep}). La QS2 es preponderante en la estratósfera ecuatorial, en la costa antártica y alrededor de 35°S, donde es el modo dominante en toda la columna de aire en verano. La QS3, a diferencia de las ondas anteriores es importante en una región reducida. Explica una parte substancial de la varianza en niveles bajos al rededor de los 45°S y mayormente en invierno. La QS4 explica muy poca varianza a excepción de cerca de superficie entre 15°S y 30°S. Ondas más cortas son aún menos importantes (no se muestra). 

```{r r2-ncep, fig.class = "fullpage", fig.cap = "$R^2$ de Fourier."}
rect.annotation <- data.frame(latmin = -65, latmax = -40,
                              levmin = 100, levmax = 700, 
                              k = 3)
ncep.qs <- ncep.mean.season[, FitQsWave(gh, k = 1:4), 
                            by = .(lat, lev, season)] 

binwidth <- 0.1
ggplot(ncep.qs, aes(lat, lev)) +
    stat_contour_fill(aes(z = r2), binwidth = binwidth, na.rm = T) +
    surface +
    geom_index.region(rect.annotation) +
    scale_fill_viridis_c(name = expression(R^2), limits = c(0, 1),
                         breaks = MakeBreaks(binwidth), 
                         guide = guide_colorstrip_bottom(),
                         option = "D") +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse", 
                     ticks = 15) +
    facet_grid(k ~ season, labeller = labeller(k = qs.lab))
```

El $r^2$ permite analizar la importancia relativa de cada modo con respecto a la variabilidad total, pero lo que importa desde el punto de vista físico es la amplitud de la onda \todo{Esto está muy mal escrito, hay que mejorar}. Las diferencias entre los campos de $r^2$ y los de amplitud son evidentes comparando las figuras \ref{fig:r2-ncep} y \ref{fig:ampl-ncep} (notar la escala logarítmica en los colores). La amplitud de la QS1 muestra un máximo bien definido centrado en 60°S que en verano se encuentra en niveles más bajos que en las otras estaciones. También existe un máximo relativo entre 15°S y 30°S en verano que migra a latitudes más altas en invierno y primavera. El mismo está presente también en las otras ondas estacionarias. 

En el caso de la QS2, se evidencia que a pesar de tener máximos de $r^2$ en la estratósfera al norte de 45°S, alcanza su máxima amplitud al sur de esa latitud y en 200hPa en verano y en 30hPa en invierno. Su actividad en la costa antártica se extiende en toda la tropósfera en invierno (a pesar de que en $r^2$ pierde importancia por encima de los 200hPa)

La región de amplitud máxima de la QS3, coincide aproximadamente con la región de máximo $r^2$ entre y otoño y primavera, aunque con menos actividad en superficie y extensión en toda la columna. En verano, en cambio aparece un máximo de amplitud importante que no se observa en el campo de $r^2$. 

Finalmente, fuera de la superficie, la QS4 presenta un máximo de amplitud bien definido sólo en verano. El máximo entre 15°S y 30°S sigue presente. 

```{r ampl-ncep, fig.class = "fullpage", fig.cap = "Ampllitud de Fourier."}
breaks <- 2^seq(0, log2(650), by = 1)
ggplot(ncep.qs, aes(lat, lev)) +
    stat_contour_fill(aes(z = amplitude), 
                      breaks = breaks) +
    surface +
    geom_index.region(rect.annotation) +
    scale_fill_viridis_c(name = "Amplitud (escala logarítmica)", 
                         trans = "log2",
                         breaks = breaks,
                         labels = round(breaks, 1),
                         guide = guide_colorstrip_bottom(),
                         option = "D") +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse", 
                     ticks = 15) +
    facet_grid(k ~ season, labeller = labeller(k = qs.lab))
```

\todo[inline]{Acá podría poner alguna reflexión general de lo que se ve. Por ejemplo, cómo en verano la variabilidad está más acotada a la tropóstera mientras que en invierno y primavera hay más contacto con la estratósfera.}


# Onda 3

\todo[inline]{introducción a QS3; decir que esto es una onda reconstruida a partir de Fourier}

## Características típicas

```{r calc-qs3-ncep}
lons <- unique(ncep$lon)
qs.wave <- ncep.qs.all[k == 3, .(lon = lons, 
                                 QS3 = amplitude*cos(3*(lons*pi/180 - phase))),
                       by = .(lat, lev, date)]
qs.wave.season <- qs.wave[, .(mean = mean(QS3),
                              sd = sd(QS3)), 
                          by = .(lon, lat, lev, season(date))]
```

```{r qs3-ncep, fig.class = "pagewidth", fig.cap = "Media de reconstrucción de onda 3.", fig.height = 6}
binwidth <- 10
cutlat <- data.frame(lat = c(-52.5, rep(NA, 3)),
                     season = c("Verano", "Invierno", "Otoño", "Primavera"))
ggplot(qs.wave.season[lev == 300], aes(lon, lat)) +
    geom_contour_fill(aes(z = mean), binwidth = binwidth, 
                      exclude = 0) +
    # geom_hline(data = cutlat, aes(yintercept = lat),
               # linetype = 2, size = 0.3, color = "gray50") +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(binwidth = binwidth, name = "QS3",
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) +
    coord_quickmap()
```

En la \autoref{fig:qs3-ncep} se muestra el campo de geopotencial reconstruido sólo a partir de la QS3 en 300 hPa, que ilustra lo que sucede en todos los niveles dado que su estructura es barotrópica equivalente (\autoref{fig:qs3-ncep-corte}. Se reproducen las características de la amplitud ya vistas en la \autoref{fig:ampl-ncep} (máximo entre 60°S y 45°S con menor intensidad en primavera, mayor amplitud en 300hPa con mayor desarrollo vertical en otoño y verano) pero además permite observar el efecto de la variación de la fase. Se observa que existe un corrimiento de la fase entre verano e invierno de poco más de 15° (algo ya observado por ??\todo{buscar referencia. Raphael referencia este movimiento, pero no lo encuentro en los papers que cita.}) anticipando que el efecto de la QS3 sobre cada lugar \todo{mal escrito} pueda tener una componente estacional. 

La inclinación meridional de las perturbaciones de geopotencial asociadas a la QS3 sugieren que ésta está asociada a transportes de cantidad de movimiento hacia el polo en las estaciones de transición, pero en menor medida en verano.

```{r uv-qs2-ncep, include = params$draft}
qs.wave.season[, 
               c("ug", "vg") := GeostrophicWind(mean, lon, lat, 
                                                cyclical = TRUE), 
               by = .(lev, season)] %>% 
    .[lev == 300, 
      .(uv = mean(ug*vg, na.rm = T)), by = .(season)] %>% 
    knitr::kable(col.names = c("Estación", "[u\\*v\\*]"), digits = 3, caption = "Transporte meridinoal de cantidad de viento zonal NO SE PUBLICA")
```

```{r qs3-ncep-corte, fig.class = "pagewidth", fig.cap = "Corte", fig.height = 4}
ggplot(qs.wave.season[lat %~% cutlat$lat[1]], aes(lon, lev)) +
    # stat_contour_fill(aes(z = sd), binwidth = 10) +
    geom_contour_fill(aes(z = mean), binwidth = binwidth, exclude = 0) +
    scale_y_level(breaks = plot.levs) +
    scale_x_longitude(name = "longitud") +
    scale_fill_divergent(binwidth = binwidth, name = "QS3",
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) 
```


```{r qs3sd-ncep, fig.class = "pagewidth", fig.cap = "Desvío estándar de la reconstrucción de QS3.",  fig.height = 6}
binwidth <- 5
cutlat <- -52.5
ggplot(qs.wave.season[lev == 300], aes(lon, lat)) +
    stat_contour(aes(z = mean), breaks = c(1, -1)*20, color = "black", 
                 size = 0.5) +
    stat_contour(aes(z = sd, color = ..level..), binwidth = binwidth) +
    map.SH +
    scale_s_map() +
    scale_color_viridis_c(name = "Desvío estándar de QS3", 
                          guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) +
    coord_quickmap()
```

\todo[inline]{No tengo idea de cómo interpretar la \autoref{fig:qs3sd-ncep}. Quizás hablar de que la variabilidad asociada a la onda 3 se da principalmente en los nodos y que entonces ahí es donde hay que ver la variación del efecto? no sé... }

### Wavelets

```{r calc-wavelet}
wv.mean.season <- ncep.mean.season[,  
                                   .(lon = lon,
                                     amplitude = unlist(PeriodicWavelet(gh, 3))),
                                   by = .(lat, lev, season)]

file.wavelet <- "DATA/ncep.wv.Rds"
wv.all <- cache.file(file.wavelet, {
    ncep[,  .(lon = lon, gh.z = gh.z,
              amplitude = unlist(PeriodicWavelet(gh, 3))),
         by = .(lat, lev, date)]
})

wv.mean.season2 <- wv.all[, .(amplitude = mean(amplitude)), 
                          by = .(lon, lat, lev, season(date))]
wv.mean.season <- wv.mean.season[wv.mean.season2, on = c("lat", "lon", "season", "lev")]
```

```{r wavelet-fourier-ncep, fig.class = "textwidth", fig.cap = "Amplitud de wavelets (sombreados) y de fourier (contornos)"}
binwidth <- 10
wv.mean.season[, .(amplitude = mean(amplitude)), 
               by = .(lat, lev, season)] %>% 
    ggplot(aes(lat, lev)) +
    stat_contour_fill(aes(z = amplitude), binwidth = binwidth) +
    geom_contour_fine(data = ncep.qs[k == 3], 
                      aes(z = amplitude),
                      binwidth = binwidth, color = "black") +
    geom_text_contour(data = ncep.qs[k == 3], 
                      aes(z = amplitude, label = ..level..),
                      binwidth = binwidth) +
    scale_fill_viridis_c(name = expression(R^2), 
                         breaks = MakeBreaks(binwidth),
                         limits = c(0, 40),
                         guide = guide_colorstrip_bottom()) +
    scale_color_viridis() +
    scale_y_level() +
    scale_x_latitude(trans = "reverse") +
    surface +
    facet_wrap(~season)
```

Para la QS3, la amplitud media obtenida mediante Wavelets \todo{agregar referencia a sección} es virtualmente idéntica a la amplitud obtenida con Fourier (\autoref{fig:wavelet-fourier-ncep}). Sin embargo, también permite obtener información de la variación meridional de la amplitud de la QS3. Al igual que con Fourier, esto puede hacerse promediando estacionalmente la amplitud de los campos mensuales o calculando la amplitud de los campos estacionales. Pero a diferencia de Fourier, los resultados de cada metodología son opuestos. Esto es evidente en la \autoref{fig:waveletz-ncep} donde se muestra el campo de amplitud de la QS3 según wavelets en líneas y su anomalía zonal en sombreado. Los valores positivos representan regiones donde la amplitud de la QS3 es mayor que la media zonal y viceversa. 

No existe mucha diferencia en la amplitud media zonal entre ambas metodologías a excepción de que la primera siempre es mayor que la segunda \todo{Esta es una propiedad general que SIEMPRE se cumple. En realidad podría ir en metodología}. Las principales diferencias se dan en las anomalías zonales.

```{r waveletz-ncep, fig.class = "fullpage", fig.cap = "Campo medio de la amplitud de la onda 3 según wavelets (contornos) y su anomalía zonal (sombreado) en 300hPa."}
wv.comp <- copy(wv.mean.season) %>% 
    setnames(c("amplitude", "i.amplitude"), c("Amplitud de \nla Media", "Media de \nla Amplitud")) %>% 
    melt(id.vars = c("lon", "lat", "lev", "season"), variable.name = "method") %>% 
    .[, value.z := Anomaly(value), 
      by = .(lat, lev, season, method)]
wv.comp[lev == 300] %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = value.z), binwidth = 1, exclude = 0) +
    geom_contour_fine(aes(z = value), binwidth = 10,
                      color = "black") +
    # stat_contour(aes(z = mean), breaks = c(1, -1)*20, color = "black",
    # size = 0.5, data = qs.wave.season[lev == 300]) +
    # geom_text_contour(aes(z = amplitude, label = ..level..), binwidth = 10,
    # color = "black") +
    geom_label_contour2(aes(z = value, label = ..level..), binwidth = 10, 
                        color = "black") +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(name = "Anomalía de ampltiud wavelets",
                         breaks = MakeBreaks(1),
                         guide = guide_colorstrip_bottom()) +
    facet_grid(method ~ season) +
    coord_quickmap()
```

Las anomalías zonales presentan, en todas las estaciones, un máximo al sur del Índico centrado en 45°S que se desplaza hacia el este en latitudes más altas. Existe un segundo máximo en altas latitudes que en otoño y primavera se encuentran en 120°E y en invierno se encuentra en 180°. En verano éste no aparece, pero sí existe un máximo centrado en 15°S y 120°O.

La principal diferencia con la media de la amplitud es que las mayores anomalías zonales se dan en latitudes altas (al rededor de 60°S) con un mínimo al sur del Índico en vez de un máximo. Al norte de 30°S, las diferencias son menores. 

\todo{Estoy pensando en no poner la \autoref{fig:wavelet-ncep-corte} porque no encuentro mucho para decir y no veo que se gane demasiado. Queda para el doctorado? :P}
```{r wavelet-ncep-corte, fig.class = "fullpage", fig.cap = "Corte zonal en -60° de la amplitud media de la onda 3 según wavelets (contornos) y su anomalía zonal (sombreado)."}
ggplot(wv.comp[lat %~% -60], aes(lon, lev)) +
    geom_contour_fill(aes(z = value.z), binwidth = 1, exclude = 0) +
    geom_contour_fine(aes(z = value), color = "black", 
                      binwidth = 5) +
    geom_label_contour2(aes(z = value, label = ..level..), 
                        binwidth = 5) +
    scale_y_level(breaks = plot.levs, name = "nivel") +
    scale_x_longitude(name = "lon") +
    scale_fill_divergent(name = "Anomalía de amplitud wavelets",
                         breaks = MakeBreaks(1),
                         guide = guide_colorstrip_bottom()) +
    facet_grid(method ~ season) 
```

Cosas para ver:    
* Si bien el máximo medio de la amplitud se da en ~300hPa (\autoref{fig:wavelet-fourier-ncep}) igual que en fourier, el análisis por longitud muestra algo un poco más complejo. En verano y otoño, la máxima amplitud sigue en 300hPa, pero ésta asciende a entre 100 y 50hPa en invierno y primavera alrededor de 120°O. Además, durante estas estaciones hay indicación de que el máximo cambia de latitud con la altura. 

```{r estacionaridad, fig.cap = "Ratio de amplitud de la media y media de la amplitud (¿medida de estacionaridad?)", fig.subcap = c("campo", "media zonal"), fig.publish = FALSE, fig.ncol = 1}
copy(wv.mean.season) %>% 
    .[, a.z := Anomaly(amplitude/i.amplitude),
      by = .(lat, season)] %>% 
    .[lev == 300] %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = amplitude/i.amplitude)) +
    map.SH +
    scale_fill_viridis_c() +
    facet_wrap(~season) 

wv.mean.season[lev == 300, .(mean(amplitude/i.amplitude)),
               by = .(lat, season)] %>% 
    ggplot(aes(lat, V1)) +
    geom_line(aes(color = season)) +
    scale_x_latitude() +
    scale_y_continuous(name = "estacionaridad") + 
    coord_flip()
```

Las diferencias vistas en la \autoref{fig:waveletz-ncep} están relacionadas con la estacionariedad\todo{¿Es una palabra?} de las ondas \todo{de nuevo, esto es general para la metodología, la explicación va en métodos}, se puede utilizar la relación entre ambas para generar un *índice de estacionariedad* \todo{¿Estoy seguro de que esto es así?}. Cuanto más similar sea el resultado, más estacionarias son las ondas. Así, la estacionariedad sería máxima en latitudes bajas y al rederor de 50°S --principalmente en verano-- y mínima en dos franjas angostas cerca de 30°S y 75°S. \todo{¿Mostrar el gŕafico \ref{fig:estacionaridad}?}
\todo[inline]{Esta discusión también aplica a fourier (\autoref{fig:estacionaridad-fourier}), en realidad, pero ahí no estoy mostrando ambos resultados porque da parecido. Quizás este párrafo se puede mover.. o borrar todo si resulta puro sinsentido.}

```{r estacionaridad-fourier, fig.cap = "Estacionaridad según fourier", fig.publish = FALSE}
ncep.qs.all %>% 
    .[k == 3, .(amplitude = mean(amplitude)), 
      by = .(lat, lev, season(date))] %>% 
    .[ncep.qs[k == 3], on = c("lat", "lev", "season")] %>%
    ggplot(aes(lat, lev)) +
    geom_contour_fill(aes(z = i.amplitude/amplitude), na.rm = T) +
    surface +
    scale_y_level() +
    scale_x_latitude(trans = "reverse") +
    scale_fill_viridis_c() +
    facet_wrap(~season)
```

```{r dif-wavelets}
lats.index <- c(-65, -40)
levs.index <- c(100, 700)
wvdif <- wv.mean.season[lat %b% lats.index & lev %b% levs.index,
                        sd(amplitude)/mean(amplitude), 
                        by = .(lat, lev, season)] %>% 
    .[, mean(V1)]*100
```


```{r cleanup1}
remove(wv.mean.season, wv.all, wv.comp, wv.mean.season2)
```

Estas observaciones destacan la utilidad de wavelets en el análisis de ondas cuasiestacionarias. Mientras que el tratamiento con fourier asume a las ondas como una propiedad media de cada círculo de latitud, wavelets permite reconocer su heterogeneidad meridional. Evaluando esta heterogeneidad, sería posible distinguir entre campos donde una onda con un determinado número de onda está presente en todo un círculo de latitud de campos donde ésta está localizada en una región acotada. 

Por otro lado, la no ortogonalidad de los wavelets complejizan la interpretación de los resultados ya que no es posible la separación de un campo en modos oscilatorios con distinto número de onda. El análisis de una QS específica, por lo tanto está contaminado por la actividad de otras QS con longitud de onda cercana. 


```{r wavelet-reconstr, fig.cap = "Reconstrucción de QS3 usando wavelets", fig.publish = FALSE}
ncep.mean.season[lev == 300, wavelet3 := ReconstructWavelet(gh.z, 3), 
                 by = .(lat, lev, season)]

ggplot(ncep.mean.season[lev == 300], aes(lon, lat)) +
    geom_contour_fill(aes(z = wavelet3), binwidth = 25, exclude = 0) +
    scale_fill_divergent() +
    map.SH +
    facet_wrap(~season)

```

Wavelets, en resumen, puede entenderse como una *corrección* a fourier que agrega información de asimetrías zonales. Dado que la variabilidad zonal es del orden de un 10% de la amplitud media, en lo que sigue de la tesis se utilizará sólo fourier, dejando el análisis e interpretación de wavelets para futuros trabajos. 

## Antecedentes 

Breve comentario sobre los índices usados en otros lados. Discutir ventajas y debilidades.

* Amplitud
* Fase (impacto en SA) 

De todo eso, motiva decisión del índice.

* Niveles elegidos
* Promedio vs. máximo
* Composiciones de campos y flujos.
* Decisión del índice. 

Quiero hacer el índice a partir de la actividad de la onda 3 tomando la región del máximo (latitud entre -65 y -40, y entre 700 y 100 hPa). Variables posibles: amplitud media, amplitud máxima, r2, correlación entre campo teórico y observado.

## Amplitud

### Máximo o media. 

Existen varios estadísticos que podrían utilizarse para representar la amplitud de la QS3 en una región extendida. La media, la máxima, la moda, la mediana, etc... En este caso, se estudió la posibilidad de representarla con la media o la máxima.\todo{esto fue escrito a las 23:30 luego de un largo día de mirar campos y números... es un delirio.}

```{r calc-indice-ncep}
lats.index <- c(-65, -40)
levs.index <- c(100, 700)
ncep.qs.all <- ncep.qs.all[, index.region := (lev %b% levs.index) & (lat %b% lats.index)]

ncep.qs.all[, phase.c := circular(phase*k, modulo = "2pi")]
index <- ncep.qs.all[index.region == TRUE & k == 3, 
                     .(amplitude   = mean(amplitude),
                       m.amplitude = max(amplitude),
                       r2          = mean(r2),
                       phase       = mean.circular(phase.c)/3,
                       lat         = lat[which.max(amplitude)]),
                     by = date]
index[, phase.c := circular(phase*3, modulo = "2pi")]
fields <- ncep[lev %b% levs.index, .(lon, lat, date, lev, gh, gh.z)][
    qs.wave[lev %b% levs.index], on = c("lat", "lon", "date", "lev")]
cor.index <- fields[, .(cor = cor(gh.z, QS3)^2), by = .(date)]
index <- index[cor.index, on = "date"]

```


```{r ampl-max-mean, fig.cap = "Distribució de amplitud para 12 fechas. En rojo la amplitud máxima, en azul la amplitud media.", fig.height = 4, fig.class = "pagewidth"}

select.dates <- as.Date(
    c("1997-05-01",  
      "2012-04-01",  
      
      "1985-01-01", 
      "1988-07-01",
      
      "1987-11-01",
      "2008-01-01", 
      
      "2000-09-01",  
      "1990-12-01",  
      
      "2003-10-01"))

# select.dates <- select.dates.manual
gdata <- ncep.qs.all[k == 3 & date %in% select.dates] %>% 
    .[, date.f := factor(as.character(date), 
                         levels = as.character(select.dates),
                         ordered = T)]
gdata.index <- index[date %in% select.dates] %>% 
    .[, date.f := factor(as.character(date), 
                         levels = as.character(select.dates),
                         ordered = T)]


melt(gdata.index[, .(date.f, amplitude, m.amplitude)], 
     id.vars = c("date.f")) %>% 
    ggplot(aes(date.f, value)) +
    geom_col(aes(fill = variable), width = 0.5, 
             position = "dodge") +
    scale_fill_brewer(palette = "Set1", 
                      labels = c(m.amplitude = "Máxima",
                                 amplitude = "Media"),
                      direction = -1) +
    scale_y_continuous(name = "Amplitud",
                       breaks = MakeBreaks(15),
                       expand = c(0, 0)) +
    scale_x_discrete(name = "Fecha", 
                     labels = labeller.date("\n"), 
                     expand = c(0, 0)) +
    coord_flip() +
    theme(panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank())
```

```{r ampl-max-mean-corte, fig.cap = "Corte vertical de amplitud", fig.class = "pagewidth", fig.height = 4}
M <- max(gdata.index[date %in% select.dates, m.amplitude])
binwidth <- 15
ggplot(gdata, aes(lat, lev)) + 
    stat_contour_fill(aes(z = amplitude), binwidth = binwidth) +
    geom_index.region(rect.annotation) +
    geom_segment(data = gdata.index[date %in% select.dates], inherit.aes = F,
                 size = 1, color = "#E41A1C", 
                 aes(x = -90, xend = -90, y = 1000, 
                     yend = 10^(-2/M*m.amplitude + 3))) +
    geom_segment(data = gdata.index[date %in% select.dates], inherit.aes = F,
                 size = 1, color = "#377EB8", 
                 aes(x = -90, xend = -90, y = 1000, 
                     yend = 10^(-2/M*amplitude + 3))) +
    surface +
    scale_y_level(name = "nivel", 
                  sec.axis = sec_axis(~-M/2*(log10(.) - 3), name = "Amplitud")) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_viridis_c(guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    facet_wrap(~date.f, labeller = labeller(date.f = labeller.date()))
```

```{r ghz-ncep-select, fig.cap = "Anomalía zonal geopotencial en 300hPa para fechas seleccionadas.", fig.class = "pagewidth", fig.height = 6}
lons <- unique(ncep$lon)
ncep[lev == 300 & date %in% select.dates, 
     FitQsWave(gh, 1:2), by = .(lat, date)] %>% 
    .[, .(lon = lons, 
          qs = amplitude*cos(k*((lons*pi/180) - phase))),
      by = .(lat, date, k)] %>% 
    .[, .(rec = sum(qs)), by = .(lon, lat, date)] %>% 
    .[ncep[lev == 300 & date %in% select.dates], on = c("lat", "lon", "date")] %>% 
    .[, gh.minus := gh.z - rec] %>% 
    .[, date.f := factor(as.character(date), 
                         levels = as.character(select.dates))] %>% 
    ggplot(aes(lon, lat)) +
    stat_contour_fill(aes(z = gh.minus), binwidth = 25, exclude = 0) +
    map.SH + 
    scale_s_map() +
    scale_fill_divergent(guide = guide_colorstrip_bottom(15)) +
    coord_quickmap() +
    facet_wrap(~date.f, labeller = labeller(date.f = labeller.date())) +
    theme(axis.title = element_blank()) 
```

Se seleccionaron manualmente 9 casos que representan distintas características de la amplitud media la máxima. Sus valores se muestran en la \autoref{fig:ampl-max-mean}, los cortes meridionales de amplitud, en la \autoref{fig:ampl-mac-mean-corte} y los campos de Z* (con las QS1 y QS2 restadas) en la \autoref{fig:ghz-ncep-select}. 


Comparando mayo de 1997 con abril de 2012, ambos tienen una media muy similar, pero la máxima del primero es menor que la del segundo. Observando el campo de geopotencial, la QS3 se aprecia mucho más claramente en 2012 que en 1997. 

Enero de 1985 y julio de 1988 son un caso similar en cuanto a la relación de las métricas de amplitud, pero en este caso\todo{repite "caso"} ambos campos de Z* son muy similares en cuanto a intensidad y claridad de la QS3. Los dos meses presentan un tren de ondas que ocupan aproximadamente 1/3 de círculo de latitud. A pesar de que la amplitud máxima de 1985 es menor que la de 1988, el tren de ondas de 1988 se ve algo más claro que el de 1985. 

El par septiembre de 2000 y diciembre de 1990 es más claro. Ambas medidas de amplitud son mayores en 1990 y, en efecto, el campo de Z* tiene una estructura de QS3 zonal más clara que el de 2000. Sin embargo, las anomalías sí están presentes en 1990 --un tren de ondas similar al de enero de 1985, aunque con distinta fase-- son más intensas, por lo que su efecto local puede ser mayor que las de 2000. 

Más extrema aún es la diferencia entre septiembre de 2000 y octubre de 2003. Ambos meses tienen una métrica de amplitud similares, pero la QS3 es apenas distinguible en el segundo mes. 

Estos casos ilustran algunas limitaciones del análisis que continua. Algunos problemas son inherentes al intentar representar una estructura con variabilidad espacial a partir de un sólo número y otros están atados a la limitación de la descomposición de Fourier que trata toda onda como una onda planetaria.\todo{Aclarar qué comparación ilustra qué problema} 

```{r cor-mean-max, fig.cap = "Correlación entre amplitud máxima y media."}
r2.ampl <- index[, cor(m.amplitude, amplitude)]^2
ggplot(index, aes(m.amplitude, amplitude)) +
    geom_point(size = 0.5, alpha = 0.5) +
    geom_smooth(color = "black", size = 0.7) +
    geom_abline(linetype = 3) +
    annotate(geom = "text", x = 50, y = 100, 
             label = paste0("r2 = ", round(r2.ampl, 2))) +
    scale_y_continuous(name = "Amplitud media", breaks = MakeBreaks(25)) +
    scale_x_continuous(name = "Amplitud máxima", breaks = MakeBreaks(25)) +
    coord_equal()
```

Es importante tener en cuenta que estos 9 casos fueron seleccionados específicamente para ilustrar estas limitaciones y que no son necesariamente representativos de la totalidad de casos posibles. Como se muestra en la \autoref{fig:cor-mean-max}, la amplitud media máxima tienen una excelente correlación ($r^2>0.9$) y una relación lineal. Debido a esto, a fines estadísticos la elección de una métrica o la otra no tiene una influencia importante. Desde este momento se usará la amplitud media\todo{expresar mejor esto}.

```{r cleanup2}
index[, m.amplitude := NULL]
```

El ciclo anual de la amplitud media se muestra en la Figura\ \ref{fig:ampl-ts1} donde los puntos son datos puntuales. La amplitud máxima en invierno es evidente, así como la mayor variabilidad. Esto es de esperarse en una variable definida positiva que toma valores cercanos a cero. Notar que la amplitud media no es mínima en primavera, en contraste con lo observado en el análisis climatológico (\autoref{fig:ampl-ncep}) y los campos reconstruidos (\autoref{fig:qs3-ncep}). La resolución a este problema radica en el análisis de la fase (\autoref{fase}).

La serie temporal de la amplitud media se muestra en la Figura\ \ref{fig:ampl-ts2} donde en líneas horizontales se marca la amplitud media anual para cada año. No hay evidencia clara de periodicidades aunque se puede observar indicios de un ciclo de dos años en la anticorrelación de los promedios anuales. Dicha periodicidad no es estadísticamente significativa (no se muestra\todo{¿no se muestra?})

```{r ampl-ts, fig.class = "pagewidth", fig.cap = "Amplitud media", fig.subcap = c("Ciclo anual", "Serie temporal"), cache = FALSE, fig.height = 4, fig.show = "hold", fig.ncol = 1}
ggplot(index, aes(factor(month(date)), amplitude)) +
    # geom_violin() +
    geom_boxplot(outlier.alpha = 0) +
    geom_point(position = position_jitter(width = 0.2),
               alpha = 0.5, size = 0.7) +
    scale_x_discrete(name = "Mes", labels = month.abb_sp) +
    scale_y_continuous(name = "Amplitud")


g <- copy(index) %>% 
    .[, amplitude.mean := mean(amplitude), by = .(year(date))] %>% 
    ggplot(aes(date, amplitude)) +
    geom_line(aes(y = amplitude.mean, group = year(date)),
              color = "gray50") +
    geom_line() +
    # geom_smooth(span = 5*12/372) +
    geom_hline(yintercept = mean(index$amplitude), linetype = 3) +
    scale_x_date(date_breaks = "1 years", expand = c(0, 0), 
                 date_labels = "%y", date_minor_breaks = "3 months")  
DivideTimeseries(g, index$date, n = 3, xlab = "Fecha", ylab = "Amplitud")
```

```{r calc-wavelet-dt}
index <- index[, amplitude.t := Anomaly(amplitude), 
               by = .(month(date))]
invisible(capture.output(w <- analyze.wavelet(index, "amplitude.t", 
                                              verbose = FALSE, n.sim = 500)))
```

```{r wavelet-period, fig.cap = "Análisis de wavelet para la amplitud de la onda 3.", fig.publish = FALSE}
ampl <- w$Ampl
dimnames(ampl) <- list(period = w$Period, date = as.character(index$date)) 
cowplot::plot_grid(
{
    melt(ampl, value.name = "amplitude") %>%
    as.data.table(.) %>% 
    .[, date := as.Date(date)] %>% 
    .[, p.val := c(w$Power.pval)] %>% 
    # .[, amplitude := ecdf(amplitude)(amplitude)] %>% 
    ggplot(aes(date, period)) +
    geom_contour_fill(aes(z = amplitude), breaks = c()) +
    geom_contour(aes(z = p.val), breaks = 0.01) +
    scale_y_continuous(trans = "log2", expand = c(0, 0),
                       breaks = 2^(seq(0, 7, by = 1))) +
    geom_hline(yintercept = c(12, 24)) +
    scale_x_date(date_breaks = "5 years", date_labels = "%y", 
                 expand = c(0, 0)) +
    # scale_fill_distiller(palette = "Spectral")
    scale_fill_viridis_c()
}, 
{
    with(w, 
           data.table(period = Period, power = Power.avg, pval = Power.avg.pval)) %>% 
    ggplot(aes(period, power)) +
    geom_line() +
    stat_filter(aes(filter = pval < 0.01), geom = "point") +
    scale_x_continuous(trans = "log2", expand = c(0, 0),
                       breaks = 2^(seq(0, 7, by = 1))) +
    coord_flip() +
    theme(axis.title.y = element_blank(),
          axis.text.y = element_blank())
}, align = "h", axis = "tblr", rel_widths = c(4, 1))
```

```{r acf-ampl, fig.cap = "Función de autocorrelación para la amplitud media anual de la onda 3", fig.publish = FALSE}
copy(index) %>% 
    .[, mean(amplitude), by = year(date)] %>% 
    .[, V1] %>% 
    acf.sig(alpha = 0.01, lag.max = 12*2, sided = "two") %>%
    ggplot(aes(lag, acf)) +
    geom_col(fill = "black", width = 0.3) +
    geom_line(aes(y = upp.sig.cut)) +
    geom_line(aes(y = low.sig.cut)) +
    scale_x_continuous(name = "lag (años)")
```


## Fase

Además de la amplitud, las sondas planetarias se caracterizan por su fase.
\todo[inline]{intro sobre la fase}

```{r fase-boxplot, fig.cap = "Ciclo anual de la fase (20 mayores amplitudes para cada mes)", fig.class = "fullpage"}
lat.lims <- c(-70, -22)
lon.lims <- c(240, 360)
map.arg <- geom_map2(BuildMap(countries = T)[lat %b% lat.lims & 
                                                 long %b% lon.lims],
                     color = "gray50")
nudge <- 0.54
size <- 2
index[, phase.c := circular(phase*3, modulo = "2pi")]
index %>% 
    group_by(month = month(date)) %>% 
    filter(greater(amplitude, 20)) %>% 
    as.data.table() %>% 
    .[, .(phase = mean.circular(phase.c)/3,
          phase.sd = sd.circular(phase.c)/3),
      by = .(month(date))] %>% 
    ggplot(aes(y = (-month + 6)*2.6 - 45)) +
    map.arg +
    geom_point(data = index %>% 
                   group_by(month = month(date)) %>% 
                   filter(greater(amplitude, 20)), 
               aes(phase*180/pi +240),
               alpha = 0.5, size = size, color = "red",
               position = position_nudge(y = -nudge)) +
    geom_point(data = index %>%
                   group_by(month = month(date)) %>%
                   filter(greater(amplitude, 20)),
               aes(ifelse(phase*180/pi + 240 - 60 < 240, NA,
                          phase*180/pi + 240 - 60)),
               alpha = 0.5, size = size, color = "blue",
               position = position_nudge(y = nudge)) +
    geom_point(data = index %>% 
                   group_by(month = month(date)) %>% 
                   filter(greater(amplitude, 20)), 
               aes(ifelse(phase*180/pi + 240 + 60 > 360, NA,
                          phase*180/pi + 240 + 60)),
               alpha = 0.5, size = size, color = "blue",
               position = position_nudge(y = nudge)) +
    # geom_point(aes(phase*180/pi + 240 + 60), color = "blue") +
    geom_point(aes(phase*180/pi + 240)) +

    geom_errorbarh(aes(xmin = (phase*180/pi + 240 - phase.sd*180/pi), 
                       xmax = (phase*180/pi + 240 + phase.sd*180/pi))) +
    geom_errorbarh(aes(xmin = (phase*180/pi + 240 - phase.sd*180/pi) + 120, 
                       xmax = (phase*180/pi + 240 + phase.sd*180/pi) + 120)) +
    # annotate(geom = "label", x = rep(237, 12), y = (-(1:12) + 6)*2.6 - 45, 
    #          label = month.abb_sp, size = 3, hjust = 0.5) +
    geom_vline(xintercept = c(240, 360), linetype = 3) +
    # map.SH.3 +
    scale_x_longitude(ticks = 20, name = "Longitud") +
    scale_y_continuous(breaks = (-(1:12) + 6)*2.6 - 45, 
                       minor_breaks = NULL,
                       labels = month.abb_sp, 
                       name = "Mes", expand = c(0, 0)) +
    # coord_quickmap()
    coord_quickmap(xlim = lon.lims, ylim = lat.lims) 
    # coord_map(projection = "mollweide", xlim = lon.lims, ylim = lat.lims)
```

La \autoref{fig:fase-boxplot} muestra la fase media (localización media del máximo de geopotencial) y el rango delimitado por $\pm$ 1 desvío estándar para cada mes para los 20 años con más amplitud de cada mes. En rojo y azul se indican la localización de los centros de máxima y mínima anomalía de geopotencial respectivamente de los 10 casos más extremos. El mapa se muestra para referencia, pero notar que la posición de los puntos en el eje vertical no tiene significado geográfico. 

Se observa el ciclo anual en la fase ya se podía apreciar en la \autoref{fig:qs3-ncep}. La fase media se centra en 55°O en enero y se desplaza a 90°O en junio con valores intermedios en los meses de transición. Es esperable que esta variación anual implica que circulación causada por la QS3 tenga impactos contrarios en verano comparado con invierno; alternando entre advecciones de aire del norte y del sur sobre el continente. 

Superpuesto a el ciclo anual, en la \autoref{fig:fase-boxplot} también se puede apreciar la variabilidad interanual para cada mes. Ésta es considerable y de una magnitud comparable a la del ciclo anual. En particular, es notorio el aumento en la variabilidad en los meses de primavera, al punto de que en noviembre la fase prácticamente no tiene una posición predilecta. 

La gran variabilidad presente durante los meses de primavera, en comparación con el resto del año, explica por qué en los campos medios la QS3 aparece débil a pesar de que su amplitud mensual no es menor. Al hacer el promedio, los campos que están defasados en entre 1/4 y 3/4 de longitud de onda (entre 30° y 90° en el caso de la QS3) interfieren destructivamente entre ellos, eliminando la señal en los campos medios. En primavera, más del 30% de los meses tienen algún nivel de interferencia destructiva con el campo medio, comparado con el 13% en verano.  

```{r phase-sd, include = params$draft}
index[, .(sd = sd(phase.c)/3*180/pi),
      by = season(date)] %>% 
    knitr::kable(digis = 2, col.names = c("Estación", "SD"),
                 caption = "Desvío estándar de la fase para cada estación - NO SE PUBLICA")
```

```{r destructiva, include = params$draft}
index[, mean(abs(phase.c - mean(phase.c)) %between% (c(1/4, 3/4)*2*pi))*100, 
      by = season(date)] %>% 
    knitr::kable(caption = "Porcentaje de meses con interferencia destructiva - NO SE PUBLICA",
                 digits = 3)
```

Observando ahora la distribución de los centros ciclónicos y anticiclónicos (puntos rojos y azules, respectivamente\todo{esto ya está dicho antes, pero lo aclaro de nuevo?}) se nota que, a pesar de que climatolǵoicamente la Sudamérica está afectada por un máximo de Z\* de la QS3, la variabilidad interanual implica que hay un número no despreciable de años donde el continente tiene un mínimo de Z\* asociado a esa onda. Aún sólo mirando a los 20 años más intensos de cada mes, en noviembre hay 5 casos y en diciembre, 4. 

## Estaciones

En las secciones anteriores se mostraron campos medios estacionales utilizando la definición tradicional de las estaciones climatológicas (verano = DEF, otoño = MAM, invierno = JJA, primavera = SON). Sin embargo, como éstas son definidas a partir del ciclo anual de temperatura en latitudes medias no constituyen necesariamente el mejor agrupamiento de los datos para otras variables u otras latitudes (por ejemplo, la Antártida \todo{cita de King}). 

Una metodología muy utilizada para la clasificación de campos es el análisis de componentes principales (PCA)\todo{citas de PCA}\todo{asumo que no hace falta explicar PCA}. 

La tabla xx \ref{eoftabla}\todo{cómo referenciar tablas?} muestra la varianza explicada de cada componente principal obtenida a partir de los campos reconstruidos de QS3. Las primeras dos componentes explican más del 80% de la varianza y cada una explica una parte similar de la varianza, indicando que se trata de autovalores degenerados\todo{buscar cita de esto}. Sabiendo, además, que los campos de QS3 prácticamente sólo tienen dos grados de libertad (amplitud y fase), la elección de seleccionar las dos primera componentes es natural además de justificada por la tabla \ref{eoftabla}.


```{r eoftabla}
qs.eof <- EOF(fields[lev == 300], lon + lat ~ date, value.var = "QS3", 
                   n = 1:5)
qs.eof$sdev[, .(PC, r.squared)] %>% 
    knitr::kable(digits = 3, 
                 caption = "Varianza explicada por las 5 primeras componentes principales de los campos de QS3 reconstruidos.", col.names = c("PC", "$R^2$"))
```


```{r eof, fig.cap = "Primeras dos componentes principales del campo de QS3"}
qs.eof <- EOF(fields[lev == 300], lon + lat ~ date, value.var = "QS3", n = 1:2)

ggplot(qs.eof$left, aes(lon, lat)) + 
    stat_contour_fill(aes(z = -value), binwidth = 0.01,
                      exclude = 0) +
    map.SH +
    scale_fill_divergent(breaks = MakeBreaks(0.01),
                         guide = "none") +
    scale_s_map() +
    coord_quickmap() + 
    facet_wrap(~PC, ncol = 2, labeller = labeller(PC = AddPreffix("PC")))

# ggplot(qs.eof$right, aes(month(date), -value)) +
#     geom_boxplot(aes(color =  paste0("PC", PC),
#                      group = interaction(PC, month(date)))) +
#     annotate("errorbarh", y = 0.15, height = 0.01, alpha = 0.5,
#              xmin = c(-1, 4, 6, 8, 12) - 0.4,
#              xmax = c(3, 5, 7, 11, 14) + 0.3,
#              color = 1) +
#     scale_x_continuous(name = "Mes", breaks = 1:12, labels = month.abb_sp) +
#     scale_y_continuous(name = "PC") +
#     scale_color_brewer(palette = "Set1") +
#     coord_cartesian(xlim = c(1, 12))
```

La forma de las dos primeras componentes principales del campo de QS3 (\autoref{fig:eof-field}) son dos QS3 en cuadratura cuya combinación lineal resulta en otra QS3 cuya fase depende de la amplitud relativa de cada componente. En verano predomina la PC1, mientras que en invierno predomina la PC2 como se muestra en la \autoref{fig:pc1-pc2}. En este diagrama se puede mapear aproximadamente la amplitud y la fase media de cada mes a la distancia y el ángulo con respecto al origen.

En la \autoref{fig:pc1-pc2} también se hace una posible modificación de las estaciones clásicas adaptada para el análisis de la QS3 basada en la posición media de cada mes en el espacio de componentes principales. Enero, febrero y marzo tienen preponderancia del PC1 y casi nulo PC2, abril, mayo, agosto, septiembre y octubre tienen una mezcla similar de componentes, pero es conveniente separar los dos primeros para respetar la progresión temporal. Junio y julio no están tan juntos como los demás meses, pero se los puede agrupar por tener gran magnitud de PC2. Finalmente, noviembre y diciembre aparecen como *outliers* en este diagrama debido a que su mayor variabilidad (como se notó en la \autoref{fase}) hace que no predomine ninguna componente principal. Es posible clasificarlos juntos como meses de "no estacionaridad" indicando que se trata de una época del año donde la QS3 no está presente. 


```{r pc1-pc2, fig.cap = "Valor medio de las dos primeras componentes principales del campo de QS3", fig.height = 5}
qs.eof$right[, .(value = -mean(value)), by = .(PC, month(date))] %>% 
    dcast(... ~ paste0("PC", PC)) %>% 
    # .[, .(dif = mean(PC2 - PC1), mag = mean(sqrt(PC2^2 + PC2^2))),
      # by = .(month(date))] %>% 
    ggplot(aes(PC1, PC2)) +
    geom_hline(yintercept = 0, linetype = 1, color = "gray50") +
    geom_vline(xintercept = 0, linetype = 1, color = "gray50") +
    ggforce::geom_link2(aes(color = qs.season(month), group = 1),
                        alpha = 0.5) +
    geom_point(aes(color = qs.season(month))) +
    ggrepel::geom_text_repel(aes(label = month.abb_sp[month])) +
    scale_color_brewer(palette = "Set1", na.translate = F) +
    coord_equal()
```

El efecto de esta nueva clasificación en los campos medios se presenta en las figuras \ref{fig:qs3-qsseason-ncep} y \ref{qs3-qsseason-ncep}. Comparando con las figuras \ref{fig:qs3-season-ncep} y \ref{qs3-season-ncep} de la sección \ref{onda-3} se ve que los campos de las estaciones de transición (AM y ASO) son más similares entre ellas tanto en el campo horizontal como en el corte meridional. Los meses no estacionarios (ND), por su parte, prácticamente carecen de QS3. 

```{r qs3-qsseason-ncep, fig.class = "pagewidth", fig.cap = "Media de reconstrucción de onda 3 en 300hPa", fig.height = 6}
qs.qs.season <- qs.wave[, 
                        .(QS3 = mean(QS3)),
                        by = .(lon, lat, lev, qs.season(date))] 

binwidth <- 10
ggplot(qs.qs.season[lev == 300], aes(lon, lat)) +
    geom_contour_fill(aes(z = QS3), binwidth = binwidth, 
                      exclude = 0) +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(binwidth = binwidth, name = "QS3",
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~qs.season, ncol = 2) +
    coord_quickmap()
```

```{r qs3-qsseason-ncep-corte, fig.class = "pagewidth", fig.cap = "Corte", fig.height = 4}
ggplot(qs.qs.season[lat %~% -52.5], aes(lon, lev)) +
    # stat_contour_fill(aes(z = sd), binwidth = 10) +
    geom_contour_fill(aes(z = QS3), binwidth = binwidth, exclude = 0) +
    scale_y_level(breaks = plot.levs) +
    scale_x_longitude(name = "longitud") +
    scale_fill_divergent(binwidth = binwidth, name = "QS3",
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~qs.season, ncol = 2) 
```

El uso de componentes principales para el análisis de una onda que cambia de fase es similar a la metodología utilizada para el monitoreo de la MJO\todo{cita de MJO} por lo que sería posible su utilización como indicador de la actividad de la QS3 distinto de la amplitud media de Fourier. La exploración de dicho indicador está por fuera del objetivo de este trabajo. 

Una desventaja de esta clasificación es que no todas las estaciones tienen la misma cantidad de meses, lo cual dificulta la comparación estadística entre distintas estaciones. 

## Persistencia (ver dónde va)

```{r lag-cor, fig.cap = "Correlación lageada para cada mes con los 12 sigientes."}
lags <- 0:12
qs.croscor <- copy(qs.wave[lev == 300]) %>%
    .[, (paste0("l", lags)) := shift(QS3, lags, type = "lead"), 
      by = .(lat, lon)] %>% 
    .[, lapply(lags, function(l) cor(.SD$l0, .SD[[paste0("l", l)]], 
                                     use = "complete.obs")), 
      by = month(date)] %>% 
    set_colnames(c("month", 0:12)) %>% 
    melt(id.vars = "month", variable.name = "lag", value.name = "cor") %>% 
    .[, lag := as.numeric(as.character(lag))] %>% 
    .[, month2 := ifelse2(month + lag, x > 12, x - 12)]

ggplot(qs.croscor[lag != 0], aes(month2, month)) +
    # annotate("ribbon", x = c(0.5, rep(1:12 + 0.5, each = 2)),
    #          ymin = c(0, 0, rep(1:11, each = 2) + 0.5, 12),
    #          ymax = 13, 
    #          fill = "gray80", alpha = 0.2) +
    # geom_point(aes(size = abs(cor), color = cor)) +
    geom_tile(aes(fill = cor)) +
    geom_text(aes(label = round(cor*10, 1))) +
    annotate("step", x = 2:13 - 0.5, y = 1:12 - 0.5, direction = "vh",
             color = "gray20", linetype = 1) +
    # points(seq(0.1, 0.5, by = 0.1)) +
    scale_size() +
    scale_y_continuous(name = "Mes", expand = c(0, 0), trans = "reverse", 
                       breaks = 1:12, labels = month.abb_sp) +
    scale_x_continuous(name = "Mes siguiente", expand = c(0, 0),
                       breaks = 1:12, labels = month.abb_sp) +
    scale_fill_divergent(breaks = MakeBreaks(0.1), 
                         guide = "none") +
    theme(panel.ontop = F)
```

## R2

Se puede estimar de dos maneras distintas: a partir del ajuste de fourier para cada nivel y latitud (figura blabla) y haciendo un promedio, o reconstruyendo el campo tridimensional de la onda 3 y haciendo la correlación (global) con el campo tridimensional observado. Esta segunda forma da casi siempre un valor menor. 

```{r r2-cor2, fig.cap = "Relación entre R2 medio y R2 reconstruido."}
r2.cor <- index[, cor(cor, r2)]^2
ggplot(index, aes(r2, cor)) +
    geom_point(size = 0.5, alpha = 0.5) +
    geom_smooth(color = "black", size = 0.7) + 
    # geom_smooth(method = "lm", data = index[r2 < 0.4]) +
    # geom_smooth(method = "lm", data = index[r2 >= 0.4]) +
    geom_abline(linetype = 3) +
    annotate(geom = "text", x = 0.5, y = 0.2, 
             label = paste0("r2 = ", round(r2.cor, 2))) +
    scale_y_continuous(name = "R2 reconstrucción", breaks = MakeBreaks(0.1)) +
    scale_x_continuous(name = "R2 medio", breaks = MakeBreaks(0.1)) +
    coord_equal()
```

Para ver:    
La relación ya no es lineal y hay bastante más scatter. Ergo, hay diferencia en la información.     
Dos regímenes: Cuando el R^2 es bajo, la relación es "menor" que 1:1 y hay algunos casos donde el R2 reconstruido es mayor que el r2 medio. Para R2 más grandes, la pendiente es 1. Modelar la relación... ¿Cómo se interpreta?


```{r r2-corte, fig.cap = "R2 medio", fig.height = 4, fig.class = "pagewidth"}
M <- max(index[date %in% select.dates, r2])
binwidth <- 0.1
ggplot(gdata, aes(lat, lev)) + 
    stat_contour_fill(aes(z = r2), binwidth = binwidth) +
    geom_index.region(rect.annotation) +
    surface +
    geom_segment(data = index[date %in% select.dates], inherit.aes = F,
                 size = 1, color = "red", 
                 aes(x = -90, xend = -90, y = 1000, 
                     yend = 10^(-2/M*r2 + 3))) +
    geom_segment(data = index[date %in% select.dates], inherit.aes = F,
                 size = 1, color = "blue", 
                 aes(x = -90, xend = -90, y = 1000, 
                     yend = 10^(-2/M*(cor) + 3))) +
    scale_y_level(name = "nivel", 
                  sec.axis = sec_axis(~-M/2*(log10(.) - 3), name = "R^2")) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_viridis_c(guide = guide_colorstrip_bottom(15)) +
    facet_wrap(~date)
```

Cosas para ver:    
Comparando con las figuras anteriores, casos donde la amplitud es grande pero el R2 no tanto. 

```{r r2-ts, fig.class = "pagewidth", fig.cap = "R2 medio", fig.subcap = c("Serie temporal", "Ciclo anual"), cache = FALSE, fig.height = 4, fig.show = "hold", fig.ncol = 1}
gdata <- melt(index, id.vars = "date", measure.vars = c("r2", "cor"), 
              variable.name = "tipo", value.name = "r2" )
g <- ggplot(gdata, aes(date, r2)) +
    geom_line(aes(color = tipo)) +
    geom_hline(data = gdata[, .(m = mean(r2)), by = tipo],
               aes(yintercept = m, color = tipo), linetype = 3) +
    scale_x_date(date_breaks = "1 years", expand = c(0, 0), date_labels = "%y") +
    scale_color_brewer(palette = "Set1")
DivideTimeseries(g, index$date, n = 3, xlab = "Fecha", ylab = "R2")

ggplot(gdata, aes(factor(month(date)), r2, color = tipo)) +
    geom_boxplot() +
    scale_x_discrete(name = "Mes", labels = month.abb_sp) +
    scale_y_continuous(name = "R2") +
    scale_color_brewer(palette = "Set1")
```

Cosas para ver:    
El ciclo anual no es para nada tan claro. Varios outliers. La correlación reconstruida (azul) no tiene casi ciclo anual. 


Una ventaja de la correlación entre el campo real y el reconstruido es que puede hacerse para cada punto y analizar la variación espacial de la misma. 


```{r cor-campo, fig.cap = "Correlación cuadrada media para estaciones según onda3."}
cor.months <- fields[lat > -90 & lev == 300, 
                     .(corelation = cor(gh, QS3)), 
                     by = .(lon, lat, month(date))][
                         , cor.w := corelation*sqrt(cos(lat*pi/180))]

binwidth <- 0.15
ggplot(cor.months[, .(cor = mean(corelation^2)), 
                  by = .(lon, lat, season = qs.season(month))], 
       aes(lon, lat)) +
    stat_contour(aes(z = cor, color = ..level..), binwidth = binwidth) +
    map.SH +
    scale_color_viridis_c(breaks = MakeBreaks(binwidth),
                          limits = c(0, 1),
                          guide = guide_colorstrip_bottom()) +
    scale_s_map() +
    coord_quickmap() +
    facet_wrap(~season)
```


Cosas para ver:    
Esto es, para cada punto de grilla, la correlación entre el campo observado y el reconstruido en todos los meses y años. 
Además de la dependencia latitudinal de la importancia de la onda 3 (que se puede ver en los cortes anteriores), se ve la dependencia zonal. La onda 3 es más importante en el Pacífico sur que en el Atlántico o el Índico. Además, se ve un patrón de altas correlaciones que asemejan a un tren de ondas.    
¿Confirma? lo que se ve en en análisis de wavelets. 


Conclusión: no voy a usar el r2 a partir del campo reconstruido. 


## Regresiones

### Geopotencial

```{r calc-regr-gh-ncep}
file <- "DATA/regr-gh-ncep.Rds"
regression <- cache.file(file, {
    ncep[lev == 300, .(lon, lat, date, gh)] %>% 
        .[index[, .(date, amplitude, phase)], on = "date"] %>% 
        .[, setNames(ExtractLm(
            RcppArmadillo::fastLm(cbind(mean = 1,
                                        amplitude = amplitude/sd(amplitude), 
                                        phase = phase),
                                  gh)),
            c("regressor", "estimate", "se")), 
          by = .(lat, lon, month(date))] %>% 
        .[, t := abs(estimate)/se]
})
```

```{r regr-gh-ncep, fig.cap = "Regresión sobre amplitud.", fig.class = "fullpage"}
binwidth <- 10
ggplot(regression[regressor == "amplitude"], aes(lon, lat)) +
    stat_contour(aes(z = estimate, color = ..level..), binwidth = binwidth) +
    map.SH +
    # scale_s_map() +
    scale_y_latitude(limits = c(-90, 0)) +
    scale_x_longitude() +
    scale_color_divergent(binwidth = binwidth,
                          guide = guide_colorstrip_bottom()) +
    # coord_polar() +
    coord_quickmap() +
    facet_wrap(~month, ncol = 3, nrow = 4, dir = "v",
               labeller = labeller(month = month.abb_sp))
```

Cosas para ver:   
* Además los patrones de onda 3, en julio y diciembre aparece un patrón de SAM positivo y negativo respectivamente. 

```{r regr-gh-polar, fig.cap = "Igual que figura  XX, pero en proyección polar para julio y septiembre."}
binwidth <- 10
ggplot(RepeatLon(regression[regressor == "amplitude" & month %in% c(7, 12)]), 
       aes(lon, lat)) +
    stat_contour(aes(z = estimate, color = ..level..), binwidth = binwidth) +
    map.SH +
    # scale_s_map() +
    scale_y_latitude(limits = c(-90, 0)) +
    scale_x_longitude() +
    scale_color_divergent(binwidth = binwidth,
                          guide = guide_colorstrip_bottom()) +
    coord_polar() +
    # coord_quickmap() +
    facet_wrap(~month, labeller = labeller(month = month.abb_sp))
```

```{r sam-ampl, fig.cap = "Relación entre amplitud media de la onda 3 y el SAM", fig.height = 6}
sam <- fread("DATA/sam.monthly.txt") %>% 
    setnames(c("year", "month", "sam")) %>% 
    .[year > 1984 & year < 2016] %>% 
    .[, date := ymd(paste0(year, " ", month, " ", 01))] %>% 
    .[, `:=`(year = NULL, month = NULL)]


index[sam, on = "date"] %>% 
    .[, month := month(date)] %>% 
    ggplot(aes(amplitude, sam)) +
    geom_point(size = 0.5) + 
    geom_smooth(method = "lm", size = 0.5, color = "black") +
    scale_x_continuous(name = "Amplitud media") +
    scale_y_continuous(name = "SAM") +
    facet_wrap(~month, scales = "free", 
               ncol = 3, nrow = 4, dir = "v",
               labeller = labeller(month = month.abb_sp))
```

### Función Corriente
```{r calc-regr-psi-ncep}
file <- "DATA/stream.reg.Rds"
stream.reg <- cache.file(file, {
    stream[, .(lon, lat, date, psi)] %>% 
        .[index[, .(date, amplitude, phase)], on = "date"] %>% 
        .[, setNames(ExtractLm(
            RcppArmadillo::fastLm(cbind(mean = 1,
                                        amplitude = amplitude/sd(amplitude), 
                                        phase = phase),
                                  psi)),
            c("regressor", "estimate", "se")),
          by = .(lat, lon, month(date))] %>% 
        .[, t := abs(estimate)/se] %>% 
        .[, estimate.z := Anomaly(estimate),
          by = .(lat, month, regressor)] %>% 
        .[, psi.z := estimate.z] %>% 
        .[, c("f.x", "f.y") := WaveFlux(.SD), by = .(regressor, month)]
})
```


```{r regr-psi-ncep, fig.cap = "Regresión de Psi con la amplitud.", fig.class = "fullpage"}
binwidth <- 1e6
scale <- 600

ggplot(stream.reg[regressor == "amplitude"], 
       aes(lon, lat)) +
    stat_contour_fill(aes(z = estimate.z), exclude = 0, 
                      complete = FALSE, binwidth = binwidth) +
    # geom_segment(aes(xend = lon + f.x*scale, yend = lat + f.y*scale)) +
    geom_vector(aes(dx = f.x, dy = f.y), skip = 4, min.mag = 0.005,
                arrow.size = 0.2, scale = 600, size = 0.2) +
    map.world +
    # scale_s_map() +
    scale_y_latitude(limits = c(-90, 40)) +
    scale_x_longitude() +
    scale_fill_divergent(binwidth = binwidth, 
                         guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_wrap(~month, labeller = labeller(month = month.abb_sp))
```


## Composición de campos. 

```{r calc-qs-fields}
setnames(fields, c("gh.z", "gh", "QS3"), c("ncep.z", "ncep", "qs3"))
fields <- melt(fields[lev == 300], id.vars = c("lon", "lat", "date"), 
               variable.name = "campo", value.name = "gh", 
               measure.vars = c("ncep", "qs3", "ncep.z"))
```

Descripción de la selección.  


```{r seleccion-tabla, fig.class = "fullpage", fig.cap = "Tabla de selección"}
index[, `:=`(select.amplitude = greater(amplitude, 10),
             select.r2 = greater(r2, 10)), 
      by = month(date)]
index <- index

selected <- melt(index[select.amplitude | select.r2],
                 id.vars = c("date", "phase", "amplitude"), 
                 measure.vars = c("select.amplitude", "select.r2"), 
                 variable.name = "select")
selected <- selected[value == T]

scale_color_selection <- 
    scale_color_brewer(palette = "Set1", name = "Selección según:", 
                       labels = c(select.amplitude = "Amplitud",
                                  select.r2  = "R2"))
library(ggstance)
ggplot(selected, aes(year(date), as.factor(month(date)))) +
    geom_point(aes(color = select),
               position = position_dodgev(height = 0.6)) +
    geom_spoke(aes(angle = phase/120*360, radius = amplitude/150), alpha = 0.6,
               data = unique(selected[, .(date, amplitude, phase)])) +
    scale_y_discrete(label = month.abb_sp, name = "Mes") +
    scale_x_continuous(breaks = 1985:2015, 
                       name = "Año", labels = decade(1985:2015)) +
    scale_color_selection
```

Cosas para ver:   
Años con coincidencia, años sin coincidencia. Meses donde la fase coincide (julio) vs meses donde no coincide (septiembre).
También, años donde hay seguidilla de meses seleccionados (1999). Aunque posiblemente sea casualidad (no hay mucha persistencia mes a mes.)

Pequeña digresión: Efecto de la fase.     
La climatología de la fase se va a discutir más adelante, pero... discutir el efecto de promediar campos con similar amplitud pero fase distinta. Del gráfico, septiembre tiene 1997 y 2003 con fase a 180°, lo que significa que va a a haber cancelación parcial. Enero, por el contrario, no tiene ningún año en contrafase, aunque sí algunos a 90°, que desdibujan el patrón. 

```{r interaccion-tabla, fig.height = 4, fig.class = "textwidth", fig.cap = "Tabla de interacción"}
gdata <- index[, .N, by = .(month(date), 
                            interaction(select.amplitude, 
                                        select.r2))] %>%
    .[, c("amplitude", "r2") := tstrsplit(interaction, split = "\\.")] %>%
    .[, interaction := NULL]

labels.truefalse <- c("TRUE" = "Sí", "FALSE" = "No")

ggplot(gdata, aes(amplitude, r2)) +
    geom_text(aes(label = N)) +
    facet_wrap(~month, labeller = labeller(month = month.abb_sp))  +
    theme(legend.title = element_text()) +
    scale_y_discrete(name = "R^2", labels = labels.truefalse) +
    scale_x_discrete(name = "Amplitud", labels = labels.truefalse)
```

Cosas para ver:    
Ambos criterios coinciden en casi todos los años seleccionados, así que no hay mucha diferencia. En efecto, las composiciones son casi iguales (no se muestra).  Voy a usar la amplitud.

```{r cleanup124}
index <- index[, c("select.r2", "cor") := NULL]
setnames(index, "select.amplitude", "select")
```

```{r gh-comp, fig.class = "fullpage", fig.cap = "Composición de campos"}
select.dates <- index[select == TRUE, date]
composition <- copy(fields) %>% 
    .[, gh.a := gh - mean(gh), by = .(lon, lat, campo, month(date))] %>% 
    .[date %in% select.dates, 
      .(gh = mean(gh.a)), 
      by = .(lon, lat, campo, month(date))]

binwidth <- 15
ggplot(composition[campo == "ncep"], aes(lon, lat)) +
    geom_contour_fine(aes(z = gh, color = ..level..), binwidth = binwidth) +
    map.SH +
    scale_s_map() +
    scale_color_divergent(breaks = MakeBreaks(binwidth),
                          guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    # coord_polar() +
    facet_wrap(~month, ncol = 3, nrow = 4, dir = "v",
               labeller = labeller(month = month.abb_sp))
```


```{r fun-plot-comp, cache = FALSE}
enso <- fread("DATA/ONI_v5.csv") %>% 
    set_names(c("year", 1:12)) %>% 
    melt(id.vars = "year", variable.name = "month", value.name = "oni") %>% 
    .[, date := ymd(paste(year, month, "01", sep = "-"))] %>% 
    .[, `:=`(month = NULL, year = NULL)] %>% 
    setkey(date) %>% 
    .[, sign := cut(oni, breaks = c(-Inf, -0.5, 0.5, Inf),
                    labels = c("niña", "neutral", "niño"))]

scale_color_enso <- function(...) {
    scale_color_manual(values = c(niña = "blue", niño = "red", neutral = "gray50"),
                       ...)
}

select.dates <- select.dates[month(select.dates) %in% c(1, 9)]
gdata <- fields[date %in% select.dates] %>% 
    .[, year := year(date), by = date] %>% 
    enso[., on = "date"] 

binwidth <- 30
tempplot <- function(m) {
    ggplot(mapping = aes(lon, lat, z = gh)) +
        stat_contour_fill(data = gdata[campo == "qs3" & month(date) == m], 
                          exclude = 0, complete = F,
                          binwidth = binwidth) +
        geom_contour_fine(data = gdata[campo == "ncep.z" & month(date) == m],
                          aes(linetype = factor(sign(-..level..))),
                          binwidth = binwidth,
                          color = "black") +
        map.SH +
        geom_point(data = gdata[lon %~% 15 & lat %~% -5 & month(date) == m], 
                   aes(color = sign)) +
        scale_s_map() +
        scale_color_enso(guide = "none") +
        scale_linetype(guide = "none") +
        scale_fill_divergent(breaks = MakeBreaks(binwidth),
                             guide = guide_colorstrip_bottom()) +
        coord_quickmap() +
        facet_wrap(~year, ncol = 2,
                   labeller = labeller(month = month.abb_sp))
}
```


```{r gh-qs3-select-ene, fig.cap = "Campos para los 10 eneros seleccionados.", fig.class = "fullpage"}
tempplot(1)

```

```{r gh-qs3-select-sep, fig.cap = "Campos para los 10 septiembres seleccionados.", fig.class = "fullpage"}
tempplot(9)

```

Estos gráficos me parecen importantes para ver lo que hay "adentro" de la composición, pero no sé bien qué decir sobre ellos. Supongo que lo principal es que hay años donde la onda 


## Fuentes de variabilidad interna

(Discusión escrita más de papers), Pero nos concentramos en la fuente externa.

## Fuentes externas

### SST

```{r calc-regr-sst-ncep}
file <- "DATA/sst.regr.Rds"

sst.regr <- cache.file(file, {
    sst <- ReadNetCDF("DATA/NCEP/sst.nc", vars = "sst") %>% 
        .[, date := as.Date(date), by = date]
    sst.regr <- sst[index[, .(date, amplitude, phase)], on = "date"] %>% 
        .[, ExtractLm(RcppArmadillo::fastLm(cbind(mean = 1, 
                                                  amplitude = amplitude/sd(amplitude), 
                                                  phase = phase),
                                            sst)),
          by = .(lon, lat, month(date))] %>% 
        .[, t := abs(estimate)/se]
})
```

```{r regr-sst-ncep, fig.cap = "Regresión de SST con la amplitud de la onda 3", fig.class = "fullpage"}
sst.regr[, estimate.full := ifelse(is.na(estimate), 
                                   mean(estimate, na.rm = T), 
                                   estimate), 
         by = regressor]

binwidth <- 0.15
ggplot(sst.regr[regressor == "amplitude"], aes(lon, lat)) +
    stat_contour_fill(aes(z = estimate.full), binwidth = binwidth, 
                      complete = FALSE, exclude = 0) +
    # stat_contour(aes(z = estimate), binwidth = binwidth) +
    # geom_raster(aes(ifelse(is.na(estimate), lon, NA)), fill = "white") +
    stat_contour(aes(z = t), breaks = c(2, 3), color = "black", size = 0.2) +
    map.world +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_s_map() +
    coord_quickmap() +
    facet_wrap(~month, labeller = labeller(month = month.abb_sp))
```


Campos de correlación con SST y OLR, principalmente
¿Discusión de otros forzantes?

# Experimentos

## Validación SPEEDY

Validación de la corrida control

```{r read-speedy, cache = FALSE}
vars <- c(gh = "gh", u = "u", t = "temp", psi = "psi", v = "v")
vars.z <- paste0(names(vars), ".z")

runs <- c("Control", "SSTCLIM", "NOLAND", "SSTZONAL") 

file.speedy <- "DATA/SPEEDY/speedy.runs.Rds"
speedy <- cache.file(file.speedy, {
    rbindlist(lapply(seq_along(runs), function (x) {
        ReadNetCDF(paste0("DATA/SPEEDY/attm-", runs[x], "_HS.nc"), 
                   vars = vars)[, run := runs[x]]
    }))
})
speedy[, run := factor(run, levels = runs)]
speedy[, t := t - 273.15]

speedy[, c(vars.z) := lapply(.SD, Anomaly), 
       by = .(lat, lev, date, run), .SDcols = -"lon"]
speedy[, c("amplitude", "phase", "r2") := FitQsWave(gh, 3),
       by = .(lat, lev, date, run)]
speedy <- speedy[, QS3 := amplitude*cos(3*(lon*pi/180 - phase))]

speedy.mean.season <- speedy[, lapply(.SD, mean), 
                             by = .(lon, lat, lev, season(date), run)]

speedy.mean.season[, zeta := Vorticity(u + v ~ lon + lat, cyclical = TRUE,
                                       sphere = TRUE), 
                   by = .(lev, season, run)]
speedy.mean.season[, zeta.dy := Derivate(zeta ~ lon + lat, 
                                         cyclical = c(FALSE, FALSE),
                                         sphere = TRUE)[[2]],
                   by = .(lev, season, run)]

speedy.mean.season[, eta.dy := zeta.dy + f.dy(lat)]
speedy.mean.season[, `:=`(zeta = NULL, zeta.dy = NULL)]
speedy.mean.season[lev == 200, 
                   c("f.lon", "f.lat") := WaveFlux(.SD, p = 200), 
                   by = .(season, run)]
```

* Comparación campos medios. 

Acá un problemita es que en speedy no tengo el nivel de 50hPa, sólo tengo `r unique(speedy$lev)`. Podría usar 30, pero eso es la tapa del modelo...

```{r calc-interp-ncep}
lons <- unique(speedy.mean.season$lon)
lats <- unique(speedy.mean.season$lat)
ncep.interp <- 
    ncep.mean.season %>% 
    melt(id.vars = c("season", "lon", "lat", "lev")) %>% 
    .[variable %in% c(names(vars), vars.z, "eta.dy")] %>% 
    .[, Interpolate.DT(value, lon, lat, lats, lons), 
      by = .(lev, season, variable)]
```


```{r calc-cor-sp-nc}
sp.nc <-  melt(speedy.mean.season[run == "Control"][, run := NULL], 
               id.vars = c("season", "lon", "lat", "lev")) %>% 
    .[ncep.interp, on = c("variable", "season", "lon", "lat", "lev")] %>% 
    .[!is.na(value) & !is.na(i.value)]

cor.sp_nc <- sp.nc[, .(cor = cor(value, i.value)),
                   by = .(season, lev, variable)]

cor.sp_nc[, zonal := substr(variable, 
                            stri_length(variable) - 1, 
                            stri_length(variable)) == ".z"] 
cor.sp_nc[zonal == TRUE, 
          variable := substr(variable, 
                             1, 
                             stri_length(variable) - 2)]
```

```{r cor-sp-nc, fig.cap = "Correlación lineal entre campos de SPEEDY y NCEP.", fig.height = 5, fig.publish = FALSE}
ggplot(cor.sp_nc, aes(lev, cor, color = zonal)) +
    geom_line() +
    coord_flip() +
    scale_x_level(breaks = plot.levs, name = "Nivel") +
    scale_y_continuous(name = "Correlación") +
    scale_color_brewer(palette = "Set1", name = "", 
                       labels = c("TRUE" = "Anomalía", "FALSE" = "Completa")) +
    facet_grid(season~variable, 
               labeller = labeller(variable = c(gh = "Altura Geopotencial",
                                                u = "Viento zonal",
                                                v = "Viento meridional",
                                                eta.dy = "Gradiente meridinoal\nde vorticidad absoluta",
                                                t = "Temperatura"))) 

```


* Altura geopotencial (gh)
Para el caso del campo total, la correlación del campo es buena (>0.8)en casi todos los niveles y meses, excepto en 30hPa durante verano donde los campos ¡está anticorrelacionados! La parte asimétrica zonal muestra valores menores, indicando que gran parte de la correlación del campo total se debe a la capacidad del modelo de reproducir el gradiente meridional. Sin embargo, se siguen obteniendo correlaciones >0.6 en casi todos los niveles y estaciones. Se observa un mínimo relativo en 500hPa donde en se tienen correlaciones menores durante casi todo el año y uno en niveles altos centrado en invierno y primavera.

* Viento zonal (U)
Las correlaciones con el campo total son >=0.8 en todo el año y todos los niveles, sin embargo, la parte asimétrica muestra correlaciones mucho más baja con un máximo de \~0.6 en 925hPa. Esto indica que el modelo resuelve correctamente la estructura media del Jet, pero no sus variaciones zonales. 

* Viento meridional (V)
Los campos de correlación son prácticamente idénticos entre parte total y parte asimétrica. Ésta muestra un patrón de bajas correlaciones en general.

* Temperatura (T)
La correlación con el campo total muestra una estructura similar que la altura geopotencial, con una excelente correlación en todos los meses para niveles mayores a 200hPa, pero anticorrelacionado en niveles altos en todos los meses salvo en invierno. La parte asimétrica muestra correlaciones bajas en todos los niveles salvo en 925hPa. 

* Gradiente meridional de vorticidad absoluta. 
Tiene correlación moderada con un mínimo relativo en 200hPa en verano que en las otras estacione se convierte en un máximo. 


### Altura Geopotencial

Anomalía


```{r ghz-sp-nc, fig.class = "fullpage", fig.cap = "Anomalía zonal de altura geopotencial (speedy sombreado, ncep contornos)"}
plot.levs.sp <- c(500, 200)
binwidth <- 20
cutlat <- -60
ggplot(speedy.mean.season[run == "Control" & lev %in% plot.levs.sp], aes(lon, lat)) +
    geom_contour_fill(aes(z = gh.z), 
                      binwidth = binwidth, exclude = 0) +
    # geom_contour_fine(aes(z = gh.z), binwidth = binwidth, exclude = 0,
    # color = "black", size = 0.2) +
    geom_contour_back(aes(z = gh.z, linetype = factor(sign(-..level..))),
                      binwidth = binwidth,
                      data = ncep.mean.season[lev %in% plot.levs.sp]) +
    geom_label_contour_back(aes(z = gh.z, label = ..level..),
                            binwidth = binwidth,
                            data = ncep.mean.season[lev %in% plot.levs.sp]) +
    # geom_hline(yintercept = cutlat, 
    # linetype = 2, size = 0.5) +
    scale_fill_divergent(binwidth = binwidth, name = "Z*", 
                         guide = guide_colorstrip_bottom(25)) +
    scale_linetype(guide = "none") +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap()
```

```{r ghz-dif-sp-nc, fig.class = "fullpage", fig.cap = "Diferencia entre speedy y ncep"}
sp.nc <- sp.nc[, dif := i.value - value]

binwidth <- 20
ggplot(sp.nc[lev %in% plot.levs.sp & variable == "gh.z"], aes(lon, lat)) +
    geom_contour_fill(aes(z = dif), exclude = 0, binwidth = binwidth) +
    scale_fill_divergent(name = "Z*", breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap()
```

Veredicto:    
* Agarra bien la anomalía zonal aunque con magnitud menor. 

```{r ghz-sp-nc-corte60, fig.class = "textwidth", fig.cap = "Corte zonal de anomalía de geopotencial en -60° (speedy sombreado, ncep contornos)."}
binwidth <- 20
ggplot(speedy.mean.season[run == "Control" & lat %~% cutlat], aes(lon, lev)) +
    geom_contour_fill(aes(z = gh.z), binwidth = binwidth, exclude = 0) +
    geom_contour_back(aes(z = gh.z, linetype = factor(sign(-..level..))), 
                      binwidth = binwidth, 
                      data = ncep.mean.season[lat %~% cutlat]) + 
    geom_label_contour_back(aes(z = gh.z, label = ..level..), 
                            binwidth = binwidth, skip = 2,
                            data = ncep.mean.season[lat %~% cutlat]) +
    scale_fill_divergent(breaks = MakeBreaks(binwidth), name = "Z*",
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    scale_y_level(breaks = plot.levs, minor_breaks = NULL) +
    scale_x_longitude(name = "longitud") +
    facet_wrap(~season)
```

El corte zonal evidencia que además de tener menor amplitud, la estructura vertical de las anomalías es barotrópica equivalente en Speedy, a diferencia de la estructura baroclínica de NCEP. 

### Temperatura 

```{r t-nc-sp, fig.cap = "Temperatura"}
binwidth <- 5
ggplot(speedy.mean.season[run == "Control" & lev %in% 850], aes(lon, lat, z = t)) +
    geom_contour_fill(binwidth = binwidth) +
    # geom_contour_fine(aes(z = gh.z), binwidth = binwidth, exclude = 0,
    # color = "black", size = 0.2) +
    geom_contour_back(aes(linetype = factor(sign(-..level..))),
                      binwidth = binwidth,
                      data = ncep.mean.season[lev %in% 850]) +
    geom_label_contour_back(aes(label = ..level..),
                            binwidth = binwidth,
                            data = ncep.mean.season[lev %in% 850]) +
    # geom_hline(yintercept = cutlat, 
    # linetype = 2, size = 0.5) +
    scale_fill_viridis_c(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) 
```


```{r tz-sp-nc, fig.cap = "T*"}
binwidth <- 2
ggplot(speedy.mean.season[run == "Control" & lev %in% c(200, 850)], aes(lon, lat, z = t.z)) +
    geom_contour_fill(binwidth = binwidth, exclude = 0) +
    # geom_contour_fine(aes(z = gh.z), binwidth = binwidth, exclude = 0,
    # color = "black", size = 0.2) +
    geom_contour_back(aes(linetype = factor(sign(-..level..))),
                      binwidth = binwidth,
                      data = ncep.mean.season[lev %in% c(200, 850)]) +
    geom_label_contour_back(aes(label = ..level..),
                            binwidth = binwidth,
                            data = ncep.mean.season[lev %in% c(200, 850)]) +
    # geom_hline(yintercept = cutlat, 
    # linetype = 2, size = 0.5) +
    scale_fill_divergent(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) 
```

En 850 tiene una fuerte onda 1 en latitudes polares producida por la topografía de la Antártida y representa bien las anomalías causadas por los continentes, aunque en menor amplitud.    
En 200, falla miserablemente. La onda 1 polar que se ve bien claro en NCEP ni aparece en SPEEDY, mientras que en latitudes medias aparecen ligeras anomalías que no se observan en las observaciones. 


### Viento zonal

```{r u-sp-nc-corte, fig.class = "textwidth", fig.cap = "Viento zonal medio (speedy contornos, ncep sombreado)."}
speedy.mean.season[run == "Control", 
                   .(u = mean(u)), 
                   by = .(lat, lev, season)] %>% 
    ggplot(aes(lat, lev)) +
    geom_contour_fill(aes(z = u), binwidth = 5, exclude = 0, complete = FALSE) +
    geom_contour_back(aes(z = u, linetype = factor(-sign(..level..))), 
                      binwidth = 5,
                      data = ncep.mean.season[, .(u = mean(u)), 
                                              by = .(lat, lev, season)]) +
    geom_label_contour_back(aes(z = u, label = ..level..), 
                            binwidth = 5,
                            data = ncep.mean.season[, .(u = mean(u)), 
                                                    by = .(lat, lev, season)]) +
    surface +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse") +
    scale_fill_divergent(name = "U media zonal", breaks = MakeBreaks(5),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    facet_wrap(~season)
```


Cosas para ver:    
* Speedy no logra desarrollar un jet polar por la falta de niveles verticales en la estratósfera. Tampoco reproduce los estes estratosféricos en latitudes bajas. Su jet subtropical es más intenso y su máximo se da ligéramente en niveles más altos en NCEP. 

Campo medio (me parece que no lo voy a poner, no agrega información que no esté en el anterior y en el de geopotencial.)

```{r u-sp-nc, fig.class = "fullpage", fig.cap = "Viento zonal (contornos ncep, sombreado speedy)."}
ggplot(RepeatLon(speedy.mean.season[run == "Control" & lev == 200]), aes(lon, lat)) +
    geom_contour_fill(aes(z = u), binwidth = 5) +
    geom_contour_back(aes(z = u, linetype = factor(-sign(..level..))), 
                      binwidth = 5, 
                      data = RepeatLon(ncep.mean.season[lev == 200])) +
    geom_label_contour_back(aes(z = u, label = ..level..), 
                            binwidth = 5, 
                            data = RepeatLon(ncep.mean.season[lev == 200])) +
    # geom_contour(aes(z = u, color = ..level..), binwidth = 5, size = 0.1) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    scale_fill_divergent(name = "U", breaks = MakeBreaks(5),
                         guide = guide_colorstrip_bottom(),
                         limits = c(-20, 70)) +
    scale_linetype(guide = "none") +
    # coord_quickmap() +
    coord_polar() +
    # coord_map(projection = "stereographic", orientation = c(-90, 0, 0)) +
    facet_grid(lev~season, labeller = labeller(lev = lev.lab))
```


```{r u-dif-sp-nc, fig.cap = "Diferencia entre ncep y speedy en viento zonal"}
binwidth <- 5

ggplot(RepeatLon(sp.nc[lev == 200 & variable == "u"]), aes(lon, lat)) +
    geom_contour_fill(aes(z = dif), exclude = 0, binwidth = binwidth) +
    scale_fill_divergent(name = "Z*", breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_polar() +
    facet_grid(lev ~ season, labeller = labeller(lev = lev.lab)) 
```

Cosas para ver:    
Jet polar en invierno y primavera en niveles altos (< 100 hPa). Jest subtropical en niveles "medios".

### Gradiente meridional de vorticidad absoluta

```{r etady-sp-nc, fig.class = "fullpage", fig.cap = "Gradiente meridional de vorticidad absoluta (speedy)."}
binwidth <- 1
ggplot(speedy.mean.season[run == "Control" & lev == 200 & lat > -85], 
       aes(lon, lat, z = eta.dy*1e11)) +
    # stat_contour_fill(binwidth = binwidth) +
    geom_contour_fine(binwidth = binwidth, color = "black") +
    geom_label_contour2(aes(label = ..level..), 
                        binwidth = binwidth) +
    stat_filter(aes(filter = eta.dy <= 0), geom = "tile",
                color = "gray50", fill = "gray50") +
    # stat_contour_fill(breaks = 0,
    # fill = "black", complete = FALSE) +
    geom_contour_fine(breaks = 0, color = "black") +
    map.SH +
    # polar.SH + 
    scale_fill_divergent(name = "Gradiente meridional de vorticiad absoluta", 
                         guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    scale_s_map() +
    coord_quickmap() +
    # coord_polar() + 
    facet_wrap( ~ season, labeller = labeller(lev = lev.lab))
```

Comparando con la figura \autoref{fig:eta-dy-ncep}, los gradientes son menores y más zonales. Es significativo que la región "prohibida" en invierno de niveles altos es menor en 200hPa y casi desaparece en 300hPa. 


### Número de onda estacionaria

```{r ks-sp, fig.cap = "Número de onda estacionario en 300hPa (speedy).", fig.height = 6}
a <- 6371000

speedy.mean.season[, k := sqrt(eta.dy/u)*(a*cos(lat*pi/180))] 
sp.ks <- speedy.mean.season[run == "Control" & lev == 300,
                            .(lon, lat, lev, season, k)]
sp.ks[ , k.full := ifelse(is.na(k) | k > 10, -1, k)]

ggplot(sp.ks, aes(lon, lat)) +
    geom_contour_fine(aes(z = k.full), breaks = 0:9, color = "black") +
    # stat_contour(aes(z = k.full),
    #              breaks = c(2.5, 3.5), color = "black") +
    geom_label_contour2(aes(z = k.full, label = ..level..),
                        breaks = 0:9, skip = 0) +
    stat_filter(aes(filter = k.full == -1), geom = "tile", color = "gray50",
                fill = "gray50") +
    map.SH +
    scale_s_map() +
    scale_fill_viridis_c(breaks = 1:9, guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_wrap(~season)
```

Comparando con \autoref{fig:k-steady-ncep} la mayor diferencia es la desaparición de una región de propagación impedida en ~-40° en el Índico y el Pacífico en Otoño. 


```{r ks-sp-nc-corte, fig.class = "textwidth", fig.cap = "Número de onda estacionario medio por círculo de latitud."}
rbind(ks[lon %~% 180][, mod := "NCEP"], 
      sp.ks[lon %~% 180][, mod := "SPEEDY"]) %>%
    .[, k := ifelse(k > 9 | !is.finite(k), NA, k)] %>% 
    ggplot(aes(lat, k, color = mod)) +
    geom_line() +
    scale_y_continuous(name = "Número de onda estacionaria", breaks = 1:9,
                       limits = c(1, 9)) +
    scale_x_latitude(name = "Latitud", ticks = 15) +
    scale_color_brewer(palette = "Set1") +
    facet_wrap(~season) +
    coord_flip()
```

En promedio zonal, sin embargo, SPEEDY funciona bien. 

### Función corriente


```{r psi-sp, fig.class = "fullpage", fig.cap = "Función corriente x 1099"}

binwidth <- 5
ggplot(speedy.mean.season[run == "Control" & lev == 200], aes(lon, lat)) +
    stat_contour_fill(aes(z = psi.z),
                      binwidth = binwidth,
                      complete = FALSE, exclude = 0) +
    geom_contour_fine(aes(z = psi), 
                      binwidth = 20,
                      color = "black") +
    geom_vector(aes(dx = f.lon, dy = f.lat), skip = 3,
                min.mag = 1e-14,
                scale = 5e14) +
    map.SH +
    # scale_s_map() +
    scale_x_longitude(limits = c(0, 360)) +
    scale_y_latitude() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season) +
    theme(axis.title = element_blank()) + 
    coord_quickmap()
```

### Onda 3


```{r ampl-sp-nc, fig.class = "pagewidth", fig.cap = "Amplitud de Fourier (speedy en sombreado, ncep en contornos)."}

qs.sp.season <-speedy[, lapply(.SD, mean),
                      by = .(lat, lev, season(date), run), 
                      .SDcols = c("amplitude", "phase", "r2")]
# breaks <- 2^seq(0, log2(650), by = 0.5)
binwidth <- 10
ggplot(qs.sp.season[run == "Control"], aes(lat, lev)) +
    geom_contour_fill(aes(z = amplitude), binwidth = binwidth) +
    geom_contour_back(aes(z = amplitude), 
                      data = ampl.mean[k == 3], binwidth = binwidth) +
    geom_label_contour_back(aes(z = amplitude, label = ..level..), 
                            data = ampl.mean[k == 3], binwidth = binwidth) +
    surface +
    geom_index.region(rect.annotation) +
    scale_fill_viridis_c(name = "Amplitud (escala logarítmica)", 
                         guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth),
                         option = "D") +
    scale_y_level(breaks = plot.levs) +
    scale_x_latitude(name = "latitud", trans = "reverse", 
                     ticks = 15) +
    facet_grid(~ season)
```


```{r calc-qs3-sp}
lons <- unique(speedy$lon)
qs.wave.sp.season <- speedy[lev == 300, .(mean = mean(QS3)), 
                            by = .(lon, lat, season(date), run)]
```


```{r qs2-sp-nc, fig.class = "pagewidth", fig.cap = "Media de reconstrucción de onda 3 (sombreado speedy, contornos ncep)", fig.height = 6}
binwidth <- 10
cutlat <- data.frame(lat = c(-52.5), 
                     season = c("Verano"))
ggplot(qs.wave.sp.season[run == "Control"], aes(lon, lat)) +
    geom_contour_fill(aes(z = mean), binwidth = binwidth, exclude = 0, 
                      complete = FALSE) +
    geom_contour_back(aes(z = mean, linetype = factor(-sign(..level..))),
                      color = "black",
                      binwidth = binwidth,
                      data = qs.wave.season[lev == 300]) +
    geom_label_contour_back(aes(z = mean, label = ..level..), 
                            binwidth = binwidth,
                            data = qs.wave.season[lev == 300]) +
    map.SH +
    scale_s_map() +
    scale_linetype(guide = "none") +
    scale_fill_divergent(breaks = MakeBreaks(binwidth), name = "QS3",
                         guide = guide_colorstrip_bottom()) +
    facet_wrap(~season, ncol = 2) +
    coord_quickmap()
```

La onda 3 no está muy bien representada en el modelo. Aunque la estructura vertical y la posición meridional está bien (salvo en otoño), la amplitud es mucho menor. La fase, además, está corrida ligeramente en verano, pero quedando en cuadratura en invierno y defasado 180 en primavera. 



## Comparación 


Comparación entre corridas
### Altura geopotencial

```{r ghz-sp-runs, fig.class = "fullpage", fig.cap = "Anomalía zonal de altura geopotencial."}

plot.levs.sp <- 200
binwidth <- 20

ggplot(speedy.mean.season[lev == 200], aes(lon, lat)) +
    geom_contour_fill(aes(z = gh.z), 
                      binwidth = binwidth, exclude = 0) +
    scale_fill_divergent(binwidth = binwidth, name = "Z*", 
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(lev = lev.lab)) 
```

```{r ghz-dif-sp-runs, fig.calss = "fullpage", fig.cap = "Diferencia Control - corrida para Z*"}
speedy.mean.season.l <- melt(speedy.mean.season, 
                             id.vars = c("lon", "lat", "lev", "season", "run"))

s <- speedy.mean.season.l[, value[run == "Control"]]
speedy.mean.season.l[, dif := s - value, by = run]
run.dif <- setNames(paste0("Control -\n", runs[-1]),
                    runs[-1])
sp.dif <- dcast(speedy.mean.season.l[run != "Control"][, -c("value")], 
                ... ~ variable, 
                value.var = "dif")
remove(speedy.mean.season.l)

binwidth <- 10
ggplot(sp.dif[lev == 200], aes(lon, lat, z = gh.z)) +
    geom_contour_fill(binwidth = binwidth) +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = "colorstrip_bottom") +
    coord_quickmap() +
    # coord_polar() +
    facet_grid(run ~ season, labeller = labeller(run = run.dif))
```

### Temperatura

ONo hay casi diferencia entre las corridas. 

```{r t-sp-runs, fig.cap = "Temperatura media en 850hPa.", fig.publish = FALSE}
binwidth <- 5
ggplot(speedy.mean.season[lev == 850], aes(lon, lat)) +
    geom_contour_fill(aes(z = t), 
                      binwidth = binwidth) +
    scale_fill_viridis_c(breaks = MakeBreaks(binwidth),
                         name = "Z*", 
                         guide = guide_colorstrip_bottom()) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(lev = lev.lab)) 
```

```{r tz-sp-runs, fig.cap = "Temperatura media en 850hPa."}
binwidth <- 5
ggplot(speedy.mean.season[lev == 850], aes(lon, lat)) +
    geom_contour_fill(aes(z = t.z), 
                      binwidth = binwidth, exclude = 0) +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         name = "Z*", 
                         guide = guide_colorstrip_bottom()) +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(lev = lev.lab)) 
```

```{r tz-dif-sp-runs, fig.class = "fullpage", fig.cap = "Diferencia Control - corrida para T*"}
binwidth <- 1
ggplot(sp.dif[lev == 850], aes(lon, lat, z = t.z)) +
    geom_contour_fill(binwidth = binwidth, exclude = 0) +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = "colorstrip_bottom") +
    coord_quickmap() +
    # coord_polar() +
    facet_grid(run ~ season, labeller = labeller(run = run.dif))
```

### Viento zonal

```{r uz-sp-runs, fig.class = "fullpage", fig.cap = "Viento zonal"}
binwidth <- 5
ggplot(speedy.mean.season[lev == 200], aes(lon, lat)) +
    geom_contour_fill(aes(z = u), 
                      binwidth = binwidth,
                      # breaks = MakeBreaks(binwidth),
                      exclude = 0) +
    scale_fill_divergent(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(lev = lev.lab)) 
```

```{r u-dif-sp-runs, fig.cap = "Diferencia control - corrida para U."}
binwidth <- 2
speedy.mean.season[lev == 200] %>% 
    .[, u.dif := speedy.mean.season[lev == 200 & run == "Control", u] - u] %>%
    .[run != "Control"] %>% 
    ggplot(aes(lon, lat)) +
    geom_contour_fill(aes(z = u.dif), 
                      binwidth = binwidth,
                      # breaks = MakeBreaks(binwidth),
                      exclude = 0) +
    scale_fill_divergent(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(run = run.dif)) 
```

### Función corriente

```{r psi-sp-runs, fig.class = "fullpage", fig.cap = "Anomalía zonal de función corriente y flujos de acción de onda."}
binwidth <- 2
ggplot(speedy.mean.season[lev == 200], aes(lon, lat)) +
    geom_contour_fill(aes(z = psi.z), 
                      binwidth = binwidth,
                      exclude = 0) +
    scale_fill_divergent(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    geom_vector(aes(dx = f.lon, dy = f.lat), skip = 3,
                min.mag = 1e-14,
                scale = 5e14) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(lev = lev.lab)) 
```


```{r psiz-dif-sp-runs, fig.cap = "Diferencia en psi.z y flujos de acción de onda."}
binwidth <- 2
ggplot(sp.dif[lev == 200], aes(lon, lat, z = psi.z)) +
    geom_contour_fill(binwidth = binwidth,
                      # breaks = MakeBreaks(binwidth),
                      exclude = 0) +
    scale_fill_divergent(name = "Z*", 
                         breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    geom_vector(aes(dx = f.lon, dy = f.lat), skip = 3,
                min.mag = 1e-14,
                scale = 5e14) +
    scale_linetype(guide = "none") +
    map.SH +
    scale_y_latitude() +
    scale_x_longitude() +
    coord_quickmap() +
    facet_grid(run ~ season, labeller = labeller(run = run.dif)) 
```


### Onda 3

```{r ampl-sp-runs, fig.cap = c("Amplitud media de la onda 3 para cada corrida."), fig.height = 5}
sp.levs <- unique(speedy$lev)
binwidth <- 5
ggplot(qs.sp.season, aes(lat, lev)) +
    geom_contour_fill(aes(z = amplitude), binwidth = binwidth) +
    scale_x_latitude(trans = "reverse") +
    scale_y_level(breaks = sp.levs)+
    scale_fill_viridis_c(guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    ylab("Nivel") + xlab("Latitud") +
    facet_grid(run ~ season)
```

```{r ampl-dif-sp-runs, fig.cap = "Diferencia de amplitud entre la corrida control y cada corrida.", fig.height = 5}
qs.sp.season[, dif := qs.sp.season[run == "Control", amplitude] - 
                 amplitude,
             by = run]
binwidth <- 2
dif <- setNames(paste0("Control - ", runs[-1]),
                runs[-1])
ggplot(qs.sp.season[run != "Control"], aes(lat, lev, z = dif)) +
    geom_contour_fill(binwidth = binwidth, exclude = 0, complete = F) +
    scale_y_level(breaks = sp.levs) +
    scale_x_latitude(trans = "reverse") +
    scale_fill_divergent(guide = guide_colorstrip_bottom(),
                         breaks = MakeBreaks(binwidth)) +
    facet_grid(run ~ season, 
               labeller = labeller(run = dif))
```

```{r calc-sp-index}
levs.index <- c(700, 300, 100)
lats.index <- c(-65, -40)
levs.index <- c(100, 700)

sp.index <- speedy[(lev %b% levs.index) & 
                       (lat %b% lats.index) & 
                       lon == 0,
                   .(amplitude   = mean(amplitude),
                     r2          = mean(r2),
                     phase  = mode.circular(phase)),
                   by = .(date, run)]
```




```{r index-sp-boxplot, fig.cap = "Ciclo anual de amplitud de onda 3."}
ggplot(sp.index, aes(factor(month(date)), amplitude, color = run)) +
    geom_boxplot() +
    scale_color_brewer(palette = "Set1") +
    scale_x_discrete(breaks = 1:12, labels = month.abb_sp, name = "Mes") +
    scale_y_continuous(name = "Amplitud")
```




## Regresión


```{r calc-regr-psi-sp}
regr.file <- "DATA/regression-exps.Rds"
regr.exps <- cache.file(regr.file, {
    speedy[lev == 300, ] %>% 
        .[sp.index[, .(date, run, amplitude, phase)], 
          on = c("date", "run")] %>% 
        .[, 
          ExtractLm(RcppArmadillo::fastLm(cbind(mean = 1, 
                                                amplitude = amplitude/sd(amplitude),
                                                phase = phase),
                                          psi)), 
          by = .(lon, lat, month(date), run)]
})
```

```{r regr-psi-sp-runs, fig.cap = "Regresión en función corriente."}
binwidth <- 1
regr.exps[regressor == "amplitude"] %>%
    .[, lapply(.SD, mean, na.rm = T), 
      by = .(lon, lat, run, season(month), regressor)] %>% 
    .[, psi.z := Anomaly(estimate), by = .(run, season, lat)] %>% 
    .[, c("fx", "fy") := WaveFlux(.SD, p = 300), by = .(run, season)] %>%
    ggplot(aes(lon, lat, z = psi.z)) +
    geom_contour_fill(binwidth = binwidth, exclude = 0) +
    geom_vector(aes(dx = fx, dy = fy), skip = 3,
                min.mag = 1e-15,
                scale = 1e15) +
    map.SH +
    scale_s_map() +
    scale_fill_divergent(breaks = MakeBreaks(binwidth),
                         guide = guide_colorstrip_bottom()) +
    coord_quickmap() +
    facet_grid(run ~ season)
```





## Cosas inesperadas...

* ?? 
* protif!

# Conclusiones

# Agradecimientos

# Referencias


```{r ending-cheer, eval = !params$draft, include = !params$draft}
beepr::beep(3)
```

